<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
    integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">


<style>
    .reporttable {
        text-align: center;
    }

    /* Absolute Center Spinner */

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }
</style>

<div class="loading" id="loader"></div>

<a id="dlink" style="display:none;"></a>
<div id="main">
    <div style="width: 40%; margin-left:30%;">
        <table class="table table-striped table-bordered">

            <tr style="border: 1px solid #DDDDDD;">
                <td style="font-size: 15px;padding-top: 15px;">
                    Report Date :
                </td>
                <td style="width: 60%;">
                    <input type="month" class=" form-control" id="end-date">
                </td>
            </tr>
            <tr>
                <td><button onClick="submit()" class="btn btn-primary" id="tap">Submit</button></td>
                <td style="text-align: right;">
                    <img src="https://img.icons8.com/color/35/000000/ms-excel.png"
                        onmouseover="this.style.cursor='pointer'"
                        onclick="tableToExcel('report_table', 'Viral load line list report', 'Viral load line list report.xls')"
                        alt="xls" style="cursor: pointer;">
                    <span id="csv-download">
                        <img src="https://img.icons8.com/dusk/35/000000/export-csv.png" alt="print"
                            onmouseover="this.style.cursor='pointer'" onclick="downloadCSV()">
                    </span>
                </td>
            </tr>
        </table>
    </div>
    <br>
    <table class="table table-bordered table-striped table-hover reporttable" width="100%" id="report_table"
        style="visibility:hidden">
        <tbody id="tableBody">
        </tbody>
    </table>
</div>

<script>

    var selectedOrgUnit = dhis2.report.organisationUnit;
    var ouChildren = dhis2.report.organisationUnitChildren;
    var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    var CSVFile = [];

    function submit() {
        CSVFile = [];
        CSVFile[0] = [];

        document.getElementById("loader").style.display = "block";
        document.getElementById("report_table").style.visibility = "hidden";
        document.getElementById("tableBody").innerHTML = "";

        var month = document.getElementById("end-date").value;
        if (!month) {
            alert("Please select a month!");
            return;
        }
        var startMonth = (endMonth) => {
            let em = endMonth.split('-');
            let sm = `${em[0] - 1}-${`00${(Number(em[1]) + 1)}`.slice(-2)}-01`;
            if (em[1] == 12) sm = `${em[0]}-${`01`.slice(-2)}-01`;
            return sm;
        }
        var endMonth = (month) => {
            month = new Date(month);
            return `${month.getFullYear()}-${('00' + (month.getMonth() + 1)).slice(-2)}-` + new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate();
        }

        var data = {
            startDate: startMonth(month),
            endDate: endMonth(month)
        }

        $('#loader').show();
        setTimeout(function () {
            getData(data);
        }, 1000);

        var getBetweenDates = function (startDate, endDate) {
            var arr = [], lastDay, start, end;
            var startYear = startDate.split("-");
            var endYear = endDate.split("-");

            for (var i = parseInt(startYear["0"]); i <= parseInt(endYear["0"]); i++) {

                startMonth = (i > parseInt(startYear["0"])) ? 1 : parseInt(startYear["1"]);
                endMonth = (i == endYear["0"]) ? endYear["1"] : 12;

                for (var j = startMonth; j <= endMonth; j++) {
                    let month = j < 10 ? i + "0" + j : i + "" + j;
                    arr.push(month);
                }
            }

            return arr;
        }

        async function getData(data) {
            var teiList = [];
            var teis = [];
            var treatmentDates = {};
            var treatementDate = [];

            var VLTESTDONE = 'rkjZKfO3IPA';

            var resTestDone = await (await fetch(`../../sqlViews/vz7sfB4SMJy/data?paging=false&var=program:L78QzNqadTV&var=orgUnit:${selectedOrgUnit.id}&var=programStage:YRSdePjzzfs&var=startDate:${data.startDate}&var=endDate:${data.endDate}`)).json();
            resTestDone.listGrid.rows.forEach(tei => teiList.push(tei[0]));
            debugger;
            var teisAttr = [];
            for (let tei of teiList) {
                let attrs = {}
                let attrRes = await (await fetch(`../../trackedEntityInstances/${tei}.json?paging=false&program=L78QzNqadTV&fields=attributes[attribute,value],orgUnit,enrollments[enrollmentDate,program,orgUnitName,events[eventDate,programStage,dataValues[dataElement,value]]]`)).json();
                attrRes.attributes.forEach(attr => attrs[attr.attribute] = attr.value);
                attrRes.enrollments.forEach(enroll => {
                    if (enroll.program) attrs.program = enroll.program;
                    if (enroll.orgUnitName) attrs.orgUnitName = enroll.orgUnitName;
                    if (enroll.enrollmentDate) attrs.enrollmentDate = enroll.enrollmentDate.split("T")[0];
                    enroll.events.forEach(event => {

                        if (event.eventDate) {
                            if (!attrs.events) attrs.events = [];
                            if (!attrs.programStage) attrs.programStage = [];
                            if (!attrs.screeningDone) attrs.screeningDone = [];
                            let eventDate = event.eventDate.split('T')[0];

                            if (eventDate && event.programStage == "YRSdePjzzfs") {
                                let dates = eventDate.split('-');
                                attrs.programStage[`${dates[0]}${dates[1]}`] = true;

                                event.dataValues.forEach(dataValue => {
                                    if (dataValue.dataElement == "rkjZKfO3IPA") {
                                        let dates = eventDate.split('-');
                                        if (!attrs['VLStage']) attrs['VLStage'] = {}
                                        attrs['VLStage'][`${dates[0]}${dates[1]}`] = "Y";
                                    }
                                    else if (dataValue.dataElement == "ji97ypBaP2i") {
                                        let dates = eventDate.split('-');
                                        if (!attrs['VLTest']) attrs['VLTest'] = {}
                                        attrs['VLTest'][`${dates[0]}${dates[1]}`] = dataValue.value;
                                    }
                                    else attrs[dataValue.dataElement] = dataValue.value;
                                })

                            }
                            if (eventDate && event.programStage == "zRUw1avYEvI") {
                                event.dataValues.forEach(dataValue => {
                                    if (dataValue.dataElement == "rQnmYAF1899" || dataValue.dataElement == "gPHLt0PQq1b") {
                                        attrs[`ARTStarted`] = dataValue.value;
                                    }
                                })
                            }


                        }
                    })

                })

                teis.push(attrs)
            }
            debugger;
            //getting between dates
            var smToEm = getBetweenDates(data.startDate, data.endDate);

            var tableBody = `<tr><td style="font-weight:400; border-bottom:1px solid white; background: rgb(39, 102, 150);font-size:20px; color:white; text-align: center;" colspan="${((smToEm.length * 2) + 14)}">Viral Load Line List Report <br/> ${selectedOrgUnit.name} - ${months[Number((data.endDate.split("-")[1]) - 1)]} ${data.endDate.split("-")[0]}</td></tr>
            <tr>
                <td rowspan="2" style="border:1px solid black;background-color:#F8F8F8;text-align:center" >S.NO.</td>
                <td rowspan="2"  style="border:1px solid black;background-color:#F8F8F8;text-align:center" >Name of ART Site</td>
                <td rowspan="2"  style="border:1px solid black;background-color:#F8F8F8;text-align:center" >DOB</td>
                <td rowspan="2"  style="border:1px solid black;background-color:#F8F8F8;text-align:center" >Enrollment Date</td>
                <td rowspan="2"  style="border:1px solid black;background-color:#F8F8F8;text-align:center" >Client Code</td>
                <td rowspan="2"  style="border:1px solid black;background-color:#F8F8F8;text-align:center" >Current Age</td>
                <td rowspan="2"  style="border:1px solid black;background-color:#F8F8F8;text-align:center" >Sex</td>
                <td rowspan="2"  style="border:1px solid black;background-color:#F8F8F8;text-align:center" >Date of ART started(Medical History)</td>
            `;
            CSVFile[0] = ['S.NO.', 'Name of ART Site', 'DOB', 'Enrollment Date', 'Client Code', 'Current Age', 'Sex', 'Date of ART started(Medical History)']

            var deRepeat = ['VL test done(Y/N)', 'VL test Result']
            var headValues = ''
            for (let date of smToEm) {
                date = `${months[(date.slice(4, 6) - 1)]} ${date.slice(0, 4)}`;
                tableBody += `<td colspan='2' style="border:1px solid black;background-color:#F8F8F8;text-align:center">${date}</td>`;
                deRepeat.forEach(de => {
                    headValues += `<td style="border:1px solid black;background-color:#F8F8F8;text-align:center">${de}</td>`
                    CSVFile[0].push(`${de} (${date})`);
                });
            }

            CSVFile[0].push(`Total number of Viral load test done`);
            CSVFile[0].push(`Total latest viral load result`);

            tableBody += `<td colspan="2" style="border:1px solid black;background-color:#F8F8F8;text-align:center" >Total</td></tr><tr>${headValues}<td style="border:1px solid black;background-color:#F8F8F8;text-align:center">Number of Viral load test done</td><td style="border:1px solid black;background-color:#F8F8F8;text-align:center">Latest viral load result</td></tr>`;
            let count = 0;
            teis.forEach(tei => {
                count++;
                CSVFile[count] = [];
                let totalValFirst = '';
                let totalValueSecond = '';
                tableBody += `<tr>
                    <td>${(count)}</td>
                    <td>${(tei['orgUnitName'] ? tei['orgUnitName'] : "")}</td>
                    <td>${(tei['fOVzjBOZdvQ'] ? tei['fOVzjBOZdvQ'] : "")}</td>
                    <td>${(tei['enrollmentDate'] ? tei['enrollmentDate'] : "")}</td>
                    <td>${(tei['drKkLxaGFwv'] ? tei['drKkLxaGFwv'] : "")}</td>
                    <td>${(tei['zTwMKXGt0xF'] ? tei['zTwMKXGt0xF'] : "")}</td>
                    <td>${(tei['TN7r3ws7IG9'] ? tei['TN7r3ws7IG9'] : "")}</td>
                    <td>${(tei['ARTStarted'] ? tei['ARTStarted'] : "")}</td>`

                CSVFile[count].push((count));
                CSVFile[count].push((tei['orgUnitName'] ? tei['orgUnitName'] : ""));
                CSVFile[count].push((tei['fOVzjBOZdvQ'] ? tei['fOVzjBOZdvQ'] : ""));
                CSVFile[count].push((tei['enrollmentDate'] ? tei['enrollmentDate'] : ""));
                CSVFile[count].push((tei['drKkLxaGFwv'] ? tei['drKkLxaGFwv'] : ""));
                CSVFile[count].push((tei['zTwMKXGt0xF'] ? tei['zTwMKXGt0xF'] : ""));
                CSVFile[count].push((tei['TN7r3ws7IG9'] ? tei['TN7r3ws7IG9'] : ""));
                CSVFile[count].push((tei['ARTStarted'] ? tei['ARTStarted'] : ""));

                for (let date of smToEm) {
                    let valueFirst = tei['VLStage'] && tei['VLStage'][date] ? tei['VLStage'][date] : '';
                    let valueSecond = tei['VLTest'] && tei['VLTest'][date] ? tei['VLTest'][date] : '';
                    tableBody += `<td>${(valueFirst ? valueFirst : tei['programStage'] && tei['programStage'][date] ? "N" : "NA")}</td>`;
                    tableBody += `<td>${(valueSecond ? valueSecond : tei['programStage'] && tei['programStage'][date] ? "N" : "NA")}</td>`;

                    CSVFile[count].push((valueFirst ? valueFirst : tei['programStage'] && tei['programStage'][date] ? "N" : "NA"));
                    CSVFile[count].push((valueSecond ? valueSecond : tei['programStage'] && tei['programStage'][date] ? "N" : "NA"));

                    if (valueFirst) totalValFirst = 1 + Number(totalValFirst);
                    totalValueSecond = valueSecond ? valueSecond : totalValueSecond;
                }
                tableBody += `<td>${totalValFirst}</td><td>${totalValueSecond}</td></tr>`
                CSVFile[count].push(totalValFirst);
                CSVFile[count].push(totalValueSecond);

            })

            document.getElementById('tableBody').innerHTML = tableBody;
            document.getElementById('report_table').style.visibility = "visible";
            document.getElementById('loader').style.display = "none";
        }

    }


    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = filename;
            document.getElementById("dlink").click();
        }
    })()

    function downloadCSV() {

        var reportName = 'Viral_Load_Report-' + selectedOrgUnit.name;
        var hiddenElement = document.createElement('a');
        hiddenElement.href = 'data:text/csv;charset=utf-8,';

        let arr = "";
        CSVFile.forEach((row, index) => {
            if (index != 0) arr += "\n"
            arr += row.join(",");
        });
        debugger;
        hiddenElement.href += arr;
        hiddenElement.target = '_blank';
        hiddenElement.download = reportName + '.csv';
        hiddenElement.click();
    }

</script>