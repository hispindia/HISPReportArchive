<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
    integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">


<style>
    .reporttable {
        text-align: center;
    }

    /* Absolute Center Spinner */

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }
</style>

<div class="loading" id="loader"></div>

<a id="dlink" style="display:none;"></a>
<div id="main">
    <div style="width: 40%; margin-left:30%;">
        <table class="table table-striped table-bordered">

            <tr style="border: 1px solid #DDDDDD;">
                <td style="font-size: 15px;padding-top: 15px;">
                    Start Date :
                </td>
                <td style="width: 60%;">
                    <input type="date" class="form-control" id="start-date">
                </td>
            </tr>
            <tr style="border: 1px solid #DDDDDD;">
                <td style="font-size: 15px;padding-top: 15px;">
                    End Date :
                </td>
                <td style="width: 60%;">
                    <input type="date" class="form-control" id="end-date">
                </td>
            </tr>
            <tr>
                <td><button onClick="submit()" class="btn btn-primary" id="tap">Submit</button></td>
                <td style="text-align: right;">
                    <img src="https://img.icons8.com/color/35/000000/ms-excel.png"
                        onmouseover="this.style.cursor='pointer'"
                        onclick="tableToExcel('report_table', 'Discontinuation of follow-up', 'Discontinuation of follow-up')"
                        alt="xls" style="cursor: pointer;">
                    <span id="csv-download">
                        <img src="https://img.icons8.com/dusk/35/000000/export-csv.png" alt="print"
                            onmouseover="this.style.cursor='pointer'" onclick="downloadCSV()">
                    </span>
                </td>
            </tr>
        </table>
    </div>
    <br>
    <table class="table table-bordered table-striped table-hover reporttable" width="100%" id="report_table"
        style="visibility:hidden">
        <tbody id="tableBody">
        </tbody>
    </table>
</div>

<script>

    var selectedOrgUnit = dhis2.report.organisationUnit;
    var hasChildren = dhis2.report.organisationUnitChildren.length;
    var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    var CSVFile = [];

    var organisationUnits = {};
    document.getElementById('loader').style.display = "block";
    $.ajax({
        async: false,
        type: "GET",
        url: `../../organisationUnits.json?paging=false`,
        success: function (data) {
            data.organisationUnits.forEach(ou => organisationUnits[ou.id] = ou.displayName)
        }
    });

    document.getElementById('loader').style.display = "none";

    function submit() {
        CSVFile = [];
        CSVFile[0] = [];

        document.getElementById("report_table").style.visibility = "hidden";
        document.getElementById("tableBody").innerHTML = "";

        var data = {
            startDate: document.getElementById("start-date").value,
            endDate: document.getElementById("end-date").value
        }
        if (new Date(data.startDate) > new Date(data.endDate) || !data.startDate || !data.endDate) {
            alert("Please Select dates Correctly!");
            return;
        } else {
            $('#loader').show();
            setTimeout(function () {
                getData(data);
            }, 1000);
        }

        async function getData(data) {
            //program stage = Discontinuation of follow-up
            var teiList = getTEIList('L78QzNqadTV', selectedOrgUnit.id, 'AcmSTzlFRAG', data.startDate, data.endDate);
            var teis = [];

            for (let tei of teiList) {
                let teiRes = await (await fetch(`../../trackedEntityInstances/${tei}.json?paging=false&program=L78QzNqadTV&fields=trackedEntityInstance,orgUnit,attributes[attribute,value],enrollments[enrollmentDate,program,orgUnitName,events[programStage,eventDate,dataValues]]`)).json();
                if (!teis[teiRes.trackedEntityInstance]) teis[teiRes.trackedEntityInstance] = {};

                teiRes.attributes.forEach(attr => teis[teiRes.trackedEntityInstance][attr.attribute] = attr.value)

                teiRes.enrollments.forEach(enroll => {
                    if (enroll.orgUnitName) teis[teiRes.trackedEntityInstance]['orgUnitName'] = enroll.orgUnitName;
                    enroll.events.forEach(ev => {
                        if (ev.programStage == "AcmSTzlFRAG") {
                            teis[teiRes.trackedEntityInstance]['eventDate'] = ev.eventDate.split('T')[0];
                            teis[teiRes.trackedEntityInstance]['enrollmentDate'] = enroll.enrollmentDate.split('T')[0];
                            ev.dataValues.forEach(dv => {
                                teis[teiRes.trackedEntityInstance][dv.dataElement] = dv.value
                            });
                        }
                        if (ev.programStage == 'zRUw1avYEvI') {
                            ev.dataValues.forEach(dv => {
                                if (dv.dataElement == "gPHLt0PQq1b") teis[teiRes.trackedEntityInstance]['ARTStarted'] = dv.value
                                if (dv.dataElement == "rQnmYAF1899") teis[teiRes.trackedEntityInstance]['ARTStartedAnother'] = dv.value

                            })
                        }
                    })
                })
            }

            var headRows = [
                'SN',
                'Name of ART Site',
                'Province', 'District',
                'Client Code',
                'Date of Birth (DOB)',
                'Enrollment Date',
                'Date of ART started at this site (Medical History)',
                'Date of ART started at another site (Medical History)',
                'Sex',
                'Age at visit',
                'Risk group',
                'SMS consent',
                'Event Date',
                'Date of Death',
                'Causes of HIV related death?',
                'Advanced HIV disease', 'Illness',
                'Late ART initiation',
                'Low CD4 Count (<200)',
                'Sickness',
                'Abdominal Tuberculosis',
                'Anaemia', 'Chest infection',
                'Chronic meningitis',
                'Cryptococcal meningitis',
                'Cryptosporidiosis or Chronic Diarrhea',
                'Gland Tuberculosis',
                'Immunological failure',
                'Liver cirrhosis',
                'Meningitis',
                'Pharyngeal ulcer',
                'Pneumonia',
                'Pulmonary Tuberculosis',
                'Septicemia',
                'Severe malnutrition',
                'Spleenomegaly',
                'Toxoplasmosis',
                'Tuberculosis',
                'Unspecified opportunistic infection',
                'Virologiral failure',
                'Others (if not included above)',
                'Total count of HIV related causes',
                'Causes of Non HIV related death?',
                'Abdominal perforation', 'Accident',
                'Acute abdominal pain',
                'Acute liver disease',
                'Alcoholism',
                'Ascites',
                'Asthma',
                'Blood cancer',
                'Brain Hemorrhage',
                'Brain tumor',
                'Breast cancer',
                'Cardiac failute',
                'Cardiopulmonary arrest',
                'Central Nervous System Disorder',
                'Cervical Cancer',
                'Chronic heart disease',
                'Chronic Obstructive Pulmonary Disease',
                'Cirrhosis', 'Depression',
                'Diabetes mellitus',
                'Drug overdose',
                'Gastro-intestinal bleeding',
                'Grievous inuries',
                'Head injury',
                'Heart disease',
                'Hemorrhage',
                'Hepatic coma',
                'Hepatitis B',
                'Hepatitis C',
                'Hepatitis',
                'Hydrocephalus',
                'Hypertension',
                'Jaundice',
                'Kalazar',
                'Leukaemia',
                'Liver cancer',
                'Lung cancer',
                'Lymphoma',
                'Multiple organ failure',
                'Murder',
                'Nephropathy',
                'Neuropathy',
                'Other Liver disease',
                'Other mental illness',
                'Paralysis',
                'Penis cancer',
                'Pneumothorax',
                'Pulmonary Edema',
                'Pulmonary Embolism',
                'Renal failure',
                'Respiratory Failure',
                'Road traffic accident',
                'Snakebite',
                'Stroke',
                'Suicide',
                'Typhoid',
                'Uterus cancer',
                'Other Causes of Non-HIV related Death',
                'Total count of Non-HIV related causes'
            ]
            var tableBody = `<tr><td style="font-weight:400; border-bottom:1px solid white; background: rgb(39, 102, 150);font-size:20px; color:white; text-align: center;" colspan="${headRows.length}"> Discontinuation of Follow Up-Line List Report <br/> ${selectedOrgUnit.name} <br/> ${data.startDate.split("-")[0]}-${months[Number((data.startDate.split("-")[1]) - 1)]}-${data.startDate.split("-")[2]} to ${data.endDate.split("-")[0]}-${months[Number((data.endDate.split("-")[1]) - 1)]}-${data.endDate.split("-")[2]}</td></tr>`

            tableBody += '<tr>';
            headRows.forEach(row => {
                CSVFile[0].push(row);
                if (row.includes('Total')) tableBody += `<td style="border:1px solid black;background-color:#F8F8F8;text-align:center" ><span style="color:#808000;">${row}</span></td>`
                else tableBody += `<td style="border:1px solid black;background-color:#F8F8F8;text-align:center" >${row}</td>`
            })
            tableBody += '</tr>';

            var count = 0;
            var totalRowCount = [];
            var hivDE = [
                'ohTf5QDSUMy', 'IHCw8vDR6rR', 'hriEnVR5Glp', 'ZPhC01ZhavV', 'vKPGRsOW0U1', 'e9GAEHFnUj1', 'uFUtKYVKLlC',
                'VD0NIjm7dUH', 'rxDY7fbIPK9', 'nkJ90I4Q4aP', 'ebFRVIHCce0', 'VLxvUiRw9dd', 'qWa1egERNQB', 'rfYQJZDIQMQ',
                'yEgaugryyDg', 'yIaxHW2BEEI', 'PtQBTz6N6yj', 'o3PXFMGUbTB', 'pfWa16u82ab', 'SUvWFeoyvHE', 'j4tRuSvsJZW',
                'B3RVzc7kOcX', 'WccdJkMmw87', 'ESN8rDJLgWQ', 'HyZWq8v0Bzi', 'QZEkwbLlU9e'
            ];
            var nonHIVDE = [
                'L0igNS0lmCH', 'XXKJC47c9Sx', 'wcFof19PS4f', 'NT2iptXIlHD', 'tc2Qb9vOwzA',
                'dzKBOSMQUyY', 'W2iNBJ8gOfX', 'ducQbukUh5B', 'x4BPRLFBoaP', 'wCSKmkmcCLG', 'E0Ec84G8Btl',
                'oyxei4tjxA5', 'wMRGPY1LOoR', 'e4pjDhZH1OI', 'bilMhjZWN9G', 'BMDqLASSBo8', 'KqlXUiJzDIA',
                'GAshMSTQoJa', 'DrB73DI2qTW', 'dF5MJLhtnHA', 'H9IeKXarQJ8', 'XpJOtM4LXO3', 'Oq9RUYV5DSa',
                'UY3o0Jxa45u', 'RKbdefRFBXM', 'KTWi5x8InAn', 'NaglYYFCjl2', 'Rl3aJjQmNwT', 'KQC80d0MZJu',
                'PpsyLn8BNGx', 'z4BmncJxWcB', 'rQWc4nfVDR9', 'rJfaqzuH1pw', 'qI9Xna0OmXj', 'CUiJE2GwouD',
                'vWvWUN3hP79', 'tRsHE6miS7w', 'bobPoPfO8m6', 'UM7DncwpmBr', 'Uh9Cr9P3WGc', 'UsLCd82k5S3',
                'HvSGATaPoHw', 'E3y8w1MBw2v', 'atc3d3qvYyr', 'r3JhWU8EpPV', 'QyPkY7ytypy', 'U2fUgi0pgyC',
                'zzRXb4YSQmg', 'hCND2M9MGuc', 'j703QluZI36', 'NxaAYH2Dh4g', 'WJQAsLxSiRz', 'AUX0x1wAnsV',
                'dyc37t24fuF', 'PT5tQkB8ipg', 'RfLBYrnjWo2', 'h3MsdbfsjAG', 'i4xptjEataW'
            ];
            for (tei in teis) {
                let indexRow = 0;
                let totalCountHIV = 0;
                let totalCountNonHIV = 0;
                count++;
                CSVFile[count] = [];

                tableBody += `<tr>
                    <td>${count}</td>
                    <td>${(teis[tei]['orgUnitName'] ? teis[tei]['orgUnitName'] : "")}</td>
                    <td>${(teis[tei]['jSozkw01sOD'] ? organisationUnits[teis[tei]['jSozkw01sOD']] : "")}</td>
                    <td>${(teis[tei]['AQ1upNTGVEj'] ? organisationUnits[teis[tei]['AQ1upNTGVEj']] : "")}</td>
                    <td>${(teis[tei]['drKkLxaGFwv'] ? teis[tei]['drKkLxaGFwv'] : "")}</td>
                    <td>${(teis[tei]['fOVzjBOZdvQ'] ? teis[tei]['fOVzjBOZdvQ'] : "")}</td>
                    <td>${(teis[tei]['enrollmentDate'] ? teis[tei]['enrollmentDate'] : "")}</td>
                    <td>${(teis[tei]['ARTStarted'] ? teis[tei]['ARTStarted'] : "")}</td>
                    <td>${(teis[tei]['ARTStarteddiffSite'] ? teis[tei]['ARTStarteddiffSite'] : "")}</td>
                    <td>${(teis[tei]['TN7r3ws7IG9'] ? teis[tei]['TN7r3ws7IG9'] : "")}</td>
                    <td>${(teis[tei]['zTwMKXGt0xF'] ? teis[tei]['zTwMKXGt0xF'] : "")}</td>
                    <td>${(teis[tei]['Usl9OzVV46v'] ? teis[tei]['Usl9OzVV46v'] : "")}</td>
                    <td>${(teis[tei]['UW6sOb7cEVT'] == 'true' ? 'Y' : (teis[tei]['UW6sOb7cEVT'] == 'false' ? 'N' : ""))}</td>
                    <td>${(teis[tei]['eventDate'] ? teis[tei]['eventDate'] : "")}</td>
                    <td>${(teis[tei]['p4wbf5rQwqx'] ? teis[tei]['p4wbf5rQwqx'] : "")}</td>
                    <td>${(teis[tei]['YorsuM4y9z1'] == 'true' ? 'Y' : (teis[tei]['YorsuM4y9z1'] == 'false' ? 'N' : ""))}</td>`


                CSVFile[count].push(count);
                CSVFile[count].push((teis[tei]['orgUnitName'] ? teis[tei]['orgUnitName'] : ""));
                CSVFile[count].push((teis[tei]['jSozkw01sOD'] ? organisationUnits[teis[tei]['jSozkw01sOD']] : ""));
                CSVFile[count].push((teis[tei]['AQ1upNTGVEj'] ? organisationUnits[teis[tei]['AQ1upNTGVEj']] : ""));
                CSVFile[count].push((teis[tei]['drKkLxaGFwv'] ? teis[tei]['drKkLxaGFwv'] : ""));
                CSVFile[count].push((teis[tei]['fOVzjBOZdvQ'] ? teis[tei]['fOVzjBOZdvQ'] : ""));
                CSVFile[count].push((teis[tei]['enrollmentDate'] ? teis[tei]['enrollmentDate'] : ""));
                CSVFile[count].push((teis[tei]['ARTStarted'] ? teis[tei]['ARTStarted'] : ""));
                CSVFile[count].push((teis[tei]['ARTStarteddiffSite'] ? teis[tei]['ARTStarteddiffSite'] : ""));
                CSVFile[count].push((teis[tei]['TN7r3ws7IG9'] ? teis[tei]['TN7r3ws7IG9'] : ""));
                CSVFile[count].push((teis[tei]['zTwMKXGt0xF'] ? teis[tei]['zTwMKXGt0xF'] : ""));
                CSVFile[count].push((teis[tei]['Usl9OzVV46v'] ? teis[tei]['Usl9OzVV46v'] : ""));
                CSVFile[count].push((teis[tei]['UW6sOb7cEVT'] == 'true' ? 'Y' : (teis[tei]['UW6sOb7cEVT'] == 'false' ? 'N' : "")));
                CSVFile[count].push((teis[tei]['eventDate'] ? teis[tei]['eventDate'] : ""));
                CSVFile[count].push((teis[tei]['p4wbf5rQwqx'] ? teis[tei]['p4wbf5rQwqx'] : ""));
                CSVFile[count].push((teis[tei]['YorsuM4y9z1'] == 'true' ? 'Y' : (teis[tei]['YorsuM4y9z1'] == 'false' ? 'N' : "")));

                if (!totalRowCount[(indexRow + 1)]) totalRowCount[(indexRow + 1)] = 0
                totalRowCount[(++indexRow)] += (teis[tei]['YorsuM4y9z1'] == 'true' ? 1 : 0);
                debugger;
                hivDE.forEach(de => {
                    if (de == "QZEkwbLlU9e") {
                        tableBody += `<td>${(teis[tei][de] ? teis[tei][de] : "")}</td>`;
                        CSVFile[count].push((teis[tei][de] ? teis[tei][de] : ""));
                    }
                    else {
                        tableBody += `<td>${(teis[tei][de] ? 1 : "")}</td>`;
                        CSVFile[count].push((teis[tei][de] ? 1 : ""));
                    }

                    totalCountHIV += teis[tei][de] ? 1 : 0;

                    if (!totalRowCount[(indexRow + 1)]) totalRowCount[(indexRow + 1)] = 0
                    totalRowCount[++indexRow] += (teis[tei][de] ? 1 : 0);
                })

                if (!totalRowCount[(indexRow + 1)]) totalRowCount[(indexRow + 1)] = 0
                totalRowCount[++indexRow] += totalCountHIV
                tableBody += `<td style="color:#808000;">${(totalCountHIV ? totalCountHIV : "")}</td>
                    <td>${(teis[tei]['lf2HGt9PPLq'] == 'true' ? 'Y' : (teis[tei]['lf2HGt9PPLq'] == 'false' ? 'N' : ""))}</td>`

                CSVFile[count].push((totalCountHIV ? totalCountHIV : ""));
                CSVFile[count].push((teis[tei]['lf2HGt9PPLq'] == 'true' ? 'Y' : (teis[tei]['lf2HGt9PPLq'] == 'false' ? 'N' : "")));

                if (!totalRowCount[(indexRow + 1)]) totalRowCount[(indexRow + 1)] = 0
                totalRowCount[++indexRow] += (teis[tei]['lf2HGt9PPLq'] == 'true' ? 1 : 0);

                nonHIVDE.forEach(de => {
                    if (de == "i4xptjEataW") {
                        tableBody += `<td>${(teis[tei][de] ? teis[tei][de] : "")}</td>`;
                        CSVFile[count].push((teis[tei][de] ? teis[tei][de] : ""));
                    }
                    else {
                        tableBody += `<td>${(teis[tei][de] ? 1 : "")}</td>`;
                        CSVFile[count].push((teis[tei][de] ? 1 : ""));
                    }
                    totalCountNonHIV += teis[tei][de] ? 1 : 0;

                    if (!totalRowCount[(indexRow + 1)]) totalRowCount[(indexRow + 1)] = 0
                    totalRowCount[++indexRow] += (teis[tei][de] ? 1 : 0);
                })

                if (!totalRowCount[(indexRow + 1)]) totalRowCount[(indexRow + 1)] = 0
                totalRowCount[++indexRow] += totalCountNonHIV

                tableBody += `<td style="color:#808000;">${(totalCountNonHIV ? totalCountNonHIV : "")}</td></tr>`
                CSVFile[count].push((totalCountNonHIV ? totalCountNonHIV : ""));

            }

            tableBody += '<tr><td colspan="15" style="background-color:#F8F8F8;">Totals</td>'
            totalRowCount.forEach(row => tableBody += `<td style="background-color:#F8F8F8;">${(row ? row : "")}</td>`)
            tableBody += '</tr>'

            document.getElementById('tableBody').innerHTML = tableBody;
            document.getElementById('report_table').style.visibility = "visible";
            document.getElementById('loader').style.display = "none";
        }


        var getTEIList = function (program, orgUnit, programStage, startDate, endDate) {
            var response = []
            $.ajax({
                async: false,
                type: "GET",
                url: `../../sqlViews/vz7sfB4SMJy/data?paging=false&var=program:${program}&var=orgUnit:${orgUnit}&var=programStage:${programStage}&var=startDate:${startDate}&var=endDate:${endDate}`,
                success: function (data) {
                    data = data.listGrid;
                    if (data.rows && data.rows.length) {
                        data.rows.forEach(tei => response.push(tei[0]))
                    }
                }
            });
            //console.log(response);
            return response;
        };


    }



    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = filename + '-' + selectedOrgUnit.name + '.xls';
            document.getElementById("dlink").click();
        }
    })()
    function downloadCSV() {

        var reportName = 'Discontinuation_of_followUp-' + selectedOrgUnit.name;
        var hiddenElement = document.createElement('a');
        hiddenElement.href = 'data:text/csv;charset=utf-8,';

        let arr = "";
        CSVFile.forEach((row, index) => {
            if (index != 0) arr += "\n"
            arr += row.join(",");
        });
        debugger;
        hiddenElement.href += arr;
        hiddenElement.target = '_blank';
        hiddenElement.download = reportName + '.csv';
        hiddenElement.click();
    }

</script>