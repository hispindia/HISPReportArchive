<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
    integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">


<style>
    .reporttable {
        text-align: center;
    }

    /* Absolute Center Spinner */

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }
</style>

<div class="loading" id="loader"></div>

<a id="dlink" style="display:none;"></a>
<div id="main">
    <div style="width: 40%; margin-left:30%;">
        <table class="table table-striped table-bordered">

            <tr style="border: 1px solid #DDDDDD;">
                <td style="font-size: 15px;padding-top: 15px;">
                    Start Month :
                </td>
                <td style="width: 60%;">
                    <input type="month" class=" form-control" id="start-date">
                </td>
            </tr>
            <tr style="border: 1px solid #DDDDDD;">
                <td style="font-size: 15px;padding-top: 15px;">
                    End Month :
                </td>
                <td style="width: 60%;">
                    <input type="month" class=" form-control" id="end-date">
                </td>
            </tr>
            <tr>
                <td><button onClick="submit()" class="btn btn-primary" id="tap">Submit</button></td>
                <td style="text-align: right;">
                    <img src="https://img.icons8.com/color/35/000000/ms-excel.png"
                        onmouseover="this.style.cursor='pointer'"
                        onclick="tableToExcel('report_table', 'PMTCT line list report', 'PMTCT line list report.xls')"
                        alt="xls" style="cursor: pointer;">
                    <span id="csv-download">
                        <img src="https://img.icons8.com/dusk/35/000000/export-csv.png" alt="print"
                            onmouseover="this.style.cursor='pointer'" onclick="downloadCSV()">
                    </span>
                </td>
            </tr>
        </table>
    </div>
    <br>
    <table class="table table-bordered table-striped table-hover reporttable" width="100%" id="report_table"
        style="visibility:hidden">
        <tbody id="tableBody">
        </tbody>
    </table>
</div>

<script>

    var selectedOrgUnit = dhis2.report.organisationUnit;
    var hasChildren = dhis2.report.organisationUnitChildren.length;
    var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    var CSVFile = [];

    function submit() {
        CSVFile = [];
        CSVFile[0] = [];

        document.getElementById("report_table").style.visibility = "hidden";
        document.getElementById("tableBody").innerHTML = "";

        var startMonth = document.getElementById("start-date").value;
        var month = document.getElementById("end-date").value;
        var endMonth = (month) => {
            month = new Date(month);
            return `${month.getFullYear()}-${('00' + (month.getMonth() + 1)).slice(-2)}-` + new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate();
        }

        var data = {
            startDate: startMonth + '-01',
            endDate: endMonth(month)
        }

        if (new Date(data.startDate) > new Date(data.endDate) || !startMonth || !month) {
            alert("Please Select dates Correctly!");
            return;
        } else {
            $('#loader').show();
            setTimeout(function () {
                getData(data);
            }, 1000);
        }

        async function getData(data) {
            var teiList = getTEIList('L78QzNqadTV', selectedOrgUnit.id, data.startDate, data.endDate);
            var teis = [];

            for (let tei of teiList) {
                let attrs = {}
                let teiRes = await (await fetch(`../../trackedEntityInstances/${tei}.json?paging=false&program=L78QzNqadTV&fields=trackedEntityInstance,orgUnit,attributes[attribute,value],enrollments[enrollmentDate,program,orgUnitName,events[programStage,eventDate,dataValues]]`)).json();
                if (!teis[teiRes.trackedEntityInstance]) teis[teiRes.trackedEntityInstance] = {};
                if (!teis[teiRes.trackedEntityInstance]['attrs']) teis[teiRes.trackedEntityInstance]['attrs'] = {};

                teiRes.attributes.forEach(attr => teis[teiRes.trackedEntityInstance]['attrs'][attr.attribute] = attr.value)

                teiRes.enrollments.forEach(enroll => {
                    teis[teiRes.trackedEntityInstance]['enrollmentDate'] = enroll.enrollmentDate.split('T')[0];
                    let childBirth = {};
                    enroll.events.forEach(event => {
                        if (event.programStage == "s7NCcAyCwp8" || event.programStage == "DgAKrnlkpHc" || event.programStage == "zRUw1avYEvI") {

                            if ((new Date(data.startDate).getFullYear() - 2 <= new Date(event.eventDate).getFullYear()) && new Date(data.endDate) >= new Date(event.eventDate)) {

                                console.log(teiRes.trackedEntityInstance)
                                if (event.programStage == "s7NCcAyCwp8") {
                                    if (!teis[teiRes.trackedEntityInstance]['pregnancy']) teis[teiRes.trackedEntityInstance]['pregnancy'] = {}
                                    if (!teis[teiRes.trackedEntityInstance]['pregnancy'][(event.eventDate).split('T')[0]]) teis[teiRes.trackedEntityInstance]['pregnancy'][(event.eventDate).split('T')[0]] = {}

                                    event.dataValues.forEach(dv => {
                                        if (dv.dataElement == 'lzK71mzgilv') childBirth[dv.value] = true;
                                        teis[teiRes.trackedEntityInstance]['pregnancy'][(event.eventDate).split('T')[0]][dv.dataElement] = dv.value;
                                    });
                                    teis[teiRes.trackedEntityInstance]['pregnancy']['orgUnitName'] = enroll.orgUnitName;
                                }
                                if (event.programStage == "DgAKrnlkpHc") {
                                    let eventVal = {};
                                    event.dataValues.forEach(dv => {
                                        if (dv.dataElement == 'eDjmTvcfCyZ' || dv.dataElement == 'HaToAlprYUQ' || dv.dataElement == 'lBhSIl8sRCm') {
                                            eventVal['childBirthday'] = dv.value;
                                        }
                                        eventVal[dv.dataElement] = dv.value;
                                    });
                                    if (eventVal['childBirthday'] && childBirth[eventVal['childBirthday']]) {
                                        if (!teis[teiRes.trackedEntityInstance]['events']) {
                                            teis[teiRes.trackedEntityInstance]['events'] = {}
                                            teis[teiRes.trackedEntityInstance]['events'][(event.eventDate).split('T')[0]] = {}
                                        }
                                        teis[teiRes.trackedEntityInstance]['events'][(event.eventDate).split('T')[0]] = eventVal;
                                    }
                                }
                            }

                            if (event.programStage == "zRUw1avYEvI") {
                                event.dataValues.forEach(dv => {
                                    if (dv.dataElement == "rQnmYAF1899" || dv.dataElement == "gPHLt0PQq1b") {
                                        teis[teiRes.trackedEntityInstance]['ARTStarted'] = dv.value
                                    }
                                });
                            }
                        }
                    })
                })
            }

            var cases = {
                new: [],
                old: []
            };
            var isCase = '';
            debugger;
            for (let tei in teis) {
                let index = 0;
                if (teis[tei].pregnancy) {
                    for (let pregnancy in teis[tei].pregnancy) {
                        if (teis[tei]['pregnancy'][pregnancy]['lzK71mzgilv'] && teis[tei].events) {
                            debugger;
                            if ((new Date(data.startDate) <= new Date(pregnancy)) && new Date(data.endDate) >= new Date(pregnancy)) {
                                isCase = 'new';
                            } else {
                                isCase = 'old'
                            }

                            for (let event in teis[tei].events) {
                                if (teis[tei]['events'][event]['childBirthday'] == teis[tei]['pregnancy'][pregnancy]['lzK71mzgilv']) {
                                    let newEID = {};
                                    Object.assign(newEID, teis[tei]['pregnancy'][pregnancy]);
                                    Object.assign(newEID, teis[tei]['events'][event]);
                                    Object.assign(newEID, teis[tei]['attrs']);
                                    newEID['ARTStarted'] = teis[tei]['ARTStarted'] ? teis[tei]['ARTStarted'] : '';
                                    newEID['orgUnitName'] = teis[tei]['pregnancy']['orgUnitName'];
                                    newEID['enrollmentDate'] = teis[tei]['enrollmentDate'];
                                    newEID['eventDatePregnancy'] = pregnancy;
                                    newEID['eventDateEID'] = event;
                                    cases[isCase].push(newEID)
                                }
                            }
                        } else if (teis[tei]['pregnancy'][pregnancy]['RqpFC5xpj1e'] == 'false' || teis[tei]['pregnancy'][pregnancy]['PLxyEiGyl8s']=="true") {
                            
                            if ((new Date(data.startDate) <= new Date(pregnancy)) && new Date(data.endDate) >= new Date(pregnancy)) {
                                isCase = 'new';
                            } else {
                                isCase = 'old'
                            }
                            let newEID = {};
                            Object.assign(newEID, teis[tei]['pregnancy'][pregnancy]);
                            Object.assign(newEID, teis[tei]['attrs']);
                            newEID['ARTStarted'] = teis[tei]['ARTStarted'] ? teis[tei]['ARTStarted'] : '';
                            newEID['orgUnitName'] = teis[tei]['pregnancy']['orgUnitName'];
                            newEID['enrollmentDate'] = teis[tei]['enrollmentDate'];
                            newEID['eventDatePregnancy'] = pregnancy;
                            cases[isCase].push(newEID);
                            debugger;
                        }
                    }
                }
            }
            console.log(cases)
            var headRows = [
                'S.NO.',
                'Name of ART Site',
                'Client Code',
                'DOB',
                'Enrollment Date',
                'Current Age',
                'Date of ART started(Medical History)',
                ['Event Date Pregnancy and Delivery (New)', 'Event Date Pregnancy and Delivery (Old)'],
                'Pregnancy Status',
                'Date of pregnancy start',
                'Expected date of delivery',
                'Delivery(Y/N)',
                'Date of delivery (infant)',
                'Status of infant(Alive/Still Birth)',
                'Live births (Single/Twins/Triplets)',
                'Event date-EID and Treatment details',
                'Date of birth (Infant 1)',
                'EID Sample Collection done (Infant 1)',
                'EID Sample Collection date (Infant 1)',
                'DNA PCR test result (Infant 1)',
                'Date of DNA PCR test done(Infant 1)',
                'Test result (Infant 1)',
                'Enolled on ART (Infant 1)',
                'Date of birth (Infant 2)',
                'EID Sample Collection done (Infant 2)',
                'EID Sample Collection date (Infant 2)',
                'DNA PCR test result (Infant 2)',
                'Date of DNA PCR test done(Infant 2)',
                'Test result (Infant 2)',
                'Enolled on ART (Infant 2)',
                'Date of birth (Infant 3)',
                'EID Sample Collection done (Infant 3)',
                'EID Sample Collection date (Infant 3)',
                'DNA PCR test result (Infant 3)',
                'Date of DNA PCR test done(Infant 3)',
                'Test result (Infant 3)',
                'Enolled on ART (Infant 3)',
            ]
            var tableBody = `<tr><td style="font-weight:400; border-bottom:1px solid white; background: rgb(39, 102, 150);font-size:20px; color:white; text-align: center;" colspan="${headRows.length}">PMTCT Line List Report <br/> ${selectedOrgUnit.name} <br/>  ${months[Number((data.startDate.split("-")[1]) - 1)]} ${data.startDate.split("-")[0]} to ${months[Number((data.endDate.split("-")[1]) - 1)]} ${data.endDate.split("-")[0]}</td></tr>`

            if (cases['new'].length) {
                tableBody += '<tr>';
                headRows.forEach(row => {
                    CSVFile[0].push((Array.isArray(row) ? row[0] : row));
                    tableBody += `<td style="border:1px solid black;background-color:#F8F8F8;text-align:center" >${(Array.isArray(row) ? row[0] : row)}</td>`
                })
                tableBody += '</tr>';
            }

            var count = 0;
            cases['new'].forEach(tei => {
                count++;
                CSVFile[count] = [];
                tableBody += `<tr>
                    <td>${(count)}</td>
                    <td>${(tei['orgUnitName'] ? tei['orgUnitName'] : "")}</td>
                    <td>${(tei['drKkLxaGFwv'] ? tei['drKkLxaGFwv'] : "")}</td>
                    <td>${(tei['fOVzjBOZdvQ'] ? tei['fOVzjBOZdvQ'] : "")}</td>
                    <td>${(tei['enrollmentDate'] ? tei['enrollmentDate'] : "")}</td>
                    <td>${(tei['zTwMKXGt0xF'] ? tei['zTwMKXGt0xF'] : "")}</td>
                    <td>${(tei['ARTStarted'] ? tei['ARTStarted'] : "")}</td>
                    <td>${(tei['eventDatePregnancy'] ? tei['eventDatePregnancy'] : "")}</td>
                    <td>${(tei['PLxyEiGyl8s'] == 'true' ? 'Y' : (tei['PLxyEiGyl8s'] == 'false' ? 'N' : ""))}</td>
                    <td>${(tei['SfSQ386xfyu'] ? tei['SfSQ386xfyu'] : "")}</td>
                    <td>${(tei['gBouKokBTre'] ? tei['gBouKokBTre'] : "")}</td>
                    <td>${(tei['RqpFC5xpj1e'] == 'true' ? 'Y' : (tei['RqpFC5xpj1e'] == 'false' ? 'N' : ""))}</td>
                    <td>${(tei['lzK71mzgilv'] ? tei['lzK71mzgilv'] : "")}</td>
                    <td>${(tei['hZw6mBxzobR'] ? tei['hZw6mBxzobR'] : "")}</td>
                    <td>${(tei['dpG2LEdSPi3'] ? tei['dpG2LEdSPi3'] : "")}</td>
                    <td>${(tei['eventDateEID'] ? tei['eventDateEID'] : "")}</td>

                    <td>${(tei['eDjmTvcfCyZ'] ? tei['eDjmTvcfCyZ'] : "")}</td>
                    <td>${(tei['rPjBJ1GCKdQ'] ? tei['rPjBJ1GCKdQ'] : "")}</td>
                    <td>${(tei['h7UjZ5YiX0D'] ? tei['h7UjZ5YiX0D'] : "")}</td>
                    <td>${(tei['h7k7HK13PQg'] ? tei['h7k7HK13PQg'] : "")}</td>
                    <td>${(tei['zq0pAQE9K8G'] ? tei['zq0pAQE9K8G'] : "")}</td>
                    <td>${(tei['IthP5lvdS3o'] ? tei['IthP5lvdS3o'] : "")}</td>
                    <td>${(tei['gg2Jjsf9Seb'] ? tei['gg2Jjsf9Seb'] : "")}</td>

                    <td>${(tei['HaToAlprYUQ'] ? tei['HaToAlprYUQ'] : "")}</td>
                    <td>${(tei['FbrFExTg92R'] ? tei['FbrFExTg92R'] : "")}</td>
                    <td>${(tei['GEqbUeytrHY'] ? tei['GEqbUeytrHY'] : "")}</td>
                    <td>${(tei['DOjaIyENQmx'] ? tei['DOjaIyENQmx'] : "")}</td>
                    <td>${(tei['tf2JirA33L9'] ? tei['tf2JirA33L9'] : "")}</td>
                    <td>${(tei['dSXO4xgyxvF'] ? tei['dSXO4xgyxvF'] : "")}</td>
                    <td>${(tei['XDeAt9U9aog'] ? tei['XDeAt9U9aog'] : "")}</td>

                    <td>${(tei['lBhSIl8sRCm'] ? tei['lBhSIl8sRCm'] : "")}</td>
                    <td>${(tei['YQ1gCc1a2hm'] ? tei['YQ1gCc1a2hm'] : "")}</td>
                    <td>${(tei['ZzlWdUjXGiL'] ? tei['ZzlWdUjXGiL'] : "")}</td>
                    <td>${(tei['yICLjp5Rb41'] ? tei['yICLjp5Rb41'] : "")}</td>
                    <td>${(tei['IN47b900K5R'] ? tei['IN47b900K5R'] : "")}</td>
                    <td>${(tei['WHMESOTo677'] ? tei['WHMESOTo677'] : "")}</td>
                    <td>${(tei['vpZRp7yBUHB'] ? tei['vpZRp7yBUHB'] : "")}</td>
                    
                </tr>`

                CSVFile[count].push((count));
                CSVFile[count].push((tei['orgUnitName'] ? tei['orgUnitName'] : ""));
                CSVFile[count].push((tei['drKkLxaGFwv'] ? tei['drKkLxaGFwv'] : ""));
                CSVFile[count].push((tei['fOVzjBOZdvQ'] ? tei['fOVzjBOZdvQ'] : ""));
                CSVFile[count].push((tei['enrollmentDate'] ? tei['enrollmentDate'] : ""));
                CSVFile[count].push((tei['zTwMKXGt0xF'] ? tei['zTwMKXGt0xF'] : ""));
                CSVFile[count].push((tei['ARTStarted'] ? tei['ARTStarted'] : ""));
                CSVFile[count].push((tei['eventDatePregnancy'] ? tei['eventDatePregnancy'] : ""));
                CSVFile[count].push((tei['PLxyEiGyl8s'] == 'true' ? 'Y' : (tei['PLxyEiGyl8s'] == 'false' ? 'N' : "")));
                CSVFile[count].push((tei['SfSQ386xfyu'] ? tei['SfSQ386xfyu'] : ""));
                CSVFile[count].push((tei['gBouKokBTre'] ? tei['gBouKokBTre'] : ""));
                CSVFile[count].push((tei['RqpFC5xpj1e'] == 'true' ? 'Y' : (tei['RqpFC5xpj1e'] == 'false' ? 'N' : "")));
                CSVFile[count].push((tei['lzK71mzgilv'] ? tei['lzK71mzgilv'] : ""));
                CSVFile[count].push((tei['hZw6mBxzobR'] ? tei['hZw6mBxzobR'] : ""));
                CSVFile[count].push((tei['dpG2LEdSPi3'] ? tei['dpG2LEdSPi3'] : ""));
                CSVFile[count].push((tei['eventDateEID'] ? tei['eventDateEID'] : ""));

                CSVFile[count].push((tei['eDjmTvcfCyZ'] ? tei['eDjmTvcfCyZ'] : ""));
                CSVFile[count].push((tei['rPjBJ1GCKdQ'] ? tei['rPjBJ1GCKdQ'] : ""));
                CSVFile[count].push((tei['h7UjZ5YiX0D'] ? tei['h7UjZ5YiX0D'] : ""));
                CSVFile[count].push((tei['h7k7HK13PQg'] ? tei['h7k7HK13PQg'] : ""));
                CSVFile[count].push((tei['zq0pAQE9K8G'] ? tei['zq0pAQE9K8G'] : ""));
                CSVFile[count].push((tei['IthP5lvdS3o'] ? tei['IthP5lvdS3o'] : ""));
                CSVFile[count].push((tei['gg2Jjsf9Seb'] ? tei['gg2Jjsf9Seb'] : ""));

                CSVFile[count].push((tei['HaToAlprYUQ'] ? tei['HaToAlprYUQ'] : ""));
                CSVFile[count].push((tei['FbrFExTg92R'] ? tei['FbrFExTg92R'] : ""));
                CSVFile[count].push((tei['GEqbUeytrHY'] ? tei['GEqbUeytrHY'] : ""));
                CSVFile[count].push((tei['DOjaIyENQmx'] ? tei['DOjaIyENQmx'] : ""));
                CSVFile[count].push((tei['tf2JirA33L9'] ? tei['tf2JirA33L9'] : ""));
                CSVFile[count].push((tei['dSXO4xgyxvF'] ? tei['dSXO4xgyxvF'] : ""));
                CSVFile[count].push((tei['XDeAt9U9aog'] ? tei['XDeAt9U9aog'] : ""));

                CSVFile[count].push((tei['lBhSIl8sRCm'] ? tei['lBhSIl8sRCm'] : ""));
                CSVFile[count].push((tei['YQ1gCc1a2hm'] ? tei['YQ1gCc1a2hm'] : ""));
                CSVFile[count].push((tei['ZzlWdUjXGiL'] ? tei['ZzlWdUjXGiL'] : ""));
                CSVFile[count].push((tei['yICLjp5Rb41'] ? tei['yICLjp5Rb41'] : ""));
                CSVFile[count].push((tei['IN47b900K5R'] ? tei['IN47b900K5R'] : ""));
                CSVFile[count].push((tei['WHMESOTo677'] ? tei['WHMESOTo677'] : ""));
                CSVFile[count].push((tei['vpZRp7yBUHB'] ? tei['vpZRp7yBUHB'] : ""));

            })
            CSVFile[(count + 1)] = [];
            CSVFile[(count + 2)] = [];
            if (cases['old'].length) {
                tableBody += `<tr><td style="font-weight:400; border-bottom:1px solid white; background:#F8F8F8" colspan="${headRows.length}"></td></tr>`
                tableBody += '<tr>';
                headRows.forEach(row => {
                    CSVFile[(count + 1)].push('');
                    CSVFile[(count + 2)].push((Array.isArray(row) ? row[1] : row));
                    tableBody += `<td style="border:1px solid black;background-color:#F8F8F8;text-align:center" >${(Array.isArray(row) ? row[1] : row)}</td>`
                })
                tableBody += '</tr>';
            }

            count += 2;
            var sno = 0;
            cases['old'].forEach(tei => {
                count++;
                sno++;

                CSVFile[count] = [];
                tableBody += `<tr>
                    <td>${(sno)}</td>
                    <td>${(tei['orgUnitName'] ? tei['orgUnitName'] : "")}</td>
                    <td>${(tei['drKkLxaGFwv'] ? tei['drKkLxaGFwv'] : "")}</td>
                    <td>${(tei['fOVzjBOZdvQ'] ? tei['fOVzjBOZdvQ'] : "")}</td>
                    <td>${(tei['enrollmentDate'] ? tei['enrollmentDate'] : "")}</td>
                    <td>${(tei['zTwMKXGt0xF'] ? tei['zTwMKXGt0xF'] : "")}</td>
                    <td>${(tei['ARTStarted'] ? tei['ARTStarted'] : "")}</td>
                    <td>${(tei['eventDatePregnancy'] ? tei['eventDatePregnancy'] : "")}</td>
                    <td>${(tei['PLxyEiGyl8s'] == 'true' ? 'Y' : (tei['PLxyEiGyl8s'] == 'false' ? 'N' : ""))}</td>
                    <td>${(tei['SfSQ386xfyu'] ? tei['SfSQ386xfyu'] : "")}</td>
                    <td>${(tei['gBouKokBTre'] ? tei['gBouKokBTre'] : "")}</td>
                    <td>${(tei['RqpFC5xpj1e'] == 'true' ? 'Y' : (tei['RqpFC5xpj1e'] == 'false' ? 'N' : ""))}</td>
                    <td>${(tei['lzK71mzgilv'] ? tei['lzK71mzgilv'] : "")}</td>
                    <td>${(tei['hZw6mBxzobR'] ? tei['hZw6mBxzobR'] : "")}</td>
                    <td>${(tei['dpG2LEdSPi3'] ? tei['dpG2LEdSPi3'] : "")}</td>
                    <td>${(tei['eventDateEID'] ? tei['eventDateEID'] : "")}</td>

                    <td>${(tei['eDjmTvcfCyZ'] ? tei['eDjmTvcfCyZ'] : "")}</td>  
                    <td>${(tei['rPjBJ1GCKdQ'] ? tei['rPjBJ1GCKdQ'] : "")}</td>
                    <td>${(tei['h7UjZ5YiX0D'] ? tei['h7UjZ5YiX0D'] : "")}</td>
                    <td>${(tei['h7k7HK13PQg'] ? tei['h7k7HK13PQg'] : "")}</td>
                    <td>${(tei['zq0pAQE9K8G'] ? tei['zq0pAQE9K8G'] : "")}</td>
                    <td>${(tei['IthP5lvdS3o'] ? tei['IthP5lvdS3o'] : "")}</td>
                    <td>${(tei['gg2Jjsf9Seb'] ? tei['gg2Jjsf9Seb'] : "")}</td>

                    <td>${(tei['HaToAlprYUQ'] ? tei['HaToAlprYUQ'] : "")}</td>
                    <td>${(tei['FbrFExTg92R'] ? tei['FbrFExTg92R'] : "")}</td>
                    <td>${(tei['GEqbUeytrHY'] ? tei['GEqbUeytrHY'] : "")}</td>
                    <td>${(tei['DOjaIyENQmx'] ? tei['DOjaIyENQmx'] : "")}</td>
                    <td>${(tei['tf2JirA33L9'] ? tei['tf2JirA33L9'] : "")}</td>
                    <td>${(tei['dSXO4xgyxvF'] ? tei['dSXO4xgyxvF'] : "")}</td>
                    <td>${(tei['XDeAt9U9aog'] ? tei['XDeAt9U9aog'] : "")}</td>

                    <td>${(tei['lBhSIl8sRCm'] ? tei['lBhSIl8sRCm'] : "")}</td>
                    <td>${(tei['YQ1gCc1a2hm'] ? tei['YQ1gCc1a2hm'] : "")}</td>
                    <td>${(tei['ZzlWdUjXGiL'] ? tei['ZzlWdUjXGiL'] : "")}</td>
                    <td>${(tei['yICLjp5Rb41'] ? tei['yICLjp5Rb41'] : "")}</td>
                    <td>${(tei['IN47b900K5R'] ? tei['IN47b900K5R'] : "")}</td>
                    <td>${(tei['WHMESOTo677'] ? tei['WHMESOTo677'] : "")}</td>
                    <td>${(tei['vpZRp7yBUHB'] ? tei['vpZRp7yBUHB'] : "")}</td>
                    
                </tr>`

                CSVFile[count].push(sno);
                CSVFile[count].push((tei['orgUnitName'] ? tei['orgUnitName'] : ""));
                CSVFile[count].push((tei['drKkLxaGFwv'] ? tei['drKkLxaGFwv'] : ""));
                CSVFile[count].push((tei['fOVzjBOZdvQ'] ? tei['fOVzjBOZdvQ'] : ""));
                CSVFile[count].push((tei['enrollmentDate'] ? tei['enrollmentDate'] : ""));
                CSVFile[count].push((tei['zTwMKXGt0xF'] ? tei['zTwMKXGt0xF'] : ""));
                CSVFile[count].push((tei['ARTStarted'] ? tei['ARTStarted'] : ""));
                CSVFile[count].push((tei['eventDatePregnancy'] ? tei['eventDatePregnancy'] : ""));
                CSVFile[count].push((tei['PLxyEiGyl8s'] == 'true' ? 'Y' : (tei['PLxyEiGyl8s'] == 'false' ? 'N' : "")));
                CSVFile[count].push((tei['SfSQ386xfyu'] ? tei['SfSQ386xfyu'] : ""));
                CSVFile[count].push((tei['gBouKokBTre'] ? tei['gBouKokBTre'] : ""));
                CSVFile[count].push((tei['RqpFC5xpj1e'] == 'true' ? 'Y' : (tei['RqpFC5xpj1e'] == 'false' ? 'N' : "")));
                CSVFile[count].push((tei['lzK71mzgilv'] ? tei['lzK71mzgilv'] : ""));
                CSVFile[count].push((tei['hZw6mBxzobR'] ? tei['hZw6mBxzobR'] : ""));
                CSVFile[count].push((tei['dpG2LEdSPi3'] ? tei['dpG2LEdSPi3'] : ""));
                CSVFile[count].push((tei['eventDateEID'] ? tei['eventDateEID'] : ""));

                CSVFile[count].push((tei['eDjmTvcfCyZ'] ? tei['eDjmTvcfCyZ'] : ""));
                CSVFile[count].push((tei['rPjBJ1GCKdQ'] ? tei['rPjBJ1GCKdQ'] : ""));
                CSVFile[count].push((tei['h7UjZ5YiX0D'] ? tei['h7UjZ5YiX0D'] : ""));
                CSVFile[count].push((tei['h7k7HK13PQg'] ? tei['h7k7HK13PQg'] : ""));
                CSVFile[count].push((tei['zq0pAQE9K8G'] ? tei['zq0pAQE9K8G'] : ""));
                CSVFile[count].push((tei['IthP5lvdS3o'] ? tei['IthP5lvdS3o'] : ""));
                CSVFile[count].push((tei['gg2Jjsf9Seb'] ? tei['gg2Jjsf9Seb'] : ""));

                CSVFile[count].push((tei['HaToAlprYUQ'] ? tei['HaToAlprYUQ'] : ""));
                CSVFile[count].push((tei['FbrFExTg92R'] ? tei['FbrFExTg92R'] : ""));
                CSVFile[count].push((tei['GEqbUeytrHY'] ? tei['GEqbUeytrHY'] : ""));
                CSVFile[count].push((tei['DOjaIyENQmx'] ? tei['DOjaIyENQmx'] : ""));
                CSVFile[count].push((tei['tf2JirA33L9'] ? tei['tf2JirA33L9'] : ""));
                CSVFile[count].push((tei['dSXO4xgyxvF'] ? tei['dSXO4xgyxvF'] : ""));
                CSVFile[count].push((tei['XDeAt9U9aog'] ? tei['XDeAt9U9aog'] : ""));

                CSVFile[count].push((tei['lBhSIl8sRCm'] ? tei['lBhSIl8sRCm'] : ""));
                CSVFile[count].push((tei['YQ1gCc1a2hm'] ? tei['YQ1gCc1a2hm'] : ""));
                CSVFile[count].push((tei['ZzlWdUjXGiL'] ? tei['ZzlWdUjXGiL'] : ""));
                CSVFile[count].push((tei['yICLjp5Rb41'] ? tei['yICLjp5Rb41'] : ""));
                CSVFile[count].push((tei['IN47b900K5R'] ? tei['IN47b900K5R'] : ""));
                CSVFile[count].push((tei['WHMESOTo677'] ? tei['WHMESOTo677'] : ""));
                CSVFile[count].push((tei['vpZRp7yBUHB'] ? tei['vpZRp7yBUHB'] : ""));
            })

            document.getElementById('tableBody').innerHTML = tableBody;
            document.getElementById('report_table').style.visibility = "visible";
            document.getElementById('loader').style.display = "none";
        }


        var getTEIList = function (program, orgUnit, startDate, endDate) {
            var response = []
            $.ajax({
                async: false,
                type: "GET",
                url: `../../sqlViews/VrrmnAM9HGO/data?paging=false&var=program:${program}&var=orgUnit:${orgUnit}&var=startDate:${startDate}&var=endDate:${endDate}`,
                success: function (data) {
                    data = data.listGrid;
                    if (data.rows && data.rows.length) {
                        data.rows.forEach(tei => response.push(tei[0]))
                    }
                }
            });
            //console.log(response);
            return response;
        };


    }



    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = filename;
            document.getElementById("dlink").click();
        }
    })()

    function downloadCSV() {
        var reportName = 'Line_list_PMTCT-' + selectedOrgUnit.name;
        var hiddenElement = document.createElement('a');
        hiddenElement.href = 'data:text/csv;charset=utf-8,';

        let arr = "";
        CSVFile.forEach((row, index) => {
            if (index != 0) arr += "\n"
            arr += row.join(",");
        });
        debugger;
        hiddenElement.href += arr;
        hiddenElement.target = '_blank';
        hiddenElement.download = reportName + '.csv';
        hiddenElement.click();
    }

</script>