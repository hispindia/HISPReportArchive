<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

</head>

<body>

    <a id="dlink" style="display:none;"></a>

    <div style="width: 40%; margin-left:30%;">

        <div id="nepali-format">
            <table class="table table-borderless table-striped" style="text-align: center;">
                <tr style="border: 1px solid #DDDDDD;">
                    <td style="font-size: 15px;padding-top: 15px;">Select Year :</td>
                    <td style="width: 60%;"><select class="form-control" id="select-year"
                            onchange="getMonths(this.value)"></select>
                </tr>
                <tr style="border: 1px solid #DDDDDD;">
                    <td style="font-size: 15px;padding-top: 15px;">Select Month :</td>
                    <td style="width: 60%;"><select class="form-control" id="select-month"></select>
                </tr>

            </table>

        </div>
        <div>
            <table class="table">
                <tr style="border: 1px solid #DDDDDD;">
                    <td><button onClick="submitValues()" class="btn" id="tap">Submit</button></td>
                    <td style="text-align: right">
                        <img src="https://img.icons8.com/color/35/000000/ms-excel.png"
                            onmouseover="this.style.cursor='pointer'"
                            onClick="tableToExcel('report-table', 'People Living with HIV - Newly Initiated', 'People Living with HIV - Newly Initiated')"
                            alt="xls">
                        <img src="https://img.icons8.com/ultraviolet/35/000000/print.png" alt="print"
                            onmouseover="this.style.cursor='pointer'" onclick="printContent('#printData')">
                       <!-- <span id="csv-download">
                            <img src="https://img.icons8.com/dusk/35/000000/export-csv.png" alt="print"
                                onmouseover="this.style.cursor='pointer'" onclick="downloadCSV()">
                        </span> -->
                    </td>
                </tr>
                <tr id="loader" style="display:none">
                    <td>
                        <h2>Loading...</h2>
                    </td>
                </tr>
            </table>

        </div>
    </div>

    <div id="print-data">
        <table class="table table-bordered table-striped table-hover reporttable" width="100%" id="report-table">
            <thead id="table-head">
                <tr>
                    <td style="font-weight:400; border-bottom:1px solid white; background: rgb(39, 102, 150);font-size:20px; color:white; text-align: center;"
                        colspan="27">
                        People Living with HIV - Newly Initiated- <span id="date"> </span>
                </tr>
                <tr>
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">S.No.
                    </td>
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">
                        Client Code</td>
						 <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">
                       Month </td>
					   <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">
                       Year </td>
					    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">
                        Organisation UID</td>
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">
                        Service Site Name (ART Centers)</td>
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">
                        Service Number</td>
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Age
                        at Registration(Years)</td>
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Treatment Initiation
                        Date</td>
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">
                        Gender</td>
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Risk
                        Group</td>
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">
                        Finger Print Id</td>
                   
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Age
                        at Visited (Years)</td>
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Age
                        in Category</td>
                    <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Age
                        and Sex Group</td>
					
						
					<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Tuberculosis screening done
					</td>
					<td style="font-weight:800; border:1px solid black;background-color:#007bff;text-align:center">Contact with TB cases
					</td>
					<td style="font-weight:800; border:1px solid black;background-color:#007bff;text-align:center">Fever
					</td>
					<td style="font-weight:800; border:1px solid black;background-color:#007bff;text-align:center">Night sweat
					</td>
					<td style="font-weight:800; border:1px solid black;background-color:#007bff;text-align:center">Presence of Cough
					</td>
					<td style="font-weight:800; border:1px solid black;background-color:#007bff;text-align:center">Weight loss
					</td>
										
					<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">TB status
					</td>
					<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Type of TB status at the date of Registration
					</td>
					<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">ATT status (Antituberculosis Therapy)
					</td>
					
					<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">ART treatment initiation date at this site (Medical History)
					</td>
					<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Presumptive TB
					</td>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <body>

        <script>
            document.querySelector("#print-data").style.display = "none";
           var selectedOU = dhis2.report.organisationUnit;

            var startDate, endDate, nepaliDate;

            var year = "";
            var dates = [
                ["2076", "1", "Baisakh", "2019-04-14", "2019-05-14"],
                ["2076", "2", "Jestha", "2019-05-15", "2019-06-15"],
                ["2076", "3", "Asadh", "2019-06-16", "2019-07-16"],
                ["2076", "4", "Shrawan", "2019-07-17", "2019-08-17"],
                ["2076", "5", "Bharda ", "2019-08-18", "2019-09-17"],
                ["2076", "6", "Ashwin", "2019-09-18", "2019-10-17"],
                ["2076", "7", "Kartik", "2019-10-18", "2019-11-16"],
                ["2076", "8", "Mansir", "2019-11-17", "2019-12-16"],
                ["2076", "9", "Poush", "2019-12-17", "2020-01-14"],
                ["2076", "10", "Magh", "2020-01-15", "2020-02-12"],
                ["2076", "11", "Falgun", "2020-02-13", "2020-03-13"],
                ["2076", "12", "Chaitra", "2020-03-14", "2020-04-12"],
                ["2077", "1", "Baisakh", "2020-04-13", "2020-05-13"],
                ["2077", "2", "Jestha", "2020-05-14", "2020-06-14"],
                ["2077", "3", "Asadh", "2020-06-15", "2020-07-15"],
                ["2077", "4", "Shrawan", "2020-07-16", "2020-08-16"],
                ["2077", "5", "Bharda", "2020-08-17", "2020-09-16"],
                ["2077", "6", "Ashwin", "2020-09-17", "2020-10-16"],
                ["2077", "7", "Kartik", "2020-10-17", "2020-11-15"],
                ["2077", "8", "Mansir", "2020-11-16", "2020-12-15"],
                ["2077", "9", "Poush", "2020-12-16", "2021-01-13"],
                ["2077", "10", "Magh", "2021-01-14", "2021-02-12"],
                ["2077", "11", "Falgun", "2021-02-13", "2021-03-13"],
                ["2077", "12", "Chaitra", "2021-03-14", "2021-04-13"],
                ["2078", "1", "Baisakh", "2021-04-14", "2021-05-14"],
                ["2078", "2", "Jestha", "2021-05-15", "2021-06-14"],
                ["2078", "3", "Asar", "2021-06-15", "2021-07-15"],
                ["2078", "4", "Shrawan", "2021-07-16", "2021-08-16"],
                ["2078", "5", "Bhadra", "2021-08-17", "2021-09-16"],
                ["2078", "6", "Ashwin", "2021-09-17", "2021-10-17"],
                ["2078", "7", "Kartik", "2021-10-18", "2021-11-16"],
                ["2078", "8", "Mansir", "2021-11-17", "2021-12-15"],
                ["2078", "9", "Poush", "2021-12-16", "2022-01-14"],
                ["2078", "10", "Magh", "2022-01-15", "2022-02-12"],
                ["2078", "11", "Falgun", "2022-02-13", "2022-03-14"],
                ["2078", "12", "Chaitra", "2022-03-15", "2022-04-13"],
                ["2079", "1", "Baisakh", "2022-04-14", "2022-05-14"],
                ["2079", "2", "Jestha", "2022-05-15", "2022-06-14"],
                ["2079", "3", "Asar", "2022-06-15", "2022-07-16"],
                ["2079", "4", "Shrawan", "2022-07-17", "2022-08-16"],
                ["2079", "5", "Bhadra", "2022-08-17", "2022-09-16"],
                ["2079", "6", "Ashwin", "2022-09-17", "2022-10-17"],
                ["2079", "7", "Kartik", "2022-10-18", "2022-11-16"],
                ["2079", "8", "Mansir", "2022-11-17", "2022-12-15"],
                ["2079", "9", "Poush", "2022-12-16", "2023-01-14"],
                ["2079", "10", "Magh", "2023-01-15", "2023-02-12"],
                ["2079", "11", "Falgun", "2023-02-13", "2023-03-14"],
                ["2079", "12", "Chaitra", "2023-03-15", "2023-04-13"],
                ["2080", "1", "Baisakh", "2023-04-14", "2023-05-14"],
                ["2080", "2", "Jestha", "2023-05-15", "2023-06-15"],
                ["2080", "3", "Asar", "2023-06-16", "2023-07-16"],
                ["2080", "4", "Shrawan", "2023-07-17", "2023-08-17"],
                ["2080", "5", "Bhadra", "2023-08-18", "2023-09-17"],
                ["2080", "6", "Ashwin", "2023-09-18", "2023-10-17"],
                ["2080", "7", "Kartik", "2023-10-18", "2023-11-16"],
                ["2080", "8", "Mansir", "2023-11-17", "2023-12-16"],
                ["2080", "9", "Poush", "2023-12-17", "2024-01-14"],
                ["2080", "10", "Magh", "2024-01-15", "2024-02-12"],
                ["2080", "11", "Falgun", "2024-02-13", "2024-03-13"],
                ["2080", "12", "Chaitra", "2024-03-14", "2024-04-12"],
				["2081", "1", "Baisakh", "2024-04-14", "2024-05-13"],
			["2081", "2", "Jestha", "2024-05-15", "2024-06-14"],
			["2081", "3", "Asar", "2024-06-15", "2024-07-15"]
            ];

            dates.forEach(date => {
                if (year != date["0"]) {
                    document.querySelector("#select-year").innerHTML += '<option>' + date["0"] + '</option>';
                    year = date["0"]
                }
            });

            dates.forEach(date => {
                if (date["0"] == document.querySelector("#select-year").value) document.querySelector("#select-month").innerHTML += '<option>' + date["2"] + '</option>';

            });

            function getMonths(value) {
                document.querySelector("#select-month").innerHTML = ''
                dates.forEach(date => {
                    if (date["0"] == value) document.querySelector("#select-month").innerHTML += '<option>' + date["2"] + '</option>';
                });
            }

            function submitValues() {
                dates.forEach(date => {
                    if (document.querySelector("#select-year").value == date["0"] && document.querySelector("#select-month").value == date["2"]) {
                        startDate = date["3"];
                        endDate = date["4"];
                    }
                });

                if (new Date(startDate) > new Date(endDate) || !startDate || !endDate) {
                    alert("Please select dates correctly");
                    return;
                }

                for (let i = 0; i < dates.length; i++) {

                    if (dates[i]["3"] == startDate && dates[i]["4"] == endDate) {
                        nepaliDate = dates[i]["2"] + " " + dates[i]["0"];
                        //CSVNepaliDate = dates[i]["1"] >= 10 ? dates[i]["1"] + "" + dates[i]["0"] : "0" + dates[i]["1"] + "" + dates[i]["0"];
                        CSVNepaliDate = dates[i]["1"] >= 10 ? dates[i]["0"] + dates[i]["1"] : dates[i]["0"] + "0" + dates[i]["1"];
                        // document.querySelector("#nepali-date").innerHTML = nepaliDate
                        checkValidDate = 0;
                    }

                }
				 document.getElementById('date').innerHTML = `(${document.querySelector("#select-month").value} ${document.querySelector("#select-year").value} from ${startDate} to ${endDate})`;
                document.getElementById('table-body').innerHTML = '';
                document.querySelector("#loader").style.display = "block";
                document.querySelector("#print-data").style.display = "none";
                setTimeout(() => getData(), 1000);
            }

            function getData() {
                var dataRows = [];
                $.ajax({
                    async: false,
                    type: "GET",
                    url: `../../analytics/events/query/L78QzNqadTV.json?startDate=${startDate}&endDate=${endDate}&dimension=ou:${selectedOU.id}&dimension=zRUw1avYEvI.drKkLxaGFwv&dimension=zRUw1avYEvI.Fu4LhjNsJZL&dimension=zRUw1avYEvI.U9uQVlPfT8G&dimension=zRUw1avYEvI.TN7r3ws7IG9&dimension=zRUw1avYEvI.Usl9OzVV46v&dimension=zRUw1avYEvI.UHoTGT1dtjj&dimension=zRUw1avYEvI.zTwMKXGt0xF&dimension=zRUw1avYEvI.EjmPVYwAmiR&dimension=zRUw1avYEvI.YYAJq451uMR&dimension=zRUw1avYEvI.YYAJq451uMR&dimension=zRUw1avYEvI.JvPdjqz2sat&dimension=zRUw1avYEvI.c7G6V8yiaBx&dimension=zRUw1avYEvI.o425jZWR5Nk&dimension=zRUw1avYEvI.QFignwrAni1&dimension=zRUw1avYEvI.SpcudBrqFRQ&dimension=zRUw1avYEvI.ukfMSv4xHHB&dimension=zRUw1avYEvI.SXq5c5e0hIy&dimension=zRUw1avYEvI.yYvhBcsAr9a&dimension=zRUw1avYEvI.gPHLt0PQq1b&stage=zRUw1avYEvI&displayProperty=NAME&outputType=EVENT&desc=eventdate&paging=false`,
                    success: function (res) {
                        debugger;
						var year=document.querySelector("#select-year").value;
						var month=document.querySelector("#select-month").value
                        res.rows.forEach(row => {
                            if(row[20]=='1') {
                            let arr = [];
                            arr.push(row[13]);
							arr.push(month);
							arr.push(year);
							arr.push(row[12]);
                            arr.push(row[10]);
                            arr.push(Number(row[14]));
                            arr.push(Number(row[15]));
                            arr.push(row[2].split(' ')[0]);
                            arr.push(row[16]);
                            arr.push(row[17]);
                            arr.push(row[18]);
                            
                            arr.push(Number(row[19]));

                            if (row[19] && row[19] <= 14) arr.push("0-14");
                            else if (row[19] && row[19] >= 14) arr.push("14+");

                            if (row[19] <= 14 && row[16] == "Male") arr.push("CM");
                            else if (row[19] <= 14 && row[16] == "Female") arr.push("CF");
                            else if (row[19] >= 14 && row[16] == "Male") arr.push("AM");
                            else if (row[19] >= 14 && row[16] == "Female") arr.push("AF");
                            else if (row[16] == "Other") arr.push("TG");
							arr.push(Number(row[21]));
							arr.push(Number(row[22]));
							arr.push(Number(row[23]));
							arr.push(Number(row[24]));
							arr.push(Number(row[25]));
							arr.push(Number(row[26]));
								
							arr.push(row[27]);
							arr.push(row[28]);
							arr.push(row[29]);
							arr.push(row[30]);
							 if (row[31] && row[22]==1 || row[23] == 1|| row[24]==1 || row[25] == 1 ||row[26] == 1) arr.push("1");
							 else if (row[31] && row[22]==0 || row[23] == 0|| row[24]==0 || row[25] == 0 ||row[26] == 0)arr.push("0");
						    dataRows.push(arr);
                            }
                        })
                    }
                });

                var tableRows = ''
                dataRows.forEach((row, index) => {
                    tableRows += `<tr><td>${index + 1}</td>`
                    row.forEach(val => tableRows += `<td style='text-align:center'>${val}</td>`)
                    tableRows += `</tr>`
                })
                document.getElementById('table-body').innerHTML = tableRows;
                document.querySelector("#loader").style.display = "none";
                document.querySelector("#print-data").style.display = "block";
            }


            var tableToExcel = (function () {
                var uri = 'data:application/vnd.ms-excel;base64,'
                    , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
                    , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
                    , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
                return function (table, name, filename) {
                    if (!table.nodeType) table = document.getElementById(table)
                    var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
                    document.getElementById("dlink").href = uri + base64(format(template, ctx));
                    document.getElementById("dlink").download = filename +" - " +  selectedOU.name +" - " + nepaliDate;
                    document.getElementById("dlink").click();
                }
            })()

            function downloadCSV() {

                var reportName = 'People living with HIV newly enrolled on ART-';
                var hiddenElement = document.createElement('a');
                hiddenElement.href = 'data:text/csv;charset=utf-8,';

                let arr = "";
                CSVFile.forEach((row, index) => {
                    if (index != 0) arr += "\n"
                    arr += row.join(",");
                });
                debugger;
                hiddenElement.href += arr;
                hiddenElement.target = '_blank';
                hiddenElement.download = reportName +" "+  selectedOU.name + " " + nepaliDate + '.csv';
                hiddenElement.click();
            }

        </script>