<!--Created for NCASC-->
<!--Created Date 2020-06-26-->
<!--Source code copyright by DHIS2 Tracker HISP  INDIA-->
<!--Source code modified by Roshan Konda-->
<!--Source code modified Date 2020-08-21-->

<title>HIV Care and ART Treatment-Regimen on Treatment</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
    integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<style>
    .reporttable {
        text-align: center;
    }

    /* Absolute Center Spinner */

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }
</style>

</head>

<body>
    <div class="loading" id="loader"></div>

    <a id="dlink" style="display:none;"></a>
    <div id="main">
        <div style="width: 40%; margin-left:30%;">
            <table class="table table-striped table-bordered">
                <tr>
                    <td style="font-size: 15px;padding-top: 15px;">
                        Report Date :
                    </td>
                    <td style="width: 60%;">
                        <input type="month" class=" form-control" id="end-date">
                    </td>
                </tr>
                <tr>
                    <td style="font-size: 15px;padding-top: 15px;">
                        Cohort
                    </td>
                    <td style="width: 60%;">
                        <select id="cohort-form" class="form-control">
                        </select>
                    </td>
                </tr>
                <tr>
                    <td><button onClick="submit()" class="btn btn-primary" id="tap">Submit</button></td>
                    <td style="text-align: right;">
                        <img src="https://img.icons8.com/color/35/000000/ms-excel.png"
                            onmouseover="this.style.cursor='pointer'"
                            onclick="tableToExcel('report-table', 'EWI Cohort Report', 'EWI Cohort Report')" alt="xls"
                            style="cursor: pointer;">
                        <span id="csv-download">
                            <img src="https://img.icons8.com/dusk/35/000000/export-csv.png" alt="print"
                                onmouseover="this.style.cursor='pointer'" onclick="downloadCSV()">
                        </span>
                    </td>
                </tr>
            </table>
        </div>
        <br>
        <table class="table table-bordered table-striped table-hover reporttable" width="100%" id="report-table"
            style="visibility:hidden">
            <thead id="table-head"></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</body>

<script>
    var months = ['', 'Jan', 'Feb', 'March', 'April', 'May', 'June', 'July', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
    var selectedOrgUnit = dhis2.report.organisationUnit;
    var cohortForm = ['Not in on time for pill pickup', 'Not in good dispensing practice', 'Not virologically suppressed']
    var cohortFormOpt = cohortForm.map((de, index) => `<option value='${index}'>${de}</option>`);
    document.getElementById('cohort-form').innerHTML = cohortFormOpt;
    var cohortIndex = '';

    var CSVFile = [];

    document.getElementById("loader").style.display = "none";

    var submit = function () {
        CSVFile = [];
        CSVFile[0] = [];

        var endDate = document.getElementById("end-date").value;
        if (!endDate) {
            alert("Please select dates Correctly");
            return;
        }

        endDate = endDate + '-' + new Date(endDate.split('-')[0], endDate.split('-')[1], 0).getDate();

        cohortIndex = document.getElementById("cohort-form").value;
        var data = { endDate: endDate, cohortIndex: cohortIndex };

        if (!cohortIndex) alert("Please select Cohort Correctly");
        else {
            document.getElementById("report-table").style.visibility = "hidden";
            document.getElementById("loader").style.display = "block";
            var dataElement = [
                { id: "drKkLxaGFwv", name: "Client Code" },
                { id: "ouid", name: "Service Site Name" },
                { id: "Fu4LhjNsJZL", name: "Service Number" },
                { id: "U9uQVlPfT8G", name: "Age At Registration (Years)" },
                { id: "enrollmentDate", name: "Enrollment Date" },
            ];

            if (data.cohortIndex == '0') dataElement.push({ id: "overDue", name: "PLHIV Group" })
            if (data.cohortIndex == '1') dataElement.push({ id: "regimen-uiLtKynfEtq'", name: "PLHIV Group" })
            if (data.cohortIndex == '2') dataElement.push({ id: "ji97ypBaP2i-uiLtKynfEtq", name: "PLHIV Group" })

            var tableHead = `<tr><td style="font-weight:400; border-bottom:1px solid white; background: rgb(39, 102, 150);font-size:20px; color:white; text-align: center;" colspan="7">EWI Cohort Report <br/> Report Date:${months[Number(endDate.split('-')[1])]} ${endDate.split('-')[0]}</td></tr><tr>`;
            for (let i = 0; i <= dataElement.length; i++) tableHead += `<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">${(i + 1)}</td>`;
            tableHead += `<tr><td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">S.No.</td>`
            CSVFile[0].push('S. No.');

            dataElement.forEach(de => {
                CSVFile[0].push(de.name);
                tableHead += `<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">${de.name}</td>`
            });
            document.getElementById("table-head").innerHTML = `${tableHead}</tr>`;

            setTimeout(function () {
                getData(data)
            }, 1000)
        }


        function checkGroup(age) {

            let value = '';
            if (age < 12) value = "Group A";
            if (age >= 12 && age <= 23) value = "Group B";
            if (age >= 24 && age <= 35) value = "Group C";
            if (age >= 36 && age <= 47) value = "Group D";
            if (age >= 48 && age <= 59) value = "Group E";
            if (age >= 60 && age <= 71) value = "Group F";
            if (age >= 72) value = "Group G";

            return value;
        }

        async function getData(data) {
            var tableBody = '';
            var counter = 0;
            var program = "L78QzNqadTV";
            var teiList = await teiList(data.endDate, program);

            for (let tei of teiList) {

                let teiEvents = await getTEIAttr(tei, data.endDate, program);
                if (!teiEvents['overDue'] && data.cohortIndex == '0') continue;
                if (!teiEvents['regimen'] && data.cohortIndex == '1') continue;
                if (!teiEvents['ji97ypBaP2i'] && !teiEvents['uiLtKynfEtq'] && data.cohortIndex == '2') continue;

                counter++;
                CSVFile[counter] = [];
                CSVFile[counter].push(counter);

                tableBody += `<tr><td>${counter}</td>`;
                dataElement.forEach((de, index) => {
                    if (index == 5) {

                        let value = ''
                        if (de == 'ji97ypBaP2i-uiLtKynfEtq' && teiEvents[de]) {

                            value = checkGroup(teiEvents[de]);
                        }
                        if (de == 'regimen-uiLtKynfEtq' && teiEvents[de]) {

                            value = checkGroup(teiEvents[de]);
                        }
                        if (de == 'overDue' && teiEvents['overDue'] && teiEvents['overDue-uiLtKynfEtq']) {

                            value = checkGroup(teiEvents['overDue-uiLtKynfEtq']);
                        }
                        tableBody += `<td>${value}</td>`;
                        CSVFile[counter].push(value);
                    }
                    else {
                        CSVFile[counter].push((teiEvents[de.id] ? teiEvents[de.id] : ""));
                        tableBody += `<td>${(teiEvents[de.id] ? teiEvents[de.id] : "")}</td>`;
                    }
                })
                tableBody += '</tr>'
            }

            document.getElementById("table-body").innerHTML = tableBody;
            document.getElementById("report-table").style.visibility = "visible";
            document.getElementById("loader").style.display = "none";

            async function getTEIAttr(teiId, endDate, program) {
                var teiData = {};
                var teiValues = await (await fetch(`../../trackedEntityInstances/${teiId}.json?paging=false&program=${program}&fields=attributes,enrollments,enrollments[enrollmentDate,orgUnitName,events]`)).json();

                teiValues.attributes.forEach(attr => teiData[attr.attribute] = attr.value);
                var events = teiValues.enrollments[0].events;
                teiData['enrollmentDate'] = (teiValues.enrollments && teiValues.enrollments[0].enrollmentDate) ? teiValues.enrollments[0].enrollmentDate.split('T')[0] : '';
                teiData['ouid'] = teiValues.enrollments[0].orgUnitName;
                for (let i = (events.length - 1); i > 0; i--) {

                    if (events[i].status == 'OVERDUE' && events[i].programStage == 'zLxGw3kEplq') {
                        let teiOverDue = events[i].dueDate.split('T')[0].split('-');
                        if (teiVisited[0] != teiOverDue[0]) teiData['overDue'] = true;
                        else if (teiVisited[1] != teiOverDue[1]) teiData['overDue'] = true;
                        else if ((teiOverDue[2] - teiVisited[2]) > 2) teiData['overDue'] = true;
                    }
                    else {

                        if (events[i].programStage == 'zRUw1avYEvI' && events[i].programStage == 'YRSdePjzzfs') {
                            events[i].dataValues.forEach(dataValue => {
                                if (!teiData['overDue-uiLtKynfEtq'] && dataValue.dataElement == 'uiLtKynfEtq') teiData['overDue-uiLtKynfEtq'] = dataValue.value;
                                if (!teiData['regimen']) {
                                    if (dataValue.dataElement == 'Bk9I9PWKHbE' || dataValue.dataElement == 'bVDIGJi6YqQ' || dataValue.dataElement == 'bllr47JqYI6' || dataValue.dataElement == 'hmHVlzgtZ0w' && dataValue.value == 'other_regimen') {
                                        teiData['regimen'] = true;
                                    }
                                }

                                if (dataValue.dataElement == 'ji97ypBaP2i' && dataValue.value > 1000) teiData['ji97ypBaP2i'] = true;
                                if (dataValue.dataElement == 'uiLtKynfEtq') teiData['uiLtKynfEtq'] = dataValue.value;
                            })

                            if (!teiData['regimen-uiLtKynfEtq'] && teiData['regimen'] && teiData['uiLtKynfEtq']) {
                                teiData['regimen-uiLtKynfEtq'] = teiData['uiLtKynfEtq'];
                            }
                            if (!teiData['ji97ypBaP2i-uiLtKynfEtq'] && teiData['ji97ypBaP2i'] && teiData['uiLtKynfEtq']) {
                                teiData['ji97ypBaP2i-uiLtKynfEtq'] = teiData['uiLtKynfEtq'];
                            }

                            teiData['regimen'] = '';
                            teiData['ji97ypBaP2i'] = '';
                            teiData['uiLtKynfEtq'] = '';
                        }
                    }
                }
                return teiData;
            }

            async function teiList(endDate, program) {
                var teiList = [];

                var includedOrgUnitGroups = {};
                var resncascCenter = await (await fetch(`../../organisationUnitGroups/pW6owR4oRKb.json?fields=id,name,organisationUnits&paging=false`)).json()
                resncascCenter.organisationUnits.forEach(row => includedOrgUnitGroups[row.id] = true);

                var url = '../../organisationUnits/' + selectedOrgUnit.id + '.json?paging=false&fields=id,name,level';
                var resLevel = await (await fetch(`../../organisationUnitLevels.json`)).json();
                for (let i = 0; i < resLevel.organisationUnitLevels.length; i++) url += ',children[id,name,level,dataSets[id]';
                url += ']';

                var resOUTree = await (await fetch(url)).json();
                await treeDown(resOUTree);
                debugger;
                async function treeDown(arr) {
                    var key = arr;
                    var obj = {}

                    if (key.children.length) {
                        key.children.sort((a, b) => a.name.localeCompare(b.name))
                        for (let i = 0; i < key.children.length; i++) {
                            await treeDown(key.children[i]);
                        }
                    }

                    if (includedOrgUnitGroups[key.id]) {
                        await runAPI(key.id, program, endDate)
                    }
                }

                async function runAPI(ou, program, endDate) {
                    var response = await (await fetch(`../../enrollments.json?paging=false&program=${program}&ou=${ou}&ouMode=DESCENDANTS&programEndDate=${endDate}&fields=trackedEntityInstance`)).json();
                    response.enrollments.forEach(tei => teiList.push(tei.trackedEntityInstance));
                }
                return teiList;
            }
        }
    };

    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = `${filename}-${cohortForm[cohortIndex]}-${selectedOrgUnit.name}`;
            document.getElementById("dlink").click();
        }
    })()

    function downloadCSV() {

        var reportName = 'EWI_Report-' + selectedOrgUnit.name;
        var hiddenElement = document.createElement('a');
        hiddenElement.href = 'data:text/csv;charset=utf-8,';

        let arr = "";
        CSVFile.forEach((row, index) => {
            if (index != 0) arr += "\n"
            arr += row.join(",");
        });
        debugger;
        hiddenElement.href += arr;
        hiddenElement.target = '_blank';
        hiddenElement.download = reportName + '.csv';
        hiddenElement.click();
    }


</script>