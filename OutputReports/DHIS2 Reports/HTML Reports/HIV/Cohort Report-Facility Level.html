<!--Created for NCASC-->
<!--Created Date 2020-06-26-->
<!--Source code copyright by DHIS2 Tracker HISP  INDIA-->
<!--Source code modified by Roshan Konda-->
<!--Source code modified Date 2020-08-21-->

<title>HIV Care and ART Treatment-Regimen on Treatment</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
    integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<style>
    .reporttable {
        text-align: center;
    }

    /* Absolute Center Spinner */

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }
</style>

</head>

<body>
    <div class="loading" id="loader"></div>

    <a id="dlink" style="display:none;"></a>
    <div id="main">
        <div style="width: 40%; margin-left:30%;">
            <table class="table table-striped table-bordered">
                <tr>
                    <td style="font-size: 15px;padding-top: 15px;">
                        Cohort Date :
                    </td>
                    <td style="width: 60%;">
                        <input type="month" class=" form-control" id="end-date">
                    </td>
                </tr>
                <tr>
                    <td><button onClick="submit()" class="btn btn-primary" id="tap">Submit</button></td>
                    <td style="text-align: right;">
                        <div id="downloads" style="display: none;">
                            <img src="https://img.icons8.com/color/35/000000/ms-excel.png"
                                onmouseover="this.style.cursor='pointer'"
                                onclick="tableToExcel('report-table', 'HIV Tracker - Cohort Report', 'HIV Tracker - Cohort Report')"
                                alt="xls" style="cursor: pointer;">
                            <span id="csv-download">
                                <img src="https://img.icons8.com/dusk/35/000000/export-csv.png" alt="print"
                                    onmouseover="this.style.cursor='pointer'" onclick="downloadCSV()">
                            </span>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        <br>
        <table class="table table-bordered table-striped table-hover reporttable" id="report-table"
            style="visibility: hidden;">
            <thead id="table-head"></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</body>

<script>
    var selectedOrgUnit = dhis2.report.organisationUnit;
    var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    var dataElement = [
        { id: "orgUnitId", name: "ART Site Id" },
        { id: "orgUnit", name: "ART Site Name" },
        { id: "drKkLxaGFwv", name: "Client Code" },
        { id: "zTwMKXGt0xF", name: "Current Age" },
        { id: "TN7r3ws7IG9", name: "Sex" },
        { id: "XjNf5IbKJFQ", name: "CD4 at start of ART" },
        { id: "Lfh80yC5Tlx", name: "Current CD4 count" },
        { id: "rQnmYAF1899-gPHLt0PQq1b", name: "Date of ART started(Medical History)" },
        { id: "bj6JwQ2TxZm", name: "Date of Transfer in(ART follow up)" },
        { id: "transferredOrgUnit", name: "Transferred From" },
        { id: "transfer_out-eventDate", name: "Date of Transfer out" },
        { id: "death-eventDate", name: "Date of Death" },
        { id: "missing-eventDate", name: "Date of Missing" },
        { id: "lost_to_follow_up-eventDate", name: "Date of LFU" },
        { id: "stop_treatment-eventDate", name: "Date of Stop Treatment" },
        { id: "uiLtKynfEtq", name: "Treatment status of Patient" },
    ];
    var getBetweenDates = function (startDate, endDate) {
        var arr = [], lastDay, start, end;
        var startYear = startDate.split("-");
        var endYear = endDate.split("-");

        for (var i = parseInt(startYear["0"]); i <= parseInt(endYear["0"]); i++) {

            startMonth = (i > parseInt(startYear["0"])) ? 1 : parseInt(startYear["1"]);
            endMonth = (i == endYear["0"]) ? endYear["1"] : 12;

            for (var j = startMonth; j <= endMonth; j++) {
                let value = j < 10 ? i + "0" + j : i + "" + j;
                arr.push(value);

            }
        }

        return arr;
    }
    var CSVFile = [];

    document.getElementById("loader").style.display = "none";

    var submit = function () {
        CSVFile = [];
        CSVFile[0] = [];
        CSVFile[0] = [
            'S.NO.', 'ART Site Id','ART Site Name', 'Client Code',
            'Current Age', 'Sex', 'CD4 at start of ART', 'Current CD4 count',
            'Date of ART started(Medical History)', 'Date of Transfer in(ART follow up)',
            'Transferred From', 'Date of Transfer out', 'Date of Death', 'Date of Missing',
            'Date of LFU', 'Date of Stop Treatment',
            'Treatment status of Patient Start on < Year1 (< 12 Month)',
            'Treatment status of Patient Start on Year1 (At 12 Month)',
            'Treatment status of Patient Start on Year2 (At 24 Month)',
            'Treatment status of Patient Start on Year3 (At 36 Month)',
            'Treatment status of Patient Start on Year4 (At 48 Month)',
            'Treatment status of Patient Start on Year5 (At 60 Month)',
            'Treatment status of Patient Start on >= Year5 (>= 72 Monnth)'
        ]
        document.getElementById("downloads").style.display = "none";

        var endDate = document.getElementById("end-date").value;
        endDate = `${endDate}-${("00" + (new Date(endDate.split("-")[0], endDate.split("-")[1], 0).getDate())).slice(-2)}`;

        if (!endDate) alert("Please select a month!");
        else {
            document.getElementById("report-table").style.visibility = "hidden";
            document.getElementById("loader").style.display = "block";

            var tableHead = `<tr><td style="font-weight:400; border-bottom:1px solid white; background: rgb(39, 102, 150);font-size:20px; color:white; text-align: center;" colspan="23">HIV Tracker - Cohort Report <br/> Cohort upto ${months[Number((endDate.split("-")[1]) - 1)]} ${endDate.split("-")[0]}</td></tr><tr><td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center" rowspan="4">S.NO.</td>`;
            for (let i = 1; i <= 16; i++) {
                if(i==1) tableHead += `<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center;" colspan="2">${i}</td>`
                else if (i == 7) continue;
                else if (i == 9) {
                    tableHead += `<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center;" colspan="7">${i}</td>`
                }
                else tableHead += `<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">${i}</td>`;
            }
            tableHead += '</tr>';
            dataElement.forEach((de, index) => tableHead += `<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center" ${index == "14" ? `colspan="7"` : `rowspan="3"`}>${de.name}</td>`);
            tableHead += `</tr><tr><td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Start on <br/>< Year1</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Start on Year1</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Start on Year2</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Start on Year3</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Start on Year4</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Start on Year5</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">Start on >= Year5</td>
                </tr>
                <tr>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">&lt; 12 Month</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">At 12 Month</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">At 24 Month</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">At 36 Month</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">At 48 Month</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">At 60 Month</td>
                <td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center"> &gt;= 72 Month</td>
                </tr>`
            document.getElementById("table-head").innerHTML = `${tableHead}</tr>`;

            setTimeout(function () {
                getData(endDate)
            }, 1000)
        }

        async function getData(endDate) {
            var tableBody = '';
            var counter = 0;

            let program = "L78QzNqadTV";
            // let events = await getTEIEvents(program);
            // let teiEvents = await getTEIAttr(events, program);
            let teiEvents = await getTEIEventAttr(selectedOrgUnit.id, program, endDate);
debugger;
            for (let tei in teiEvents) {
                counter++;
                CSVFile[counter] = [];
                CSVFile[counter].push(counter);

                tableBody += `<tr><td>${counter}</td>`;

                dataElement.forEach((de, index) => {
                    if (index == "7") {
                        const DE = de.id.split("-");
                        let value = ''
                        if (teiEvents[tei][DE["0"]]) value = (teiEvents[tei][DE["0"]] ? teiEvents[tei][DE["0"]] : "");
                        else value = (teiEvents[tei][DE["1"]] ? teiEvents[tei][DE["1"]] : "");
                        tableBody += `<td>${value}</td>`;
                        CSVFile[counter].push(value);
                    }
                    else if (index >= "8" && index <= "14") {
                        let value = ''
                        if (index == 8) value = (teiEvents[tei][de.id] ? teiEvents[tei][de.id] : "");
                        else value = (teiEvents[tei][de.id] ? teiEvents[tei][de.id].split("T")["0"] : "");
                        tableBody += `<td>${value}</td>`;
                        CSVFile[counter].push(value);
                    }
                    else if (index == "15") {
                        tableBody += `<td>${(teiEvents[tei]["tretmentStatus0"] ? teiEvents[tei]["tretmentStatus0"] : "")}</td>`;
                        tableBody += `<td>${(teiEvents[tei]["tretmentStatus12"] ? teiEvents[tei]["tretmentStatus12"] : "")}</td>`;
                        tableBody += `<td>${(teiEvents[tei]["tretmentStatus24"] ? teiEvents[tei]["tretmentStatus24"] : "")}</td>`;
                        tableBody += `<td>${(teiEvents[tei]["tretmentStatus36"] ? teiEvents[tei]["tretmentStatus36"] : "")}</td>`;
                        tableBody += `<td>${(teiEvents[tei]["tretmentStatus48"] ? teiEvents[tei]["tretmentStatus48"] : "")}</td>`;
                        tableBody += `<td>${(teiEvents[tei]["tretmentStatus60"] ? teiEvents[tei]["tretmentStatus60"] : "")}</td>`;
                        tableBody += `<td>${(teiEvents[tei]["tretmentStatus72"] ? teiEvents[tei]["tretmentStatus72"] : "")}</td>`;

                        CSVFile[counter].push((teiEvents[tei]["tretmentStatus0"] ? teiEvents[tei]["tretmentStatus0"] : ""));
                        CSVFile[counter].push((teiEvents[tei]["tretmentStatus12"] ? teiEvents[tei]["tretmentStatus12"] : ""));
                        CSVFile[counter].push((teiEvents[tei]["tretmentStatus24"] ? teiEvents[tei]["tretmentStatus24"] : ""));
                        CSVFile[counter].push((teiEvents[tei]["tretmentStatus36"] ? teiEvents[tei]["tretmentStatus36"] : ""));
                        CSVFile[counter].push((teiEvents[tei]["tretmentStatus48"] ? teiEvents[tei]["tretmentStatus48"] : ""));
                        CSVFile[counter].push((teiEvents[tei]["tretmentStatus60"] ? teiEvents[tei]["tretmentStatus60"] : ""));
                        CSVFile[counter].push((teiEvents[tei]["tretmentStatus72"] ? teiEvents[tei]["tretmentStatus72"] : ""));
                    }
                    else {
                        tableBody += `<td>${(teiEvents[tei][de.id] ? teiEvents[tei][de.id] : "")}</td>`;
                        CSVFile[counter].push((teiEvents[tei][de.id] ? teiEvents[tei][de.id] : ""));
                    }
                })
                tableBody += '</tr>'
            }

            document.getElementById("table-body").innerHTML = tableBody;
            document.getElementById("report-table").style.visibility = "visible";
            document.getElementById("downloads").style.display = "block";
            document.getElementById("loader").style.display = "none";


            async function getTEIEventAttr(ou, program, date) {

                var teiEvents = {};
                var includedOrgUnitGroups = {};
                var resncascCenter = await (await fetch(`../../organisationUnitGroups/pW6owR4oRKb.json?fields=id,name,organisationUnits&paging=false`)).json()
                resncascCenter.organisationUnits.forEach(row => includedOrgUnitGroups[row.id] = true);

                var url = '../../organisationUnits/' + ou + '.json?paging=false&fields=id,name,level';
                var resLevel = await (await fetch(`../../organisationUnitLevels.json`)).json();
                for (let i = 0; i < resLevel.organisationUnitLevels.length; i++) url += ',children[id,name,level,dataSets[id]';
                url += ']';

                var resOUTree = await (await fetch(url)).json();
                await treeDown(resOUTree);
                async function treeDown(arr) {
                    var key = arr;
                    var obj = {}

                    if (key.children.length) {
                        key.children.sort((a, b) => a.name.localeCompare(b.name))
                        for (let i = 0; i < key.children.length; i++) {
                            await treeDown(key.children[i]);
                        }
                    }

                    if (includedOrgUnitGroups[key.id]) {
                        await runAPI(key.id,key.name, program, date)
                    }
                }

                async function runAPI(ou, ouName, program, date) {
                    var response = await (await fetch(`../../trackedEntityInstances.json?paging=false&program=${program}&ou=${ou}&programEndDate=${date}&fields=trackedEntityInstance,attributes,enrollments[program,orgUnit,events[eventDate,dueDate,orgUnit,orgUnitName,dataValues]]`)).json()

                    response.trackedEntityInstances.forEach(tei => {
                        var teiId = tei.trackedEntityInstance;
                        if (!teiEvents[teiId]) teiEvents[teiId] = [];
                        teiEvents[teiId]["orgUnitId"] = ou;
                        teiEvents[teiId]["orgUnit"] = ouName;
                        tei.attributes.forEach(attr => teiEvents[teiId][attr.attribute] = attr.value);
                        var artStarted = ''
                        var events = tei.enrollments[0].events;
                        for (let i = 0; i < events.length; i++) {
                            
                            let treatmentDuration = "", treatmentStatus = "", deathAge = "";
                            if (events[i].orgUnit != ou && !teiEvents[teiId]["transferredOrgUnit"]) teiEvents[teiId]["transferredOrgUnit"] = events[i].orgUnitName;
                            let eventDate = events[i].eventDate ? events[i].eventDate.split('T')[0] : '';
                            if(eventDate && new Date(eventDate) <= new Date(date)) {
                                debugger;
                                events[i].dataValues.forEach(dataValue => {
                                if (dataValue.dataElement == "WpBa1L6xxPC") {
                                    if (!teiEvents[teiId][`${dataValue.value}-eventDate`] && dataValue.value != "on_treatment") teiEvents[teiId][`${dataValue.value}-eventDate`] = (events[i].eventDate ? events[i].eventDate : "");
                                    treatmentStatus = dataValue.value;
                                    treatmentDuration = getBetweenDates(artStarted, eventDate).length;
                                   
                                }
                                else if (dataValue.dataElement == "rQnmYAF1899" || dataValue.dataElement == "gPHLt0PQq1b") {
                                    artStarted = dataValue.value;
                                    teiEvents[teiId][dataValue.dataElement] = dataValue.value;
                                }
                                else if (dataValue.dataElement == "p4wbf5rQwqx") {
                                    teiEvents[teiId]["death-eventDate"] = dataValue.value;
                                    teiEvents[teiId]["deathTEI"] = "death";
                                    treatmentDuration = getBetweenDates(artStarted, eventDate).length;
                                    if (!teiEvents[teiId]["deathAge"]) teiEvents[teiId]["deathAge"] = treatmentDuration;
                                  
                                }
                                else if (dataValue.dataElement == "bj6JwQ2TxZm") (!teiEvents[teiId][dataValue.dataElement] ? teiEvents[teiId][dataValue.dataElement] = (events[i].eventDate ? events[i].eventDate : "") : "")
                                else teiEvents[teiId][dataValue.dataElement] = dataValue.value;
                            })
                            if (treatmentDuration) {
                                if (treatmentDuration < 12 && !teiEvents[teiId]["tretmentStatus0"]) teiEvents[teiId]["tretmentStatus0"] = treatmentStatus;
                                else if (treatmentDuration >= 12 && treatmentDuration <= 23 && !teiEvents[teiId]["tretmentStatus12"]) teiEvents[teiId]["tretmentStatus12"] = treatmentStatus;
                                else if (treatmentDuration >= 24 && treatmentDuration <= 35 && !teiEvents[teiId]["tretmentStatus24"]) teiEvents[teiId]["tretmentStatus24"] = treatmentStatus;
                                else if (treatmentDuration >= 36 && treatmentDuration <= 47 && !teiEvents[teiId]["tretmentStatus36"]) teiEvents[teiId]["tretmentStatus36"] = treatmentStatus;
                                else if (treatmentDuration >= 48 && treatmentDuration <= 59 && !teiEvents[teiId]["tretmentStatus48"]) teiEvents[teiId]["tretmentStatus48"] = treatmentStatus;
                                else if (treatmentDuration >= 60 && treatmentDuration <= 71 && !teiEvents[teiId]["tretmentStatus60"]) teiEvents[teiId]["tretmentStatus60"] = treatmentStatus;
                                else if (treatmentDuration >= 72 && !teiEvents[teiId]["tretmentStatus72"]) teiEvents[teiId]["tretmentStatus72"] = treatmentStatus;
                            }
                            }

                           
                        }
                        
                        if (teiEvents[teiId]["deathTEI"]) {
                            let treatmentDuration = teiEvents[teiId]["deathAge"];
                            let treatmentStatus = teiEvents[teiId]["deathTEI"];
                            if (treatmentDuration < 12) teiEvents[teiId]["tretmentStatus0"] = treatmentStatus;
                            else if (treatmentDuration >= 12 && treatmentDuration <= 23) teiEvents[teiId]["tretmentStatus12"] = treatmentStatus;
                            else if (treatmentDuration >= 24 && treatmentDuration <= 35) teiEvents[teiId]["tretmentStatus24"] = treatmentStatus;
                            else if (treatmentDuration >= 36 && treatmentDuration <= 47) teiEvents[teiId]["tretmentStatus36"] = treatmentStatus;
                            else if (treatmentDuration >= 48 && treatmentDuration <= 59) teiEvents[teiId]["tretmentStatus48"] = treatmentStatus;
                            else if (treatmentDuration >= 60 && treatmentDuration <= 71) teiEvents[teiId]["tretmentStatus60"] = treatmentStatus;
                            else if (treatmentDuration >= 72) teiEvents[teiId]["tretmentStatus72"] = treatmentStatus;
                        }
                    })
                }
                return teiEvents;
            }

            // async function getTEIAttr(teiEvents, program) {
            //     for (let teiId in teiEvents) {
            //         var response = await (await fetch(`../../trackedEntityInstances/${teiId}.json?paging=false&program=${program}&fields=[orgUnit,attributes]`)).json();

            //         teiEvents[teiId]["orgUnit"] = selectedOrgUnit.name;
            //         response.attributes.forEach(attr => teiEvents[teiId][attr.attribute] = attr.value);
            //     }
            //     return teiEvents
            // }

            // async function getTEIEvents(program) {
            //     var teiEvents = {};
            //     var response = await (await fetch(`../../events.json?paging=false&program=${program}&orgUnit=${selectedOrgUnit.id}&endDate=${endDate}&order=eventDate:desc&ouMode=DESCENDANTS`)).json();

            //     response.events.forEach(event => {
            //         let treatmentDuration = "", treatmentStatus = ""
            //         if (!teiEvents[event.trackedEntityInstance]) teiEvents[event.trackedEntityInstance] = [];
            //         event.dataValues.forEach(dataValue => {
            //             if (dataValue.dataElement == "WpBa1L6xxPC") {
            //                 if (!teiEvents[event.trackedEntityInstance][`${dataValue.value}-eventDate`] && dataValue.value != "on_treatment") teiEvents[event.trackedEntityInstance][`${dataValue.value}-eventDate`] = (event.eventDate ? event.eventDate : "");
            //                 treatmentStatus = dataValue.value;
            //             }
            //             else if (dataValue.dataElement == "uiLtKynfEtq") treatmentDuration = dataValue.value;
            //             else if (dataValue.dataElement == "p4wbf5rQwqx") {
            //                 teiEvents[event.trackedEntityInstance]["death-eventDate"] = dataValue.value;
            //                 treatmentStatus = "death";
            //             }
            //             else if (!teiEvents[event.trackedEntityInstance][dataValue.dataElement] && dataValue.dataElement == "bj6JwQ2TxZm") (!teiEvents[event.trackedEntityInstance][dataValue.dataElement] ? teiEvents[event.trackedEntityInstance][dataValue.dataElement] = (event.eventDate ? event.eventDate : "") : "")
            //             else if (!teiEvents[event.trackedEntityInstance][dataValue.dataElement]) teiEvents[event.trackedEntityInstance][dataValue.dataElement] = dataValue.value;
            //         })
            //         if (treatmentDuration) {
            //             if (treatmentDuration < 12 && !teiEvents[event.trackedEntityInstance]["tretmentStatus0"]) teiEvents[event.trackedEntityInstance]["tretmentStatus0"] = treatmentStatus;
            //             else if (treatmentDuration >= 12 && treatmentDuration <= 23 && !teiEvents[event.trackedEntityInstance]["tretmentStatus12"]) teiEvents[event.trackedEntityInstance]["tretmentStatus12"] = treatmentStatus;
            //             else if (treatmentDuration >= 24 && treatmentDuration <= 35 && !teiEvents[event.trackedEntityInstance]["tretmentStatus24"]) teiEvents[event.trackedEntityInstance]["tretmentStatus24"] = treatmentStatus;
            //             else if (treatmentDuration >= 36 && treatmentDuration <= 47 && !teiEvents[event.trackedEntityInstance]["tretmentStatus36"]) teiEvents[event.trackedEntityInstance]["tretmentStatus36"] = treatmentStatus;
            //             else if (treatmentDuration >= 48 && treatmentDuration <= 59 && !teiEvents[event.trackedEntityInstance]["tretmentStatus48"]) teiEvents[event.trackedEntityInstance]["tretmentStatus48"] = treatmentStatus;
            //             else if (treatmentDuration >= 60 && treatmentDuration <= 71 && !teiEvents[event.trackedEntityInstance]["tretmentStatus60"]) teiEvents[event.trackedEntityInstance]["tretmentStatus60"] = treatmentStatus;
            //             else if (treatmentDuration >= 72 && !teiEvents[event.trackedEntityInstance]["tretmentStatus72"]) teiEvents[event.trackedEntityInstance]["tretmentStatus72"] = treatmentStatus;
            //         }
            //     });
            //     return teiEvents;
            // }
        }
    };

    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = `${filename}-${selectedOrgUnit.name}.xls`;
            document.getElementById("dlink").click();
        }
    })()


    function downloadCSV() {

        var reportName = 'Cohort_Report-' + selectedOrgUnit.name;
        var hiddenElement = document.createElement('a');
        hiddenElement.href = 'data:text/csv;charset=utf-8,';

        let arr = "";
        CSVFile.forEach((row, index) => {
            if (index != 0) arr += "\n"
            arr += row.join(",");
        });
        hiddenElement.href += arr;
        hiddenElement.target = '_blank';
        hiddenElement.download = reportName + '.csv';
        hiddenElement.click();
    }

</script>