<!--Created for NCASC-->
<!--Created Date 2020-06-26-->
<!--Source code copyright by DHIS2 Tracker HISP  INDIA-->
<!--Source code modified by Roshan Konda-->
<!--Source code modified Date 2020-08-21-->

<title>HIV Care and ART Treatment-Regimen on Treatment</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
    integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<style>
    .reporttable {
        text-align: center;
    }

    /* Absolute Center Spinner */

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }
</style>

</head>

<body>
    <div class="loading" id="loader"></div>

    <a id="dlink" style="display:none;"></a>
    <div id="main">
        <div style="width: 40%; margin-left:30%;">
            <table class="table table-striped table-bordered">

                <tr style="border: 1px solid #DDDDDD;">
                    <td style="font-size: 15px;padding-top: 15px;">Select Year :</td>
                    <td style="width: 60%;"><select class="form-control" id="select-year"
                            onchange="getMonths(this.value)"></select>
                    <td style="font-size: 15px;padding-top: 15px;">Select Month :</td>
                    <td style="width: 60%;"><select class="form-control" id="select-month"></select>
                </tr>
                <!-- <tr style="border: 1px solid #DDDDDD;">
                    <td style="font-size: 15px;padding-top: 15px;">Select Month :</td>
                    <td style="width: 60%;"><select class="form-control" id="select-month"></select>
                        
                </tr> -->
                <tr style="border: 1px solid #DDDDDD; text-align: center;">
                    <td colspan="6">OR</td>
                </tr>
                <tr style="border: 1px solid #DDDDDD;">
                    <td style="font-size: 15px;padding-top: 15px;">
                        Start Date :
                    </td>
                    <td style="width: 60%;">
                        <input type="date" class="form-control" id="start-date">
                    </td>
                    <td style="font-size: 15px;padding-top: 15px;">
                        End Date :
                    </td>
                    <td style="width: 60%;">
                        <input type="date" class="form-control" id="end-date">
                    </td>
                </tr>

                <!-- <tr style="border: 1px solid #DDDDDD;">
                    <td style="font-size: 15px;padding-top: 15px;">
                        End Date :
                    </td>
                    <td style="width: 60%;">
                        <input type="date" class="form-control" id="end-date">
                    </td>
                </tr> -->
                <!-- <tr>
                    <td style="font-size: 15px;padding-top: 15px;">
                        Status of Client
                    </td>
                    <td style="width: 60%;">
                        <select id="status-form" class="form-control">
                            <!-- <option value="on_treatment+WpBa1L6xxPC">On Treatment</option> -->
                <!-- </select>
                    </td>
                </tr> -->
                <tr>
                    <td><button onClick="submit()" class="btn btn-primary" id="tap" colspan="2">Submit</button></td>
                    <td colspan="4" style="text-align: right;">
                        <img src="https://img.icons8.com/color/35/000000/ms-excel.png"
                            onmouseover="this.style.cursor='pointer'"
                            onclick="tableToExcel('report-table', 'Hepatitis C', 'Hepatitis C')" alt="xlsx"
                            style="cursor: pointer;">
                        <span id="csv-download">
                            <img src="https://img.icons8.com/dusk/35/000000/export-csv.png" alt="print"
                                onmouseover="this.style.cursor='pointer'" onclick="downloadCSV()">
                        </span>
                    </td>
                </tr>
            </table>
        </div>
        <br>
        <table class="table table-bordered table-striped table-hover reporttable" width="100%" id="report-table">
            <thead id="table-head"></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</body>

<script>
    var months = ['', 'Jan', 'Feb', 'March', 'April', 'May', 'June', 'July', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
    var selectedOrgUnit = dhis2.report.organisationUnit;

    var startDate, endDate, nepaliDate;

    var year = "";
    var dates = [
        ["2080", "1", "Baisakh", "2023-04-14", "2023-05-14"],
        ["2080", "2", "Jestha", "2023-05-15", "2023-06-15"],
        ["2080", "3", "Asar", "2023-06-16", "2023-07-16"],
        ["2080", "4", "Shrawan", "2023-07-17", "2023-08-17"],
        ["2080", "5", "Bhadra", "2023-08-18", "2023-09-17"],
        ["2080", "6", "Ashwin", "2023-09-18", "2023-10-17"],
        ["2080", "7", "Kartik", "2023-10-18", "2023-11-16"],
        ["2080", "8", "Mansir", "2023-11-17", "2023-12-16"],
        ["2080", "9", "Poush", "2023-12-17", "2024-01-14"],
        ["2080", "10", "Magh", "2024-01-15", "2024-02-12"],
        ["2080", "11", "Falgun", "2024-02-13", "2024-03-13"],
        ["2080", "12", "Chaitra", "2024-03-14", "2024-04-12"],
        ["2081", "1", "Baisakh", "2024-04-13", "2024-05-13"],
        ["2081", "2", "Jestha", "2024-05-14", "2024-06-14"],
        ["2081", "3", "Asar", "2024-06-15", "2024-07-15"],
        ["2081", "4", "Shrawan", "2024-07-16", "2024-08-16"],
        ["2081", "5", "Bhadra", "2024-08-17", "2024-09-16"],
        ["2081", "6", "Ashwin", "2024-09-17", "2024-10-16"],
        ["2081", "7", "Kartik", "2024-10-17", "2024-11-15"],
        ["2081", "8", "Mansir", "2024-11-16", "2024-12-15"],
        ["2081", "9", "Poush", "2024-12-16", "2025-01-13"],
        ["2081", "10", "Magh", "2025-01-14", "2025-02-12"],
        ["2081", "11", "Falgun", "2025-02-13", "2025-03-13"],
        ["2081", "12", "Chaitra", "2025-03-14", "2025-04-13"],
        ["2082", "1", "Baisakh", "2025-04-14", "2025-05-14"],
        ["2082", "2", "Jestha", "2025-05-15", "2025-06-14"],
        ["2082", "3", "Asar", "2025-06-15", "2025-07-16"],
        ["2082", "4", "Shrawan", "2025-07-17", "2025-08-16"],
        ["2082", "5", "Bhadra", "2025-08-17", "2025-09-16"],
        ["2082", "6", "Ashwin", "2025-09-17", "2025-10-17"],
        ["2082", "7", "Kartik", "2025-10-17", "2025-11-16"]
    ];

    const yearSelect = document.querySelector("#select-year");
    const monthSelect = document.querySelector("#select-month");
    const manualStartDate = document.querySelector("#start-date");
    const manualEndDate = document.querySelector("#end-date");

    // Initialize dropdowns
    yearSelect.innerHTML = '<option value="">Select Year</option>';
    monthSelect.innerHTML = '<option value="">Select Month</option>';

    let lastYear = "";

    dates.forEach(date => {
        if (lastYear !== date[0]) {
            yearSelect.innerHTML += `<option value="${date[0]}">${date[0]}</option>`;
            lastYear = date[0];
        }
    });

    function getMonths(selectedYear) {
        monthSelect.innerHTML = '<option value="">Select Month</option>';

        dates.forEach(date => {
            if (date[0] === selectedYear) {
                monthSelect.innerHTML += `<option value="${date[2]}">${date[2]}</option>`;
            }
        });
    }

    // Event listener for year selection
    yearSelect.addEventListener('change', function () {
        if (this.value) {
            getMonths(this.value);
        }
    });

    // Clear Nepali calendar when manual dates are selected
    manualStartDate.addEventListener('change', function () {
        if (this.value) {
            yearSelect.value = '';
            monthSelect.value = '';
            monthSelect.innerHTML = '<option value="">Select Month</option>';
        }
    });

    manualEndDate.addEventListener('change', function () {
        if (this.value) {
            yearSelect.value = '';
            monthSelect.value = '';
            monthSelect.innerHTML = '<option value="">Select Month</option>';
        }
    });

    // Clear manual dates when Nepali calendar is selected
    yearSelect.addEventListener('change', function () {
        if (this.value) {
            manualStartDate.value = '';
            manualEndDate.value = '';
        }
    });

    monthSelect.addEventListener('change', function () {
        if (this.value) {
            manualStartDate.value = '';
            manualEndDate.value = '';
        }
    });

    var dataElement = [
        { id: "drKkLxaGFwv", name: "Client Code" },
        { id: "ouName", name: "Service Site Name" },
        { id: "Fu4LhjNsJZL", name: "Service Number" },
        { id: "U9uQVlPfT8G", name: "Age At Registration (Years)" },
        { id: "enrollmentDate", name: "Enrollment Date" },
        { id: "TN7r3ws7IG9", name: "Gender" },
        { id: "Usl9OzVV46v", name: "Risk Group" },
        { id: "UHoTGT1dtjj", name: "Finger Print ID" },
        { id: "ouId", name: "Organisation UID" },
        { id: "zTwMKXGt0xF", name: "Age at Visited (Years)" },
        { id: "rQnmYAF1899-gPHLt0PQq1b", name: "ART Initiation Date" },
        { id: "eventDate", name: "Event Date" },
        { id: "bVDIGJi6YqQ", name: "Regimen before by Another Site (Medical History and Case Assesment)" },
        { id: "bllr47JqYI6", name: "Regimen at this Site (Medical History and Case Assesment)" },
        { id: "TULSRUan4HK", name: "Regimen Substituted? (ART follow up)" },
        { id: "hmHVlzgtZ0w", name: "Substituted Regimen (ART follow up)" },
        { id: "vne8TzbU8R8", name: "Regimen Switched? (ART follow up)" },
        { id: "Bk9I9PWKHbE", name: "Switched Regimen (ART follow up)" },
        { id: "p4iEE1Z50ck", name: "Reason of Switching (ART follow up)" },
        { id: "currentRegimen", name: "Current Regimen" },
        { id: "WpBa1L6xxPC", name: "Treatment Status (ART follow up)" },
        { id: "F0n5ydhTEiJ", name: "HCV antibody test" },
        { id: "HD2aY1MaBI4", name: "HCV RNA test done" },
        { id: "HsQWo6bMHCl", name: "HCV RNA test result (Detectable/Undetectable)" },
        { id: "jhxkkzooMh9", name: "HCV RNA test result" },
        { id: "njCRc8ijFCT", name: "Hepatitis C Core Antigen (HCVcAg) test done" },
        { id: "ECzy5qQig15", name: "Mention Hepatitis C Core Antigen (HCVcAg) test result" },
        { id: "O7NbD7PvktP", name: "Diagnosis of HCV infection" },
        { id: "HGYJfUsO6qU", name: "HCV Treatment Started" },
        { id: "VZFQhXjtjrx", name: "If DAA started ,then select provided treatment" },
        { id: "zTwMKXGt0xF", name: "Age" },
        { id: "ageInCategory", name: "Age (in category)" },
        { id: "ageSexGroup", name: "Age and Sex Group" },
    ];

    var CSVFile = [];

    document.getElementById("loader").style.display = "none";

    var submit = function () {
        CSVFile = [];
        CSVFile[0] = [];

        var sd, ed, displayDateRange;
        var usingNepaliCalendar = false;

        // Check which input method is being used
        var selectedYear = document.querySelector("#select-year").value;
        var selectedMonth = document.querySelector("#select-month").value;
        var manualStart = document.querySelector("#start-date").value;
        var manualEnd = document.querySelector("#end-date").value;

        // Nepali Calendar Method
        if (selectedYear && selectedMonth) {
            usingNepaliCalendar = true;
            dates.forEach(date => {
                if (date[0] === selectedYear && date[2] === selectedMonth) {
                    startDate = date[3];
                    endDate = date[4];
                    nepaliDate = date[2] + " " + date[0];
                    CSVNepaliDate = date[1] >= 10 ? date[0] + date[1] : date[0] + "0" + date[1];
                }
            });
            sd = startDate;
            ed = endDate;
            displayDateRange = `${selectedMonth} ${selectedYear} (${sd} to ${ed})`;
        }
        // Manual Date Method
        else if (manualStart && manualEnd) {
            startDate = manualStart;
            endDate = manualEnd;
            sd = manualStart;
            ed = manualEnd;
            displayDateRange = `${sd} to ${ed}`;
        }
        // Validation: No input method selected
        else {
            alert("Please select dates using either Nepali Calendar (Year + Month) or Manual Dates (Start Date + End Date)");
            return;
        }

        // Validate date range
        if (new Date(startDate) > new Date(endDate)) {
            alert("Start Date cannot be after End Date. Please select dates correctly");
            return;
        }

        document.getElementById("report-table").style.visibility = "hidden";
        document.getElementById("loader").style.display = "block";

        var tableHead = `<tr><td style="font-weight:400; border-bottom:1px solid white; background: rgb(39, 102, 150);font-size:20px; color:white; text-align: center;" colspan="34">HIV Care and ART Treatment-Regimen (Hepatitis-C) and Retention with Age <br/> Report Date: (${displayDateRange})</td></tr><tr>`;

        for (let i = 0; i <= dataElement.length; i++) {
            tableHead += `<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">${(i + 1)}</td>`;
        }

        tableHead += `<tr><td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">S. No.</td>`;

        dataElement.forEach(de => {
            tableHead += `<td style="font-weight:800; border:1px solid black;background-color:#F8F8F8;text-align:center">${de.name}</td>`;
            CSVFile[0].push(de.name);
        });

        document.getElementById("table-head").innerHTML = `${tableHead}</tr>`;

        setTimeout(function () {
            getData(sd, ed);
        }, 1000);

        async function getData(startDateParam, endDateParam) {
            var tableBody = '';
            var counter = 0;
            const orgunit = selectedOrgUnit.id;

            const url =
                `../../sqlViews/mS02kLM42Kb/data.json?paging=false` +
                `&var=orgunit:${orgunit}` +
                `&var=deid:WpBa1L6xxPC` +
                `&var=startdate:${startDateParam}` +
                `&var=enddate:${endDateParam}`;

            const response = await (await fetch(url)).json();

            teiListObj = {};

            if (response.listGrid?.rows?.length) {
                response.listGrid.rows.forEach(row => {
                    teiListObj[row[0]] = true;
                });
            }

            var teiList = Object.keys(teiListObj);

            for (let teiId of teiList) {
                let program = "L78QzNqadTV";
                let tei = await getTEIEvents(teiId, selectedOrgUnit.id, program, {
                    startDate: startDateParam,
                    endDate: endDateParam
                });

                if (tei.events["death"]) continue;

                tableBody += `<tr><td>${++counter}</td>`;
                CSVFile[counter] = [];

                debugger;
                dataElement.forEach((de, index) => {

                    // 1️⃣ AGE-IN-CATEGORY MUST BE FIRST (index 31)
                    if (de.id === "ageInCategory") {
                        let category = tei.attr["ageInCategory"] || "";
                        CSVFile[counter].push(category);
                        tableBody += `<td>${category}</td>`;
                        return;
                    }
                    if (de.id === "ageSexGroup") {
                        let val = tei.attr["ageSexGroup"] || "";
                        CSVFile[counter].push(val);
                        tableBody += `<td>${val}</td>`;
                        return;
                    }

                    // 2️⃣ First 10 are attributes
                    if (index < 10) {
                        let value = tei.attr[de.id] || "";
                        CSVFile[counter].push(value);
                        tableBody += `<td>${value}</td>`;
                    }

                    // 4️⃣ index 12
                    else if (index == 12) {
                        let deIds = de.id.split('-');
                        let value =
                            tei.events[deIds[1]] ||
                            tei.events[deIds[0]] ||
                            "";
                        CSVFile[counter].push(value);
                        tableBody += `<td>${value}</td>`;
                    }

                    // 5️⃣ all other DEs are events
                    else {
                        let value = tei.events[de.id] || "";
                        CSVFile[counter].push(value);
                        tableBody += `<td>${value}</td>`;
                    }
                });


            }

            document.getElementById("table-body").innerHTML = tableBody;
            document.getElementById("report-table").style.visibility = "visible";
            document.getElementById("loader").style.display = "none";

            async function getTEIEvents(teiId, ou, program, dateRange) {
                var tei = {
                    attr: {},
                    events: {}
                };

                var response = await (await fetch(`../../trackedEntityInstances/${teiId}.json?paging=false&program=${program}&fields=trackedEntityInstance,attributes,enrollments[program,orgUnit,orgUnitName,enrollmentDate,events[programStage,orgUnit,eventDate,dueDate,dataValues[dataElement,value]]]`)).json();

                response.attributes.forEach(attr => tei['attr'][attr.attribute] = attr.value);
                response.enrollments.forEach(enrollment => {

                    tei['attr'].ouId = enrollment.orgUnit;
                    tei['attr'].ouName = enrollment.orgUnitName;
                    enrollment.events.forEach(event => {
                        let eventDate = "";
                        if (event.eventDate) eventDate = event.eventDate.split('T')[0];

                        if (
                            eventDate &&
                            new Date(eventDate) >= new Date(dateRange.startDate) &&
                            new Date(eventDate) <= new Date(dateRange.endDate) &&
                            (event.programStage == 'AcmSTzlFRAG' || event.programStage == 'YRSdePjzzfs')
                        ) {

                            event.dataValues.forEach(dv => {
                                if (dv.dataElement == "WpBa1L6xxPC") {
                                    tei.events['eventDate'] = eventDate;
                                }

                                if (dv.dataElement == "HNpcuv51Vsq") {
                                    tei.events['death'] = true;
                                }
                                else if (dv.dataElement == "bVDIGJi6YqQ" || dv.dataElement == "bllr47JqYI6" || dv.dataElement == "hmHVlzgtZ0w" || dv.dataElement == "Bk9I9PWKHbE") {
                                    tei['events']['currentRegimen'] = dv.value;
                                }
                                else {
                                    tei['events'][dv.dataElement] = dv.value;
                                }
                            });
                        }

                        if (event.programStage == 'zRUw1avYEvI') {
                            event.dataValues.forEach(dv => {
                                tei['events'][dv.dataElement] = dv.value;
                                if (dv.dataElement == "bVDIGJi6YqQ" || dv.dataElement == "bllr47JqYI6" || dv.dataElement == "hmHVlzgtZ0w" || dv.dataElement == "Bk9I9PWKHbE") {
                                    tei['events']['currentRegimen'] = dv.value;
                                }
                            });
                        }

                        tei['attr'].enrollmentDate = enrollment.enrollmentDate.split('T')[0];
                    });
                });
                // ✔ FIX AGE SOURCE (ATTRIBUTE OR EVENT)
                let age = null;

                // 1. Age from attribute
                if (tei.attr["zTwMKXGt0xF"]) {
                    age = Number(tei.attr["zTwMKXGt0xF"]);
                }

                // 2. If missing → pick AGE from events
                else if (tei.events["zTwMKXGt0xF"]) {
                    age = Number(tei.events["zTwMKXGt0xF"]);
                    tei.attr["zTwMKXGt0xF"] = age;   // store into attr for AgeInCategory usage
                }

                // ✔ Calculate Age Category
                if (age !== null && !isNaN(age)) {
                    tei.attr["ageInCategory"] = age >= 14 ? "Adult" : "Child";
                } else {
                    tei.attr["ageInCategory"] = "";
                }
                // ✔ Calculate Age + Sex Group (AM / AF / CM / CF)
                let genderRaw = tei.attr["TN7r3ws7IG9"] || "";   // Male / Female
                let ageCat = tei.attr["ageInCategory"] || "";    // Adult / Child
                let gender = genderRaw.toLowerCase();

                let ageSexGroup = "";

                // Adult categories
                if (ageCat === "Adult") {
                    if (gender === "male") ageSexGroup = "AM";
                    else if (gender === "female") ageSexGroup = "AF";
                }

                // Child categories
                else if (ageCat === "Child") {
                    if (gender === "male") ageSexGroup = "CM";
                    else if (gender === "female") ageSexGroup = "CF";
                }

                // Save result into TEI attributes
                tei.attr["ageSexGroup"] = ageSexGroup;

                return tei;
            }
        }
    };

    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = `${filename}-${selectedOrgUnit.name}.xlsx`;
            document.getElementById("dlink").click();
        }
    })()


    function downloadCSV() {

        var reportName = 'Hepatitis-C-' + selectedOrgUnit.name;
        var hiddenElement = document.createElement('a');
        hiddenElement.href = 'data:text/csv;charset=utf-8,';

        let arr = "";
        CSVFile.forEach((row, index) => {
            if (index != 0) arr += "\n"
            arr += row.join(",");
        });
        debugger;
        hiddenElement.href += arr;
        hiddenElement.target = '_blank';
        hiddenElement.download = reportName + '.csv';
        hiddenElement.click();
    }
</script>