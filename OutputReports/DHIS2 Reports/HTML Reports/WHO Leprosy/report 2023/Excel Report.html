<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
    integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">


<style>
    thead>tr>td {
        font-weight: bold;
    }

    tbody>tr>td {
        font-weight: bold;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        opacity: 1;
    }

    /* Center the loader  */
    #loader {
        position: absolute;
        left: 50%;
        top: 50%;
        z-index: 1;
        width: 150px;
        height: 150px;
        margin: -75px 0 0 -75px;
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #34B4DB;
        width: 120px;
        height: 120px;
        -webkit-animation: spin 2s linear infinite;
        animation: spin 2s linear infinite;
    }

    @-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
        }
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Add animation to "page content" */

    .animate-bottom {
        position: relative;
        -webkit-animation-name: animatebottom;
        -webkit-animation-duration: 1s;
        animation-name: animatebottom;
        animation-duration: 1s
    }

    @-webkit-keyframes animatebottom {
        from {
            bottom: -100px;
            opacity: 0
        }

        to {
            bottom: 0px;
            opacity: 1
        }
    }

    @keyframes animatebottom {
        from {
            bottom: -100px;
            opacity: 0
        }

        to {
            bottom: 0;
            opacity: 1
        }
    }

    #printing {

        text-align: center;
    }
</style>

<a id="dlink" style="display:none;"></a>
<button type="button" class="btn btn-primary btn-sm" style="vertical-align: middle;"
    onclick="printContent('printing')"><span class="glyphicon glyphicon-print" style="font-size: 15px;"></span> &nbsp;
    Print
</button>

<button type="button" class="btn btn-success btn-sm" style="vertical-align: middle;" id="btnExport"
    onclick="tableToExcel('dataTable', 'Excel Report', 'Excel Report.xls')"><span
        class="glyphicon glyphicon-download-alt" style="font-size: 15px;"></span>Download As Excel</button>

<div id="loader"></div>
<div id="printing" class="animate-bottom">
    <div id='state'>
        <table id="dataTable" border="1" class="table  table-hover text-center" cellspacing="6" cellpadding="4"
            style="border-collapse: collapse; text-align: center">
            <thead>
                <tr style=" font:bold; text-align:center;">
                    <td style="border:1px solid black;background:#ADD8E6;">Region and country</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Code</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Population <span class="currentYear"></span></td>
                    <td style="border:1px solid black;background:#ADD8E6;">Total Number of New Cases Detected in <span
                            class="currentYear"></td>
                    <td style="border:1px solid black;background:#ADD8E6;">New Case Detection Rate</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Number of Cases Registered for Treatment at
                        end of Year <span class="currentYear"> </span></td>
                    <td style="border:1px solid black;background:#ADD8E6;">Prevalence Rate (per 10,000 Population)</td>
                    <td style="border:1px solid black;background:#ADD8E6;">MB Cases</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Proportion of MB</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Female cases</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Proportion of Female cases</td>

                    <td style="border:1px solid black;background:#ADD8E6;">Children &lt;5 years </td>
                    <td style="border:1px solid black;background:#ADD8E6;">Children 6-15 years </td>

                    <td style="border:1px solid black;background:#ADD8E6;">Child Population <span class="currentYear">
                        </span>( in '000)</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Children Under 15 Years of Age</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Proportion of Child Cases</td>

                    <td style="border:1px solid black;background:#ADD8E6;">Child case detection rate (per Million
                        population)</td>

                    <td style="border:1px solid black;background:#ADD8E6;">New Cases With Grade-2 Disabilities children
                        (< 15 Years)</td>
                    <td style="border:1px solid black;background:#ADD8E6;">New Cases with Grade-2
                        Disabilities Adult (>= 15 Years)</td>

                    <td style="border:1px solid black;background:#ADD8E6;">Leprosy Cases - Grade 2 Disability Age
                        (Unknown) </td>
                    <td style="border:1px solid black;background:#ADD8E6;">New Cases with Grade-2 Disabilities (G2D
                        Cases</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Proportion of New G2D Cases</td>
                    <td style="border:1px solid black;background:#ADD8E6;">New G2D Case Rate</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Number of Relapses Reported During the
                        endYear
                    </td>
                    <td style="border:1px solid black;background:#ADD8E6;">Other Retreatment Cases</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Number of Total Re-treatment cases Reported
                        During the Year3</td>

                    <td style="border:1px solid black;background:#ADD8E6;">Cure Rate PB% - Cohort endYear <span
                            id="lastYear"></span< /td>
                    <td style="border:1px solid black;background:#ADD8E6;">Cure Rate MB% - Cohort endYear <span
                            id="secondLastYear"></span< /td>
                    <td style="border:1px solid black;background:#ADD8E6;">Foreign Cases</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Legistation against discrimination</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Number of patients with resistance strain to any one drug</td>

                    <td style="border:1px solid black;background:#ADD8E6;">Number of patients with resistance strains to more than one drug</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Percentage of Contacts examined</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Cases detected from contacts</td>
                    <td style="border:1px solid black;background:#ADD8E6;">Proportion of cases detected from Contacts
                    </td>
                    <td style="border:1px solid black;background:#ADD8E6;">Remarks</td>
                </tr>
                <tr id="show" style=" display:none; font-weight:400; text-align:center;">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>=ROUND(D3/C3*100,2)</td>
                    <td></td>
                    <td>=ROUND(F3/C3*10,2)</td>
                    <td></td>
                    <td>=ROUND(H3/D3*100,2)</td>
                    <td></td>
                    <td>=ROUND(J3/D3*100,2)</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>=ROUND(L3/D3*100,2)</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>=ROUND(Q3/D3*100,2)</td>
                    <td>=ROUND(Q3/C3*1000,2)</td>
                </tr>
            </thead>
        </table>
    </div>
</div>

<script>
    document.getElementById("loader").style.display = "";
    document.getElementById("state").style.display = "none";

    var endYear = dhis2.report.date.split('-')[0];
    var dates = [endYear];
    for (let i = 0; i < document.getElementsByClassName("currentYear").length; i++) {
        document.getElementsByClassName("currentYear")[i].innerHTML = endYear;
    }
    var endFullDate = () => {
        var month = new Date(endYear);
        return `${month.getFullYear()}-12-` + new Date(month.getFullYear(), 12, 0).getDate();
    }
    document.getElementById("lastYear").innerHTML = endYear - 1;
    document.getElementById("secondLastYear").innerHTML = endYear - 2;

    var tabledatalevel2Orgs = '';

    var dataElementIdRows = [
        ["d1d6EWQZJGB.HllvX50cXC0"],
        ["evXyDr6c7eu.Te9RyzefSAz + gVmFx873rdZ.Te9RyzefSAz + IQgrP2W9gTV.Te9RyzefSAz + evXyDr6c7eu.ZZFiCRpT37i + gVmFx873rdZ.ZZFiCRpT37i + IQgrP2W9gTV.ZZFiCRpT37i + evXyDr6c7eu.sdMU6tpPki6 + gVmFx873rdZ.sdMU6tpPki6 + IQgrP2W9gTV.sdMU6tpPki6 + liZaznYiWwp.HllvX50cXC0"],
        ["evXyDr6c7eu.Te9RyzefSAz + gVmFx873rdZ.Te9RyzefSAz + IQgrP2W9gTV.Te9RyzefSAz + evXyDr6c7eu.ZZFiCRpT37i + gVmFx873rdZ.ZZFiCRpT37i + IQgrP2W9gTV.ZZFiCRpT37i + evXyDr6c7eu.sdMU6tpPki6 + gVmFx873rdZ.sdMU6tpPki6 + IQgrP2W9gTV.sdMU6tpPki6 + liZaznYiWwp.HllvX50cXC0", "d1d6EWQZJGB.HllvX50cXC0"],
        ["bLR7YvL1f5O.Te9RyzefSAz + bLR7YvL1f5O.ZZFiCRpT37i + mdupOTsRJ58.Te9RyzefSAz + mdupOTsRJ58.ZZFiCRpT37i + lzbsUQJvvJB.Te9RyzefSAz + lzbsUQJvvJB.ZZFiCRpT37i + LL3PpzJHqJZ.HllvX50cXC0"],
        ["bLR7YvL1f5O.Te9RyzefSAz + bLR7YvL1f5O.ZZFiCRpT37i + mdupOTsRJ58.Te9RyzefSAz + mdupOTsRJ58.ZZFiCRpT37i + lzbsUQJvvJB.Te9RyzefSAz + lzbsUQJvvJB.ZZFiCRpT37i + LL3PpzJHqJZ.HllvX50cXC0", "d1d6EWQZJGB.HllvX50cXC0"],
        ["evXyDr6c7eu"],
        ["evXyDr6c7eu", "evXyDr6c7eu + gVmFx873rdZ + IQgrP2W9gTV"],
        ["xdbnQxRVTBq"],
        ["xdbnQxRVTBq.HllvX50cXC0 + mNPlDlzmwru", "evXyDr6c7eu + gVmFx873rdZ + IQgrP2W9gTV - coycFHeZ257.HllvX50cXC0 + liZaznYiWwp"],
        ["MiHLzmsVFPf.xC5PhT2YVtr + ubgNtdy3h9H.xC5PhT2YVtr + tyHgOKrZsMJ.xC5PhT2YVtr"],
        ["MiHLzmsVFPf.GcQ4Ep0wmnH + ubgNtdy3h9H.GcQ4Ep0wmnH + tyHgOKrZsMJ.GcQ4Ep0wmnH"],
        ["EnQPW5xZDPX.DGU1CWAZ6qw"],
        ["evXyDr6c7eu.ZZFiCRpT37i + gVmFx873rdZ.ZZFiCRpT37i + IQgrP2W9gTV.ZZFiCRpT37i + TBTHguhWty1"],
        ["TBTHguhWty1 + evXyDr6c7eu.ZZFiCRpT37i + gVmFx873rdZ.ZZFiCRpT37i + IQgrP2W9gTV.ZZFiCRpT37i", "evXyDr6c7eu + gVmFx873rdZ + IQgrP2W9gTV + liZaznYiWwp"],
        ["evXyDr6c7eu.ZZFiCRpT37i + gVmFx873rdZ.ZZFiCRpT37i + IQgrP2W9gTV.ZZFiCRpT37i + TBTHguhWty1", "EnQPW5xZDPX.DGU1CWAZ6qw"],
        ["xl4EXfRMBrK.ZZFiCRpT37i + uiiSia2NAnz"],
        ["xl4EXfRMBrK.Te9RyzefSAz"],
        ["xl4EXfRMBrK.sdMU6tpPki6"],
        ["xl4EXfRMBrK.Te9RyzefSAz + xl4EXfRMBrK.ZZFiCRpT37i + xl4EXfRMBrK.sdMU6tpPki6 + tzGljEoaVdT + uiiSia2NAnz"],
        ["xl4EXfRMBrK + tzGljEoaVdT", "evXyDr6c7eu + gVmFx873rdZ + IQgrP2W9gTV + liZaznYiWwp"],
        ["tzGljEoaVdT.HllvX50cXC0 + xl4EXfRMBrK.Te9RyzefSAz + xl4EXfRMBrK.ZZFiCRpT37i + xl4EXfRMBrK.sdMU6tpPki6", "d1d6EWQZJGB.HllvX50cXC0"],
        ["VBEhMPsLu53.HllvX50cXC0 + YVj2PYy0Slj.HllvX50cXC0 + KJtRiyeoCGx.HllvX50cXC0"],
        ["lhSRNgfsxYC.HllvX50cXC0 + EHT4ON2ZtNl.HllvX50cXC0 + vp8pxtgYBL2.HllvX50cXC0"],
        ["YVj2PYy0Slj + EHT4ON2ZtNl + VBEhMPsLu53 + lhSRNgfsxYC + vp8pxtgYBL2 + KJtRiyeoCGx + ze0DbmcIajV"],
        ["t5AmFhGyKw9.HllvX50cXC0", "PFNL3BPu3A6.HllvX50cXC0"],
        ["TCJv5BNVYCw.HllvX50cXC0", "VVBrsKiEqdh.HllvX50cXC0"],
        ["nbDlMYKljTK"],
        ["fWOu6CXWmYj"],
        ["sgdAybfDzTl.oSHl2cUvHmk + sgdAybfDzTl.qqJwrOzkzcz + sgdAybfDzTl.G0EY8ZnkmVI"],
        ["doyMvQWxmOJ.HllvX50cXC0 + ej7YYjvhLmR.HllvX50cXC0 + XAQepu1Zi18.HllvX50cXC0 + DAs6FtLcYz1.HllvX50cXC0"],
        ["GuZ5MKrfrBp.HllvX50cXC0", "qHIGkVqSItK.HllvX50cXC0"],
        ["Xzuid5sSSg3.HllvX50cXC0"],
        ["Xzuid5sSSg3.HllvX50cXC0", "evXyDr6c7eu + gVmFx873rdZ + IQgrP2W9gTV"],
        [""]
    ];

    var dataElementIds = [
        'd1d6EWQZJGB', 'gY7b9azcUQG', 'ElAjdwOrjMq', 'YgvbZE63e8T', 'sAXV6Hnve4i',
        'evXyDr6c7eu', 'LhfXR2fKhsZ', 'xdbnQxRVTBq', 'KrvcvcTLqIh', 'yMIaVLPC3P9',
        'eBG4XbLqTmY', 'EnQPW5xZDPX.DGU1CWAZ6qw', 'PS9m9ERoPaj', 'C6xcdI95huJ', 'SsZP6Izyhay',
        'vDXU1FdXPHz', 'xl4EXfRMBrK.Te9RyzefSAz','xl4EXfRMBrK.sdMU6tpPki6', 'cyg9FDI48hW',
        'j62SFyBOrSN', 'v1Fr4On014j','', '',  'SSmKGrwFLyR',
        'PQCJ1jNYVMU', 'xWUvequQxeM', 'nbDlMYKljTK', 'fWOu6CXWmYj', '', '', 'trqV4BI71xI',
        'Xzuid5sSSg3.HllvX50cXC0', 'M2kzreZCnhv', ''
    ];
    var parentOU = [
        {
            id: "L9CbxlithLc",
            name: "AFR"
        },
        {
            id: "uWVIlmAl1r5",
            name: "AMR"
        },
        {
            id: "XHT7CFb5mEe",
            name: "EMR"
        },
        {
            id: "UzbbopOhq1L",
            name: "EUR"
        },
        {
            id: "vY40CQrh4Kk",
            name: "SEAR"
        },
        {
            id: "QvCHetFovQg",
            name: "WPR"
        },
        {
            id: "x3i5oi4axNu",
            name: "Global"
        }
    ]

    var parentOUId = parentOU.map(ou => ou.id);

    var arrSorting = (a, b) => {
        if (a.name < b.name) //sort string ascending
            return -1
        if (a.name > b.name)
            return 1
        return 0
    }

    var orgUnitChildren = [];
    var orgUnitChildrenAll = [];
    var selectedOrgUnit = dhis2.report.organisationUnit;
    let orgUnitLevel = dhis2.report.organisationUnitHierarchy.length;
    var valuesParentTotal = {
        "x3i5oi4axNu": []
    }, hasOUCommentedValue = {
        "x3i5oi4axNu": []
    };
    var dataValuesParent = []
    getData();



    function getData() {

        if (orgUnitLevel == 1) {
            dhis2.report.organisationUnitChildren.forEach((child, index) => {
                $.ajax({
                    type: "GET",
                    async: false,
                    url: "../api/organisationUnits/" + child.id + ".json?fields=children[id,name,code]&paging=false",
                    data: JSON,
                    success: function (data, status) {
                        orgUnitChildren[child.name] = data.children;
                        let sortedChildrens = orgUnitChildren[child.name].sort(arrSorting);
                        orgUnitChildrenAll[child.name] = []
                        for (let i = 0; i < sortedChildrens.length; i++) {
                            orgUnitChildrenAll[child.name][i + "-" + sortedChildrens[i].id] = { name: sortedChildrens[i].name, code: sortedChildrens[i].code };
                        }
                    }
                });
            })
        }
        else if (orgUnitLevel == 2) {
            orgUnitChildren[selectedOrgUnit.name] = dhis2.report.organisationUnitChildren.sort(arrSorting);
            let sortedChildrens = dhis2.report.organisationUnitChildren.sort(arrSorting);
            orgUnitChildrenAll[selectedOrgUnit.name] = []
            for (let i = 0; i < sortedChildrens.length; i++) {
                orgUnitChildrenAll[selectedOrgUnit.name][i + "-" + sortedChildrens[i].id] = { name: sortedChildrens[i].name, code: sortedChildrens[i].code };
            }
        }
        else {
            let id = dhis2.report.organisationUnit;
            orgUnitChildren[id.name] = [dhis2.report.organisationUnit];
            orgUnitChildrenAll[selectedOrgUnit.name] = [];
            orgUnitChildrenAll[selectedOrgUnit.name]["0-" + id.id] = { name: id.name, code: id.code };
        }


        $.ajax({
            type: 'GET',
            async: false,
            url: `../api/29/analytics.json?paging=false&dimension=pe:${dates.join(";")}&dimension=dx:${dataElementIds.join(';')}&dimension=ou:${parentOUId.join(";")}&displayProperty=NAME`,
            data: JSON,
            success: function (data, success) {
                for (let val in data.metaData.items) {
                    dataValuesParent[data.metaData.items[val].name] = val;
                };
                data.rows.forEach((values, index) => {
                    dataValuesParent[`${values[2]}_${values[0]}.${values[1]}`] = values[3];
                });
            }
        });


        let orgUnitChildrenKeys = Object.keys(orgUnitChildren).sort();

        orgUnitChildrenKeys.forEach(val => finalValues(val));

        if (orgUnitLevel == 1) {

            let totalData = '<tr style="border:1px solid black; background-color:#DCDCDC"><td style="font:bold;" colspan = "2">Grand Total</td>'

            dataElementIds.forEach((de, counter) => {

                if(counter==0 || counter==11) {                
                    let val = dataValuesParent[`x3i5oi4axNu_${de}.${endYear}`] ? Math.round(dataValuesParent[`x3i5oi4axNu_${de}.${endYear}`]/1000)  : hasOUCommentedValue[ouRegion] && hasOUCommentedValue[ouRegion][counter] ? hasOUCommentedValue[ouRegion][counter] : "NR";
                    totalData += `<td style="font:bold;background-color:#eaeaea">${val}</td>`;
                }
                else if(de=="PQCJ1jNYVMU") {
                    let val = dataValuesParent[`x3i5oi4axNu_${de}.${endYear}`] ? Number(dataValuesParent[`x3i5oi4axNu_${de}.${endYear}`]) : (valuesParentTotal[ouRegion] && valuesParentTotal[ouRegion][counter] === 0 ? valuesParentTotal[ouRegion][counter] : hasOUCommentedValue[ouRegion] && hasOUCommentedValue[ouRegion][counter] ? hasOUCommentedValue[ouRegion][counter] : "NR");
                    totalData += `<td style="font:bold;background-color:#eaeaea">${val}</td>`;
                }
                else if(de=='xWUvequQxeM') {
                    let val = dataValuesParent[`x3i5oi4axNu_${de}.${endYear}`] ? Number(dataValuesParent[`x3i5oi4axNu_${de}.${endYear}`]) : (valuesParentTotal[ouRegion] && valuesParentTotal[ouRegion][counter] === 0 ? valuesParentTotal[ouRegion][counter] : hasOUCommentedValue[ouRegion] && hasOUCommentedValue[ouRegion][counter] ? hasOUCommentedValue[ouRegion][counter] : "NR");
                    totalData += `<td style="font:bold;background-color:#eaeaea">${val}</td>`;
                }
                else if (de) {
                    let val = dataValuesParent[`x3i5oi4axNu_${de}.${endYear}`] ? Number(dataValuesParent[`x3i5oi4axNu_${de}.${endYear}`]) : (valuesParentTotal['x3i5oi4axNu'] && valuesParentTotal['x3i5oi4axNu'][counter] === 0 ? valuesParentTotal['x3i5oi4axNu'][counter] : hasOUCommentedValue['x3i5oi4axNu'] && hasOUCommentedValue['x3i5oi4axNu'][counter] ? hasOUCommentedValue['x3i5oi4axNu'][counter] : "NR");
                    totalData += `<td style="font:bold;background-color:#eaeaea">${val}</td>`;
                }
                else {
                    let val = (valuesParentTotal['x3i5oi4axNu'] && valuesParentTotal['x3i5oi4axNu'][counter] || valuesParentTotal['x3i5oi4axNu'][counter] === 0 ? valuesParentTotal['x3i5oi4axNu'][counter] : hasOUCommentedValue['x3i5oi4axNu'] && hasOUCommentedValue['x3i5oi4axNu'][counter] ? hasOUCommentedValue['x3i5oi4axNu'][counter] : "NR");
                    totalData += `<td style="font:bold;background-color:#eaeaea">${val}</td>`;
                }
            })
            totalData += '</tr>'
            document.getElementById("dataTable").innerHTML += totalData;
        }

        document.getElementById("loader").style.display = "none";
        document.getElementById("state").style.display = "block";
    }

    function finalValues(ouRegion) {
        tabledatalevel2Orgs = '<tr>';
        tabledatalevel2Orgs += ('<td align="left"; style=" font-weight:bold; background-color:#ADD8E6;">' + ouRegion + "</td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td>\
                                            <td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td>\
                                            <td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td>\
                                            <td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td>\
                                            <td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td>\
                                            <td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td>\
                                            <td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td>\
                                            <td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td>\
                                            <td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td><td style='background-color:#ADD8E6'></td>");
        tabledatalevel2Orgs += "</tr>";
        document.getElementById("dataTable").innerHTML += tabledatalevel2Orgs;

        orgUnitChildren[ouRegion].forEach(ou => {
            var tabledata = '', dataValues = {}, deValues = [], commentValues = {}, hasCommentedValue = {}, populationTotal = {};

            $.ajax({
                type: 'GET',
                async: false,
                url: `../api/sqlViews/lJ28Bauf7Ns/data.json?var=ou:${ou.id}&var=startDate:${endYear}-01-01&var=endDate:${endFullDate()}&paging=false`,
                data: JSON,
                success: function (data, success) {
                    data.listGrid.rows.forEach((values, index) => {
                        if (values[4]) {
                            if (!dataValues[`${values[0]}_${values[6]}`]) dataValues[`${values[0]}_${values[6]}`] = Number(values[4]);
                            else dataValues[[`${values[0]}_${values[6]}`]] += Number(values[4]);

                            if (!dataValues[`${values[0]}.${values[1]}_${values[6]}`]) dataValues[`${values[0]}.${values[1]}_${values[6]}`] = Number(values[4]);
                        }
                        if (values[5]) {
                            commentValues[`${values[0]}_${values[6]}`] = values[5];
                            commentValues[`${values[0]}.${values[1]}_${values[6]}`] = values[5];
                        }
                    });


                    dataElementIdRows.forEach((deRows, index) => {
                        let rows = deRows[0].split(' + ')
                        console.log(deRows)
                        rows.forEach(de => {
                            dates.forEach(pe => {

                                if (dataValues[`${de}_${pe}`] || dataValues[`${de}_${pe}`] == 0) {
                                    if (!deValues[index + "_" + pe]) deValues[index + "_" + pe] = dataValues[`${de}_${pe}`]
                                    else deValues[index + "_" + pe] = dataValues[`${de}_${pe}`] + Number(deValues[index + "_" + pe])
                                }
                                if (commentValues[`${de}_${pe}`]) {
                                    hasCommentedValue[index + "_" + pe] = "NA";
                                }
                            })
                        })
                    });
                    console.log('ehlo')
                    
                    counter = 0;
                    if (!valuesParentTotal[ouRegion]) valuesParentTotal[ouRegion] = [];

                    tabledata += `<tr><td style="font:bold;">${(ou.name ? ou.name : '')}</td><td style="font:bold;">${(ou.code ? ou.code : '')}</td>`;

                    dataElementIdRows.forEach((de, index) => {
                        let val = ""

                        if (index == 0 || index == 11) {
                            let num = deValues[`${index}_${endYear}`] ? deValues[`${index}_${endYear}`] : '';
                            val = num ? num : (hasCommentedValue[index + "_" + endYear] ? hasCommentedValue[index + "_" + endYear] : 'NR');
                            tabledata += `<td style="font:bold; border:1px solid black;">${val}</td>`;
                        }
                        else if (index == 2 || index == 4 || index == 20) {
                            let num = deValues[`${index}_${endYear}`] || deValues[`${index}_${endYear}`] === 0 ? deValues[`${index}_${endYear}`] : "";
                            let deno = dataValues[`d1d6EWQZJGB.HllvX50cXC0_${endYear}`] ? dataValues[`d1d6EWQZJGB.HllvX50cXC0_${endYear}`] : '';

                            val = num && deno && num / deno && num / deno != "Infinity" || num === 0 ? deno === 0 ? "0.00" : ((num / deno) * 1000000).toFixed(2) : (hasCommentedValue[index + "_" + endYear] ? hasCommentedValue[index + "_" + endYear] : '');
                            tabledata += `<td style="font:bold; border:1px solid black;">${val}</td>`;
                        }
                        else if (index == 14) {
                            let num = deValues[`${index}_${endYear}`] || deValues[`${index}_${endYear}`] === 0 ? deValues[`${index}_${endYear}`] : "";
                            let deno = dataValues[`EnQPW5xZDPX.DGU1CWAZ6qw_${endYear}`] ? dataValues[`EnQPW5xZDPX.DGU1CWAZ6qw_${endYear}`] : '';
                            val = num && deno && num / deno && num / deno != "Infinity" || num === 0 ? deno === 0 ? "0.00" : ((num / deno) * 1000000).toFixed(2) : (hasCommentedValue[index + "_" + endYear] ? hasCommentedValue[index + "_" + endYear] : '');
                            tabledata += `<td style="font:bold; border:1px solid black;">${val}</td>`;
                        }
                        else if (index == 6 || index == 8 || index == 13 || index == 19 || index == 33) {
                            let deno;
                            if (index == 6 || index == 33) deno = (dataValues[`evXyDr6c7eu_${endYear}`] ? dataValues[`evXyDr6c7eu_${endYear}`] : 0) + (dataValues[`gVmFx873rdZ_${endYear}`] ? dataValues[`gVmFx873rdZ_${endYear}`] : 0) + (dataValues[`IQgrP2W9gTV_${endYear}`] ? dataValues[`IQgrP2W9gTV_${endYear}`] : 0);
                            if (index == 8) deno = (dataValues[`evXyDr6c7eu_${endYear}`] ? dataValues[`evXyDr6c7eu_${endYear}`] : 0) + (dataValues[`gVmFx873rdZ_${endYear}`] ? dataValues[`gVmFx873rdZ_${endYear}`] : 0) + (dataValues[`IQgrP2W9gTV_${endYear}`] ? dataValues[`IQgrP2W9gTV_${endYear}`] : 0) + (dataValues[`liZaznYiWwp_${endYear}`] ? dataValues[`liZaznYiWwp_${endYear}`] : 0) + (dataValues[`coycFHeZ257.HllvX50cXC0_${endYear}`] ? dataValues[`coycFHeZ257.HllvX50cXC0_${endYear}`] : 0)
                            if (index == 19 || index == 13) deno = (dataValues[`evXyDr6c7eu_${endYear}`] ? dataValues[`evXyDr6c7eu_${endYear}`] : 0) + (dataValues[`gVmFx873rdZ_${endYear}`] ? dataValues[`gVmFx873rdZ_${endYear}`] : 0) + (dataValues[`IQgrP2W9gTV_${endYear}`] ? dataValues[`IQgrP2W9gTV_${endYear}`] : 0) + (dataValues[`liZaznYiWwp_${endYear}`] ? dataValues[`liZaznYiWwp_${endYear}`] : 0)

                            let num = deValues[`${index}_${endYear}`] || deValues[`${index}_${endYear}`] === 0 ? deValues[`${index}_${endYear}`] : "";
                            val = num && deno && num / deno && num / deno != "Infinity" || num === 0 ? deno === 0 ? "0.00" : ((num / deno) * 100).toFixed(2) : (hasCommentedValue[index + "_" + endYear] ? hasCommentedValue[index + "_" + endYear] : '');
                            tabledata += `<td style="font:bold; border:1px solid black;">${val}</td>`;
                        }
                        else if (index == 24 || index == 25 || index == 30) {
                            let id;
                            if (index == 24) id = "PFNL3BPu3A6.HllvX50cXC0"
                            else if (index == 25) id = "VVBrsKiEqdh.HllvX50cXC0"
                            else id = "qHIGkVqSItK.HllvX50cXC0"

                            // let year = index == 24 ? endYear - 1 : endYear - 2;
                            // if (index == 30) year = endYear;
                            year = endYear
                        
                            let num = deValues[`${index}_${year}`] || deValues[`${index}_${year}`] === 0 ? deValues[`${index}_${year}`] : "";
                            let deno = (dataValues[`${id}_${year}`] ? dataValues[`${id}_${year}`] : 0)

                            val = num && deno && num / deno && num / deno != "Infinity" || num === 0 ? deno === 0 ? "0.00" : ((num / deno) * 100).toFixed(2) : (hasCommentedValue[index + "_" + year] ? hasCommentedValue[index + "_" + year] : '');
                            tabledata += `<td style="font:bold; border:1px solid black;">${val}</td>`;
                        }
                        else {

                            val = !isNaN(deValues[`${index}_${endYear}`]) ? Number(deValues[`${index}_${endYear}`]) : (hasCommentedValue[index + "_" + endYear] ? hasCommentedValue[index + "_" + endYear] : 'NR');
                            tabledata += `<td style="font:bold; border:1px solid black;">${val}</td>`;

                        }

                        if (ouRegion) {
                            val = val && !isNaN(val) || val === 0 ? Number(val) : ''
                            if (!valuesParentTotal[ouRegion][counter]) valuesParentTotal[ouRegion][counter] = '';
                            if (val || val === 0) valuesParentTotal[ouRegion][counter] = Number(valuesParentTotal[ouRegion][counter]) + Number(val);

                            if (!valuesParentTotal['x3i5oi4axNu'][counter]) valuesParentTotal['x3i5oi4axNu'][counter] = '';
                            if (val || val === 0) valuesParentTotal['x3i5oi4axNu'][counter] = Number(val) + Number(valuesParentTotal['x3i5oi4axNu'][counter]);

                            if (hasCommentedValue[index + "_" + endYear]) {
                                if (!hasOUCommentedValue[ouRegion]) hasOUCommentedValue[ouRegion] = {};
                                hasOUCommentedValue[ouRegion][counter] = hasCommentedValue[index + "_" + endYear]
                                hasOUCommentedValue['x3i5oi4axNu'][counter] = hasCommentedValue[index + "_" + endYear];
                            }
                            counter++;
                        }
                    })
                    tabledata += '</tr>';
                    document.getElementById("dataTable").innerHTML += tabledata;
                }
            });
        })
        if (orgUnitLevel != 3) {
            let totalData = '<tr style="border:1px solid black; background-color:#DCDCDC"><td style="font:bold;" colspan = "2">Total</td>'

            dataElementIds.forEach((de, counter) => {
                if(counter==0 || counter==11) {                
                    let val = dataValuesParent[`${dataValuesParent[ouRegion]}_${de}.${endYear}`] ? Math.round(dataValuesParent[`${dataValuesParent[ouRegion]}_${de}.${endYear}`])  : hasOUCommentedValue[ouRegion] && hasOUCommentedValue[ouRegion][counter] ? hasOUCommentedValue[ouRegion][counter] : "NR";
                    totalData += `<td style="font:bold;background-color:#eaeaea">${val}</td>`;
                }
                else if(de=="PQCJ1jNYVMU") {
                    let val = dataValuesParent[`${dataValuesParent[ouRegion]}_${de}.${endYear}`] ? Number(dataValuesParent[`${dataValuesParent[ouRegion]}_${de}.${endYear}`]) : (valuesParentTotal[ouRegion] && valuesParentTotal[ouRegion][counter] === 0 ? valuesParentTotal[ouRegion][counter] : hasOUCommentedValue[ouRegion] && hasOUCommentedValue[ouRegion][counter] ? hasOUCommentedValue[ouRegion][counter] : "NR");
                    totalData += `<td style="font:bold;background-color:#eaeaea">${val}</td>`;
                }
                else if(de=='xWUvequQxeM') {
                    let val = dataValuesParent[`${dataValuesParent[ouRegion]}_${de}.${endYear}`] ? Number(dataValuesParent[`${dataValuesParent[ouRegion]}_${de}.${endYear}`]) : (valuesParentTotal[ouRegion] && valuesParentTotal[ouRegion][counter] === 0 ? valuesParentTotal[ouRegion][counter] : hasOUCommentedValue[ouRegion] && hasOUCommentedValue[ouRegion][counter] ? hasOUCommentedValue[ouRegion][counter] : "NR");
                    totalData += `<td style="font:bold;background-color:#eaeaea">${val}</td>`;
                }
                else if (de) {                    
                    let val = dataValuesParent[`${dataValuesParent[ouRegion]}_${de}.${endYear}`] ? Number(dataValuesParent[`${dataValuesParent[ouRegion]}_${de}.${endYear}`]) : (valuesParentTotal[ouRegion] && valuesParentTotal[ouRegion][counter] === 0 ? valuesParentTotal[ouRegion][counter] : hasOUCommentedValue[ouRegion] && hasOUCommentedValue[ouRegion][counter] ? hasOUCommentedValue[ouRegion][counter] : "NR");
                    totalData += `<td style="font:bold;background-color:#eaeaea">${val}</td>`;
                }
                else {
                    let val = (valuesParentTotal[ouRegion] && valuesParentTotal[ouRegion][counter] || valuesParentTotal[ouRegion][counter] === 0 ? valuesParentTotal[ouRegion][counter] : hasOUCommentedValue[ouRegion] && hasOUCommentedValue[ouRegion][counter] ? hasOUCommentedValue[ouRegion][counter] : "NR");
                    totalData += `<td style="font:bold;background-color:#eaeaea">${val}</td>`;
                }
            })
            totalData += '</tr>'
            document.getElementById("dataTable").innerHTML += totalData;
        } else {

            let totalData = '<tr style="border:1px solid black; background-color:#DCDCDC"><td style="font:bold;" colspan = "2">Total</td>'

            dataElementIds.forEach((de, counter) => {
                let val = (valuesParentTotal[ouRegion] && valuesParentTotal[ouRegion][counter] || valuesParentTotal[ouRegion][counter] === 0 ? valuesParentTotal[ouRegion][counter] : hasOUCommentedValue[ouRegion] && hasOUCommentedValue[ouRegion][counter] ? hasOUCommentedValue[ouRegion][counter] : "NR");
                totalData += `<td style="font:bold;background-color:#eaeaea">${val}</td>`;
            })
            totalData += '</tr>'
            document.getElementById("dataTable").innerHTML += totalData;
        }
    }

    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="https://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            document.getElementById("show").style.display = "block";
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = filename;
            document.getElementById("dlink").click();
            document.getElementById("show").style.display = "none";
        }
    })()

</script>