<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ"
crossorigin="anonymous">


<style>
        table {
            border-collapse: collapse;
        }

        thead>tr>td {
        font-weight: bold;
        }
        tbody>tr>td {
        font-weight: bold;
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button {  
        opacity: 1;
        }

        /* Center the loader  */
        #loader {
        position: absolute;
        left: 50%;
        top: 50%;
        z-index: 1;
        width: 150px;
        height: 150px;
        margin: -75px 0 0 -75px;
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #34B4DB;
        width: 120px;
        height: 120px;
        -webkit-animation: spin 2s linear infinite;
        animation: spin 2s linear infinite;
        }
        
        @-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
        }
        }
        
        @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
        }
        /* Add animation to "page content" */
        
        .animate-bottom {
        position: relative;
        -webkit-animation-name: animatebottom;
        -webkit-animation-duration: 1s;
        animation-name: animatebottom;
        animation-duration: 1s
        }
        
        @-webkit-keyframes animatebottom {
        from {
            bottom: -100px;
            opacity: 0
        }
        to {
            bottom: 0px;
            opacity: 1
        }
        }
        
        @keyframes animatebottom {
        from {
            bottom: -100px;
            opacity: 0
        }
        to {
            bottom: 0;
            opacity: 1
        }
        }
        
        #printing {
        
        text-align: center;
        }
    </style>
        
<a id="dlink" style="display:none;"></a>
<button type="button" class="btn btn-primary btn-sm" style="vertical-align: middle;" onclick="printContent('printing')"><span
    class="glyphicon glyphicon-print" style="font-size: 15px;"></span> &nbsp; Print
</button>

<button type="button" class="btn btn-success btn-sm" style="vertical-align: middle;" id="btnExport" onclick="tableToExcel('dataTable', 'Gynaecology Summary Report', 'Gynaecology Summary Report.xls')"><span
    class="glyphicon glyphicon-download-alt" style="font-size: 15px;"></span>Download As Excel</button> 


<div id="loader"></div>
<div id="printing" class="animate-bottom">
    <div id='state'>
        <table  border="1"   id="dataTable"   class="table  table-hover text-center" cellspacing="6" cellpadding="4" style="border-collapse: collapse; text-align: center">
            <thead id="tableHead" >
                <tr style="font-weight:800; text-align:center;">   
                    <td colspan = "25" style="border:1px solid black;background:#ADD8E6;"> Gynaecology Summary Report - CHC - <span id="date"></span></td>
                <tr style="font-weight:800; text-align:center;">
                    <td rowspan="3" style="border:1px solid black;background:#ADD8E6;">District Name</td>
                    <td rowspan="3" style="border:1px solid black;background:#ADD8E6;">Name of Institution</td>
                    <td rowspan="3" style="border:1px solid black;background:#ADD8E6;">Category</td>
                    <td rowspan="3" style="border:1px solid black;background:#ADD8E6;">No. of beds</td>
                    <td colspan="2" style="border:1px solid black;background:#ADD8E6;">IPHS Standard</td>
                    <td rowspan="3" style="border:1px solid black;background:#ADD8E6;">Sanction posts</td>
                    <td rowspan="3" style="border:1px solid black;background:#ADD8E6;">In position</td>
                    <td rowspan="3" style="border:1px solid black;background:#ADD8E6;">Gap as per IPHS</td>
                    <td rowspan="3" style="border:1px solid black;background:#ADD8E6;">Gap as per sanctioned posts</td>
                    <td colspan="5" style="border:1px solid black;background:#ADD8E6;">Upto previous month</td>
                    <td colspan="5" style="border:1px solid black;background:#ADD8E6;">During month </td>
                    <td colspan="5" style="border:1px solid black;background:#ADD8E6;">Cumulative </td>
                </tr>

                <tr style="font-weight:800; text-align:center;">
                    
                    <td rowspan="2" style="border:1px solid black;background:#ADD8E6;">Essential</td>
                    <td rowspan="2" style="border:1px solid black;background:#ADD8E6;">Desired</td>
                    <td colspan="2" style="border:1px solid black;background:#ADD8E6;">Day Time</td>
                    <td colspan="2" style="border:1px solid black;background:#ADD8E6;">Night Time</td>
                    <td rowspan="2" style="border:1px solid black;background:#ADD8E6;">Total</td>
                    <td colspan="2" style="border:1px solid black;background:#ADD8E6;">Day Time</td>
                    <td colspan="2" style="border:1px solid black;background:#ADD8E6;">Night Time</td>
                    <td rowspan="2" style="border:1px solid black;background:#ADD8E6;">Total</td>
                    <td colspan="2" style="border:1px solid black;background:#ADD8E6;">Day Time</td>
                    <td colspan="2" style="border:1px solid black;background:#ADD8E6;">Night Time</td>
                    <td rowspan="2" style="border:1px solid black;background:#ADD8E6;">Total</td>
                </tr>

                <tr style="font-weight:800; text-align:center;">
                        <td style="border:1px solid black;background:#ADD8E6;">Normal</td>
                        <td style="border:1px solid black;background:#ADD8E6;">Caesarian</td>
                        <td style="border:1px solid black;background:#ADD8E6;">Normal</td>
                        <td style="border:1px solid black;background:#ADD8E6;">Caesarian</td>
                        <td style="border:1px solid black;background:#ADD8E6;">Normal</td>
                        <td style="border:1px solid black;background:#ADD8E6;">Caesarian</td>
                        <td style="border:1px solid black;background:#ADD8E6;">Normal</td>
                        <td style="border:1px solid black;background:#ADD8E6;">Caesarian</td>
                        <td style="border:1px solid black;background:#ADD8E6;">Normal</td>
                        <td style="border:1px solid black;background:#ADD8E6;">Caesarian</td>
                        <td style="border:1px solid black;background:#ADD8E6;">Normal</td>
                        <td style="border:1px solid black;background:#ADD8E6;">Caesarian</td>
                </tr>
                
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>
<script>

    var selectedOrgUnit = [dhis2.report.organisationUnit];  
    var orgUnit = dhis2.report.organisationUnitChildren;
    var organisationUnitChildren = orgUnit.sort((a,b)=> a.name.localeCompare(b.name));
    var orgUnitLevel = dhis2.report.organisationUnitHierarchy.length;

    var months = ["Jan", "Feb", "Mar", "Apr", "May", "June", "July", "Aug", "Sep", "Oct", "Nov", "Dec"]
    var selectedDate = dhis2.report.periods[0];
    var month = selectedDate.slice(4,6);
    var year = month >= 4  ? selectedDate.slice(0,4) :  selectedDate.slice(0,4)-1;
    var period, totalPeriod;
    if(month != 4) {
        period = function() {
        var currentYear;
        var arr = [];
        
        if(month > 4) {
            for(let j = 4; j < month; j++) {
                let str = j >= 10 ? j : "0"+j;
                arr[j-4] = `${year}${str}`;
            }
        } else {
            for(let j = 4; j <= 12; j++) {
                let str = j >= 10 ? j : "0"+j;
                arr[j-4] = `${year}${str}`;
            }
            currentYear = year+1
            for(let k=1; k < month; k++){
            let str = "0"+ k;
             arr[8+k] = `${currentYear}${str}`;
            }
        }
        return arr;

        }
        totalPeriod = period().join(";")
       
    }
     
    
    var printTableBody ='';
    var printValue = [],total = [], globalTotal = [];
    for(var i = 0; i < 25; i++) {
        printValue["value"+i] = 0;
        total["value"+i] = 0;
        globalTotal["value"+i] = 0;
    }    
    

    var childParent = [], block = [];
    var IPHSLeftCol = [], IPHSRightCol = [];

    document.getElementById("date").innerHTML = months[month-1] + " " + (month >= 4 ?  Number(year) : (Number(year)+1));

    // to get the level3 as value and level 5 as key of childParent
    $.ajax({
                type: "GET",
                async: false,
                url: "../api/sqlViews/LKCILcpyZW9/data.json?paging=false",
                data: JSON,
                success: function (data, status) {
                    data.listGrid.rows.forEach( child => childParent[child["19"]] = child["11"] );                   
                }
              });

    //getting chc organisation unit
    $.ajax({
                type: "GET",
                async: false,
                url: "../api/29/organisationUnitGroups/Kn6u8kZPK51.json?fields=name,organisationUnits[id,name]&paging=false",
                data: JSON,
                success: function (data, status) {
                    block["CHC"] = data.organisationUnits;                   
                }
              });
    //data is coming from two pivot and they are stored in array name: IPHSLeftCol  & IPHSRightCol: IPHSRightCol["During"] && IPHSRightCol["upto"]
    //Api for them and they are given below : 

    //1st pivot - Gynaecology summary report (IPHS) -part1
    $.ajax({
                type:"GET",
                async: false,
                url: "../api/29/analytics.json?dimension=pe:" + year + "April&dimension=dx:ELqjRpVEVZU;NwpkLnF1FW7;WPoZDq2AQ9T;Qxl8DZ7SXZh;C7bHw1fFR21&dimension=ou:" + selectedOrgUnit["0"].id + ";LEVEL-5&displayProperty=NAME",
                data:JSON,
                success: function (datas) {
                    if(datas.rows.length) {
                        datas.rows.forEach( data => {
                            if(!IPHSLeftCol[data["2"]]) IPHSLeftCol[data["2"]] = [];
                            if(data["0"] == "ELqjRpVEVZU") {
                                IPHSLeftCol[data["2"]]["0"] = Number(data["3"]);
                            }
                            if(data["0"] == "NwpkLnF1FW7") {
                                IPHSLeftCol[data["2"]]["1"] = Number(data["3"]);
                            }
                            if(data["0"] == "WPoZDq2AQ9T") {
                                IPHSLeftCol[data["2"]]["2"] = Number(data["3"]);
                            }
                            if(data["0"] == "Qxl8DZ7SXZh") {
                                IPHSLeftCol[data["2"]]["3"] = Number(data["3"]);
                            }
                            if(data["0"] == "C7bHw1fFR21") {
                                IPHSLeftCol[data["2"]]["4"] = Number(data["3"]);
                            }
                    
                        })

                    }
                    
                }
            });

    //2nd pivot - Gynaecology summary report (IPHS) -part2
    //IPHSRightCol["During"] 
    $.ajax({
                type:"GET",
                async: false,
                url: "../api/29/analytics.json?dimension=pe:" + selectedDate + "&dimension=dx:zjdNpjSpWd0;lM5THoI5E2Z;IIh2lXcYXhD;N9y3eskwVew&dimension=ou:" + selectedOrgUnit["0"].id + ";LEVEL-5&displayProperty=NAME",
                data:JSON,
                success: function (datas) {
                    IPHSRightCol["duringMonth"] = [];
                    if(datas.rows.length) {
                        datas.rows.forEach( data => {
                            if(!IPHSRightCol["duringMonth"][data["2"]]) IPHSRightCol["duringMonth"][data["2"]] = [];
                            if(data["0"] == "zjdNpjSpWd0") {
                                IPHSRightCol["duringMonth"][data["2"]]["0"] = Number(data["3"]);
                            }
                            if(data["0"] == "IIh2lXcYXhD") {
                                IPHSRightCol["duringMonth"][data["2"]]["1"] = Number(data["3"]);
                            }
                            if(data["0"] == "lM5THoI5E2Z" ) {
                                IPHSRightCol["duringMonth"][data["2"]]["2"] = Number(data["3"]);
                            }
                            if(data["0"] == "N9y3eskwVew") {
                                IPHSRightCol["duringMonth"][data["2"]]["3"] = Number(data["3"]);
                            }
                        })
                    }

                    
                }
            });
    
    // IPHSRightCol["upToMonth"] 
    if(month != 4) {
        $.ajax({
                type:"GET",
                async: false,
                url: "../api/29/analytics.json?dimension=pe:" + totalPeriod + "&dimension=dx:zjdNpjSpWd0;lM5THoI5E2Z;IIh2lXcYXhD;N9y3eskwVew&dimension=ou:" + selectedOrgUnit["0"].id + ";LEVEL-5&displayProperty=NAME",
                data:JSON,
                success: function (datas) {
                    IPHSRightCol["upToMonth"] = [];
                    if(datas.rows.length) {
                        datas.rows.forEach( data => {
                            if(!IPHSRightCol["upToMonth"][data["2"]]) IPHSRightCol["upToMonth"][data["2"]] = [];
                            if(data["0"] == "zjdNpjSpWd0") {
                                if(!IPHSRightCol["upToMonth"][data["2"]]["0"]) IPHSRightCol["upToMonth"][data["2"]]["0"] = Number(data["3"]);
                                else IPHSRightCol["upToMonth"][data["2"]]["0"] += Number(data["3"]);
                            }
                            if(data["0"] == "IIh2lXcYXhD") {
                                if(!IPHSRightCol["upToMonth"][data["2"]]["1"]) IPHSRightCol["upToMonth"][data["2"]]["1"] = Number(data["3"]);
                                else IPHSRightCol["upToMonth"][data["2"]]["1"] += Number(data["3"]);
                           }
                            if(data["0"] == "lM5THoI5E2Z") {
                                if(!IPHSRightCol["upToMonth"][data["2"]]["2"]) IPHSRightCol["upToMonth"][data["2"]]["2"] = Number(data["3"]);
                                else IPHSRightCol["upToMonth"][data["2"]]["2"] += Number(data["3"]);
                            }
                            if(data["0"] == "N9y3eskwVew") {
                                if(!IPHSRightCol["upToMonth"][data["2"]]["3"]) IPHSRightCol["upToMonth"][data["2"]]["3"] = Number(data["3"]);
                                else IPHSRightCol["upToMonth"][data["2"]]["3"] += Number(data["3"]);
                            }
                        })
                    }
                }
            });
    }
    

    getOrgUnitChildren();

    function getOrgUnitChildren() { 
            if(orgUnitLevel == 2) {
                passToGroup(organisationUnitChildren);            

            } else if( orgUnitLevel == 3) {                
                passToGroup(selectedOrgUnit);
            }
        
        }
    
        function passToGroup(children) {
            let chcGrandTotalCounter = 0, showTotal = false;
            children.forEach( child  => {
                let chcTotalCounter = 0;
                    block["CHC"].forEach( CHCChild => {
                        if(child.name == childParent[CHCChild.name]) {
                            showTotal = true;
                            chcTotalCounter += 1; chcGrandTotalCounter += 1;

                            showData(CHCChild,child.name, "CHC")
                        }
                    })
                    if(showTotal) {
                        printTableBody += '<tr style="font-weight:400; text-align:center;">\
                                                    <td colspan="2" style="border:1px solid black;background:#DCDCDC;"> '+ child.name +' district Total (CHC)</td>\
                                                    <td style="border:1px solid black;background:#DCDCDC;"> '+ chcTotalCounter +'</td>'
                        for(let i=3; i<25;i++) {
                            printTableBody += '<td  style="border:1px solid black;background:#DCDCDC;">' + total["value"+i] + '</td>' 
                            globalTotal["value" + i] += Number(total["value" + i] );
                            total["value"+i] = 0;              
                        }
                        printTableBody += '</tr>';
                        showTotal = false;
                    }
                })
                if( orgUnitLevel != 3) { 
                    printTableBody += '<tr style="font-weight:400; text-align:center;">\
                                                    <td colspan="2" style="border:1px solid black;background:#DCDCDC;">State Total</td>\
                                                    <td style="border:1px solid black;background:#DCDCDC;"> '+ chcGrandTotalCounter +'</td>'
                        for(let i=3; i<25;i++) {
                            printTableBody += '<td  style="border:1px solid black;background:#DCDCDC;">' + globalTotal["value"+i] + '</td>';                                     
                        }
                        printTableBody += '</tr>';
                }

        }

        
        function showData(orgUnitChild, orgUnit, group) {
            printValue["value"+0] = orgUnit;
            printValue["value"+1] = orgUnitChild.name;
            printValue["value"+2] = group;

            if(IPHSLeftCol[orgUnitChild.id]) {
                printValue["value"+3] = IPHSLeftCol[orgUnitChild.id]["0"];
                printValue["value"+4] = IPHSLeftCol[orgUnitChild.id]["1"];
                printValue["value"+5] = IPHSLeftCol[orgUnitChild.id]["2"];
                printValue["value"+6] = IPHSLeftCol[orgUnitChild.id]["3"];
                printValue["value"+7] = IPHSLeftCol[orgUnitChild.id]["4"];
                printValue["value"+8] = printValue["value"+5] - printValue["value"+7];
                printValue["value"+9] = printValue["value"+6] - printValue["value"+7];
            }
            if(IPHSRightCol["upToMonth"]) {
                if(IPHSRightCol["upToMonth"][orgUnitChild.id]) {
                    printValue["value"+10] = IPHSRightCol["upToMonth"][orgUnitChild.id]["0"];
                    printValue["value"+11] = IPHSRightCol["upToMonth"][orgUnitChild.id]["1"];
                    printValue["value"+12] = IPHSRightCol["upToMonth"][orgUnitChild.id]["2"];
                    printValue["value"+13] = IPHSRightCol["upToMonth"][orgUnitChild.id]["3"];
                    printValue["value"+14] = Number(printValue["value"+10]) + Number(printValue["value"+11]) + Number(printValue["value"+12]) + Number(printValue["value"+13]);
                    
                }
            }
            if(IPHSRightCol["duringMonth"]) {
                if(IPHSRightCol["duringMonth"][orgUnitChild.id]) {
                    printValue["value"+15] = IPHSRightCol["duringMonth"][orgUnitChild.id]["0"];
                    printValue["value"+16] = IPHSRightCol["duringMonth"][orgUnitChild.id]["1"];
                    printValue["value"+17] = IPHSRightCol["duringMonth"][orgUnitChild.id]["2"];
                    printValue["value"+18] = IPHSRightCol["duringMonth"][orgUnitChild.id]["3"];
                    printValue["value"+19] = Number(printValue["value"+15]) + Number(printValue["value"+16]) + Number(printValue["value"+17]) + Number(printValue["value"+18]);
            

                }}
               
                printValue["value"+20] = Number(printValue["value"+10]) + Number(printValue["value"+15]);
                printValue["value"+21] = Number(printValue["value"+11]) + Number(printValue["value"+16]);
                printValue["value"+22] = Number(printValue["value"+12]) + Number(printValue["value"+17]);
                printValue["value"+23] = Number(printValue["value"+13]) + Number(printValue["value"+18]);
                printValue["value"+24] = Number(printValue["value"+14]) + Number(printValue["value"+19]);
                
                if(!printValue["value"+3]) printValue["value"+3] = 0;
                if(!printValue["value"+4]) printValue["value"+4] = 0;
                if(!printValue["value"+5]) printValue["value"+5] = 0;
                if(!printValue["value"+6]) printValue["value"+6] = 0;
                if(!printValue["value"+7]) printValue["value"+7] = 0;
                if(!printValue["value"+8]) printValue["value"+8] = 0;
                if(!printValue["value"+9]) printValue["value"+9] = 0;
                if(!printValue["value"+10]) printValue["value"+10] = 0;
                if(!printValue["value"+11]) printValue["value"+11] = 0;
                if(!printValue["value"+12]) printValue["value"+12] = 0;
                if(!printValue["value"+13]) printValue["value"+13] = 0;
                if(!printValue["value"+14]) printValue["value"+14] = 0;
                if(!printValue["value"+15]) printValue["value"+15] = 0;
                if(!printValue["value"+16]) printValue["value"+16] = 0;
                if(!printValue["value"+17]) printValue["value"+17] = 0;
                if(!printValue["value"+18]) printValue["value"+18] = 0;
                if(!printValue["value"+19]) printValue["value"+19] = 0;

                printTableBody += '<tr style="font-weight:800; text-align:center;">'
                        for(let i=0; i<25;i++) {
                            printTableBody += '<td>' + printValue["value"+i] + '</td>' 
                            total["value" + i] += Number(printValue["value" + i] );
                            printValue["value"+i] = 0;              
                        }
                printTableBody += '</tr>';
        }
        
            
        document.getElementById('tableBody').innerHTML = printTableBody;
        document.getElementById("loader").style.display = "none";
        document.getElementById("printing").style.display = "block"; 

        var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = filename;
            document.getElementById("dlink").click();
        }
        })() 
</script>

<!-- printing script -->
<script type="text/javascript">
        function printContent(el) {
            var restorepage = document.body.innerHTML;
            var printcontent = document.getElementById(el).innerHTML;
            document.body.innerHTML = printcontent;
            window.print();
            document.body.innerHTML = restorepage;
        }

</script>