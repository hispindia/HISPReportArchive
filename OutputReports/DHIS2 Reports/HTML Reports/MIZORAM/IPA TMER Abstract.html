<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
    integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<style>
    /* Absolute Center Spinner */
    * {
        font-family: 'Times New Roman', Times, serif;
    }

    .borderless,
    .borderless th,
    .borderless td {
        border: 0;
        border-collapse: collapse;
    }

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }

    .box {
        width: 50%;
        float: left;
    }
</style>

</head>

<body>

    <button type="button" class="btn btn-success btn-sm" style="vertical-align: middle" id="downlaods"
        onclick="tableToExcel('output', 'IPA TMER Abstract', 'IPA TMER Abstract')">
        <span class="glyphicon glyphicon-download-alt" style="font-size: 15px"></span>Download As Excel
    </button>

    <div class="loading" id="loader"></div>

    <a id="dlink" style="display:none;"></a>
    <div id="main">
        <!-- <div style="width: 40%; margin-left:30%;">
            <table class="table table-bordered">
                <tr>
                    <td style="font-size: 15px;padding-top: 15px;">
                        Start Date </td>
                    <td style="width: 60%;">
                        <input type="date" class=" form-control" id="start-date">
                    </td>
                </tr>
                <tr>
                    <td style="font-size: 15px;padding-top: 15px;">
                        End Date
                    </td>
                    <td style="width: 60%;">
                        <input type="date" class=" form-control" id="end-date">
                    </td>
                </tr>
                <tr>
                    <td><button onClick="submit()" class="btn btn-primary" id="tap">Submit</button></td>
                    <td style="text-align: right;">
                        <div id="downloads" style="display: none;">
                            <img src="https://img.icons8.com/color/35/000000/ms-excel.png"
                                onmouseover="this.style.cursor='pointer'"
                                onclick="tableToExcel('output', 'IPA TMER Abstract', 'IPA TMER Abstract')"
                                alt="xls" style="cursor: pointer;">
                        </div>
                    </td>


                </tr>
            </table>
        </div> -->
        <br>
        <div id="output" style="display: none;">


            <table class="table table-hover" style="width:100%;text-align:center" id="report-table">
                <thead style="font-weight: bold;">
                    <tr>
                        <td colspan="23" style="text-align:center;">
                            <h5> Report generated on: <span id="curr-date"></span> <br />Report ID:<span
                                    id="curr-count"></span>
                            </h5>

                        </td>
                    </tr>
                    <tr>

                    </tr>
                    <tr>
                        <td colspan="23"
                            style="text-align:center; background: rgb(39, 102, 150);font-size:20px; color:white">IPA
                            TMER Abstract
                            <br />
                            <span id="quater-year"></span>
                        </td>
                    </tr>
                    <tr>
                        <td rowspan="2" style="text-align:center; background:#f2f2f2">Sl. No</td>
                        <td rowspan="2" style="text-align:center; background:#f2f2f2">District</td>
                        <td rowspan="2" style="text-align:center; background:#f2f2f2">Name of IPA</td>
                        <td rowspan="2" style="text-align:center; background:#f2f2f2">IPA Unit</td>
                        <td colspan="3" style="text-align:center; background:#f2f2f2">Activity sheet</td>
                        <td colspan="4" style="text-align:center; background:#f2f2f2">Other Schemes/ Other source of
                            funding</td>
                        <td colspan="6" style="text-align:center; background:#f2f2f2">TMER Abstract</td>
                        <td colspan="5" style="text-align:center; background:#f2f2f2">Bank Reconciliation Statement
                            Abstract</td>
                        <td rowspan="2" style="text-align:center; background:#f2f2f2">Certified Utilisation amount of
                            MHSSP</td>
                    </tr>
                    <tr>
                        <td style="text-align:center; background:#f2f2f2">Approved Action plan</td>
                        <td style="text-align:center; background:#f2f2f2">Funds Received</td>
                        <td style="text-align:center; background:#f2f2f2">Funds utilised</td>
                        <td style="text-align:center; background:#f2f2f2">Opening Balance</td>
                        <td style="text-align:center; background:#f2f2f2">Funds receipt from other Scheme </td>
                        <td style="text-align:center; background:#f2f2f2">Utilisation</td>
                        <td style="text-align:center; background:#f2f2f2">Closing Balance</td>
                        <td style="text-align:center; background:#f2f2f2">Opening Balance</td>
                        <td style="text-align:center; background:#f2f2f2">Funds receipt from MHSSP</td>
                        <td style="text-align:center; background:#f2f2f2">Other receipts</td>
                        <td style="text-align:center; background:#f2f2f2">Funds Utilised </td>
                        <td style="text-align:center; background:#f2f2f2">Other payments</td>
                        <td style="text-align:center; background:#f2f2f2">Closing Balance</td>
                        <td style="text-align:center; background:#f2f2f2">Balance as per Bank Statement</td>
                        <td style="text-align:center; background:#f2f2f2">Total plus items</td>
                        <td style="text-align:center; background:#f2f2f2">Total minus Items</td>
                        <td style="text-align:center; background:#f2f2f2">Balance as per Cash Book</td>
                        <td style="text-align:center; background:#f2f2f2">Difference</td>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
</body>

<script>
    var selectedOrgUnit = dhis2.report.organisationUnit;
    var quaters = [
        "January-March",
        "April-June",
        "July-September",
        "October-December"
    ]
    var sno = 1;
    var orgUnits = [];
    var totalRows = '';
    var includedOrgUnitGroups = [];
    var dataElementIds = [
        '', 'g7BpEj08sCF', 'hZP3yMW6DrW', 'AC9jB4B3HyD', 'g4aENebKWAR', 'MGofBCvifQ8', '', 'pruqL3yxefO', 'f0a2dQQiU1s', 'BJr6LxgHJck', 'ESXDwaEJ3ph', 'ul7BDdSk6TL', 'Ufo684GsXCI', 'hIQ7ajZBPDY', 'nKylfBE3GZg', 'W54WaupIpFN', 'miqd2Td6pdy', 'adV6wRr8pSw', 'KJPVAwpIk0y'
    ]
    var quater = '';
    var dataStoreCount = 0;
    $.ajax({
        async: false,
        type: "GET",
        url: '../api/dataStore/reportCounts/tmer',
        success: function (data) {
            debugger;
            dataStoreCount = data;
        }
    });

    document.getElementById("output").style.display = "none";
    document.getElementById("loader").style.display = "block";

    //getting between dates
    var quater = dhis2.report.periods[0];
    var dateSelected = quaters[quater.split('Q')[1] - 1] + ', ' + quater.split('Q')[0]
    document.getElementById('quater-year').innerHTML = dateSelected;

    const orgUnitGroup = [{
        id: 'u52bDIwLiOG',
        name: 'PHC'
    }, {
        id: 'QbaIyUsVHJ9',
        name: 'CHC / SDH'
    }, {
        id: 'vTZ2yIeAi81',
        name: 'UPHC'
    }, {
        id: 'qvN06qQw9Hr',
        name: 'DH'
    }, {
        id: 'Y1P2f3awpzt',
        name: 'SHT'
    }, {
        id: 'D5YO4NsZtSp',
        name: 'DHT'
    }, {
        id: 'qsRLv1WjuiM',
        name: 'INS'
    }];

    const promises = (ouGroup) => {
        return ouGroup.map(ou => {
            return new Promise(resolve => fetch(`../api/organisationUnitGroups/${ou.id}.json?fields=id,name,organisationUnits[id,name]&paging=false`).then(res => res.json()).then(res => resolve(res)))
        })
    }
    Promise.all(promises(orgUnitGroup)).then((res, index) => {
        res.map(group => {
            group.organisationUnits.forEach(ou => includedOrgUnitGroups[ou.id] = group.name)
        })
    }).then(() => {
        const orgUnits = getOU();
        for (let i = 0; i < orgUnits.length; i++) getData(orgUnits[i].id, orgUnits[i].name, orgUnits[i].district);
    }).then(() => {
        document.getElementById("table-body").innerHTML = totalRows;
        document.getElementById("output").style.display = "block";
        document.getElementById("loader").style.display = "none";
    })

    function getOU() {
        $.ajax({
            async: false,
            type: "put",
            url: '../api/dataStore/reportCounts/tmer',
            data: JSON.stringify(++dataStoreCount),
            contentType: "application/json"
        });
        debugger;
        var date = new Date();
        date = `${('00' + date.getDate()).slice(-2)}/${('00' + (date.getMonth() + 1)).slice(-2)}/${date.getFullYear()}-${('00' + date.getHours()).slice(-2)}:${('00' + date.getMinutes()).slice(-2)}:${('00' + date.getSeconds()).slice(-2)}`


        document.getElementById("curr-date").innerHTML = date;
        document.getElementById("curr-count").innerHTML = date + '-' + dataStoreCount;

        var url = '../api/organisationUnits/' + selectedOrgUnit.id + '.json?paging=false&fields=id,name,level,dataSets[id]';
        $.ajax({
            type: "GET",
            async: false,
            url: '../api/organisationUnitLevels.json',
            data: JSON,
            success: function (data, status) {

                for (let i = 0; i < data.organisationUnitLevels.length; i++) {
                    url += ',children[id,name,level,dataSets[id]';
                }
                url += ']';
            }
        });
        $.ajax({
            type: "GET",
            async: false,
            url: url,
            data: JSON,
            success: function (data, status) {
                treeDown(data, '');
            }
        });


        async function treeDown(arr, district) {
            var key = arr;

            if (key.children.length) {
                key.children.sort((a, b) => a.name.localeCompare(b.name))
                for (let i = 0; i < key.children.length; i++) {
                    if (key.level == 2) district = key.name;

                    treeDown(key.children[i], district);
                }
            }


            if (includedOrgUnitGroups[key.id]) {
                orgUnits.push({ id: key.id, name: key.name, district })
            }
        }

        return orgUnits;

    }
    function getData(orgUnitId, orgUnit, district) {
        var dataObj = {};

        $.ajax({
            type: "GET",
            async: false,
            url: `../api/analytics.json?dimension=dx:${dataElementIds.join(';')}&&filter=pe:${quater}&dimension=ou:${orgUnitId}&displayProperty=NAME&outputIdScheme=UID&&skipRounding=true&paging=false`,
            data: JSON,
            success: function (response, status) {
                response.rows.forEach(row => {
                    dataObj[row[0]] = row[2];
                })
                totalRows += `<tr>
                <td>${sno++}</td>
                <td>${district}</td>
                <td>${orgUnit}</td>
                <td>${includedOrgUnitGroups[orgUnitId]}</td>`
                dataElementIds.forEach(de => {
                    totalRows += `<td>${(dataObj[de] ? Number(dataObj[de]) : '')}</td>`
                })
                totalRows += `</tr>`
            }
        });


    }


    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = `${filename}-${selectedOrgUnit.name}-${dateSelected}.xls`;
            document.getElementById("dlink").click();
        }
    })()


</script>