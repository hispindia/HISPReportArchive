<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
    integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<style>
    /* Absolute Center Spinner */
    * {
        font-family: 'Times New Roman', Times, serif;
    }

    .borderless,
    .borderless th,
    .borderless td {
        border: 0;
        border-collapse: collapse;
    }

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }

    .box {
        width: 50%;
        float: left;
    }
</style>

</head>

<body>
    <div class="loading" id="loader"></div>

    <a id="dlink" style="display:none;"></a>
    <div id="main">
        <div id="downloads" style="display: none;">
            <button class="btn btn-success" onclick="printContent('output')">Print
            </button>

        </div>
        <br>

        <div class="container w-50">
            <div class="m-2 row">
                <label for="start-date" class="col-3 col-form-label">Start Date</label>
                <div class="col-7">
                  <input type="date" class="form-control" id="start-date">
                </div>
              </div>
              <div class="m-2 row">
                <label for="end-date" class="col-3 col-form-label">End Date</label>
                <div class="col-7">
                  <input type="date" class="form-control" id="end-date">
                </div>
              </div>
    
              <div class="m-2 row">
                <button class="btn btn-primary" onclick="displayReport()">Submit</button>
              </div>
        </div>
        <div id="output" style="display: none;">
            <style>
                * {
                    font-family: 'Times New Roman', Times, serif;
                }

                .borderless,
                .borderless th,
                .borderless td {
                    border: 0;
                    border-collapse: collapse;
                }
            </style>

            <div id="date-count" style="display:none;text-align: center;">
                <h5> Report generated on: <span id="curr-date"></span> <br />Report ID:<span id="curr-count"></span>
                </h5>
            </div>
            <div style="text-align: center;">
                <img src="../api/documents/k6jP5EObI9Y/data" alt="mizoram health strn project" height='100'
                    width='100' />
            </div>
            <table class="table table-hover borderless" style="width:100%;text-align:center">
                <tbody>
                    <tr>
                        <td>
                            <h2>Mizoram Health Systems Strengthening Project</h2>
                            <h3>REPORT OF EX-ANTE VERIFICATION OF HEALTH FACILITIES</h3>
                        </td>
                    </tr>

                </tbody>
            </table>

            <table class="table table-hover borderless" style="width:100%;text-align:left">
                <tbody>
                    <tr>
                        <td>
                            <h5>NAME OF QUALITY ASSESSMENT TEAM: <span id="qa-team-name"></span></h5>
                            <h5>NAME OF IPA UNIT ASSESSED: <span id="ou"></span></h5>
                            <h5>DATE OF EX-ANTE ASSESSMENT:<span id="exAnte-startDate"></span><span
                                    id="exAnte-endDate"></span></h5>
                            <h5>PERIOD OF EX-ANTE ASSESSMENT: <span id="quater-dates"></span></h5>

                        </td>
                    </tr>
                </tbody>
            </table>

            <div>
                <h5 style="font-weight: 700;border-bottom:1px solid black;">SUMMARY</h5>
                <h5 style="font-weight: 700;">NQAS ASSESSMENT </h5>
                <h5 style="font-weight: 700;">NAME OF QUARTERLY FOCUSED AOC: All Areas of Concern</h5>
            </div>

            <table class="table table-bordered table-hover" style="width:100%;">
                <colgroup>
                    <col width="30%" />
                    <col width="30%" />
                    <col width="20%" />
                </colgroup>
                <thead>
                    <tr>
                        <td style="text-align: center;">
                            <h6>Assessment Type</h6>
                        </td>
                        <td style="text-align: center;">
                            <h6>Date of Assessment</h6>
                        </td>
                        <td style="text-align: center;">
                            <h6>Score</h6>
                        </td>

                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Self-Assessment</td>
                        <td style="text-align:center;" id="ps-programStage1"></td>
                        <td style="text-align:center;" id="de-HHUbvL1Z2aO"></td>
                    </tr>
                    <tr>
                        <td>Ex-Ante Assessment</td>
                        <td style="text-align:center;" id="ps-programStage2"></td>
                        <td style="text-align:center;" id="de-wJ3A5NF5Acj"></td>
                    </tr>
                </tbody>
            </table>


            <div>
                <h5 style="font-weight: 700;border-bottom:1px solid black;">IPA EX-ANTE ASSESSMENT SCORE</h5>
            </div>

            <table class="table table-bordered table-hover" width="100%">
                <colgroup>
                    <col width="40%" />
                    <col width="60%" />
                </colgroup>
                <thead>
                    <td style="background-color:e9ecef">
                        <h6>CODE</h6>
                    </td>
                    <td style="text-align: center;background-color:e9ecef">
                        <h6>Score</h6>
                    </td>
                </thead>
                <tbody id="code-score"></tbody>
            </table>

            <div>
                <h5 style="font-weight: 700;border-bottom:1px solid black;">Ex-Ante Assessment Observation</h5>
                <p id="ex-anteNotes"></p>
            </div>

            <div>
                <h5 style="font-weight: 700;border-bottom:1px solid black;">Ex-Ante Assessment Recommendation</h5>
                <p id="ex-anteRec"></p>
            </div>

            <div>
                <h5 style="font-weight: 700;border-bottom:1px solid black;">ASSESSORS</h5>
            </div>
            <div>
                <h5>Assessor I (Name and Designation): <span id="assessorI-nd"></span></h5>
                <h5>Assessor II (Name and Designation):<span id="assessorII-nd"></span></h5>
                <h5>Assessor III (Name and Designation): <span id="assessorIII-nd"></span> </h5>
            </div>
            <br>
            <div>
                <h5>Signature: </h5>
            </div>
            <div>
                <div style="width:30%;float:left;">
                    <span id="assessorI-sign"></span>
                    <br />
                    ________________
                    <br>
                    <p id="assessorI-designation"></p>
                </div>
                <div style="width:40%;float:left;">
                    <span id="assessorII-sign"></span>
                    <br />
                    __________________________
                    <br>
                    <p id="assessorII-designation"></p>
                </div>
                <div style="width:30%;float:left;">
                    <span id="assessorIII-sign"></span>
                    <br />
                    ________________
                    <br>
                    <p id="assessorIII-designation"></p>
                </div>
            </div>
            <div style="clear:both"></div>
            <div>
                <p style="font-style: italic;">
                    This document is computer generated and does not require the assessor’s physical signature in order
                    to be considered valid.</p>
            </div>
        </div>
    </div>
</body>

<script>
    document.getElementById("date-count").style.display = "none";
    document.getElementById("output").style.display = "none";

    var selectedOrgUnit = dhis2.report.organisationUnit;
    var pdfName = selectedOrgUnit.name + ' Report'
   
    var quaters = [
        "January-March",
        "April-June",
        "July-September",
        "October-December"
    ]

    var dataElement = [
        {
            id: 'tm5mca1RtIi',
            name: 'PHC_1_NQAS'
        },
        {
            id: 'yiLQuZMuSmj',
            name: 'PHC_2_Plannings'
        },
        {
            id: 'WSAbtRZhxM5',
            name: 'PHC_3_Plan Execution'
        },
        {
            id: 'BNyKVjqlhtL',
            name: 'PHC_4_Assesment'
        },
        {
            id: 'pMGCVgtvVOS',
            name: 'PHC_5_SC-HWC CBAC'
        },
        {
            id: 'cG5yglbpgRR',
            name: 'PHC_6_SC HWC Outreach'
        },
        {
            id: 'oPZ91aEQbxC',
            name: 'PHC_7_SC HWC Medicine'
        },
        {
            id: 'zWCr9GKfyTz',
            name: 'PHC_8_Low-Cost Medicine'
        },
        {
            id: 'TDPUQXGEy0n',
            name: 'PHC_9_Medicine Quality Test'
        },
        {
            id: 'mwBMY6pBnNt',
            name: 'PHC_10_Drug Store Quality/Dispensing Unit'
        },
        {
            id: 'NronO8j2Fft',
            name: 'PHC_11_Drug Dispensation'
        },
        {
            id: 'LA8oFJGjiX3',
            name: 'PHC_12_Knowledge'
        },
        {
            id: 'uIbs7yJJGEe',
            name: 'PHC_13_BMW'
        },
        {
            id: 'OjLkSpUqD2P',
            name: 'PHC_14_Outcome Quality'
        },
        {
            id: 'FuBMShCvsTa',
            name: 'PHC_15_Accountability'
        },
        {
            id: 'mdbSU6XYoK3',
            name: 'PHC_16_Patient Experience Score'
        },
        {
            id: 'uj9OgZ2awL0',
            name: 'PHC_17_Grievance'
        },
        {
            id: 'SdPujxa8O9N',
            name: 'PHC_18_HMIS Reporting'
        },
        {
            id: 'xSSLUxMZgqP',
            name: 'PHC_19_NCD Consultations'
        },
        {
            id: 'm50G1QGE4E8',
            name: 'TOTAL (Max 1000 points = 100%)'
        },
        {
            id: 'm50G1QGE4E8',
            name: 'PERCENTAGE'
        }
    ]
    var dataStoreCount = 0;
    $.ajax({
        async: false,
        type: "GET",
        url: '../api/dataStore/reportCounts/phcOM3',
        success: function (data) {
            debugger;
            dataStoreCount = data;
        }
    });
    $.ajax({
        async: false,
        type: "put",
        url: '../api/dataStore/reportCounts/phcOM3',
        data: JSON.stringify(++dataStoreCount),
        contentType: "application/json"
    });
    debugger;
    var date = new Date();
    date = `${('00' + date.getDate()).slice(-2)}/${('00' + (date.getMonth() + 1)).slice(-2)}/${date.getFullYear()}-${('00' + date.getHours()).slice(-2)}:${('00' + date.getMinutes()).slice(-2)}:${('00' + date.getSeconds()).slice(-2)}`
    pdfName += `(${date})-${dataStoreCount}`;

    document.getElementById("curr-date").innerHTML = date;
    document.getElementById("curr-count").innerHTML = date + '-' + dataStoreCount;

    function displayReport() {
        document.getElementById("date-count").style.display = "none";
        document.getElementById("output").style.display = "none";
        document.getElementById("loader").style.display = "block";
        var dates = {
            startDate: document.getElementById('start-date').value,
            endDate: document.getElementById('end-date').value,
        }
        if (!dates.startDate || !dates.endDate) {
            document.getElementById("loader").style.display = "none";
            alert("Please Select Dates Correctly!");
        } else {
            setTimeout(() => {
                getData(dates);
            }, 1000)
        }

    }

    async function getData(dates) {
        var dataObj = {};
        var selfAssessmentDate = ''

        var responseFirst = await (await fetch(`../api/events.json?fields=*&program=XdyicAxrGPC&orgUnit=${selectedOrgUnit.id}&startDate=${dates.startDate}&endDate=${dates.endDate}&paging=false`)).json();
        responseFirst.events.forEach(event => {
            if (event.programStage == "Oy7oALmesOu") {
                let obj = {};
                event.dataValues.forEach(dv => {
                    obj[dv.dataElement] = dv.value;
                    if (dv.dataElement == 'm50G1QGE4E8') {
                        let value = event.eventDate.split("T")[0];
                        let year = Number(value.split("-")[0]);
                        value = Number(value.split("-")[1]);
                        value = value >= 1 && value <= 3 ? 0 : value;
                        value = value >= 4 && value <= 6 ? 1 : value;
                        value = value >= 7 && value <= 9 ? 2 : value;
                        value = value >= 10 && value <= 12 ? 3 : value;
                        let quater = quaters[(value + '')].split('-');

                        obj["exAnte-ev"] = quater.length ? quater[0] + ' ' + year + ' - ' + quater[1] + ' ' + year : ''
                    }
                })
                if (obj['hqDoSMfLh8F'] == "Ex-Ante Assessment") dataObj = obj;
            }
            if (event.programStage == "SXAZ0n3NLgK") selfAssessmentDate = event.eventDate.split('T')[0]
        });

        if (dataObj['HHUbvL1Z2aO']) {
            document.getElementById("de-HHUbvL1Z2aO").innerHTML = dataObj['HHUbvL1Z2aO'];
        }
        document.getElementById("ps-programStage1").innerHTML = selfAssessmentDate;

        if (dataObj['wJ3A5NF5Acj']) {
            document.getElementById("ps-programStage2").innerHTML = (dataObj['i2afLnjFrdh'] ? dataObj['i2afLnjFrdh'] : '')
            document.getElementById("de-wJ3A5NF5Acj").innerHTML = Number(dataObj['wJ3A5NF5Acj']).toFixed(2);
        }
        document.getElementById('qa-team-name').innerHTML = (dataObj['D8fsB13w245'] ? dataObj['D8fsB13w245'] : '');
        document.getElementById('ou').innerHTML = selectedOrgUnit.name;
        document.getElementById('quater-dates').innerHTML = (dataObj["exAnte-ev"] ? dataObj["exAnte-ev"] : '');
        document.getElementById('exAnte-startDate').innerHTML = (dataObj['i2afLnjFrdh'] ? dataObj['i2afLnjFrdh'] : '');
        document.getElementById('exAnte-endDate').innerHTML = (dataObj['MkkWs8MkL8C'] ? ` to ${dataObj['MkkWs8MkL8C']}` : '');

        document.getElementById('ex-anteNotes').innerHTML = dataObj['kEmB5rxi38s'] ? dataObj['kEmB5rxi38s'] : '';
        document.getElementById('ex-anteRec').innerHTML = dataObj['EZBZprxThUz'] ? dataObj['EZBZprxThUz'] : '';

        document.getElementById('assessorI-nd').innerHTML = (dataObj['YHGt2ebEsPP'] ? dataObj['YHGt2ebEsPP'] : '') + (dataObj['Bt7OvMO4KoD'] ? `, ${dataObj['Bt7OvMO4KoD']}` : '');
        document.getElementById('assessorII-nd').innerHTML = (dataObj['tHlFqnqwV2o'] ? dataObj['tHlFqnqwV2o'] : '') + (dataObj['PEUbEOT8VNV'] ? `, ${dataObj['PEUbEOT8VNV']}` : '');
        document.getElementById('assessorIII-nd').innerHTML = (dataObj['g3xzqucnUyW'] ? dataObj['g3xzqucnUyW'] : '') + (dataObj['Zrt7faR6v76'] ? `, ${dataObj['Zrt7faR6v76']}` : '');
        document.getElementById('assessorI-sign').innerHTML = (dataObj['YHGt2ebEsPP'] ? dataObj['YHGt2ebEsPP'] : '');
        document.getElementById('assessorII-sign').innerHTML = (dataObj['tHlFqnqwV2o'] ? dataObj['tHlFqnqwV2o'] : '');
        document.getElementById('assessorIII-sign').innerHTML = (dataObj['g3xzqucnUyW'] ? dataObj['g3xzqucnUyW'] : '');
        document.getElementById('assessorI-designation').innerHTML = (dataObj['Bt7OvMO4KoD'] ? dataObj['Bt7OvMO4KoD'] : '');
        document.getElementById('assessorII-designation').innerHTML = (dataObj['PEUbEOT8VNV'] ? dataObj['PEUbEOT8VNV'] : '');
        document.getElementById('assessorIII-designation').innerHTML = (dataObj['Zrt7faR6v76'] ? dataObj['Zrt7faR6v76'] : '');

        var codeScore = '';
        dataElement.forEach(de => {
             if (de.id == "m50G1QGE4E8") {
                let value = dataObj['m50G1QGE4E8'] ? changeDec(dataObj['m50G1QGE4E8'], 2) : '';
                if (de.name == "PERCENTAGE") calculatedVal = value ? ((value / 1000) && value / 1000 != "Infinity" ? ((value / 1000) * 100).toFixed(2) : '') : '';
                else calculatedVal = value;
                codeScore += `<tr><td style="font-weight:bold">${de.name}</td><td style="text-align:center;font-weight:bold">${calculatedVal}</td></tr>`;
            }
            else codeScore += `<tr><td>${de.name}</td><td style="text-align:center">${(dataObj[de.id] ? formatNumber(dataObj[de.id]) : '')}</td></tr>`;
        })
        document.getElementById('code-score').innerHTML = codeScore;

        document.getElementById("date-count").style.display = "block";
        document.getElementById("output").style.display = "block";
        document.getElementById("downloads").style.display = "block";
        document.getElementById("loader").style.display = "none";

        function changeDec(val, index) {
            var isDec = val.includes('.');
            if (isDec) {
                return val.split('.')[0] + '.' + val.split('.')[1].slice(0, index)
            }
            return val;
        }
        
        function formatNumber(value) {
            const num = Number(value);
            if (isNaN(num)) return 'Invalid number';
            return Number.isInteger(num) ? num : Number(num.toFixed(2));
        }

    }

    function printContent(el) {
        window.parent.document.title = pdfName;
        var restorepage = document.body.innerHTML;
        var printcontent = document.getElementById("output").innerHTML;
        document.body.innerHTML = printcontent;
        window.print();
        window.location.reload();
    }

</script>