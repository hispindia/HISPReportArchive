<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
    integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<style>
    /* Absolute Center Spinner */
    * {
        font-family: 'Times New Roman', Times, serif;
    }

    .borderless,
    .borderless th,
    .borderless td {
        border: 0;
        border-collapse: collapse;
    }

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }

    .box {
        width: 50%;
        float: left;
    }
</style>

</head>

<body>

    <button type="button" class="btn btn-success btn-sm" style="vertical-align: middle;" id="btnExport"
        onclick="tableToExcel('main', 'IPA Action Plan Report', 'IPA Action Plan Report')"><span
            class="glyphicon glyphicon-download-alt" style="font-size: 15px;"></span>Download As Excel</button>

    <div class="loading" id="loader"></div>
    <a id="dlink" style="display:none;"></a>
    <div id="main">
        <table class="table table-hover borderless" style="width:100%;">
            <thead>
                <tr>
                    <td colspan="6" style="text-align:center;font-weight:bold;background:#ADD8E6 ">Mizoram Health Systems
                        Strengthening Project (MHSSP)<br />
                        Health &amp; Family Welfare Department, Govt of Mizoram</td>
                </tr>
                <tr>
                    <td colspan="6" style="text-align:center;font-weight:bold;background:#ADD8E6 ">
                        <span id="facility-period"></span><br />
                        Action Plan <br />
                    </td>
                </tr>
                <tr>
                    <td colspan="6" style="border:0">&nbsp;</td>
                </tr>
                <tr>
                    <td colspan="6" style="font-family:Tahoma,Geneva,sans-serif;font-weight:bold;background:#F3EFEF">
                        Sheet 1: Action Plan</td>
                </tr>
                <tr>
                    <td style="background:#ECEAEA"> S.No. </td>
                    <td style="background:#ECEAEA">Activity Name</td>
                    <td style="text-align: center;background:#ECEAEA">Activity Details</td>
                    <td style="background:#ECEAEA">Budget (quarterly) </td>
                    <td style="text-align: center;background:#ECEAEA">Quantum and Source of Funding</td>
                    <td style="text-align: center;background:#ECEAEA">Supporting Document Upload</td>
                </tr>

            </thead>
            <tbody id="table-body"> </tbody>
        </table>
    </div>
</body>

<script>
    var selectedOrgUnit = dhis2.report.organisationUnit;
    var period = dhis2.report.periods[0];
    var quaters = [
        "January-March",
        "April-June",
        "July-September",
        "October-December"
    ]
    var dataValues = {};
    var dataElements = {
        activityWiseReport: [
            ['VVIknvNFllm', 'p8xTDkgHsW6', 'f67ZajxqsmY', 'cicKzaKvLox'],
            ['YddG3Yozj2O', 'X2Ph3buRd9a', 'T771Iq8VT2A', 'qj2t3pDU4w2'],
            ['QO1TUAFfiXt', 'kAZ8rFbRTCG', 'bjIxerzHn5I', 'r9YjaO6c7xe'],
            ['ZnJL41tE81z', 'b02hLOPk0fw', 'HZ1HgQCVyxn', 'OxKOfVVEipR'],
            ['FB3gXdUJe5p', 'LxVdBnonnTv', 'D6pZljYsadH', 'MJdcTbO2Qmh'],
            ['jytj2fG3tXu', 'RA4BJMZStmE', 'u5kQHdYYwCQ', 'uELgwsuBfYM'],
            ['pLIGpTiEGOY', 'jQsROeoS85s', 'MKrd2jH7jwd', 'FZPZwquJtlk'],
            ['MK6mvL2275n', 'Mxsk25IRx5h', 'dZ0p1wsLlxT', 'SrSdThn5TOz'],
            ['s9CdwW8WLad', 'mC3iNEFTw0S', 'tQIUrnaw8em', 'GFky64f1peQ'],
            ['UVjnwhpXanc', 'UErPwRKsNeH', 'Y1j3Fzmdb2C', 'wcXjkQTMjlf'],
            ['IYRZq6iBPxW', 'gmwmPUQu7K2', 's3sFQBvDtck', 'K8l4SIh6qoW'],
            ['FNCeZ5UUh1H', 'C9C3VeQqP1e', 'u7XNv7vNtRI', 'tPG0y6YCHcF'],
            ['NUQ24Wh9pb7', 'on2WgJcH9Ey', 'GxAUWkXrFER', 'uE6TDRMy2cJ'],
            ['sCIYthcfmx0', 'lDugqUbxHmw', 'OVWjzpg5MbR', 'XCprqbvk2Br'],
            ['Oxi5BJa0KsV', 'RbCVwxzJrh7', 'oWBB3nXZyao', 'P8LHONWySOQ'],
            ['qNkFn6j2Rjs', 'AsuTj2YxrkA', 'YCyPhwdlnhJ', 'BHNx2VaztA5'],
            ['wDFLAGP8Cei', 'KBilxYniKrc', 't9J3Q9uAq7M', 'Xypd58ppaFc'],
            ['shbxKEeWt7N', 'SGccV2YGscJ', 'RfTr5esct2g', 'e2XIpKMQtMX'],
            ['VhCn7dkV1JE', 'z2XNnOfsIHA', 'PvY8PAuvPl2', 'ROVIHHpITi8'],
            ['pTjbxyiAXbO', 'C301MBJU6Q1', 'CHBVlZYKC6X', 'C7qzWSAJS0j'],
            ['YXc5AJnO01m', 'RL88HtoiII3', 'd9qCXvPwvKN', 'aF8bPEogu0g'],
            ['RtcTKj1EEDC', 'lvM5Gxd81Ix', 'DfPYoYcXgvh', 'yOJ29S2RZK6'],
            ['NqR9VtqLkx4', 'jChg5y14P85', 'pIuOKBVAdSt', 'nuSXSyhE9w7'],
            ['sFEaPaQvqC3', 'XfDHMPEKcnV', 'Zg05MMvbM4y', 'sEJxXB5SzcO'],
            ['yXF7gvrCI1a', 'f3eKY60yd8Z', 'PJHOU0BJJl5', 'AWmDo9CnLNF'],
            ['xblfT14iNPd', 'R12bs7FXxBK', 'PHfS3uEJuv5', 'KYVNjhEavKW'],
            ['mKesBVkrATj', 'V2Hr6fZqsHG', 'TV1Dbi9wf1A', 'uftCFWGetn0'],
            ['FwfcIGAyW2B', 'tn6IGY4oIme', 'CoCl9gnNirL', 'O1zYMGg1YqG'],
            ['Pmaqm4COVDG', 'rD0WgqBflwa', 'QgttonKkV4a', 'zY482xCZ6yn'],
            ['mRDFpN6oJfo', 'QugKRTkbVcX', 'J743VK4PSt7', 'Gfx8ga9Nx0n'],
            ['Ft4ST7a87Va', 'nD2eqz4rLD9', 'zJ6RtDeygra', 'jNyKnLk6lz4'],
            ['rKMDGuQ4Y1a', 'oEcXdsF777x', 'Eve795ahq6K', 'j9dgb5Hr7FJ'],
            ['AN9MWnmbG5J', 'wJPsHMKzxeo', 'IC8c3jA9xY4', 'Sr8hWVxtyeT'],
            ['Gsyuaogolic', 'AWWESppYbdN', 'cFMDSoWIzjb', 'FJIFc35rDEN'],
            ['w22J0KiRgct', 'PlaWvXPrhZz', 'dasteAUZj6i', 'bQ4dopxro5W'],
            ['xlp0dBYTO9q', 'GvTdnP7vggd', 'zHTq4YkoyjE', 'DlbfnvnUxK3'],
            ['A9OMeUq5NrD', 'F9ZrSObl62o', 'kdWOAP0qp62', 'CnLlzhkiSc9'],
            ['p1ZkomnlSth', 'NhHN9CmNorv', 'ULQbrC93FMZ', 'slmY5Me0gJ0'],
            ['v7JdCgGz3DA', 'PZFBdEUa4fH', 'r8acjkZdQht', 'LtaD4ipRwNV'],
            ['d6QMvfxEklP', 'vcGzNI247yv', 'N5jXQjXvhbJ', 'j8aEYkusuXP'],
            ['trL9Uh8hl1X', 'qoNybvVrjuN', 'spPKRKwYLlP', 'Q6mMYImiR1Z'],
            ['oR4p8obJscv', 'KUSgoWxvNp4', 'CYni90Wdcye', 'ydFuubRwgsg'],
            ['uSYLSVqZQsE', 'dgt4OtNKTS5', 'bGpDFmBFCsR', 'vq3DMWMdSyp'],
            ['aU8Pzn1VDOq', 'eyTUQtO4uap', 'pe0NQHbSnHm', 'paMDNzxg8x7'],
            ['KKquBC8hARB', 'ewukHCm4lrl', 'MvkUOs8FcXz', 'cbkAU1M5fT5'],
            ['iwxs0yzDvLM', 'q3SSJIY56Ti', 'XlMGhykbBSC', 'vNkRzPn8ab2'],
            ['pmKEF481Cks', 'nXfCBcpycDS', 'Xt6ZDOUnN2J', 'jap5BEKQ9aM'],
            ['cJVtnu7SzYi', 'Z2haAMr268q', 'lG8PQLJ8ebc', 'amjsjWBAJtJ'],
            ['Md9YJuNu3aI', 'ApF7cvp84CC', 'PSHRSrVPwaA', 'BcFphpiprbb'],
            ['Am0InfYIhRy', 'jmLk0HVDpBp', 'OwtHbSGfEDM', 'grPWsBYuJgb'],
        ]
    }

    document.getElementById("loader").style.display = "block";
    document.getElementById("facility-period").innerHTML = `${selectedOrgUnit.name} (${period.split('Q')[0]} ${quaters[(period.split('Q')[1] - 1)]})`

    displayData();
    async function displayData() {
        var resAnalytics = await (await fetch(`../api/analytics.json?dimension=dx:oY95j3Hxedf&dimension=pe:${period}&dimension=ou:${selectedOrgUnit.id}&paging=false`)).json();
        resAnalytics.rows.forEach(row => {
            dataValues[row[0]] = Number(row[3]);
        })
        debugger;
        var response = await (await fetch(`../api/dataValueSets.json?period=${period}&orgUnit=${selectedOrgUnit.id}&dataSet=wwcxotLHZGY`)).json();
        response.dataValues.forEach(dv => dataValues[dv.dataElement] = dv.value)
        console.log(response);
        var tableRow = '';
        dataElements.activityWiseReport.forEach((deIds, sno) => {
            let row = ''
            let hasValue = false;
            row += `<tr><td>${(sno + 1)}</td>`
            deIds.forEach(de => {
                if(dataValues[de]) {
                    row += `<td>${dataValues[de]}</td>`
                    hasValue = true;
                } else {
                    row += `<td></td>`
                }

            })
            row += '</tr>'
            if(hasValue) tableRow += row;
        })
        tableRow += `<tr>
            <td colspan="2" style="font-weight:bold"> Total </td>
            <td style="font-weight:bold"></td>
            <td style="font-weight:bold">${(dataValues['oY95j3Hxedf'] ? dataValues['oY95j3Hxedf'] : '')}</td>
            <td style="font-weight:bold"></td>
            <td style="font-weight:bold"></td>
            </tr>`;
        document.getElementById('table-body').innerHTML = tableRow;
        document.getElementById("loader").style.display = "none";
    }

    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = `${filename}_${selectedOrgUnit.name}_${quaters[(period.split('Q')[1] - 1)]}.xls`;
            document.getElementById("dlink").click();
        }
    })()

</script>