<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
    integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<style>
    /* Absolute Center Spinner */
    * {
        font-family: 'Times New Roman', Times, serif;
    }

    .borderless,
    .borderless th,
    .borderless td {
        border: 0;
        border-collapse: collapse;
    }

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }

    .box {
        width: 50%;
        float: left;
    }
</style>

</head>

<body>

    <div class="loading" id="loader"></div>

    <a id="dlink" style="display:none;"></a>

    <div id="downloads" style="display: none;">
        <button class="btn btn-success"
        onclick="tablesToExcel(['table-PHC','table-CHC', 'table-DH','table-SHT','table-DHT','table-DHT_CI'],['PHC','CHC', 'DH','SHT','DHT','DJT-CI'], 'OM3 IPA Ex-Ante Scores Compiled Report.xls','Excel')"
                >Download as Excel
            </button>
    </div>

    <div class="container w-50">
        <div class="m-2 row">
            <label for="start-date" class="col-3 col-form-label">Start Date</label>
            <div class="col-7">
              <input type="date" class="form-control" id="start-date">
            </div>
          </div>
          <div class="m-2 row">
            <label for="end-date" class="col-3 col-form-label">End Date</label>
            <div class="col-7">
              <input type="date" class="form-control" id="end-date">
            </div>
          </div>

          <div class="m-2 row">
            <button class="btn btn-primary" onclick="displayReport()">Submit</button>
          </div>
    </div>
    <div id="report-table" style="visibility:hidden">
    </div>
</body>

<script>
    document.getElementById('report-table').visibility = "hidden";
    document.getElementById("downloads").style.display = "none";

    var selectedOrgUnit = dhis2.report.organisationUnit;
    var quaters = [
        "January-March",
        "April-June",
        "July-September",
        "October-December"
    ]
    var includedOrgUnitGroups = {};
    var tableHead = {
        'PHC': [
            "S.No", "District", "IPA Unit", "IPA Type", 'Ex Ante Assessment Date', 'Ex-Ante Assessment NQAS Score (%)', 'PHC/UPHC_1_NQAS', 'PHC/UPHC_2_Plannings', 'PHC/UPHC_3_Plan_Execution', 'PHC/UPHC_4_Assesment', 'PHC/UPHC_5_SC_HWC_CBAC', 'PHC/UPHC_6_SC_HWC_Outreach', 'PHC/UPHC_7_SC_HWC_Medicine', 'PHC/UPHC_8_Low-cost_Medicine', 'PHC/UPHC_9_Medicine_Quality_Test', 'PHC/UPHC_10_Drug_Store_Quality/Dispensing_Unit', 'PHC/UPHC_11_Drug_Dispensation', 'PHC/UPHC_12_Knowledge', 'PHC/UPHC_13_BMW', 'PHC/UPHC_14_Outcome_Quality', 'PHC/UPHC_15_Accountability', 'PHC/UPHC_16_Patient_Experience_Score', 'PHC/UPHC_17_Grievance', 'PHC/UPHC_18_HMIS_Reporting', 'PHC/UPHC_19_NCD_Consultations', 'Ex-Ante Assessment Score', 'Ex-Ante Assessment Score (%)'
        ],
        'CHC': [
            "S.No", "District", "IPA Unit", "IPA Type", 'Ex Ante Assessment Date', 'Ex-Ante Assessment NQAS Score (%)', 'CHC/SDH_1_NQAS', 'CHC/SDH_2_Planning', 'CHC/SDH_3_Plan_Execution', 'CHC/SDH_4_Assesment', 'CHC/SDH_5_Blood', 'CHC/SDH_6_low-cost_medicine', 'CHC/SDH_7_Medicine_Quality_test', 'CHC/SDH_8_Drug_Store_Quality', 'CHC/SDH_9_drug_Dispensation', 'CHC/SDH_10_Knowledge', 'CHC/SDH_11_BMW', 'CHC/SDH_12_Outcome_quality', 'CHC/SDH_13_Accountability', 'CHC/SDH_14_patient_experience_score', 'CHC/SDH_15_grievance', 'CHC/SDH_16_HMIS_reporting', 'Ex-Ante Assessment Score', 'Ex-Ante Assessment Score (%)' 
        ],
        'DH': [
            "S.No", "District", "IPA Unit", "IPA Type", 'Ex Ante Assessment Date', 'Ex-Ante Assessment NQAS Score (%)', 'DH_1_NQAS', 'DH_2_Planning', 'DH_3_Plan_Execution', 'DH_4_Assesment', 'DH_5_Portfolio', 'DH_6_Blood', 'DH_7_low-cost_medicine', 'DH_8_Medicine_Quality_test', 'DH_9_Drug_Store_Quality', 'DH_10_drug_Dispensation', 'DH_11_Medicines', 'DH_12_Knowledge', 'DH_13_BMW', 'DH_14_Surgical_safety_checklist', 'DH_15_Outcome_quality', 'DH_16_Accountability', 'DH_17_patient_experience_score', 'DH_18_grievance', 'DH_19_HMIS_reporting', 'Ex-Ante Assessment Score', 'Ex-Ante Assessment Score (%)'
        ],
        'SHT': [
            "S.No", "District", "IPA Unit", "IPA Type", 'Ex Ante Assessment Date', 'Ex-Ante Assessment NQAS Score (%)', 'SHT_1_NQAS', 'SHT_2_Planning', 'SHT_3_Ex-Ante_Assesment', 'SHT_4_State_HR_Policy', 'SHT_5_Policy_procurement', 'SHT_6_policy_ low_cost _supply', 'SHT_7_Policy_drug_quality', 'SHT_8_Policy_drug_Store_low_cost', 'SHT_9_Policy_drug_Inventory_training', 'SHT_10_drug_prescription/Stock_reporting', 'SHT_11_Monitoring_of_Condemnation _medical equipment', 'SHT_12_coaching', 'SHT_13_Accountability', 'SHT_14_grievance_accountability', 'SHT_15_HMIS_reporting', 'SHT_16_Insurance_Efficiency_Medical_Audit', 'SHT_17_Quality_Outcome_reporting', 'Ex-Ante Assessment Score', 'Ex-Ante Assessment Score (%)' 
        ],
        'DHT': [
            "S.No", "District", "IPA Unit", "IPA Type", 'Ex Ante Assessment Date', 'Ex-Ante Assessment NQAS Score (%)', 'DHT_1_NQAS', 'DHT_2_Planning', 'DHT_3_Plan_Execution', 'DHT_4_Ex-Ante_Assesment', 'DHT_5_coaching-visit _ Quality_HR', 'DHT_6_Drug_Quality', 'DHT_7_Drug_Store_Quality', 'DHT_8_Store_quality _PHC/CHC', 'DHT_9_Pharmacy review', 'DHT_10_Nursing_review', 'DHT_11_Emergency_Training', 'DHT_12_Accountability', 'DHT_13_grievance', 'DHT_14_HMIS_reporting', 'DHT_15_Condemnation _medical_equipment', 'DHT_16_Condemnation - Vehicles', 'DHT_17_NCD_Screening_Data -Submission', 'Ex-Ante Assessment Score', 'Ex-Ante Assessment Score (%)', ],
        'DHT_CI': [
            "S.No", "District", "IPA Unit", "IPA Type", 'Ex Ante Assessment Date', 'Ex-Ante Assessment NQAS Score (%)', 'IPA for Community Intervention activities - Indicator 1', 'IPA for Community Intervention activities - Indicator 2', 'Ex-Ante Assessment Score', 'Ex-Ante Assessment Score (%)' 
        ]
    };

    function displayReport() {
            document.getElementById("loader").style.display = "block";
            var dates = {
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
            }
            if (!dates.startDate || !dates.endDate) {
                document.getElementById("loader").style.display = "none";
                alert("Please Select Dates Correctly!");
            } else {
                setTimeout(() => {
                    getData(dates);
                }, 1000)
            }
        }

    async function getData(dates) {

    let totalHead = '';
    for (let item in tableHead) {
        let headVal = `<table  class="table table-hover borderless" style="width:100%;" id="table-${item}">
           
            <tr>`;
        tableHead[item].forEach(name => headVal += `<td style="font-weight:bold;text-align:center; background:#f2f2f2">${name}</td>`)
        headVal += `</tr> 
        </thead>
        
        <tbody id="tbody-${item == "PHC" ? "PHC_UPHC" : item}"></tbody>
       
        </table>`
        totalHead += headVal
    }

    document.getElementById('report-table').innerHTML = totalHead;

    var totalRows = [];

    const orgUnitGroup = [{
        id: 'u52bDIwLiOG',
        name: 'PHC'
    }, {
        id: 'QbaIyUsVHJ9',
        name: 'CHC / SDH'
    }, {
        id: 'vTZ2yIeAi81',
        name: 'UPHC'
    }, {
        id: 'qvN06qQw9Hr',
        name: 'DH'
    }, {
        id: 'Y1P2f3awpzt',
        name: 'SHT'
    }, {
        id: 'D5YO4NsZtSp',
        name: 'DHT'
    }];

    const promises = (ouGroup) => {
        return ouGroup.map(ou => {
            return new Promise(resolve => fetch(`../api/organisationUnitGroups/${ou.id}.json?fields=id,name,organisationUnits&paging=false`).then(res => res.json()).then(res => resolve(res)))
        })
    }

    Promise.all(promises(orgUnitGroup)).then((res, index) => {
        res.map(group => group.organisationUnits.forEach(ou => includedOrgUnitGroups[ou.id] = group.name))
    }).then(() => getOU()).then(() => {
        var dataPhcUPHC = ''
        for (let row in totalRows) {
            if (row == 'PHC' || row == 'UPHC') dataPhcUPHC += totalRows[row].join('');
            else document.getElementById(`tbody-${row}`).innerHTML = totalRows[row].join('');
        }
        document.getElementById(`tbody-PHC_UPHC`).innerHTML = dataPhcUPHC;
        document.getElementById('report-table').style.visibility = 'visible';
        document.getElementById("downloads").style.display = "block";
        document.getElementById("loader").style.display = "none";
    })

    var period = '';
    dateValues = dates.startDate.split('-');
    if(dateValues[1]>=10 || dateValues[1]<=1) {
        if(dateValues[1]==1) period = (dateValues[0]-1) + `Q4`;
        else period = dateValues[0] + `Q4`;
    }
    else if(dateValues[1]>=2 && dateValues[1]<=5) period = dateValues[0] + 'Q2';
    else if(dateValues[1]>=6 && dateValues[1]<=9) period = dateValues[0] + 'Q3 ';

    function getOU() {

        var url = '../api/organisationUnits/' + selectedOrgUnit.id + '.json?paging=false&fields=id,name,level,dataSets[id]';
        $.ajax({
            type: "GET",
            async: false,
            url: '../api/organisationUnitLevels.json',
            data: JSON,
            success: function (data, status) {

                for (let i = 0; i < data.organisationUnitLevels.length; i++) {
                    url += ',children[id,name,level,dataSets[id]';
                }
                url += ']';
            }
        });
        $.ajax({
            type: "GET",
            async: false,
            url: url,
            data: JSON,
            success: function (data, status) {
                treeDown(data, '');
            }
        });
        debugger;
        function treeDown(arr, district) {
            var key = arr;

            if (key.children.length) {
                key.children.sort((a, b) => a.name.localeCompare(b.name))
                for (let i = 0; i < key.children.length; i++) {
                    if (key.level == 2) district = key.name;

                    treeDown(key.children[i], district);
                }
            }


            if (includedOrgUnitGroups[key.id]) {
                getData(key.id, key.name, district);
            }
        }

        function getData(orgUnitId, orgUnit, district) {
            var dataObj = {};
            var rows = '';
            var total = 0;
            var percent = 0;
            var dataElementIds = {
                
                'PHC': ['NxpizrKetxX', 'dHuVSKPUOtv', 'MgBNehilt4X','RatMTqCbdoP','NWVTwAuFhu8','KyLrsPRsaOy','O6uZ5wJSIDM','ywXq4mJDhC2','sRo0KYPtSSb','dEh5Ge4GMrr','fhkXHuejOe9','uZ6gUvUnw7D','PRsCYxCeTcx','ulBPG1KFoqF','zDanki0LR8A','b4yvHbtL0LP','MiQWa6m05hn','MncGRZOpz5P','tze6k5digrL','Rex3P2ddpnK','tREbd3kCESt'],
                'UPHC': ['NxpizrKetxX', 'dHuVSKPUOtv', 'MgBNehilt4X','RatMTqCbdoP','NWVTwAuFhu8','KyLrsPRsaOy','O6uZ5wJSIDM','ywXq4mJDhC2','sRo0KYPtSSb','dEh5Ge4GMrr','fhkXHuejOe9','uZ6gUvUnw7D','PRsCYxCeTcx','ulBPG1KFoqF','zDanki0LR8A','b4yvHbtL0LP','MiQWa6m05hn','MncGRZOpz5P','tze6k5digrL','Rex3P2ddpnK','tREbd3kCESt'],
                'CHC / SDH': ['NxpizrKetxX','dHuVSKPUOtv','hEmw1SgUk5B','OApGB4RqNj2','nVsUOeemfuM','Wag2MMDU11i','LxkcyG5uB6P','aVp0MdFg6Jz','qVwhxqrpHue','SlyWuCZrZlV','HGCD1m0dxXV','Qj70QIMbOIB','JNU2mkoOQFx','AyT7JccdH3J','EnfVLUDAT2Y','AAQVlEg3Fpu','zdc2D3qvmgO','bFW1Lm7xHgp'],
                'DH': ['NxpizrKetxX','dHuVSKPUOtv','VxbUxDaAkWa','RdSGHDTjdHG','eMJJhDAc0Fa','GnrmKd87gSI','j4uggA952Vi','tD6oBYAvn98','HYqtx7QRwew','RwsbRdO6buY','DUcaCVQcENy','UmgCJ4TRJ2z','HzWwN7ijfvO','rpbQ1GnS0dU','sAoofnHxMdM','lhkcJSi0858','POPDaE96GfE','B5KFVFGnOh0','FEZ0CMoRjwy','b6JPxOkX68O','YGM9kx0lv2C'],
                'SHT': ['NxpizrKetxX', 'dHuVSKPUOtv', 't74ltsSf68i', 'Df7VRgqMvEp', 'OIezn65tpN5', 'C8YsYJzaegB', 'm9QOEyGCXLq', 'YoLFvclGCa3', 'nLLsH2AOTAN', 'V3OgbCiZHUJ', 'je23VNqB5hs', 'mVLROjY20Ib', 'GvDDhBesf5y', 'pdXzJIaTpJ6', 'Nf8NfMw6wAN', 'NM7Rfr4HSPa', 'Skl2xFuYZvA', 'WQJj6ZvuGeM', 'DZUSFXHl974'],
                'DHT': ['NxpizrKetxX', 'dHuVSKPUOtv', 'HMJl1ihGttQ', 'BH0ne79iBdW', 'rFYAyQBq5uZ', 'mvMxxUm7C1d', 'kHRI6M7VeMq', 'GfGniN4O5Ib', 'Pus6IXftvwT', 'MR6DTd8WfXj', 'krs4kVOxr6s', 'CHa6lWCvzUa', 'kRWBZFZbseb', 'bKb96k49lpq', 'sriHepQzObV', 'nnGPlabpjOx', 'xWJHsHBdENm', 'x0eOZt7dq67', 'LwvDauUsAB9'],
                'DHT_CI': ['NxpizrKetxX', 'dHuVSKPUOtv', 'FHh0DreGwAg', 'IhQHr47XxSx'],
            };
            var dataSets = {
                'PHC': 'jCKIvz9Lzn3',
                'UPHC': 'jCKIvz9Lzn3',
                'CHC / SDH': 'wAFjqCC6UD2',
                'DH': 'NyaZybJvx9P',
                'SHT': 'VkyTAoaNh5A',
                'DHT': 'B0yqzoaEgPc',
                'DHT_CI': 'uEtJKk84A9b',
            };

            $.ajax({
                type: "GET",
                async: false,
                url: `../api/dataValueSets.json?dataSet=${dataSets[includedOrgUnitGroups[orgUnitId]]}&period=${period}&orgUnit=${orgUnitId}&paging=false`,
                data: JSON,
                success: function (response, status) {

                    response.dataValues.forEach(row => {
                        dataObj[row.dataElement] = row.value;
                    })
                    var totalRowsSNo = 0;
                    var groupName = ''
                    if(includedOrgUnitGroups[orgUnitId] == 'CHC / SDH') {
                        //spliting CHC / SDH 
                        if(orgUnitId == 'iXxhiiGp1S3' || orgUnitId == 'yXWYQb3OsdT'){
                            if(!totalRows['SDH']) totalRows['SDH'] = [];
                            totalRowsSNo = totalRows['SDH'].length; 
                            groupName = 'SDH'
                        }
                        else  {
                            if(!totalRows['CHC']) totalRows['CHC'] = [];   
                            totalRowsSNo = totalRows['CHC'].length; 
                            groupName = 'CHC'
                        }
                    }
                    else {
                        if(!totalRows[includedOrgUnitGroups[orgUnitId]]) totalRows[includedOrgUnitGroups[orgUnitId]] = [];
                        totalRowsSNo = totalRows[includedOrgUnitGroups[orgUnitId]].length;
                        groupName = includedOrgUnitGroups[orgUnitId];
                    } 
                
                    rows = `<tr>
                <td>${(totalRowsSNo +1)}</td>
                <td>${district}</td>
                <td>${orgUnit}</td>
                <td>${groupName}</td>`
                    dataElementIds[includedOrgUnitGroups[orgUnitId]].forEach((de, index) => {

                        var val = 0;
                        if(index == 0) val = (dataObj[de] ? dataObj[de] : 0);
                        else val = formatNumber(dataObj[de]);
                        
                        if (includedOrgUnitGroups[orgUnitId] == 'PHC' || includedOrgUnitGroups[orgUnitId] == 'UPHC' || includedOrgUnitGroups[orgUnitId] == 'CHC / SDH' || includedOrgUnitGroups[orgUnitId] == 'DH') if (index != 0 && index != 1) total += Number(val);
                        if (includedOrgUnitGroups[orgUnitId] == 'SHT' || includedOrgUnitGroups[orgUnitId] == 'DHT' || includedOrgUnitGroups[orgUnitId] == 'INS') if (index != 0) total += Number(val);
                        rows += `<td style="text-align:center">${val}</td>`
                    })
                    percent = total ? ((total / 1000) * 100).toFixed(2) : ''
                    rows += `<td style="text-align:center">${formatNumber(total)}</td><td style="text-align:center">${percent}</td></tr>`

                    totalRows[groupName].push(rows);
                }
            });
        }
    }

    }

    function formatNumber(value) {
        const num = Number(value);            
        if (isNaN(num)) return '';
        return Number.isInteger(num) ? num : Number(num.toFixed(2));
    }

    var tablesToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , tmplWorkbookXML = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">'
                + '<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office"><Author>Axel Richter</Author><Created>{created}</Created></DocumentProperties>'
                + '<Styles>'
                + '<Style ss:ID="Currency"><NumberFormat ss:Format="Currency"></NumberFormat></Style>'
                + '<Style ss:ID="Date"><NumberFormat ss:Format="Medium Date"></NumberFormat></Style>'
                + '</Styles>'
                + '{worksheets}</Workbook>'
            , tmplWorksheetXML = '<Worksheet ss:Name="{nameWS}"><Table>{rows}</Table></Worksheet>'
            , tmplCellXML = '<Cell{attributeStyleID}{attributeFormula}><Data ss:Type="{nameType}">{data}</Data></Cell>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (tables, wsnames, wbname, appname) {
            var ctx = "";
            var workbookXML = "";
            var worksheetsXML = "";
            var rowsXML = "";

            for (var i = 0; i < tables.length; i++) {
                if (!tables[i].nodeType) tables[i] = document.getElementById(tables[i]);
                for (var j = 0; j < tables[i].rows.length; j++) {
                    rowsXML += '<Row>'
                    for (var k = 0; k < tables[i].rows[j].cells.length; k++) {
                        var dataType = tables[i].rows[j].cells[k].getAttribute("data-type");
                        var dataStyle = tables[i].rows[j].cells[k].getAttribute("data-style");
                        var dataValue = tables[i].rows[j].cells[k].getAttribute("data-value");
                        dataValue = (dataValue) ? dataValue : tables[i].rows[j].cells[k].innerHTML;
                        var dataFormula = tables[i].rows[j].cells[k].getAttribute("data-formula");
                        dataFormula = (dataFormula) ? dataFormula : (appname == 'Calc' && dataType == 'DateTime') ? dataValue : null;
                        ctx = {
                            attributeStyleID: (dataStyle == 'Currency' || dataStyle == 'Date') ? ' ss:StyleID="' + dataStyle + '"' : ''
                            , nameType: (dataType == 'Number' || dataType == 'DateTime' || dataType == 'Boolean' || dataType == 'Error') ? dataType : 'String'
                            , data: (dataFormula) ? '' : dataValue
                            , attributeFormula: (dataFormula) ? ' ss:Formula="' + dataFormula + '"' : ''
                        };
                        rowsXML += format(tmplCellXML, ctx);
                    }
                    rowsXML += '</Row>'
                }
                ctx = { rows: rowsXML, nameWS: wsnames[i] || 'Sheet' + i };
                worksheetsXML += format(tmplWorksheetXML, ctx);
                rowsXML = "";
            }

            ctx = { created: (new Date()).getTime(), worksheets: worksheetsXML };
            workbookXML = format(tmplWorkbookXML, ctx);
            console.log(workbookXML);
            var link = document.createElement("A");
            link.href = uri + base64(workbookXML);
            link.download = wbname || 'Workbook.xls';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    })();

</script>