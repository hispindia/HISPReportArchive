<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
    integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<style>
    /* Absolute Center Spinner */
    * {
        font-family: 'Times New Roman', Times, serif;
    }

    .borderless,
    .borderless th,
    .borderless td {
        border: 0;
        border-collapse: collapse;
    }

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }

    .box {
        width: 50%;
        float: left;
    }
</style>

</head>

<body>

    <div class="loading" id="loader"></div>

    <a id="dlink" style="display:none;"></a>
    <div id="main">
        <div style="width: 40%; margin-left:30%;">
            <table class="table table-bordered">
                <tr>
                    <td style="font-size: 15px;padding-top: 15px;">
                        Start Date </td>
                    <td style="width: 60%;">
                        <input type="date" class=" form-control" id="start-date">
                    </td>
                </tr>
                <tr>
                    <td style="font-size: 15px;padding-top: 15px;">
                        End Date
                    </td>
                    <td style="width: 60%;">
                        <input type="date" class=" form-control" id="end-date">
                    </td>
                </tr>
                <tr>
                    <td><button onClick="submitData()" class="btn btn-primary" id="tap">Submit</button></td>
                    <td style="text-align: right;">
                        <div id="downloads" style="display: none;">
                            <img src="https://img.icons8.com/color/35/000000/ms-excel.png"
                                onmouseover="this.style.cursor='pointer'"
                                onclick="tableToExcel('dataTable', 'IPA Ex-Ante Scores Compiled Report-PHC', 'IPA Ex-Ante Scores Compiled Report-PHC')"
                                alt="xls">
                        </div>
                    </td>


                </tr>
            </table>
        </div>
        <table class="table table-hover borderless" style="width:100%;visibility: hidden;" id="dataTable">
            <thead>
                <tr>
                    <td colspan="22" style="text-align:center;font-weight:bold;background:#ADD8E6 ">
                        IPA Ex-Ante Scores Compiled Report-PHC
                    </td>
                </tr>
                 <tr>
                    <td colspan="22" style="text-align:center;font-weight:bold;background:#ADD8E6 ">
                        <span id="facility-period"></span>
                    </td>
                </tr>
                <tr>
                    <td style="background:#ECEAEA"> S.No. </td>
                    <td style="background:#ECEAEA"> Organisation Unit </td>
                    <td style="background:#ECEAEA">Assessment Start Date</td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - NQAS score 300</td>
                    <td style="background:#ECEAEA"> Calculated Value - HFM Team Meetings </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Level of Execution of Planned
                        Activities </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - General premises
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Cleanliness of Wards
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Hand-washing
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Toilets
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Medical Waste Disposal
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Medical Waste Handling
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Average percentage score for Client Satisfaction
                        Surveys (Ex-Ante)
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Insurance Efficiency
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Provider's Knowledge - CKSI
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Grievance Redressal
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Human Resources for Health
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Essential Medicines
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Essential Diagnostics
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Calculated Value - Low-cost drugs
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Total Score (Ex-Ante) max 1000
                    </td>
                    <td style="text-align: center;background:#ECEAEA">Ex-Ante Score (%)
                    </td>
                </tr>

            </thead>
            <tbody id="table-body"> </tbody>
        </table>
    </div>
</body>

<script>
    var selectedOrgUnit = dhis2.report.organisationUnit;
    var dates = { startDate: '', endDate: '' }
    var dataValues = {};
    var tableRow = '';

    document.getElementById("loader").style.display = "none";


    function submitData() {
        dataValues = '';
        tableRow = '';
        var startDate = document.getElementById('start-date').value;
        var endDate = document.getElementById('end-date').value;
        dates = { startDate, endDate }
        if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) {
            alert("Please Select dates Correctly!");
            return;
        } else {
            document.getElementById("dataTable").style.visibility = "hidden";
            document.getElementById("downloads").style.display = "none";
            document.getElementById("facility-period").innerHTML = selectedOrgUnit.name + " ( " + startDate + " to " + endDate + " )"
            document.getElementById("loader").style.display = "block";
            setTimeout(function () {
                getData(dates)

            }, 1000);

        }
    }

    async function getData(dates) {
        var dataValues = {};
        var resAnalytics = await (await fetch(`../api/analytics/events/query/HoSWGbzZxF9.json?paging=false&startDate=${dates.startDate}&endDate=${dates.endDate}&dimension=ou:${selectedOrgUnit.id}&dimension=VQkf0I3XtO3.i2afLnjFrdh&dimension=VQkf0I3XtO3.KlrfpnCYJAj&dimension=VQkf0I3XtO3.AQAxhZf5ac8&dimension=VQkf0I3XtO3.tIjpeBxQEmv&dimension=VQkf0I3XtO3.sRpBeAUYgMr&dimension=VQkf0I3XtO3.ZgcURySniLD&dimension=VQkf0I3XtO3.i5kIcliOLTc&dimension=VQkf0I3XtO3.VvGLnxMa2sv&dimension=VQkf0I3XtO3.rASLM0hqIYF&dimension=VQkf0I3XtO3.eZ6d42PJkp2&dimension=VQkf0I3XtO3.shULFYxYJLU&dimension=VQkf0I3XtO3.pHdhGRXtgYK&dimension=VQkf0I3XtO3.AuBUhr0hGcX&dimension=VQkf0I3XtO3.OsdaS7OtRMO&dimension=VQkf0I3XtO3.NryCpvgIjgf&dimension=VQkf0I3XtO3.ZTAiGHl0H2a&dimension=VQkf0I3XtO3.ulBdw5b0IHO&dimension=VQkf0I3XtO3.IdIkPvFudmu&dimension=VQkf0I3XtO3.VQfr47DujUb&dimension=VQkf0I3XtO3.s3c29xLWsHM&dimension=VQkf0I3XtO3.p1CksgJdni5&dimension=VQkf0I3XtO3.m50G1QGE4E8&stage=VQkf0I3XtO3`)).json();
        resAnalytics.rows.forEach(row => {
            var index = 19;
            var sno = 0;
            if (!dataValues[row[14]]) dataValues[row[14]] = [];
            dataValues[row[14]][(sno++)] = row[index]; index++;
            dataValues[row[14]][(sno++)] = Number(row[index]);
            dataValues[row[14]][(sno++)] = Number(row[++index]) + Number(row[++index]) + Number(row[++index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]);
            dataValues[row[14]][(sno++)] = Number(row[++index]) + Number(row[++index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]); index++;
            dataValues[row[14]][(sno++)] = Number(row[index]);
            dataValues[row[14]][(sno++)] = row[index] && (row[index]/1000) && (row[index]/1000)!== Infinity ? ((row[index]/1000) * 100).toFixed(2): '';
        })
        var count=0;
        for (let ou in dataValues) {
            tableRow += `<tr><td>${(++count)}</td><td>${ou}</td>`;
            dataValues[ou].forEach(val => tableRow += `<td>${val}</td>`)
            tableRow += '</tr>'
        }
        debugger;
        document.getElementById('table-body').innerHTML = tableRow;
        document.getElementById('dataTable').style.visibility = 'visible';
        document.getElementById("downloads").style.display = "block";

        document.getElementById("loader").style.display = "none";
    }

    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = `${filename}_${selectedOrgUnit.name}_${dates.startDate}-${dates.endDate}.xls`;
            document.getElementById("dlink").click();
        }
    })()

</script>