<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../dhis-web-commons/reports-libraries/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ"
        crossorigin="anonymous">

    <script src="../dhis-web-commons/reports-libraries/jquery.js"></script>
    <script src="../dhis-web-commons/reports-libraries/jquery-ui.js"></script>
    <script src="../dhis-web-commons/reports-libraries/moment.js"></script>

    <script src="../dhis-web-commons/reports-libraries/highcharts.js"></script>
    <script src="../dhis-web-commons/reports-libraries/highcharts-nodatadisplay.js"></script>
    <script src="../dhis-web-commons/reports-libraries/highcharts-exporting.js"></script>
    <script src="../dhis-web-commons/reports-libraries/leaflet.js"></script>

    <script src="../dhis-web-commons/reports-libraries/bootstrap.min.js"></script>

 <link rel="stylesheet" href="../dhis-web-commons/reports-libraries/leaflet.css" />
    <link rel="stylesheet" href="../dhis-web-commons/reports-libraries/font-awesome.min.css" />


</head>
<style>
    .datedivmng {
        float: left;
        position: relative;
    }

    .datedivmng .datepicker {
        position: relative;
        width: 87% !important;
        cursor: pointer;
    }

    .datedivmng:after {
        /* symbol for "opening" panels */
        font-family: 'FontAwesome';
        content: "\f073";
        color: #329ac4;
        font-size: 16px;
        text-shadow: none;
        position: absolute;
        vertical-align: middle;
        pointer-events: none;
        float: right;
        top: 2px;
        right: 7px;
    }
</style>
<style type="text/css" href="../api/documents/IlCodOSjSxY/data" media="print">
    @media print {
        #notPrint {
            display: none;
        }
        #printing {
            display: block;
        }
        @page {
            size: A4 portrait;
            margin: 1cm;
            max-height: 100%;
            max-width: 100%
        }
    }
</style>
<style>
    .leaflet-popup-tip-container {
        display: none;
    }

    .leaflet-container {
        background-color: rgba(255, 0, 0, 0.0);
    }

    .newRow td {
        border: none;
        height: 30px;
    }

    thead th {
        text-align: center;
    }

    .reporttable {
        border-collapse: collapse;
    }

    .tablerows1 {
        text-align: center;
        text-align: center;
        font-size: 16px;
        height: 50px;
        width: 10%;
    }

    .tablerows {
        text-align: center;
        font-size: 16px;
        border: 1px solid black;
        height: 50px;
        width: 10%;
    }



    .table3 h1 {
        text-align: center;
    }

    .reporttableC {

        border-collapse: collapse;
        border: 1px solid black;
        text-align: center;
        width: 100%;
    }

    .reporttableC tr td {
        border: 1px solid black;
        height: 40px;
        min-width: 120px;
    }

    .reporttableC thead tr th {
        height: 50px;
        min-width: 120px;
        border: 2px solid black;
        background-color: #99ccff;
    }

    table {
        border-collapse: collapse;
    }

    tr {
        padding-top: .4em;
        padding-bottom: .5em;
    }

    .clusterHead td {
        font-weight: 600;
        font-family: 'Times New Roman', Times, serif;
        border-bottom: 1px solid black;
        background: #FFF9B1 !important;
        font-size: 15px;
        text-align: center;
    }

    .custom-popup .leaflet-popup-content-wrapper {
        font-size: 10px;
        line-height: 2px;
    }

    .custom-popup .leaflet-popup-content-wrapper a {
        font-size: 2px;
        line-height: 2px;
        width: 04px;
        height: 04px;
    }

    .custom-popup .leaflet-popup-tip-container {
        width: 04px;
        height: 04px;
    }

    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    .legend {
        text-align: left;
        line-height: 18px;
        color: #555;
    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }

    .alertstable {
        display: none;
    }

    /* #printing {
        display: none;
    } */

    .highcharts-credits {
        display: none !important;
    }
</style>

<body>
    <div id="notPrint">
        <div class="datedivmng">
            <b>Select Date : </b>
            <input type="text" id="datepicker" name="datepicker" value="" />
        </div>
        <button id="click" onClick="loadDataX()" style="margin-left:20px">Go</button>
        <button onClick="location.reload();" style="margin-left:20px">Reset</button>
    </div>
    <div id="printing" item-width="800px">
        <div item-width="100%">
            <table width="100%">
                <tr>
                    <td>
                        <img src="../api/documents/PRa74yvj2VL/data" alt="logo" width="100" height="100" />
                    </td>
                    <td style="text-align:center">
                        <h1>Daily Summary Report(DLDMP), <p id="ou" style='align:right;display:inline-block'></p> </h1>
                    </td>
                    <td>
                        <img src="../api/documents/KyVqC2KDKXO/data" width="100" height="100" />
                    </td>
                </tr>
            </table>

        </div>


        <div style="width:100%">
            <table style="width:100%">
                <tr>
                    <td width="25%">
                        <table class="table table-striped alertstable" style="font-family:'Times New Roman', Times, serif;" width="100%">
                            <tr>
                                <th colspan="2">Alerts</th>
                            </tr>
                            <tr>
                                <th>Name of the block</th>
                                <th>Name of the village</th>
                            </tr>
                        </table>
                    </td>
                    <td style="width:75%; text-align:-webkit-center" rowspan="2">
                        <div id="map1" style="width:800px;height:400px;margin-right:10%;"></div>
                    </td>
                </tr>
                <tr>
                    <td style="width:25%;text-align:-webkit-center; border:none;">
                        <table style="background-color:#FFF9B1 !important; font-family:'Times New Roman', Times, serif;">
                            <tr>
                                <th style="border:none">
                                    <p style="display: inline" id="report"></p>
                                </th>
                            </tr>
                            <tr>
                                <th style="border:none">
                                    <p style="display: inline" id="datet"></p>
                                </th>
                            </tr>
                            <tr>
                                <th style="border:none">
                                    <p style="display: inline" id="period"></p>
                                </th>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

        </div>


        <table style="width: 100%">
            <tbody>
                <tr>
                    <td style="width: 50%">
                        <div id="summary"></div>
                    </td>
                    <td style="width: 50%;">
                        <div id="sumamry_chart" style="height:300px"></div>
                    </td>
                </tr>
            </tbody>
        </table>

        <div id="table3">
            <table style="width:90%;margin:auto" class="table3">
                <tbody>
                    <tr>

                        <td style="width:50%;">
                            <H1></H1>
                            <div id="container_op" style="width: 500px;  height: 180px; margin: 0 auto; "></div>
                        </td>
                        <td style="width:50%;">
                            <H1></H1>
                            <div id="container" style="width: 500px;  height: 180px; margin: 0 auto; "></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <table style="width:90%;margin:auto" class="table3">
            <tbody>
                <tr>

                    <td style="width:50%;">
                        <H1></H1>
                        <div id="container_ip" style="width: 500px;  height: 180px; margin: 0 auto; " class="empty-table"></div>
                    </td>
                    <td style="width:50%;">
                        <H1></H1>
                        <div id="container1" style="width: 500px;  height: 180px; margin: 0 auto; " class="empty-table"></div>
                    </td>
                </tr>
            </tbody>
        </table>

        <table style="width:90%;margin:auto" class="table3">
            <tbody>
                <tr>

                    <td style="width:50%;">
                        <H1></H1>
                        <div id="container_fever" style="width: 500px;  height: 180px; margin: 0 auto; " class="empty-table"></div>
                    </td>
                    <td style="width:50%;">
                        <H1></H1>
                        <div id="container2" style="width: 500px;  height: 180px; margin: 0 auto; " class="empty-table"></div>
                    </td>
                </tr>
            </tbody>
        </table>
        <br>
        <br>
        <br>


        <div id="patientdata">
            <p class="Cheading">
                <b>Line list of case patients :</b>
            </p>
            <br>
            <table class="reporttable" width="100%">
                <thead>
                    <tr style='border:0px 0px 1px 0px; border-color:lightgray;text-align:center'>
                        <th class='tablerows1' colspan='1'>S.No.</th>
                        <th class='tablerows1' colspan='1'>Name</th>
                        <th class='tablerows1' colspan='1'>Age(in years)</th>
                        <th class='tablerows1' colspan='1'>Gender</th>
                        <th class='tablerows1' colspan='1'>Door, Street Name</th>
                        <th class='tablerows1' colspan='1'>Habitation</th>
                        <th class='tablerows1' colspan='1'>Village</th>
                        <!-- <th class='tablerows1' colspan='1'>Mobile Number</th>
                <th class='tablerows1' colspan='1'>Onset of AFI/ADD</th> -->
                        <th class='tablerows1' colspan='1'>Date of Admission</th>
                        <th class='tablerows1' colspan='1'>Lab Results</th>
                        <th class='tablerows1' colspan='1'>Reported Institution</th>
                </thead>
            </table>
        </div>
    </div>
</body>


<script>
    $("#datepicker").datepicker({
        dateFormat: 'dd-mm-yy',
        changeMonth: true
    });
</script>
<script>
    //new map constants
    var ou= "";
    var age12count=0,age1to5count=0,age6count=0,ageless1count=0,scrubcount=0,denguecount=0;
    var NIE = {
    }
$(document).ready(function(){
    var url = window.location.href;
    var arrayUrl = url.split('&');
    ou = arrayUrl[1].split('=')[1];
    var level = ouandblockname(ou,'true');
    var ouname = ouandblockname(ou,'on');
    document.getElementById('ou').innerHTML = '<h1>'+ ouname + '</h1>';
    if(level > 4){alert("wrong selection");window.history.back();}
        if (arrayUrl.length > 2) {
            var arraySDate = arrayUrl[2];
            today = arraySDate.split('=')[1];
            today = today.split("-").reverse().join("-");
            console.log(today);
            document.getElementById('datepicker').value = today;
            loadDataX();
        }
        else {
            var now = new Date();
            var month = (now.getMonth() + 1);
            var day = now.getDate();
            if (month < 10)
                month = "0" + month;
            if (day < 10)
                day = "0" + day;
            var today = day + '-' + month + '-' + now.getFullYear();
            document.getElementById('datepicker').value = today;
        }

        NIE = {
        ROOT_OU_UID: ou,
        CLUSTER_TEA_CLUSTER_TAIL_DATE: "b1WmXl2TU5U",
        CLUSTER_TEA_CLUSTER_START_DATE: "XGWh7OT2Pa8",
        Cluster_ProgramUID: "mcnt7nqNrNw",
        TEA_IS_ACTIVE: "DyjpKLdKmoD",
        TEA_COORDS: "sanq4S5uYdb",
        TEA_CLUSTER_TYPE: "sBmb7HfvAau",
        TEA_CLUSTER_CASES: "I2eCWfhryZH",
        AFI_TEA_3_5: "vCeMi4DtfEC",
        AFI_TEA_5_7: "k0L2KR4ZrU2",
        ADD_TEA_2_3: "ET5iMtBo5fV",
        TEA_LAB: "nMC9jWaMUTA",

    }
});

    var map;
   
  


    const imgpath_polygon_5_sided = "../api/documents/ph7t8TbV1lJ/data";
    const imgpath_red_circle = "../api/documents/AafIibwti0p/data";
    const imgpath_star = "../api/documents/KE87BJI62sC/data";
    const imgpath_marker_icon_blue = "../api/documents/ph7t8TbV1lJ/data";
    const imgpath_marker_icon_inactive = "../api/documents/ph7t8TbV1lJ/data";
    const imgpath_marker_icon_add_2 = "../dhis-web-commons/reports-libraries/img/add.png";

    function findValueAgainstId(data, idKey, id, valKey) {
        for (var i = 0; i < data.length; i++) {
            if (data[i][idKey] == id) {
                return data[i][valKey]
            }
        }
        return null;
    }
//sidhanshu changes start --
    var getReportId = function () {
        var id = "";
        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/dataStore/id.json',
            success: function (data) {
                data.sort(function (a, b) { return a - b });
                id = data[data.length - 1];

                var datatosend = "{'id':" + (parseInt(id) + 1) + "}"
                $.ajax({
                    async: false,
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json",
                    url: '../api/dataStore/id/' + (parseInt(id) + 1),
                    data: JSON.stringify(datatosend),
                    success: function (response) {
                        console.log(response);
                    }
                });

            },
            error: function (e) {
                //if (e.httpStatusCode == 404) {
                id = 1;

                var datatosend = "{'id':" + (parseInt(id) + 1) + "}"
                $.ajax({
                    async: false,
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json",
                    url: '../api/dataStore/id/' + (parseInt(id) + 1),
                    data: JSON.stringify(datatosend),
                    success: function (response) {
                        console.log(response);
                    }
                });
            }
        });

        if (id < 10) { return "00" + id }
        else if (id >= 10 && id < 100) { return "0" + id }
        else { return id; }
    };
//sidhanshu changes end --


    var ou, clusterId = "None", clusterType = "None", block = "None", phc = "None", patients, patientsArray, Pname, Page, Pgender, Pdoor, Phabitation, Pvillage, Pmob, Ponset, Pdate, Pstreet, Plab = [];

    var total_1day = 0, total_7day = 0, total_30day = 0, x_categories = [], ip_fever_male_data = [], ip_fever_female_data = [], ip_fever_total_data = [];
    var series = [], ip_fever_age12 = [], ip_fever_agel = [], ip_fever_age1to5 = [], ip_fever_ageg6to12 = [], ip_fever_dengue_cases = [], ip_fever_scrub_cases = [],ip_fever_malaria_cases=[],ip_fever_lepto_cases=[],ip_fever_chikun=[], ipcases = [], labconfirmedcases = [];
    var last30days, last7days;
    var url, ou;
    var taluk_count_07 = {
        orgname: [],
        orgcount: []

    };
    var opcases = {
        ouval: [],
        ouperiod: []

    };

    var taluk_count_01 = {
        orgname: [],
        orgcount: []

    };
    var taluk_count_30 = {
        orgname: [],
        orgcount: []

    };
    var taluk_chart_data = [];
    var taluk_chart_data_name = [];
    var ip_fever = {
        ip_fever_male: [],
        ip_fever_female: [],
        ip_fever_total: []
    };

    var ip_fever_gender = {
        ip_fever_age_g_12: [],
        ip_fever_age_l_1: [],
        ip_fever_age_6to12: [],
        ip_fever_age_1to5: []
    };

    var today = "";

	
	
	//sidhanshu changes start --
    //get ou name
    var ouandblockname = function (ouid,lvl) {
        var oun = "", blockn = "", level = "";
        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/organisationUnits/' + ouid + '.json?fields=level,displayName,ancestors[name,level]',
            success: function (ous) {
                oun = ous.displayName; 
                level = ous.level;  
                for (var k = 0; k < ous.ancestors.length; k++) {
                    if (ous.ancestors[k].level == 5) {
                        blockn = ous.ancestors[k].name;
                    }
                }
            }
        });
        if(lvl == 'true'){return level;}
        else if(lvl == 'on'){return oun;}
        else{return [blockn, oun];}
    };

    var alertstable = function (teis) {
        var row = "<tbody>";
        for (var j = 0; j < teis.length; j++) {
            var attr = teis[j].attributes;
            var ou = teis[j].orgUnit;
            var ounames = ouandblockname(ou);
            var oun = ounames[1];
            var blockn = ounames[0];
            var imagehref = "";
            for (var t = 0; t < attr.length; t++) {

                if (attr[t].displayName == "1 Lab confirmed case") {
                    imagehref = "../api/documents/AafIibwti0p/data";
                }
                if (attr[t].displayName == "≥ 3 AFI cases (last 5 days)") {
                    imagehref = "../api/documents/ph7t8TbV1lJ/data";
                }
                if (attr[t].displayName == "≥ 5 AFI cases (last 7 days)") {
                    imagehref = "../api/documents/KE87BJI62sC/data";
                }
                if (attr[t].displayName == "≥ 2 ADD cases (last 3 days)") {
                    imagehref = "../dhis-web-commons/reports-libraries/img/add.png";
                }
                if (attr[t].displayName == "Manual Cluster") {
                    imagehref = "../api/documents/dWIBuOQPMHq/data";
                }
            }
            row = row + "<tr><td>" + blockn + "</td><td>" + oun + "<img src='" + imagehref + "' style='width:20px;height: 20px ;float:right'></td></tr>";
        }
        $('.alertstable').append(row + '</tbody>');
        $('.alertstable').show();
    };
//sidhanshu changes end --
	
	
    function loadDataX() {
        url = window.location.href;
       
		//sidhanshu changes start --
        $('#printing').show();
		//sidhanshu changes end --
        $("#legend").show();

        var datee;
        if (today == "") {
            today = document.getElementById('datepicker').value;
            today = today.split("-").reverse().join("-");
        }
        var year = today.substring(0, 4), month = today.substring(5, 7), piechartperod = year + '' + month, date = today.substring(8, 11);

        var today_ = year + "-" + month + "-" + date, today_fortable = year + month + date, last30days = "", d = new Date(year, month - 1, date);
        var previousdy = new Date(d.getTime() - 1 * 24 * 60 * 60 * 1000), previousdy_7 = new Date(d.getTime() - 7 * 24 * 60 * 60 * 1000), mon = previousdy.getMonth() + 1;
        var mon_ = previousdy_7.getMonth() + 1, datenew = previousdy.getDate(), datenew_ = previousdy_7.getDate(), dateyear = previousdy.getFullYear();
        var date_print = datenew + "-" + mon + "-" + dateyear;
        if (mon < 10) {
            mon = '0' + mon;
        }
        if (datenew < 10) {
            datenew = "0" + datenew;
        }
        if (mon_ < 10) {
            mon_ = '0' + mon_;
        }
        if (datenew_ < 10) {
            datenew_ = "0" + datenew_;
        }
        var previousdy1 = previousdy.getFullYear() + '' + mon + '' + datenew, previousdy1_ = previousdy.getFullYear() + '-' + mon + '-' + datenew, previousdy_7_ = previousdy_7.getFullYear() + '-' + mon_ + '-' + datenew_;


        for (var x = 30; x >= 1; x--) {
            // var date2=x-date;

            var startDate = new Date(d.getTime() - x * 24 * 60 * 60 * 1000);

            var date3 = startDate.getDate();
            if (date3 < 10) {
                date3 = '0' + date3;
            }
            var month1 = startDate.getMonth() + 1;
            if (month1 < 10) {
                month1 = '0' + month1;
            }
            var year1 = startDate.getFullYear();
            var period = year1 + '' + month1 + '' + date3;


            last30days = period + ';' + last30days;

        };
        var len = last30days.length - 1;
        last30days = last30days.substring(0, len);
        var last7days = "";
        var periodArray7Days=[];
        for (var x = 7; x >= 1; x--) {
            // var date2=x-date;

            var startDate = new Date(d.getTime() - x * 24 * 60 * 60 * 1000);
            var date3 = startDate.getDate();
            if (date3 < 10) {
                date3 = '0' + date3;
            }
            var month1 = startDate.getMonth() + 1;
            if (month1 < 10) {
                month1 = '0' + month1;
            }
            var year1 = startDate.getFullYear();


            var period = year1 + '' + month1 + '' + date3;

            periodArray7Days.push(period);
            last7days = period + ';' + last7days;

        };
        loadReports(previousdy_7_, previousdy1_, last7days);
        var len1 = last7days.length - 1;
        last7days = last7days.substring(0, len1);

        map = L.map('map1').setView([13.252525, 79.797979], 9.5);

        var style = {
            color: "black",
            opacity: 0.75,
            fillColor: "white",
            fillOpacity: 0,
            weight: 2,

        }
        $(".leaflet-control-zoom").css("display", "none");

        addOrgUnitLayer(5, Object.assign({}, style), true);
        style.weight = 0.95;
        style.color = "black";
        style.opacity = 0.25;
        addOrgUnitLayer(7, Object.assign({}, style));



        // get color depending on population density value
        function getColor(d) {
            var afi_3 = '../api/documents/ph7t8TbV1lJ/data', afi_5 = '../api/documents/KE87BJI62sC/data', lab_1 = '../api/documents/AafIibwti0p/data';
            return d > '1 Lab confirmed case' ? lab_1 :
                d > '5 AFI cases (last 7 days)' ? afi_5 :
                    d > '3 AFI cases (last 5 days)' ? afi_3 :
                        '#FFEDA0';

        }
        function style(feature) {
            return {
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7,
                fillColor: getColor(feature.properties.density)
            };
        }
        var legend = L.control({
            position: 'topleft'
        });

        legend.onAdd = function (map) {

            /*var div = L.DomUtil.create('div', 'info legend'),
                grades = ['3 AFI cases (last 5 days)', '5 AFI cases (last 7 days)', '1 Lab confirmed case',
                    'Manual Cluster','ADD 2 Cases in 3 Days'
                ],
                labels = [],
                from = ['../api/documents/ph7t8TbV1lJ/data', '../api/documents/KE87BJI62sC/data',
                    '../api/documents/AafIibwti0p/data', '../api/documents/dWIBuOQPMHq/data', '../api/documents/yVEmCyGgEoR/data'
                ],
                to;*/

            //legend order change to (1,2,3,5,manual)
            var div = L.DomUtil.create('div', 'info legend'),
                grades = ['1 Lab confirmed case', '3 AFI cases (last 5 days)', '5 AFI cases (last 5 days)', 'ADD 2 Cases in 3 Days',
                    'Manual Cluster'
                ],
                labels = [],
                from = ['../api/documents/AafIibwti0p/data', '../api/documents/ph7t8TbV1lJ/data', '../api/documents/KE87BJI62sC/data', '../dhis-web-commons/reports-libraries/img/add.png',
                    '../api/documents/dWIBuOQPMHq/data'
                ],
                to;

            for (var i = 0; i < grades.length; i++) {
                //                from = grades[i];
                to = grades[i];

                labels.push(
                    '<img src="' + (from[i]) + '"  style="width:20px;height: 20px ;"> ' + (to));
            }

            div.innerHTML = labels.join('<br>');
            return div;
        };

        legend.addTo(map);
		//sidhanshu changes start --
        document.getElementById("report").innerHTML = "Report ID: eDDSS-" + (today_.split("-")).join("") + "-" + getReportId();
        //sidhanshu changes end --
		document.getElementById("datet").innerHTML = "Date : " + dateformat(today_);
        document.getElementById("period").innerHTML = "Period : " + dateformat(previousdy_7_) + " - " + dateformat(
            previousdy1_);

        datepicked = document.getElementById('datepicker').value;
        datepicked = datepicked.split("-").reverse().join("-");

        var format = "YYYY-MM-DD", endDate = new Date(datepicked), startDate = new Date(endDate);

        startDate = startDate.setDate(endDate.getDate() - 7);

        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: "../api/trackedEntityInstances?ou=" + NIE.ROOT_OU_UID + "&ouMode=DESCENDANTS&filter=" +
                NIE.CLUSTER_TEA_CLUSTER_TAIL_DATE + ":ge:" + moment(startDate).format(format) + "&filter=" +
                NIE.CLUSTER_TEA_CLUSTER_START_DATE + ":eq:" + moment(endDate).format(format) +
                "&program=" + NIE.Cluster_ProgramUID +
                "&skipPaging=true",
            success: function (data) {
                var teis = data.trackedEntityInstances;
                //console.log(data);
                coords = extractCoordsFromTEI(teis, true);
                featureCollection = getPointFeatures(coords)
                addClusterMarkers(featureCollection);
				//sidhanshu changes start --
                 alertstable(teis);
				 //sidhanshu changes end --
            },
            error: function (response) {

            }
        });
        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/25/analytics.json?dimension=dx:c6ZZS1owbii;BJ3D1sBfXkN&dimension=pe:' + last7days +
                '&filter=ou:'+NIE.ROOT_OU_UID+'&displayProperty=NAME&outputIdScheme=CODE',
            success: function (dhis_rows) {
                var ipmalecount=0,ipfemalecount=0;
                for (var i = 0; i < dhis_rows.metaData.pe.length; i++) {
                    x_categories.push(dhis_rows.metaData.pe[i]);
                }

                for (var i = 0; i < dhis_rows.rows.length; i++) {
                    if (dhis_rows.rows[i][0] == "c6ZZS1owbii") {
                        ip_fever.ip_fever_male.push({
                            "name": "IP fever case (male)",
                            "period": dhis_rows.rows[i][1],
                            "value": dhis_rows.rows[i][2]
                        });

                        if(periodArray7Days[ipmalecount]==dhis_rows.rows[i][1])
                        {
                            ip_fever_male_data.push(Number(dhis_rows.rows[i][2]));

                        }
                        else {
                            ip_fever_male_data.push(Number(0));
                            i--;
                        }
                        ipmalecount++;


                    } else if (dhis_rows.rows[i][0] == "BJ3D1sBfXkN") {
                        ip_fever.ip_fever_female.push({
                            "name": "IP fever case (female)",
                            "period": dhis_rows.rows[i][1],
                            "value": dhis_rows.rows[i][2]
                        });

                        if(periodArray7Days[ipfemalecount]==dhis_rows.rows[i][1])
                        {
                            ip_fever_female_data.push(Number(dhis_rows.rows[i][2]));

                        }
                        else {
                            ip_fever_female_data.push(Number(0));
                            i--;
                        }
                        ipfemalecount++;


                    } else {
                        ip_fever.ip_fever_total.push({
                            "name": "IP fever case (total)",
                            "period": dhis_rows.rows[i][1],
                            "value": dhis_rows.rows[i][2]
                        });

                        ip_fever_total_data.push(dhis_rows.rows[i][2]);
                    }

                }
                x_categories.reverse();
                //  ip_fever_male_data.reverse();
                // ip_fever_female_data.reverse();

                generatechart_ipfever_male_female(x_categories, ip_fever_male_data,
                    ip_fever_female_data);

				// //sidhanshu changes start --
               //  x_categories.reverse();
               //  ip_fever_male_data.reverse();
               // ip_fever_female_data.reverse();
               //
               //  generatechart_ipfever_male_female(x_categories, ip_fever_male_data,
               //  ip_fever_female_data);
				// //sidhanshu changes end --

            },
            error: function (response) {

            }
        });

        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/25/analytics.json?dimension=dx:qt1YSg9Nxrf;tGevnp0W5lQ;b2RCQBQGScR;PGmsNGvuZtr&dimension=pe:' +
                last7days + '&filter=ou:'+NIE.ROOT_OU_UID+'&displayProperty=NAME&skipMeta=true',
            success: function (dhis_rows) {
                x_categories = [];
                for (var i = 0; i < dhis_rows.rows.length; i++) {
                    for (var i = 0; i < dhis_rows.rows.length; i++) {
                        if (dhis_rows.rows[i][0] == "PGmsNGvuZtr") {
                            ip_fever_gender.ip_fever_age_g_12.push({
                                "name": "IP fever case (age > 12 yrs)",
                                "period": dhis_rows.rows[i][1],
                                "value": dhis_rows.rows[i][2]
                            });

                            if(periodArray7Days[age12count]==dhis_rows.rows[i][1])
                            {
                                ip_fever_age12.push(Number(dhis_rows.rows[i][2]));

                            }
                            else {
                                ip_fever_age12.push(Number(0));
                                i--;
                            }
                            age12count++;
                            x_categories.push(dhis_rows.rows[i][1]);
                        }
                        else if (dhis_rows.rows[i][0] == "qt1YSg9Nxrf") {
                            ip_fever_gender.ip_fever_age_l_1.push({
                                "name": "IP fever case (age < 1 year)",
                                "period": dhis_rows.rows[i][1],
                                "value": dhis_rows.rows[i][2]
                            });

                            if(periodArray7Days[ageless1count]==dhis_rows.rows[i][1])
                            {
                                ip_fever_agel.push(Number(dhis_rows.rows[i][2]));

                            }
                            else {
                                ip_fever_agel.push(Number(0));
                                i--;
                            }
                            ageless1count++;
                        } else if (dhis_rows.rows[i][0] == "b2RCQBQGScR") {
                            ip_fever_gender.ip_fever_age_6to12.push({
                                "name": "IP fever case (age 6-12 yrs)",
                                "period": dhis_rows.rows[i][1],
                                "value": dhis_rows.rows[i][2]
                            });

                            if(periodArray7Days[age6count]==dhis_rows.rows[i][1])
                            {
                                ip_fever_ageg6to12.push(Number(dhis_rows.rows[i][2]));

                            }
                            else {
                                ip_fever_ageg6to12.push(Number(0));
                                i--;
                            }

                            age6count++;
                        } else if (dhis_rows.rows[i][0] == "tGevnp0W5lQ") {
                            ip_fever_gender.ip_fever_age_1to5.push({
                                "name": "IP fever case (age 1-5 yrs)",
                                "period": dhis_rows.rows[i][1],
                                "value": dhis_rows.rows[i][2]
                            });

                            if(periodArray7Days[age1to5count]==dhis_rows.rows[i][1])
                            {
                                ip_fever_age1to5.push(Number(dhis_rows.rows[i][2]));

                            }
                            else {
                                ip_fever_age1to5.push(Number(0));
                                i--;
                            }
                            age1to5count++;
                        } else {
                            ip_fever_total_data.push(dhis_rows.rows[i][2]);
                        }
                    }
                }
                x_categories.reverse();
                ip_fever_age12.reverse();
                ip_fever_age1to5.reverse();
                ip_fever_ageg6to12.reverse();
                ip_fever_agel.reverse();
                generatechart_ipfever_age(x_categories, ip_fever_age12, ip_fever_agel, ip_fever_age1to5,
                    ip_fever_ageg6to12);
				// //sidhanshu changes start --
            //     x_categories.reverse();
            // //    ip_fever_age12.reverse();
            // //    ip_fever_age1to5.reverse();
            // //    ip_fever_ageg6to12.reverse();
            // //    ip_fever_agel.reverse();
            //     generatechart_ipfever_age(x_categories, ip_fever_age12, ip_fever_agel, ip_fever_age1to5,
            //     ip_fever_ageg6to12);
				// //sidhanshu changes end --
            },
            error: function (response) {

            }
        });

        $.ajax({

            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/25/analytics.json?dimension=dx:rtJChfVTmu7;LbnFL8X21GT;UwV54uUUVSB;d52vGh8MZ67;HRbBOn83m5D&dimension=pe:' + last7days +
                '&filter=ou:'+NIE.ROOT_OU_UID+'&displayProperty=NAME',
            success: function (dhis_rows) {
                x_categories = [];
                var denguecount=0,scrubcount=0,malariacount=0,chikuncount=0,leptocount=0;
                for (var j = 0; j < dhis_rows.metaData.pe.length; j++) {
                    x_categories.push(dhis_rows.metaData.pe[j]);
                }
                for (var i = 0; i < dhis_rows.rows.length; i++) {
                    if (dhis_rows.rows[i][0] == "rtJChfVTmu7") {

                        if(periodArray7Days[denguecount]==dhis_rows.rows[i][1])
                        {
                            ip_fever_dengue_cases.push(Number(dhis_rows.rows[i][2]));

                        }
                        else {
                            ip_fever_dengue_cases.push(Number(0));
                            i--;
                        }
                        denguecount++;


                    } else if (dhis_rows.rows[i][0] == "LbnFL8X21GT") {
                        if(periodArray7Days[scrubcount]==dhis_rows.rows[i][1])
                        {
                            ip_fever_scrub_cases.push(Number(dhis_rows.rows[i][2]));

                        }
                        else {
                            ip_fever_scrub_cases.push(Number(0));
                            i--;
                        }
                        scrubcount++;

                    }
                    else if (dhis_rows.rows[i][0] == "UwV54uUUVSB") {
                        if(periodArray7Days[malariacount]==dhis_rows.rows[i][1])
                        {
                            ip_fever_malaria_cases.push(Number(dhis_rows.rows[i][2]));

                        }
                        else {
                            ip_fever_malaria_cases.push(Number(0));
                            i--;
                        }
                        malariacount++;

                    }
                    else if (dhis_rows.rows[i][0] == "UwV54uUUVSB") {
                        if(periodArray7Days[leptocount]==dhis_rows.rows[i][1])
                        {
                            ip_fever_lepto_cases.push(Number(dhis_rows.rows[i][2]));

                        }
                        else {
                            ip_fever_lepto_cases.push(Number(0));
                            i--;
                        }
                        leptocount++;

                    }
                    else if (dhis_rows.rows[i][0] == "HRbBOn83m5D") {
                        if(periodArray7Days[chikuncount]==dhis_rows.rows[i][1])
                        {
                            ip_fever_chikun.push(Number(dhis_rows.rows[i][2]));

                        }
                        else {
                            ip_fever_chikun.push(Number(0));
                            i--;
                        }
                        chikuncount++;

                    }
                }


                generatechart_ipfever_disease(x_categories, ip_fever_dengue_cases, ip_fever_scrub_cases,ip_fever_malaria_cases,ip_fever_lepto_cases,ip_fever_chikun);
            },
            error: function (response) {

            }
        });

        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/25/analytics.json?dimension=dx:yldg0WX82FD&dimension=pe:' + last7days +
                '&dimension=ou:'+NIE.ROOT_OU_UID+'&displayProperty=NAME',
            success: function (dhis_rows) {
                x_categories = [];
                var opcount=0;
                for (var j = 0; j < dhis_rows.metaData.pe.length; j++) {
                    x_categories.push(dhis_rows.metaData.pe[j]);

                }
                for (var i = 0; i < dhis_rows.rows.length; i++) {

                    if (dhis_rows.rows[i][0] == "yldg0WX82FD") {

                        if(periodArray7Days[opcount]==dhis_rows.rows[i][1])
                        {
                            opcases.ouperiod.push(dhis_rows.rows[i][1]);
                            opcases.ouval.push(Number(dhis_rows.rows[i][3]));

                        }
                        else {
                            opcases.ouperiod.push(dhis_rows.rows[i][1]);
                            opcases.ouval.push(Number(0));
                            i--;
                        }
                        opcount++;

                    }
                }
                // opcases.ouval.reverse();
                // opcases.ouperiod.reverse();

                linechart_op(opcases.ouperiod, opcases.ouval,last30days);
            },
            error: function (response) {

            }
        });

        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/25/analytics.json?dimension=dx:kI1lGixi5a5&dimension=pe:' + last7days +
                '&filter=ou:'+NIE.ROOT_OU_UID+'&displayProperty=NAME',
            success: function (dhis_rows) {
                x_categories = [];
                var ipcount=0;
                for (var i = 0; i < dhis_rows.metaData.pe.length; i++) {
                    x_categories.push(dhis_rows.metaData.pe[i]);
                }
                for (var i = 0; i < dhis_rows.rows.length; i++) {
                    if (dhis_rows.rows[i][0] == "kI1lGixi5a5") {
                        if(periodArray7Days[ipcount]==dhis_rows.rows[i][1])
                        {
                            ipcases.push(Number(dhis_rows.rows[i][2]));

                        }
                        else {
                            ipcases.push(Number(0));
                            i--;
                        }
                        ipcount++;


                    }
                }
                ipcases.reverse();

                linechart_ip(x_categories, ipcases,last30days);
            },
            error: function (response) {

            }
        });
        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/25/analytics.json?dimension=dx:BZW0y6OUSVS&dimension=pe:' + last7days +
                '&filter=ou:'+NIE.ROOT_OU_UID+'&displayProperty=NAME',
            success: function (dhis_rows) {
                x_categories = [];
                var labcount=0;
                for (var i = 0; i < dhis_rows.metaData.pe.length; i++) {
                    x_categories.push(dhis_rows.metaData.pe[i]);
                }

                for (var i = 0; i < dhis_rows.rows.length; i++) {
                    if (dhis_rows.rows[i][0] == "BZW0y6OUSVS") {

                        if(periodArray7Days[labcount]==dhis_rows.rows[i][1])
                        {
                            labconfirmedcases.push(Number(dhis_rows.rows[i][2]));

                        }
                        else {
                            labconfirmedcases.push(Number(0));
                            i--;
                        }
                        labcount++;

                    }
                }

                linechart_fever(x_categories, labconfirmedcases,last30days);
			},
            error: function (response) {

            }
        });
        $.getJSON("../api/analytics/events/aggregate/Ml0ZNj9APN0.json?stage=iWcQ5lxmsy4&dimension=pe:" + last7days +
            "&dimension=ou:LEVEL-5;"+NIE.ROOT_OU_UID+"&outputType=EVENT&displayProperty=NAME",
            function (odfjson1, id) {
                var map = [],
                    count;
                for (var i = 0; i < odfjson1.rows.length; i++) {
                    if (!map[odfjson1.rows[i][1]]) {
                        map[odfjson1.rows[i][1]] = [];
                    }
                    map[odfjson1.rows[i][1]].push(odfjson1.rows[i]);
                }

                for (var j = 0; j < Object.keys(map).length; j++) {
                    count = 0;
                    $.ajax({
                        async: false,
                        type: "GET",
                        dataType: "json",
                        contentType: "application/json",
                        url: '../api/organisationUnits/' + Object.keys(map)[j] + '.json?fields=name,id',
                        success: function (data) {

                            taluk_count_07.orgname.push(data.name);
                        }
                    });


                    for (var i = 0; i < Object.values(map)[j].length; i++) {
                        count = Number(count) + Number(Object.values(map)[j][i][2]);

                    }
                    taluk_count_07.orgcount.push(Math.round(count / 7));

                }
                if (taluk_count_07.orgname.length < 14) {
                    taluk_count_07.orgname.push("Puzhal");
                    taluk_count_07.orgcount.push(0);
                } else {

                }
                $.ajax({
                    async: false,
                    type: "GET",
                    dataType: "json",
                    contentType: "application/json",
                    url: '../api/analytics/events/aggregate/Ml0ZNj9APN0.json?stage=iWcQ5lxmsy4&dimension=pe:' +
                        last30days +
                        '&dimension=ou:LEVEL-5;'+NIE.ROOT_OU_UID+'&outputType=EVENT&displayProperty=NAME',
                    success: function (odfjson1, id) {
                        var map = [],
                            count = 0;
                        for (var i = 0; i < odfjson1.rows.length; i++) {
                            if (!map[odfjson1.rows[i][1]]) {
                                map[odfjson1.rows[i][1]] = [];
                            }
                            map[odfjson1.rows[i][1]].push(odfjson1.rows[i]);
                        }

                        for (var j = 0; j < Object.keys(map).length; j++) {


                            $.ajax({
                                async: false,
                                type: "GET",
                                dataType: "json",
                                contentType: "application/json",
                                url: '../api/organisationUnits/' + Object.keys(map)[j] +
                                    '.json?fields=name,id',
                                success: function (data) {

                                    taluk_count_30.orgname.push(data.name);
                                }
                            });

                            for (var i = 0; i < Object.values(map)[j].length; i++) {
                                count = Number(count) + Number(Object.values(map)[j][i][2]);

                            }
                            taluk_count_30.orgcount.push(Math.round(count / 30));
                            count = 0;

                        }
                    },
                    error: function (response) { }
                });

                $.ajax({
                    async: false,
                    type: "GET",
                    dataType: "json",
                    contentType: "application/json",
                    url: '../api/analytics/events/aggregate/Ml0ZNj9APN0.json?stage=iWcQ5lxmsy4&dimension=pe:' +
                        today_fortable +
                        '&dimension=ou:LEVEL-5;'+NIE.ROOT_OU_UID+'&outputType=EVENT&displayProperty=NAME',
                    success: function (odfjson1, id) {
                        var map = [],
                            count = 0;
                        for (var i = 0; i < odfjson1.rows.length; i++) {
                            if (!map[odfjson1.rows[i][1]]) {
                                map[odfjson1.rows[i][1]] = [];
                            }
                            map[odfjson1.rows[i][1]].push(odfjson1.rows[i]);
                        }

                        for (var j = 0; j < Object.keys(map).length; j++) {


                            $.ajax({
                                async: false,
                                type: "GET",
                                dataType: "json",
                                contentType: "application/json",
                                url: '../api/organisationUnits/' + Object.keys(map)[j] +
                                    '.json?fields=name,id',
                                success: function (data) {

                                    taluk_count_01.orgname.push(data.name);
                                }
                            });

                            for (var i = 0; i < Object.values(map)[j].length; i++) {
                                count = Number(count) + Number(Object.values(map)[j][i][2]);

                            }
                            taluk_count_01.orgcount.push(Math.round(count));
                            count = 0;
                        }

                        for (var i = 0; i < taluk_count_07.orgname.length; i++) {
                            for (var j = 0; j < taluk_count_30.orgname.length; j++) {
                                if (taluk_count_07.orgname[i] == taluk_count_30.orgname[j]) {
                                    taluk_count_30.orgname[i] = taluk_count_30.orgname[j];
                                    taluk_count_30.orgcount[i] = taluk_count_30.orgcount[j];

                                }
                                if (taluk_count_07.orgname[i] == taluk_count_01.orgname[j]) {
                                    taluk_count_01.orgname[i] = taluk_count_01.orgname[j];
                                    taluk_count_01.orgcount[i] = taluk_count_01.orgcount[j];

                                }

                            }
                        }
                        generatetable(today_, taluk_count_07, taluk_count_30, taluk_count_01);
                    },
                    error: function (response) { }
                });

            });


    }

    function generatetable(today_, taluk_count_07, taluk_count_30, taluk_count_01) {
        var tablerow = "";
        for (var tab = 0; tab < taluk_count_07.orgname.length; tab++) {

            if (taluk_count_01.orgname.includes(taluk_count_07.orgname[tab])) { } else {
                taluk_count_01.orgname.push(taluk_count_07.orgname[tab]);
                taluk_count_01.orgcount.push(0);
            }


            if (taluk_count_01.orgcount[tab] == "undefined" || taluk_count_01.orgcount[tab] == "" || taluk_count_01
                .orgcount[tab] == null) {
                taluk_count_01.orgcount[tab] = 0;
            }
            if (taluk_count_07.orgcount[tab] == "undefined" || taluk_count_07.orgcount[tab] == "" || taluk_count_07
                .orgcount[tab] == null) {
                taluk_count_07.orgcount[tab] = 0;
            }
            if (taluk_count_30.orgcount[tab] == "undefined" || taluk_count_30.orgcount[tab] == "" || taluk_count_30
                .orgcount[tab] == null) {
                taluk_count_30.orgcount[tab] = 0;
            }

        }
	//sidhanshu changes start --
        var sortedvalues = [];
        for (var tab = 0; tab < taluk_count_07.orgname.length; tab++) {
            //code for sorting
            var diff = Math.round(taluk_count_07.orgcount[tab] - taluk_count_30.orgcount[tab]);
            sortedvalues[tab + "-" + taluk_count_07.orgname[tab]] = diff;
        }
        var sortedT = Object.keys(sortedvalues)
            .sort(function (a, b) { return +b - +a })
            .map(function (k) { return { key: k, value: sortedvalues[k] } });

        sortedT.sort(function (a, b) {
            var nameA = a.value, nameB = b.value
            if (nameA < nameB) //sort string ascending
                return -1
            if (nameA > nameB)
                return 1
            return 0 //default return value (no sorting)
        });

        sortedT.reverse();
        console.log(sortedT);



        for (var tab1 = 0; tab1 < taluk_count_07.orgname.length; tab1++) {
            var tab = (sortedT[tab1].key).split("-")[0];
			
			//sidhanshu changes end --
            console.log("name:--" + tab + "->", taluk_count_07.orgname[tab])
            tablerow +=
                "<tr style='padding-bottom: 1em;border-bottom:0.5px solid black'><td style='text-align:right;padding-right:5px;'>" +
                parseInt(
                    parseInt(tab1) + 1) + "</td><td style='text-align:left;'>" +
                taluk_count_07.orgname[tab] + "</td><td style='text-align:right;'>" + taluk_count_01.orgcount[
                tab] +
                "</td><td style='text-align:right;'>" + taluk_count_07.orgcount[tab] +
                "</td><td style='text-align:right;'>" + taluk_count_30.orgcount[tab] + "</td></tr>";
            taluk_chart_data.push(Math.round(taluk_count_07.orgcount[tab] - taluk_count_30.orgcount[tab]));
            taluk_chart_data_name.push((taluk_count_07.orgname[tab]));

            if (taluk_count_01.orgcount[tab] == "-") {
                taluk_count_01.orgcount[tab] = 0;
            }
            if (taluk_count_07.orgcount[tab] == "-") {
                taluk_count_07.orgcount[tab] = 0;
            }
            if (taluk_count_30.orgcount[tab] == "-") {
                taluk_count_30.orgcount[tab] = 0;
            }
            total_1day += parseInt(taluk_count_01.orgcount[tab]);
            total_7day += parseInt(taluk_count_07.orgcount[tab]);
            total_30day += parseInt(taluk_count_30.orgcount[tab]);
        }
        var _7day = total_1day.toString();
        var _1day = total_7day.toString();
        var _30day = total_30day.toString();
        _7day.replace(/[^a-zA-Z ]/g, "");
        _1day.replace(/[^a-zA-Z ]/g, "");
        _30day.replace(/[^a-zA-Z ]/g, "");
        var tableheading =
            "<tr style='border-bottom:2px solid black;'><td style='text-align:center;'> S.No  </td><td style='text-align:center;'>Name of the Block </td><td style='text-align:center;'>" +
            "IP-" + today_ +

            "</td><td style='text-align:center;'>Last 7 Days (Average)</td><td style='text-align:center;'>Last 30 Days(Average)</td></tr>";
        //to DO add a Total at the end of row
        var table_total =
            "<tr style='border-top:2px solid black'><td style='text-align:left;'> Total </td><td style='text-align:left;'> </td><td style='text-align:right;'>" +
            total_1day +
            "</td><td style='text-align:right;'>" + total_7day + "</td><td style='text-align:right;'>" + total_30day +
            "</td></tr>";

        var table = "<table style='margin-left: 12%; width: 80%;height: 40%;margin-bottom:5%;margin-top:5%;'>" +
            tableheading + tablerow + table_total + "</table>";
        document.getElementById("summary").innerHTML = table;

        generatechart_taluk(taluk_chart_data, taluk_chart_data_name);
    }

    function generatechart_taluk(taluk_chart_data) {
        Highcharts.chart('sumamry_chart', {
            chart: {
                type: 'bar'
            },
            title: {
                text: 'Difference of last 7 days average and last 30 days average'
            },

            xAxis: {

                lineWidth: 0,
                minorGridLineWidth: 0,
                lineColor: 'transparent',

                labels: {
                    enabled: false
                },
                minorTickLength: 0,
                tickLength: 0
            },

            yAxis: {
                gridLineWidth: 0,
                minorGridLineWidth: 0,
                allowDecimals: false,
                title: {
                    text: null
                },
                plotLines: [{
                    color: 'red',
                    width: 3,
                    value: 0
                }],
                labels: {
                    enabled: true
                },

            },

            plotOptions: {
                bar: {
                    zones: [{
                        value: 0, // Values up to 10 (not including) ...
                        color: 'blue', // ... have the color blue.
                        label: 'Negative -----'
                    }, {
                        color: 'red', // Values from 10 (including) and up have the color red
                        label: 'Positive -----'
                    }]
                }
            },
            legend: {
                enabled: false
            },

            series: [{
                dataLabels: {
                    enabled: true,
                },
                data: taluk_chart_data
            }]
        });


    }

    function generatechart_ipfever_male_female(x_categories, ip_fever_male_data, ip_fever_female_data) {
        Highcharts.chart('container1', {
            chart: {
                type: 'column'
            },
            title: {
                text: ''
            },
            xAxis: {
                categories: x_categories,
                max: 6,
                labels: {
                    enabled: false
                },
            },
            yAxis: {
                min: 0,
                max: 100,
                tickInterval: 20,
                gridLineWidth: 0,
                minorGridLineWidth: 0,
                title: {
                    text: 'by Gender'
                },
                plotOptions: {
                    bar: {
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                labels: {
                    format: '{value}%'
                }
            },
            plotOptions: {
                series: {
                    dataLabels: {
                        enabled: true,
                    }
                }
            },
            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle'
            },
            // tooltip: {
            //     pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.0f}%)<br/>',
            //     shared: true
            // },
            plotOptions: {
                column: {
                    gapSize: 0,
                    groupPadding: 0,
                    pointPadding: 0,
                    stacking: 'percent',
                    dataLabels: {
                        enabled: true,
                        color: 'black'
                    }
                },

            },
            series: [{
                dataLabels: {
                    enabled: true,
                    color: 'black'
                },
                name: "Male",
                color: '#0099CC',
                data: ip_fever_male_data
            }, {
                dataLabels: {
                    enabled: true,
                    color: 'black'
                },
                name: "Female",
                color: '#FF9933',
                data: ip_fever_female_data
            }]
        });
    }

    function generatechart_ipfever_age(x_categories, ip_fever_age12, ip_fever_agel, ip_fever_age1to5,
        ip_fever_ageg6to12) {
        Highcharts.chart('container', {
            chart: {
                type: 'column'
            },
            title: {
                text: ''
            },
            xAxis: {
				categories: x_categories, 
				reversed: true,
                max: 6,
                labels: {
                    enabled: false
                },
            },
            yAxis: {
                min: 0,
                max: 100,
                tickInterval: 20,
                gridLineWidth: 0,
                minorGridLineWidth: 0,
                title: {
                    text: 'by Age'
                },
                plotOptions: {
                    bar: {
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                labels: {
                    format: '{value}%'
                }
            },
            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle'
            },

            tooltip: {
                pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.0f}%)<br/>',
                shared: true
            },
            plotOptions: {
                column: {
                    gapSize: 0,
                    groupPadding: 0,
                    pointPadding: 0,
                    stacking: 'percent',
                    dataLabels: {
                        enabled: true,
                        color: 'black'
                    }
                }
            },
            series: [{
                dataLabels: {
                    enabled: true,
                    color: 'black'
                },
                name: "> 12",
                color: '#BE8D55',
                data: ip_fever_age12
            }, {
                dataLabels: {
                    enabled: true,
                    color: 'black'
                },
                name: "6 to 12 ",
                color: '#7AE08C',
                data: ip_fever_ageg6to12
            }, {
                dataLabels: {
                    enabled: true,
                    color: 'black'
                },
                name: "1 to 5",
                color: '#FFF162',
                data: ip_fever_age1to5
            }, {
                dataLabels: {
                    enabled: true,
                    color: 'black'
                },
                name: "< 1",
                color: '#FF9966',
                data: ip_fever_agel
            }]
        });
    }

    function generatechart_ipfever_disease(x_categories, ip_fever_dengue_cases, ip_fever_scrub_cases,ip_fever_malaria_cases,ip_fever_lepto_cases,ip_fever_chikun) {
        var period_array = [];
        for (var i = 0; i < x_categories.length; i++) {
            var _period = dateformat1(x_categories[i]);
            period_array.push(_period);
        }
        period_array.reverse();
        Highcharts.chart('container2', {
            chart: {
                type: 'column'
            },
            title: {
                text: ''
            },
            xAxis: {
                categories: period_array,
                min: 0,
                max: 6
            },
            column: {
                minPointLength: 7
            },
            yAxis: {
                min: 0,
                max: 100,
                tickInterval: 20,
                gridLineWidth: 0,
                minorGridLineWidth: 0,
                title: {
                    text: 'by diseases(Lab)'
                },
                labels: {
                    format: '{value}%'
                }
            },
            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle'
            },
            tooltip: {
                pointFormat: '<span style="color:black">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.0f}%)<br/>',
                shared: true
            },
            plotOptions: {
                column: {
                    gapSize: 0,
                    groupPadding: 0,
                    pointPadding: 0,
                    stacking: 'percent',
                    dataLabels: {
                        enabled: true,
                        color: 'black'
                    }
                }
            },
            series: [{
                dataLabels: {
                    enabled: true,
                    color: 'black'
                },
                name: "Dengue",
                color: '#32CD33',
                data: ip_fever_dengue_cases
            }, {
                dataLabels: {
                    enabled: true,
                    color: 'black'
                },
                name: "Scrub",
                color: 'orange',
                data: ip_fever_scrub_cases
            },
                {
                    dataLabels: {
                        enabled: true,
                        color: 'black'
                    },
                    name: "Malaria",
                    color: 'blue',
                    data: ip_fever_malaria_cases
                },
                {
                    dataLabels: {
                        enabled: true,
                        color: 'black'
                    },
                    name: "Leptospirosis",
                    color: 'red',
                    data: ip_fever_lepto_cases
                },
                {
                    dataLabels: {
                        enabled: true,
                        color: 'black'
                    },
                    name: "Chikungunya",
                    color: 'violet',
                    data: ip_fever_chikun
                },

            ]
        });
    }

    function linechart_op(x_categories, opcases, last30days) {

        var avg = 0;
        var sum = 0;
        for (var i = 0; i < opcases.length; i++) {
            sum += opcases[i];
        }

        avg = parseInt(sum) / (opcases.length);

        var target = 0;
        var oplast30days = '../api/25/analytics.json?dimension=dx:yldg0WX82FD&dimension=pe:' + last30days +
            '&filter=ou:'+NIE.ROOT_OU_UID+'&displayProperty=NAME'

        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/25/analytics.json?dimension=dx:yldg0WX82FD&dimension=pe:' + last30days +
                '&filter=ou:'+NIE.ROOT_OU_UID+'&displayProperty=NAME',
            success: function (data_op) {
                for (var i = 0; i < data_op.rows.length; i++) {
                    target += parseInt(data_op.rows[i][2]);

                }
                target = target / 30;

            },
            error: function (response) { }
        });



        Highcharts.chart('container_op', {

            title: {
                text: ''
            },
            xAxis: {
                categories: x_categories,
                min: 0,
                max: 6,
                labels: {
                    enabled: false
                }
            },
            yAxis: {
			//sidhanshu changes start --
                max: opcases.reduce(function (a, b) {
                    return Math.max(a, b);
                },0) + 5,
                min: opcases.reduce(function (a, b) {
                    return Math.min(a, b);
                },0),
                gridLineWidth: 0,
                minorGridLineWidth: 0,
                title: {
                    text: 'OP Cases(n =' + sum + ')'
                },

                plotLines: [{
                    value: Math.round(avg),
                    color: 'red',
                    width: 2,
                    label: {
                        text: 'Average ' + Math.round(avg),
                        align: 'center'
                    }
                }]
            },
            legend: {
                enabled: false,
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle'
            },
            series: [{
                dataLabels: {
                    enabled: true,
                    color: 'black'
                },
                name: 'OP Cases',
                color: 'lightgreen',
                data: opcases
            }]

        });

    }

    function linechart_ip(x_categories, ipcases, last30days) {


        var avg = 0;
        var sum = 0;
        for (var i = 0; i < ipcases.length; i++) {
            sum += ipcases[i];
        }

        avg = parseInt(sum) / (ipcases.length);

        var target = 0;
        var iplast30 = '../api/analytics.json?dimension=dx:kI1lGixi5a5&dimension=pe:' + last30days +
            '&filter=ou:'+NIE.ROOT_OU_UID+'&displayProperty=NAME';

        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: iplast30,
            success: function (data_op) {

                for (var i = 0; i < data_op.rows.length; i++) {
                    target += parseInt(data_op.rows[i][2]);

                }

                target = target / 30;

            },
            error: function (response) {

            }
        });

        Highcharts.chart('container_ip', {

            title: {
                text: ''
            },
            xAxis: {
                categories: x_categories,
                reversed: true,
                min: 0,
                max: 6,
                labels: {
                    enabled: false
                }
            },
			//sidhanshu changes start --
            yAxis: {
                max: ipcases.reduce(function (a, b) {
                    return Math.max(a, b);
                },0) + 5,
                min: ipcases.reduce(function (a, b) {
                    return Math.min(a, b);
                },0),
                gridLineWidth: 0,
                minorGridLineWidth: 0,
                title: {
                    text: 'IP Cases(n =' + sum + ')'
                },
                plotLines: [{
                    value: Math.round(avg),
                    color: 'red',
                    width: 2,
                    label: {
                        text: 'Last 30 Days Average ' + Math.round(avg),
                        align: 'center',
                    }
                }]
            },
            legend: {
                enabled: false,
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle'
            },
            series: [{
                dataLabels: {
                    enabled: true,
                    color: 'black'
                },
                name: 'IP Cases',
                data: ipcases
            }]

        });

    }


    function linechart_fever(x_categories, labconfirmedcases, last30days) {

        var avg = 0;
        var sum = 0;
        for (var i = 0; i < labconfirmedcases.length; i++) {
            sum += labconfirmedcases[i];
        }

        avg = parseInt(sum) / (labconfirmedcases.length);


        var period_array = [];
        for (var i = 0; i < x_categories.length; i++) {
            var _period = dateformat1(x_categories[i]);
            period_array.push(_period);
        }
        period_array.reverse();
        var target = 0;
        var oplast30days = '../api/25/analytics.json?dimension=dx:CwwhAcIkrSq&dimension=pe:' + last30days +
            '&filter=ou:'+NIE.ROOT_OU_UID+'&displayProperty=NAME'

        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: oplast30days,
            success: function (data_op) {
                for (var i = 0; i < data_op.rows.length; i++) {
                    target += parseInt(data_op.rows[i][2]);

                }
                target = target / 30;

            },
            error: function (response) {

            }
        });

        Highcharts.chart('container_fever', {

            title: {
                text: ''
            },

            xAxis: {
                categories: period_array,
                min: 0,
                max: 6,
                labels: {
                    enabled: true
                }
            },
			//sidhanshu changes start --
            yAxis: {
                max: labconfirmedcases.reduce(function (a, b) {
                    return Math.max(a, b);
                },0) + 5,
                min: labconfirmedcases.reduce(function (a, b) {
                    return Math.min(a, b);
                },0),
                gridLineWidth: 0,
                minorGridLineWidth: 0,
                title: {
                    text: 'Lab Confirmed Cases(n =' + sum + ')'
                },
                plotLines: [{
                    value: Math.round(avg),
                    color: 'red',
                    width: 2,
                    label: {
                        text: 'Last 30 Days  Average ' + Math.round(avg),
                        align: 'center'
                    }
                }]
            },
            legend: {
                enabled: false,
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle'
            },

            series: [{
                dataLabels: {
                    enabled: true,
                    color: 'black'
                },
                name: 'Lab Cases',
                color: 'purple',
                data: labconfirmedcases,
            }]

        });
    }
//sidhanshu changes start --
    var getClusterId = function (t) {
        var c = "";
        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/trackedEntityInstances/' + t + '.json?fields=*&ouMode=ALL',
            success: function (data11) {
                if (data11.attributes.length != 0) {
                    for (var i = 0; i < data11.attributes.length; i++) {
                        if (data11.attributes[i].displayName == "Cluster ID") {
                            c = data11.attributes[i].value;
                        }
                    }
                }
            }
        });
        return c;
    };
    var teiClusterMap = [];
    var getSortedData = function (res) {
        for (var i = 0; i < res.trackedEntityInstances.length; i++) {
            var tei = res.trackedEntityInstances[i].trackedEntityInstance;
            var cluster = getClusterId(tei);
            teiClusterMap[cluster] = tei;
        }
        var sorted = Object.keys(teiClusterMap)
            .sort(function (a, b) { return +b - +a })
            .map(function (k) { return { key: k, value: teiClusterMap[k] } });

        sorted.sort(function (a, b) {
            var nameA = a.key.toLowerCase(), nameB = b.key.toLowerCase()
            if (nameA < nameB) //sort string ascending
                return -1
            if (nameA > nameB)
                return 1
            return 0 //default return value (no sorting)
        });

        return sorted;
    };
//sidhanshu changes end --
    var loadReports = function (previousdy_7_, previousdy1_, last7days) {

        var format = "YYYY-MM-DD";


        datepicked = document.getElementById('datepicker').value;
        datepicked = datepicked.split("-").reverse().join("-");

        var endDate = new Date(datepicked);
        var startDate = new Date(endDate)

        startDate = startDate.setDate(endDate.getDate() - 7);
        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json", //sidhanshu changes start --
			url: "../api/trackedEntityInstances?ou=" + NIE.ROOT_OU_UID + "&ouMode=DESCENDANTS&filter=" +
			NIE.CLUSTER_TEA_CLUSTER_TAIL_DATE + ":ge:" + moment(startDate).format(format) + "&filter=" +
			NIE.CLUSTER_TEA_CLUSTER_START_DATE + ":eq:" + moment(endDate).format(format) +
			"&program=" + NIE.Cluster_ProgramUID +
			"&skipPaging=true",
            success: function (data5) {
                var data =  getSortedData(data5);
                for (var i = 0; i < data.length; i++) {
                    var tei = data[i].value;
                    $.ajax({
                        async: false,
                        type: "GET",
                        dataType: "json",
                        contentType: "application/json",
                        url: '../api/trackedEntityInstances/' + tei + '.json?fields=*',
                        success: function (data) {

                            ou = data.orgUnit;

                            if (data.attributes.length != 0) {
                                var printDisplay = ""
                                for (var i = 0; i < data.attributes.length; i++) {
                                    if (data.attributes[i].displayName == "Cluster ID") {
                                        clusterId = data.attributes[i].value;
                                    }
                                    if (data.attributes[i].displayName ==
                                        "Cluster Type") {
                                        clusterType = data.attributes[i].value;
                                    }
                                    if (data.attributes[i].attribute == "vCeMi4DtfEC") {

                                    }
                                    if (data.attributes[i].displayName ==
                                        "≥ 3 AFI cases (last 5 days)") {
                                        if (data.attributes[i].value == "true") {
                                            printDisplay = printDisplay + ";" + data.attributes[
                                                i].displayName;
                                        }
                                    }
                                    if (data.attributes[i].displayName ==
                                        "≥ 2 ADD cases (last 3 days)") {
                                        if (data.attributes[i].value == "true") {
                                            printDisplay = printDisplay + ";" + data.attributes[
                                                i].displayName;
                                        }
                                    }
                                    if (data.attributes[i].displayName ==
                                        "≥ 5 AFI cases (last 7 days)") {
                                        if (data.attributes[i].value == "true") {
                                            printDisplay = printDisplay + ";" + data.attributes[
                                                i].displayName;
                                        }
                                    }
                                    if (data.attributes[i].displayName ==
                                        "Lab confirmed case") {
                                        if (data.attributes[i].value == "true") {
                                            printDisplay = printDisplay + ";" + data.attributes[
                                                i].displayName;
                                        }
                                    }
                                    if (data.attributes[i].attribute == "sBmb7HfvAau") {
                                        if (data.attributes[i].value == "MANUAL") {
                                            printDisplay = printDisplay + ";" + data.attributes[
                                                i].value;
                                        }
                                    }
                                    if (data.attributes[i].displayName == "CasesUIDs") {
                                        patients = data.attributes[i].value;
                                    }
                                }
                            } else {
                                clusterId = "None";
                                clusterType = "None";
                            }


                            console.log(clusterId);
                            console.log(clusterType);
                            patientsArray = patients.split(';');

                            var format = "YYYY-MM-DD";
                            datepicked = document.getElementById('datepicker').value;
                            datepicked = datepicked.split("-").reverse().join("-");

                            var endDate = new Date(datepicked);
                            var startDate = new Date(endDate)

                            startDate = startDate.setDate(endDate.getDate() - 7);
                            $.ajax({
                                async: false,
                                type: "GET",
                                dataType: "json",
                                contentType: "application/json",
                                url: '../api/26/analytics/events/query/Ml0ZNj9APN0.json?dimension=pe:THIS_YEAR&dimension=ou:'+NIE.ROOT_OU_UID+'&dimension=xUhbNO2bQCz&dimension=pa6AUJ4s9li&dimension=xq2RxjLDbev&dimension=KSaU2NSe3ga&dimension=XYhSJWeyxQL&dimension=GIGDIz8ivwS&dimension=KQFdmU5Oqz6&dimension=IeAaU6tgIFl&dimension=mYQBPHZugDx&dimension=glBt6kk3AXS&dimension=nOCIVMD4lOv&dimension=vN0BoElifvC&dimension=IXnRY4BQtQZ&dimension=jwmIajW8wa4&dimension=z4NPqwhOjDH&dimension=xvEO66y1BB4&dimension=ojqkjOup797&dimension=GJsrYvDPJG1&dimension=pQLz5yJ0AJQ&dimension=aWM069T9jXj&dimension=eezUUL7VZMd&stage=iWcQ5lxmsy4&displayProperty=NAME&outputType=EVENT&paging=false',
                                //                url:'../api/trackedEntityInstances?ou='+NIE.ROOT_OU_UID+'&ouMode=DESCENDANTS&filter='+NIE.CLUSTER_TEA_CLUSTER_TAIL_DATE+':ge:'+moment(startDate).format(format)+'&filter='+NIE.CLUSTER_TEA_CLUSTER_START_DATE+':le:'+moment(endDate).format(format)+'&programEndDate='+moment(endDate).format(format)+'&program='+NIE.Cluster_ProgramUID+'&skipPaging=true',
                                success: function (data5) {

                                    if (printDisplay == "") { } else {

                                        var slice_printDisplay = printDisplay;
                                        var _printDisplay = slice_printDisplay.slice(
                                            1);
                                        var rowcluster =
                                            "<tr><td colspan='20'>&nbsp;</td></tr><tr class='clusterHead'><td colspan='4' style='text-align:left'> Cluster ID : " +
                                            clusterId +
                                            "</td><td colspan='6' style='text-align:left'>Cluster Type :" +
                                            clusterType + " " +
                                            "(" + _printDisplay + ")" +
                                            "</td></tr>";
                                        $('.reporttable').append(rowcluster);
                                        var index = 1;
                                        for (var h = 0; h < patientsArray.length -
                                            1; h++) {
                                            var kk = 0;
                                            for (var ii = 0; ii < data5.rows
                                                .length; ii++) {
                                                if (data5.rows[ii][0] ==
                                                    patientsArray[h]) {
                                                    Pname = data5.rows[ii][
                                                        8
                                                    ];
                                                    Pgender = data5.rows[ii]
                                                    [9];
                                                    Page = data5.rows[ii][
                                                        10
                                                    ];
                                                    Pstreet = data5.rows[ii]
                                                    [11];
                                                    Pdoor = data5.rows[ii][
                                                        12
                                                    ] + data5.rows[ii][
                                                        13
                                                        ];
                                                    Phabitation = data5.rows[
                                                        ii][14];
                                                    Pvillage = data5.rows[
                                                        ii][15];
                                                    Pmob = data5.rows[ii][
                                                        16
                                                    ];
                                                    Ponset = data5.rows[ii]
                                                    [17];
                                                    Pdate = data5.rows[ii][
                                                        18
                                                    ];
                                                    phc = data5.rows[ii][19];

                                                    for (var jj = 20; jj <
                                                        data5.rows[ii].length; jj++
                                                    ) {
                                                        if (data5.rows[ii][
                                                            jj
                                                        ] == "positive") {
                                                            Plab[kk] =
                                                                data5.headers[
                                                                    jj].column;
                                                            kk++;
                                                        }
                                                    }
                                                }
                                            }
                                            if (Plab.length == 0) {
                                                Plab[0] = "none";
                                            }

                                            var newAge = Math.round(Page);
                                            var newStreet = Pstreet.split(
                                                '-')[0];
                                            var newDoor = Pdoor.split('-')[0] +
                                                newStreet;
                                            var newVil = Pvillage.split('-')[
                                                1];
                                            var newHab = Phabitation.split(
                                                '-')[0];
                                            if (phc != "") {
                                                phc = phc.split('-')[1];
                                                if (phc == 'undefined' ||
                                                    phc == null) {
                                                    phc = "";
                                                }
                                            }

                                            if (Ponset == 'eDFSS_IPD_V3') {
                                                Ponset = 'IPD'
                                            } else {
                                                Ponset = 'OPD'
                                            }

                                            var newRow = $(
                                                "<tr class='newRow'><td class='tdrow' colspan='1' style='text-align:right;padding-right:5px'>" +
                                                index +
                                                "</td><td class='tdrow' colspan='1' style='text-align:left;padding-left:5px'>" +
                                                Pname +
                                                "</td><td class='tdrow' colspan='1' style='text-align:right;padding-right:5px'>" +
                                                newAge +
                                                "</td><td class='tdrow' colspan='1' style='text-align:left;padding-left:5px'>" +
                                                Pgender +
                                                "</td><td class='tdrow' colspan='1' style='text-align:left;padding-left:5px'>" +
                                                newDoor +
                                                "</td><td class='tdrow' colspan='1' style='text-align:left;padding-left:5px'>" +
                                                newHab +
                                                "</td><td class='tdrow' colspan='1' style='text-align:left;padding-left:5px'>" +
                                                newVil +
                                                // "</td><td class='tdrow' colspan='1'>" +
                                                // Pmob +
                                                // "</td><td class='tdrow' colspan='1'>" +
                                                // Ponset +
                                                "</td><td class='tdrow' colspan='1' style='text-align:right;padding-right:5px'>" +
                                                dateformat(Pdate) +
                                                "</td><td class='tdrow' colspan='1' style='text-align:left;padding-left:5px'>" +
                                                Plab +
                                                "</td><td class='tdrow' colspan='1' style='text-align:left;padding-left:5px'>" +
                                                phc + "</td></tr>");
                                            $('.reporttable').append(newRow);
                                            index++;

                                        }
                                    }
                                }
                            });
                        },
                        error: function (data) { }
                    });
                }
            }
        });
    };


    function extractCoordsFromTEI(teis, excludeInactive) {

        var result = [];

        for (var i = 0; i < teis.length; i++) {
            var type = "unknown";

            var coord = findValueAgainstId(teis[i].attributes, "attribute", NIE.TEA_COORDS, "value");

            var active = findValueAgainstId(teis[i].attributes, "attribute", NIE.TEA_IS_ACTIVE, "value");

            if (active == "false" && excludeInactive) {
                continue
            }

            if (coord) {

                coord = JSON.parse(coord);

                var clusterType = findValueAgainstId(teis[i].attributes, "attribute", NIE.TEA_CLUSTER_TYPE, "value");
                var cases = findValueAgainstId(teis[i].attributes, "attribute", NIE.TEA_CLUSTER_CASES, "value");
                var afi3_5 = findValueAgainstId(teis[i].attributes, "attribute", NIE.AFI_TEA_3_5, "value");
                var afi5_7 = findValueAgainstId(teis[i].attributes, "attribute", NIE.AFI_TEA_5_7, "value");
                var lab = findValueAgainstId(teis[i].attributes, "attribute", NIE.TEA_LAB, "value");


                if (clusterType == "ADD") {
                    type = "ADD2";
                }
                if (afi3_5) {
                    type = "AFI3"
                }
                if (afi5_7) {
                    type = "AFI5"
                }
                if (lab) {
                    type = "LAB"
                }
                if (clusterType == "MANUAL") {
                    type = "MANUAL";
                }
                if (active == "false") {
                    type = "INACTIVE"
                }

                result.push({
                    id: teis[i].trackedEntityInstance + clusterType,
                    coordinates: coord,
                    orgUnit: teis[i].orgUnit,
                    type: type,
                    trackedEntityInstance: teis[i].trackedEntityInstance,
                    attributes: teis[i].attributes,
                    cases: cases

                })

            }
        }


        return result;
    }

    function getPointGeoJson(data) {
        var coord = data.coordinates;
        var point = {
            "type": "Feature",
            properties: {
                id: "cluster",
                type: data.type,
                label: data.orgUnit,
                layerId: "custom",
                trackedEntityInstance: data.trackedEntityInstance,
                attributes: data.attributes,
                cases: data.cases
            },
            "geometry": {
                "type": "Point",
                "coordinates": [coord.longitude, coord.latitude]
            }
        };
        return point;
    }

    function getPointFeatures(coords) {
        var geoJsonPointFeatures = {
            type: "FeatureCollection",
            features: []
        };
        for (var i = 0; i < coords.length; i++) {
            var point = getPointGeoJson(coords[i]);
            geoJsonPointFeatures.features.push(point);

        }
        return geoJsonPointFeatures;
    }


    function getCustomIcon2(iconUrl, iconSize, iconAnchor) {

        if (!iconSize) {
            iconSize = [15, 15]
        }

        if (!iconAnchor) {
            iconAnchor = [6, 1]
        }

        return new L.Icon({
            //  iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            iconUrl: iconUrl,
            //  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            shadowUrl: 'images/point-shadow.png',
            iconSize: iconSize,
            //        iconSize: [25, 41],

            //        iconAnchor: [12, 41],
            iconAnchor: iconAnchor,

            popupAnchor: [1, 0],
            shadowSize: [16, 20]
        });

    }

    function addClusterMarkers(gjson) {

        var pointToLayer = function (feature, latlng) {
            if (feature.properties) {
                switch (feature.properties.type) {
                    case 'centroid':
                        var centroidIcon = L.divIcon({
                            className: 'alert-icon-centroid leaflet-clickable',
                            html: '<i class="alert-icon-centroid"><b>[' + feature.properties.clusterSize +
                                ']</b></i>'
                        });
                        return L.marker(latlng, {
                            icon: centroidIcon
                        });
                    case 'LAB':
                        return L.marker(latlng, {
                            icon: getCustomIcon2(imgpath_red_circle)
                        });
                    case 'AFI3':
                        return L.marker(latlng, {
                            icon: getCustomIcon2(imgpath_polygon_5_sided, [20, 20], [15, 0])
                        });
                    case 'AFI5':
                        return L.marker(latlng, {
                            icon: getCustomIcon2(imgpath_star, [20, 20], [0, 0])
                        });
                    case 'ADD2':
                        return L.marker(latlng, {
                            icon: getCustomIcon2(imgpath_marker_icon_add_2, [17, 17], [0, 15])
                        });

                    case 'MANUAL':
                        return L.marker(latlng, {
                            icon: getCustomIcon2(imgpath_marker_icon_blue, [25, 41], [5, 15])
                        });
                    case 'INACTIVE':
                        return L.marker(latlng, {
                            icon: getCustomIcon2(imgpath_marker_icon_inactive, [25, 41], [10, 10])
                        });
                }
            }

            return L.marker(latlng, {});
        }

        geojson = L.geoJson(gjson, {
            pointToLayer: pointToLayer
        }).addTo(map);

    }


    function addOrgUnits(blockCoords, style) {
        var geoJson = {
            "type": "Feature",
            "geometry": {
                "type": "MultiPolygon",
                "coordinates": blockCoords
            },
            "properties": {
                "name": "MultiPolygon",
                key: "block"
            }
        };

        var pointToLayer = function (feature, latlng) {
            feature.properties.style = style;
        };

        addGeoJson(geoJson, null, style, null);
    }

    this.addGeoJson = function (geoJson, pointToLayer, style, onEachFeature) {

        var mapArgs = {
        };
        if (style) {
            mapArgs.style = style;
        }
        if (onEachFeature) {
            mapArgs.onEachFeature = onEachFeature;
        }
        if (pointToLayer) {
            mapArgs.pointToLayer = pointToLayer;
        }


        return new L.GeoJSON(geoJson, mapArgs).addTo(map);
    };

    function addOrgUnitLayer(level, style, addLabels) {

        $.ajax({
            type: "GET",
            async: true,
            contentType: "application/json",
            url: "../api/organisationUnits?filter=level:eq:" + level +
                "&fields=id,name,coordinates&paging=false",
            success: function (response) {
                if (addLabels) {
                    addOrgUnitLabels(response.organisationUnits)
                } else {
                    addOrgUnits(getCoordinatesFromOus(response.organisationUnits), style);

                }
            }
        })
    }

    function getCoordinatesFromOus(ous) {

        var ouCoords = [];
        for (var key in ous) {
            if (ous[key].coordinates) {
                var coords = JSON.parse(ous[key].coordinates);
                //reverseCoordinates(coords[0]);

                ouCoords.push(coords[0]);
            }
        }
        return ouCoords;
    }

    function addOrgUnitLabels(orgUnits) {


        for (var i = 0; i < orgUnits.length; i++) {

            var geojsonFeature = {
                "type": "Feature",

                "geometry": {
                    "type": "Polygon",
                    "coordinates": JSON.parse(orgUnits[i].coordinates)[0]
                }
            };

            var style = {
                color: "black",
                opacity: 0.75,
                fillColor: "white",
                fillOpacity: 0,
                weight: 2,

            }

            var polygon = L.geoJSON(geojsonFeature, {
                style: style
            }).addTo(map);

            var icon = L.divIcon({
                iconSize: new L.Point(0, 0),
                iconAnchor: [15, 0],
                html: '<label>' + orgUnits[i].name + '</label>'
            });


            var marker = L.marker(polygon._layers[polygon._leaflet_id - 1].getCenter(), {
                icon: icon
            }).addTo(map);


        }


    }

    function dateformat(date) {

        var date_ = date;
        var year = date_.substring(0, 4);
        var month = date_.substring(5, 7);
        var day = date_.substring(8, 10);

        return day + '/' + month + '/' + year;
    }

    function dateformat1(date) {
        var date_ = date;
        var year = date_.substring(0, 4);
        var month = date_.substring(4, 6);
        var day = date_.substring(6, 8);

        return day + '/' + month + '/' + year;
    }
</script>
<script type="text/javascript">
    var tei, url, ou, index = 1;
    var clusterId, clusterType = "None";
    var district = "None",
        hud = "None",
        block = "None",
        phc = "None",
        rrt = "None";
    var population = 0,
        houseCount = 0;
    var Pname, Page, Pgender, Pdoor, Phab, Pvillage, Pmob, Ponset, Pdate, Plab = [],
        Ptei, Pins;
    var data44, data55, data;
    var Week1, Week2;


    var getDate = function () {
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth() + 1; //January is 0!
        var yyyy = today.getFullYear();

        if (dd < 10) {
            dd = '0' + dd
        }

        if (mm < 10) {
            mm = '0' + mm
        }

        today = mm + '/' + dd + '/' + yyyy;
        return today;
    };

    var getWeek = function () {
        var curr = new Date; // get current date
        var first = curr.getDate() - curr.getDay() - 4; // First day is the day of the month - the day of the week
        var last = first + 6; // last day is the first day + 6
        var startDate = new Date(curr.setDate(first));
        Week1 = "" + (startDate.getMonth() + 1) + "/" + startDate.getDate() + "/" + startDate.getFullYear();
        var endDate = new Date(curr.setDate(last));
        Week2 = "" + (endDate.getMonth() + 1) + "/" + endDate.getDate() + "/" + endDate.getFullYear();

        return;

    };



    var displayReport = function () {

        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/trackedEntityInstances.json?fields=*&program=wXXVzDXRLMe&ouMode=ALL',
            success: function (data7) {

                for (var p = 0; p < data7.trackedEntityInstances.length; p++) {
                    var tei = data7.trackedEntityInstances[p].trackedEntityInstance;
                    var cluster = getClusterId(tei);
                    teiClusterMap[tei] = cluster;
                }
                console.log(teiClusterMap);
                //buildReport(data7, 0);
            }
        });
    };



    var buildReport = function (data7, increment) {

        if (increment >= data7.trackedEntityInstances.length) {
            return;
        } else {
            tei = data7.trackedEntityInstances[increment].trackedEntityInstance;
            clusterId = "", Pname = "", Page = "", Pgender = "", Pdoor = "", Phab = "", Pvillage = "", Pmob =
                "", Ponset = "", Pdate = "", Plab = [], Ptei = "", Pins = "";
            data = getData11(tei);
            data55 = getData5();
            data44 = getData4();
            printHeader(increment);
            printTable(data, data55, data44, increment, 0);
            buildReport(data7, increment + 1);
        }
    };

    var getData11 = function (tei) {
        rrt = "";
        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/trackedEntityInstances/' + tei + '.json?fields=*&ouMode=ALL',
            success: function (data11) {

                if (data11.attributes.length != 0) {
                    for (var i = 0; i < data11.attributes.length; i++) {
                        if (data11.attributes[i].displayName == "Cluster ID") {
                            clusterId = data11.attributes[i].value;
                        }
                        if (data11.attributes[i].displayName == "Cluster type") {
                            clusterType = data11.attributes[i].value;
                        }
                        if (data11.attributes[i].displayName == "≥ 3 AFI cases (last 5 days)") {
                            rrt = rrt + data11.attributes[i].displayName;
                        }
                        if (data11.attributes[i].displayName == "≥ 5 AFI cases (last 7 days)") {
                            rrt = rrt + data11.attributes[i].displayName;
                        }
                        if (data11.attributes[i].displayName == "1 Lab confirmed case") {
                            rrt = rrt + data11.attributes[i].displayName;
                        }
                    }

                } else {
                    clusterId = "None";
                    clusterType = "None";
                }
                data = data11;
            }
        });
        return data;
    };

    var getData4 = function () {
        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/analytics/events/query/X2XfE0rYiwk.json?stage=apqU6esBuwV&dimension=pe:' +
                last7days +
                '&dimension=ou:WXW1rhM9hgR&dimension=A4xv2IGIidc&dimension=u4Im7YWqdL6&dimension=leMIOD9cjVL&dimension=bcNxz9ZI7Zi&dimension=wFiHJnAmAyK&dimension=wZbg3yGKcNu&dimension=QGtJOccfJJO&dimension=CPrDolo2qSh&dimension=DKXiHk6FrtK&dimension=wvVoqUUWHnI&dimension=HpKD5NQqDqX&dimension=xYO8HkDDW3N&dimension=J6uckqQfkyc&dimension=mEWZIvuQWwe&dimension=GWQL3jsnuaM&dimension=ysgOCWco2Gw&dimension=wCHzBwjAwn4&displayProperty=NAME',
            success: function (data4) {
                data44 = data4;

            }
        });
        return data44;
    };
    var getData5 = function () {
        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/json",
            url: '../api/analytics/events/query/X2XfE0rYiwk.json?stage=apqU6esBuwV&dimension=pe:' +
                last7days +
                '&dimension=ou:WXW1rhM9hgR&dimension=DKXiHk6FrtK&dimension=CPrDolo2qSh&dimension=wvVoqUUWHnI&dimension=leMIOD9cjVL&dimension=HpKD5NQqDqX&dimension=bcNxz9ZI7Zi&dimension=J6uckqQfkyc&dimension=mEWZIvuQWwe&dimension=wZbg3yGKcNu&dimension=QGtJOccfJJO&dimension=A4xv2IGIidc&dimension=wFiHJnAmAyK&dimension=WUoOh92Rftx&dimension=n6kP82CbJUh&dimension=FfvWigqXGOt&dimension=HmIhUj55Q9i&dimension=p3Ozgnoorit&dimension=YmnPLo5tyYv&dimension=f91ufC0PCuy&dimension=ZFxhXoEh3xb&dimension=r5Pg7EcNbE2&dimension=y8701JIOBhm&dimension=ceSYgw6p45I&dimension=GWQL3jsnuaM&&dimension=ysgOCWco2Gw&displayProperty=NAME',
            success: function (data5) {
                data55 = data5;

            }
        });
        return data55;
    };

    var printHeader = function (aaa) {
        var todayDate = getDate();
        getWeek();

        var Divid =
            "<div class='headingg' width='100%' style='border:1px solid black;background-color:yellow'><div style='width:25%;float:left'>Cluster ID: " +
            clusterId + "</div><div style='width:25%;float:left'>Confirmed Case: " + rrt +
            "</div><div style='width:25%;float:left'>Date: " + todayDate +
            "</div><div style='width:25%;float:left'>Period: " + Week1 + "-" + Week2 + "</div></div>";
        $('.patientdata').append(Divid);
        var heading = "<table id='reporttable_" + aaa +
            "' class='reporttableC'><thead><tr>" +
            "<th class = 'tablerows' colspan='1' >Date of Admission</th>" +
            "<th class = 'tablerows' colspan='1' >Block</th>" +
            "<th class = 'tablerows' colspan='1' >Village</th>" +
            "<th class = 'tablerows' colspan='1' >Name</th>" +
            "<th class = 'tablerows' colspan='1' >Age(in years)</th>" +
            "<th class = 'tablerows' colspan='1' >Sex(M/F)</th>" +
            "<th class = 'tablerows' colspan='1' >Door number, Street Name</th>" +
            "<th class = 'tablerows' colspan='1' >Mobile Number</th>" +
            "<th class = 'tablerows' colspan='1' >Reported Institution</th>" +
            "<th class = 'tablerows' colspan='1' >Lab Diagnosis</th>" +
            "</thead>" +
            "</table><br><br><br>";
        $('.patientdata').append(heading);
    };

    var printTable = function (data, data55, data44, v, aa) {

        if (aa >= data.relationships.length) {
            return;
        } else {
            for (var hh = 0; hh < data.relationships[aa].relative.attributes.length; hh++) {

                if (data.relationships[aa].relative.attributes[hh].displayName == "TEI-UID") {
                    Ptei = data.relationships[aa].relative.attributes[hh].value;
                }

            }
            var d = 0,
                diag = [];
            for (var ii = 0; ii < data55.rows.length; ii++) {
                if (data55.rows[ii][32] == Ptei) {
                    for (var k = 20; k < 32; k++) {
                        if (data55.rows[ii][k] == "Positive") {
                            diag[d] = data55.headers[k].column;
                            d++;
                        }
                    }
                }
            }
            if (diag.length == 0) {
                diag[0] = "none";
            }

            for (var l = 0; l < data44.rows.length; l++) {
                if (data44.rows[l][23] == Ptei) {
                    Pname = data44.rows[l][16];
                    Pdoor = data44.rows[l][18] + " " + data44.rows[l][22];
                    Pgender = data44.rows[l][10];
                    Page = data44.rows[l][8];
                    Phab = data44.rows[l][20];
                    Pdate = data44.rows[l][9];
                    Pmob = data44.rows[l][12];
                    Pins = data44.rows[l][14];
                    Pvillage = data44.rows[l][21];
                }
            }
            var phab = Phab.split('-')[0];

            var newRow = $("<tr><td class='tdrow' colspan='1'>" + Pdate + "</td><td class='tdrow' colspan='1'>" +
                phab + "</td><td class='tdrow' colspan='1'>" + Pvillage +
                "</td><td class='tdrow' colspan='1'>" + Pname + "</td><td class='tdrow' colspan='1'>" +
                Page + "</td><td class='tdrow' colspan='1'>" + Pgender +
                "</td><td class='tdrow' colspan='1'>" + Pdoor + "</td><td class='tdrow' colspan='1'>" +
                Pmob + "</td><td class='tdrow' colspan='1'>" + Pins + "</td><td class='tdrow' colspan='1'>" +
                diag + "</td></tr>");
            $('#reporttable_' + v).append(newRow);
            index++;
            printTable(data, data55, data44, v, aa + 1);
        }

    };
</script>

</html>
