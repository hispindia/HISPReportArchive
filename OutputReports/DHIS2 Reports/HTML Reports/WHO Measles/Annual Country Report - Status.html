<html>

<head>
    <title>HIV Care and ART Treatment-Individual Patient Summary</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
        integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <style>
        .report-table {
            text-align: left;
        }

        /* Absolute Center Spinner */

        .loading {
            position: fixed;
            z-index: 999;
            height: 2em;
            width: 2em;
            overflow: show;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            display: none;
        }

        /* Transparent Overlay */

        .loading:before {
            content: '';
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* :not(:required) hides these rules from IE9 and below */

        .loading:not(:required) {
            /* hide "loading..." text */
            font: 0/0 a;
            color: transparent;
            text-shadow: none;
            background-color: transparent;
            border: 0;
        }

        .loading:not(:required):after {
            content: '';
            display: block;
            font-size: 10px;
            width: 1em;
            height: 1em;
            margin-top: -0.5em;
            -webkit-animation: spinner 1500ms infinite linear;
            -moz-animation: spinner 1500ms infinite linear;
            -ms-animation: spinner 1500ms infinite linear;
            -o-animation: spinner 1500ms infinite linear;
            animation: spinner 1500ms infinite linear;
            border-radius: 0.5em;
            -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
            box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        }

        /* Animation */

        @-webkit-keyframes spinner {
            0% {
                -webkit-transform: rotate(0deg);
                -moz-transform: rotate(0deg);
                -ms-transform: rotate(0deg);
                -o-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                -moz-transform: rotate(360deg);
                -ms-transform: rotate(360deg);
                -o-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        @-moz-keyframes spinner {
            0% {
                -webkit-transform: rotate(0deg);
                -moz-transform: rotate(0deg);
                -ms-transform: rotate(0deg);
                -o-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                -moz-transform: rotate(360deg);
                -ms-transform: rotate(360deg);
                -o-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        @-o-keyframes spinner {
            0% {
                -webkit-transform: rotate(0deg);
                -moz-transform: rotate(0deg);
                -ms-transform: rotate(0deg);
                -o-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                -moz-transform: rotate(360deg);
                -ms-transform: rotate(360deg);
                -o-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        @keyframes spinner {
            0% {
                -webkit-transform: rotate(0deg);
                -moz-transform: rotate(0deg);
                -ms-transform: rotate(0deg);
                -o-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                -moz-transform: rotate(360deg);
                -ms-transform: rotate(360deg);
                -o-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        button {
            cursor: pointer;
        }
    </style>

</head>

<body>
    <a id="dlink" style="display:none;"></a>

    <button type="button" class="btn btn-primary btn-sm" style="vertical-align: middle;position:fixed;z-index:1"
        onclick="printContent('printing')"><span class="glyphicon glyphicon-print" style="font-size: 15px;"></span>
        &nbsp;
        Print
    </button>
    <button type="button" class="btn btn-success btn-sm" style="vertical-align: middle;position:fixed;z-index:1;margin-left:4em;" id="btnExport"
        onclick="tableToExcel('printing', 'Annual Country Report', 'Annual Country Report')"><span
            class="glyphicon glyphicon-download-alt" style="font-size: 15px;"></span>Download As Excel</button>
    
    <br/>
    <div id="loader"></div>
    <div id="printing" class="animate-bottom">
        <table class="table table-hover table-bordered" id="report-table" style="visibility:hidden">
            <tbody id="table-body"></tbody>
        </table>
    </div>
</body>
<script>

    document.getElementById("report-table").style.visibility = "hidden";
    document.getElementById("loader").style.display = "block";

    var selectedOrgunit = dhis2.report.organisationUnit;
    var selectedPeriod = dhis2.report.periods["0"];
    var organisationUnit = [];
    var printValue = [];

    $.ajax({
        async: false,
        type: "GET",
        url: `../../organisationUnits/GaRQQc2xvan.json?fields=id,name,children[id,name]&paging=false`,
        success: function (orgUnit) {
            organisationUnit = orgUnit.children.sort((a, b) => a.name.localeCompare(b.name))
        }
    });

    $.ajax({
        async: false,
        type: "GET",
        url: `../../events.json?program=qwD1MiX35HB&programStage=IAeiPRPu6q7&startDate=${selectedPeriod}-01-01&endDate=${selectedPeriod}-12-31&paging=false`,
        success: function (data) {
            data.events.forEach(event => {
                printValue[event.orgUnit] = {};
                printValue[event.orgUnit]["status"] = (event.status == "COMPLETED" ? "COMPLETED" : "In progress");
                printValue[event.orgUnit]["eventDate"] = (event.completedDate ? event.completedDate.split("T")["0"] : '');
            })
        }
    });

    showData();

    function showData() {
        console.log("showData")
        var tableRow = "";
        tableRow += `<tr>
                    <td colspan="3" style="background-color:#F8F8F8;font-weight:bold; text-align:center">Status of completion of Annual NVC report for the year ${selectedPeriod} </td>
                    </tr>
                    <tr>
                    <td colspan="3"> </td>
                    </tr>
                    <tr>
                    <td colspan="3" style="background-color:#F8F8F8;font-weight:bold; text-align:center"> (Status options â€“ Completed and submitted with date, In progress, Not yet initiated) </td>
                    </tr>
                    <tr style="background-color:#F8F8F8;font-weight:bold; text-align:center">
                    <td style="text-align:left"> Country Name </td>
                    <td> Status </td>
                    <td> Date </td>
                    </tr>`;

        organisationUnit.forEach(orgUnit => {
            if (printValue[orgUnit.id]) {
                tableRow += `<tr>
                            <td>${orgUnit.name}</td>
                            <td style="text-align:center">${printValue[orgUnit.id]["status"] ? printValue[orgUnit.id]["status"]  : "Not yet Initiated"}</td>
                            <td style="text-align:center">${printValue[orgUnit.id]["eventDate"]}</td>
                            </tr>`;
            } else {
                tableRow += `<tr>
                            <td>${orgUnit.name}</td>
                            <td></td>
                            <td></td>
                            </tr>`;
            }
        })

        document.getElementById("table-body").innerHTML = tableRow;
        document.getElementById("report-table").style.visibility = "visible";
        document.getElementById("loader").style.display = "none";

    }


    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = filename + "-" + (selectedOrgunit.name);
            document.getElementById("dlink").click();
        }
    })()

    function printContent(el) {
        var restorepage = document.body.innerHTML;
        var printcontent = document.getElementById(el).innerHTML;
        document.body.innerHTML = printcontent;
        window.print();
        document.body.innerHTML = restorepage;
    }

</script>

</html>