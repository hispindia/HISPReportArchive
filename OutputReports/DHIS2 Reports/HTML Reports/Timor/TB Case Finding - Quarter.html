<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
    integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<style>
    /* Absolute Center Spinner */
    * {
        font-family: 'Times New Roman', Times, serif;
    }

    .borderless,
    .borderless th,
    .borderless td {
        border: 0;
        border-collapse: collapse;
    }

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }

    .box {
        width: 50%;
        float: left;
    }
</style>

</head>

<body>

    <button type="button" class="btn btn-success btn-sm" style="vertical-align: middle" id="downlaods"
        onclick="tableToExcel('output', 'SIX-MONTHLY REPORT ON RR-TB DETECTION', 'SIX-MONTHLY REPORT ON RR-TB DETECTION')">
        <span class="glyphicon glyphicon-download-alt" style="font-size: 15px"></span>Download As Excel
    </button>

    <button type="button" class="btn btn-primary btn-sm" style="vertical-align: middle;"
        onclick="printContent('output')"><span class="glyphicon glyphicon-print" style="font-size: 15px;"></span>
        &nbsp;
        Print
    </button>

    <div class="loading" id="loader"></div>
    <a id="dlink" style="display:none;"></a>
    <div id="output" style="display: none;">
        <table class="table table-hover" style="width:100%;text-align:center">
            <thead>
                <tr>
                    <th colspan="6"
                        style="text-align:center; background: rgb(39, 102, 150);font-size:20px; color:white">
                        MINISTRY OF HEALTH
                        <br />
                        NATIONAL TUBERCULOSIS CONTROL PROGRAMME
                        <br />
                        SIX-MONTHLY REPORT ON RR-TB DETECTION
                    </th>
                </tr>
                <tr>
                    <th colspan="1" style="text-align:center; background:#f2f2f2">
                        District: <span id="district"></span>
                    </th>
                    <th colspan="1" style="text-align:center; background:#f2f2f2">
                        Health facility: <span id="facility"></span>
                    </th>
                    <th colspan="1" style="text-align:center; background:#f2f2f2">
                        Name of reporting person : <span></span>
                    </th>
                    <th colspan="1" style="text-align:center; background:#f2f2f2">
                        Signature : <span></span>
                    </th>

                    <th colspan="1" style="text-align:center; background:#f2f2f2">
                        Year: <span id="quater-year"></span>
                    </th>
                </tr>
                <tr>
                    <th colspan="6"></th>
                </tr>
                <tr>
                    <th colspan="6" style="text-align:center; background:#f2f2f2">
                        BLOCK 1. Surveillance of drug resistance
                    </th>
                </tr>
                <tr>
                    <th>Risk category</th>
                    <th>Tested by Gene Xpert Ultra</th>
                    <th>Confirmed MTB</th>
                    <th>Confirmed RR-TB </th>

                </tr>
            </thead>
            <tbody id="block-1">

            </tbody>
        </table>

        <!-- for block 2 start -->
        <table class="table table-hover" style="width:100%;text-align:center">

            <thead>
                <tr>
                    <th colspan="6" style="text-align:center; background:#f2f2f2">
                        BLOCK 2. Delay in detection
                    </th>
                </tr>
                <!-- <tr>

                    <th>Number of RR cases with information on interval</th>
                    <th>Interval between presumption of RR-TB and Gene-Xpert results (in days)</th>
                    <th>Mean</th>
                    <th>Minimum</th>
                    <th>Maximum</th>

                </tr> -->

                <tr>
                    <th colspan="2" style="text-align:center; background:#f2f2f2">
                        Number of RR cases with information on interval
                    </th>
                    <!-- <th></th> -->
                    <th colspan="3" style="text-align:center; background:#f2f2f2">
                        Interval between presumption of RR-TB and Gene-Xpert results (in days)
                    </th>
                </tr>
                <tr>
                    <th></th>
                    <th></th>
                    <th>Mean</th>
                    <th>Minimum</th>
                    <th>Maximum</th>
                </tr>


            </thead>

            <tbody id="block-2">

            </tbody>
        </table>
        <!-- block 2 end -->

    </div>
</body>

<script>
    var selectedOrgUnit = dhis2.report.organisationUnit;
    var heirarchy = dhis2.report.organisationUnitHierarchy;
    var district = heirarchy.length >= 2 ? heirarchy[heirarchy.length - 2].name : ''
    var year = dhis2.report.periods[0];
    var date = dhis2.report.date;


    var quaters = [
        "January-March",
        "April-June",
        "July-September",
        "October-December"
    ]
    // var dateSelected = quaters[quater.split('Q')[1] - 1] + ', ' + quater.split('Q')[0];
    // var dateSelected = date.split('-');
    // dateSelected = quater

    document.getElementById('district').innerHTML = district;
    document.getElementById('quater-year').innerHTML = year;
    document.getElementById('facility').innerHTML = selectedOrgUnit.name;

    var deItems = {
        block1: [
            'New TB cases',
            'Retreated cases',
            'Unknown treatment history',
            'TOTAL',
            'Among them:',
            'HIV positive cases on ART',
            'HIV positive not on ART',
            'Children &lt;15 years',
            'Females',
            'Treatment failure using first-line drugs',
        ],
    }
    var dataElementIds = {
        block1: [
            ['GIHmLGJ1M6R', 'BTmFxKN2Xh0', 'vfWt1Z1n03I'],
            ['CSC6k8QsxeG', 'QF2UHyZ87Rg', 'MYv42UBWVX3'],
            ['lfKvA90VSu9', 'GtNQxWi4Rg1', 'ZinMXNgYfEK'],
            [], [],
            ['K9lspi1jCtB', 'WlWoycykYyK', 'ZuDqnSt2gix'],
            ['RwM7jREOSYa', 'T6wYiPmzAsr', 'EXUWX5AkodU'],
            ['nI7RtIM1kwB', 'praP0Wv8Hks', 'E95XXn797h7'],
            ['uMqlZrAnpZ2', 'CQ6MvTcqnBl', 'Bvje3sz27E9'],
            ['Cm8qHjB4uLE', 'jvFICoSejCS', 'aaGkOhcPw0q']

        ],

    }
    // var deIds = dataElementIds.block1.toString() +';'+ dataElementIds.block2.toString() +';'+ dataElementIds.block34.toString() +';'+ dataElementIds.block56.toString();
    // deIds = deIds.replaceAll(',', ';');
    var deIds = dataElementIds.block1.toString();
    deIds = deIds.replaceAll(',', ';');

    document.getElementById("output").style.display = "none";
    document.getElementById("loader").style.display = "block";


    getOU();
    async function getOU() {
        let data = await getData(selectedOrgUnit.id, deIds, year);

        console.log('data:>>>>>>', data)

        let tableRow = ''
        dataElementIds.block1.forEach((ids, index) => {
            let total = 0;
            tableRow += `<tr><td style='text-align:left'>${deItems.block1[index]}</td>`
            ids.forEach(id => {
                let val = data[id] ? data[id] : '';
                tableRow += `<td>${val}</td>`
                total += Number(val);
            });
            // tableRow += `<td>${total}</td>`
            tableRow += '</tr>'
        })
        document.getElementById('block-1').innerHTML = tableRow;


        document.getElementById("output").style.display = "block";
        document.getElementById("loader").style.display = "none";
    };


    async function getData(orgUnitId, deIds, period) {
        var dataObj = {};

        var response = await (await fetch(`../api/analytics.json?dimension=dx:${deIds}&dimension=pe:${period}&dimension=ou:${orgUnitId}&displayProperty=NAME&outputIdScheme=UID&&skipRounding=true&paging=false`)).json();
        console.log("RRRRRRRRRRRRRRRRRRRRRRRRR", response)

        response.rows.forEach(row => {
            console.log('row:>>>>>>', row)
            if (!dataObj[row[0]]) dataObj[row[0]] = Number(row[3])
            else dataObj[row[0]] += Number(row[3])
        })

        return dataObj;

    }


    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = `${filename}-${selectedOrgUnit.name}-${date}.xls`;
            document.getElementById("dlink").click();
        }
    })()


    function printContent(el) {
        var restorepage = document.body.innerHTML;
        var printcontent = document.getElementById(el).innerHTML;
        document.body.innerHTML = printcontent;
        window.print();
        document.body.innerHTML = restorepage;
    }


</script>