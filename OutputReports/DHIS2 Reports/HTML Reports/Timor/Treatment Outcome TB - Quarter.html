<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
    integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<style>
    /* Absolute Center Spinner */
    * {
        font-family: 'Times New Roman', Times, serif;
    }

    .borderless,
    .borderless th,
    .borderless td {
        border: 0;
        border-collapse: collapse;
    }

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: none;
    }

    /* Transparent Overlay */

    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
    }

    /* :not(:required) hides these rules from IE9 and below */

    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 1500ms infinite linear;
        -moz-animation: spinner 1500ms infinite linear;
        -ms-animation: spinner 1500ms infinite linear;
        -o-animation: spinner 1500ms infinite linear;
        animation: spinner 1500ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.5) -1.5em 0 0 0, rgba(0, 0, 0, 0.5) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    button {
        cursor: pointer;
    }

    .box {
        width: 50%;
        float: left;
    }
</style>

</head>

<body>

    <button type="button" class="btn btn-success btn-sm" style="vertical-align: middle" id="downlaods"
        onclick="tableToExcel('output', 'Treatment Outcome TB - Quater', 'Treatment Outcome TB - Quater')">
        <span class="glyphicon glyphicon-download-alt" style="font-size: 15px"></span>Download As Excel
    </button>

    <button type="button" class="btn btn-primary btn-sm" style="vertical-align: middle;"
        onclick="printContent('output')"><span class="glyphicon glyphicon-print" style="font-size: 15px;"></span>
        &nbsp;
        Print
    </button>

    <div class="loading" id="loader"></div>
    <a id="dlink" style="display:none;"></a>
    <div id="output" style="display: none;">
        <table class="table table-hover" style="width:100%;text-align:center">
            <thead>
                <tr>
                    <th colspan="10"
                        style="text-align:center; background: rgb(39, 102, 150);font-size:20px; color:white">
                        MINISTRY OF HEALTH
                        <br />
                        NATIONAL TUBERCULOSIS CONTROL PROGRAMME
                        <br />
                        QUARTERLY REPORT ON TB CASE FINDING (CHC LEVEL)
                    </th>
                </tr>
                <tr>
                    <th colspan="2" style="text-align:center; background:#f2f2f2">
                        District
                    </th>
                    <th colspan="2" style="text-align:center; background:#f2f2f2">
                        Name of DOT Center
                    </th>
                    <th colspan="2" style="text-align:center; background:#f2f2f2">
                        Year
                    </th>
                    <th colspan="4" style="text-align:center; background:#f2f2f2">
                        Signature and Date of Completion of This Form 
                    </th>
                </tr>
                <tr>
                    <th colspan="2" >
                     <span id="district"></span>
                    </th>
                    <th colspan="2" >
                        <span id="facility"></span>
                    </th>
                    <th colspan="2" >
                         <span id="quater-year"></span>
                    </th>
                    <th colspan="4" >
                         <span id="signature"></span>
                    </th>
                </tr>
                <tr>
                    <th colspan="10"></th>
                </tr>
                <tr>
                    <th colspan="10" style="text-align:left; background:#f2f2f2">
                        Block 1: All TB cases registered during the quarter (except for TB cases moved to the
                        second-line treatment register)
                    </th>
                </tr>
                <tr>
                    <th rowspan="2">Type of TB patient</th>
                    <th rowspan="2">No. of cases registered</th>
                    <th colspan="8">Treatment outcomes</th>
                </tr>
                <tr>
                    <th>Cured</th>
                    <th>Treatment completed</th>
                    <th>Treatment failed</th>
                    <th>Died</th>
                    <th>Lost to follow up</th>
                    <th>Not evaluated</th>
                    <th>Moved to second-line treatment</th>
                    <th>Total evaluated</th>
                </tr>
            </thead>
            <tbody id="block-1">

            </tbody>
        </table>

        <table class="table table-hover" style="width:100%;text-align:center">
            <thead>
                <tr>
                    <th colspan="3">
                    </th>
                </tr>
                <tr>
                    <th colspan="3" style="text-align:left; background:#f2f2f2">
                        Block 2: TB/HIV activities (all TB cases registered during the quarter)
                    </th>
                </tr>
                <tr>
                    <th >HIV-positive TB patients</th>
                    <th >HIV-positive TB patients on ART</th>
                    <th >HIV-positive TB patients on CPT</th>
                </tr>
            </thead>
            <tbody id="block-2">

            </tbody>
        </table>

        <table class="table table-hover" style="width:100%;text-align:center">
            <thead>
                <tr>
                    <th colspan="9">
                    </th>
                </tr>
                <tr>
                    <th colspan="9" style="text-align:left; background:#f2f2f2">
                        Block 3: Treatment Observation by DOT Provider's
                    </th>
                </tr>
                <tr>
                    <th colspan="9">
                        Directly Observed Treatment (DOT)
                    </th>
                </tr>
                <tr>
                    <th rowspan="2">Tipu kazu TB</th>
                    <th colspan="8">DOT (by)</th>
                </tr>
                <tr>
                    <th >Health staff</th>
                    <th >NGO staff</th>
                    <th>Private clinic </th>
                    <th>Traditional healer</th>
                    <th>Volunteer/PSF</th>
                    <th>Family DOT</th>
                    <th>Not DOT</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="block-3">

            </tbody>
        </table>
        <table class="table table-hover" style="width:100%;text-align:center">
            <thead>
                <tr>
                    <th colspan="8">
                    </th>
                </tr>
                <tr>
                    <th colspan="8" style="text-align:left; background:#f2f2f2">
                        Block 4: Treatment Outcome by Volunteer (PSF=Family Health Promoter)
                    </th>
                </tr>
                <tr>
                    <th colspan="8" ></th>
                </tr>
                <tr>
                    <th rowspan="2">Type of TB case</th>
                    <th rowspan="2">No. of cases registered</th>
                    <th colspan="6">Treatment outcomes</th>
                </tr>
                <tr>
                    <th>Cured</th>
                    <th>Treatment completed</th>
                    <th>Treatment failed</th>
                    <th>Died</th>
                    <th>Lost to Follow up</th>
                    <th>Not evaluated</th>
                </tr>
            </thead>
            <tbody id="block-4">

            </tbody>
        </table>
    </div>
</body>

<script>
    var selectedOrgUnit = dhis2.report.organisationUnit;
    var heirarchy = dhis2.report.organisationUnitHierarchy;
    var district = heirarchy.length >= 2 ? heirarchy[heirarchy.length - 2].name : ''
    var quater = dhis2.report.periods[0];

    var quaters = [
        "January-March",
        "April-June",
        "July-September",
        "October-December"
    ]
    var dateSelected = quaters[quater.split('Q')[1] - 1] + ', ' + quater.split('Q')[0];

    document.getElementById('district').innerHTML = district;
    document.getElementById('quater-year').innerHTML = dateSelected;
    document.getElementById('facility').innerHTML = selectedOrgUnit.name;

    var deItems = {
        block1: [
            'Bacteriologically confirmed, new and relapse (Pulmonary and extra pulmonary)',
            'Clinically diagnosed, new and relapse (Pulmonary and extra pulmonary)',
            'HIV-positive, all type'
        ],
        block3: [
            'Bacteriologically confirmed, new and relapse (Pulmonary and extra pulmonary)',
            'Clinically diagnosed, new and relapse (Pulmonary and extra pulmonary)',
        ],
        block4: [
            'New pulmonary bacteriologically confirmed',						
            'New pulmonary clinically diagnosed',					
            'New extra pulmonary bacteriologically and clinically diagnosed',								
            'Total No. of TB cases should be same as Block 4 column DOT by volunteer/PSF'								
        ],
    }
    var dataElementIds = {
        block1: [
            ['GAzhv5u9SZu', 'YO7yCduVsYJ', 'YO7yCduVsYJ', 'qxAvAJ5mfnP', 'XaiVZTlXnFC', 'hS1gj5XNxT0', 'i9ErCakluAg', 'UoUNEwbcH9l'],
            ['zCD6mRZwrOq', '', 'Z1buO8YgUJQ', 'CW4g6c2TiTq', 'ff8BUQFPXgk', 'R4p1YigmV7I', 'mwrWvSMxFsT', 'p5PqNR3QWT5'],
            ['l2muzX2aNUj', 'PjesDWQhuyy', 'PjesDWQhuyy', 'fj5QYjA2cnp', 'ORNJgrbRJFx', 'ha6NYAGS8Z2', 'QzQfZKB1dzb', 'NODIy471jsm'],
        ],
        block2: [
            'l2muzX2aNUj', 'YDeGQH4dK8l', 'Pxf0xz6QPaX'
        ],
        block3: [
            ['mdQVAssDjDk', 'SQZUm4Mt5xz', '', 'BORWkwpJU4j', 'lNFjUhsHpiq', 'Q5ASOYQ7tdK', 'EY6Xuvlot94'],
            ['G2tdjqFmj4s', 'PJTtHzsknAn', '', 'Cs613WxbsOM', 'e1vZH4N2Xh4', 'ToCCPzcEyjj', 'gbF71mHt2VC']
        ],
        block4: [
            ['KUmcXOU6Zid', 'OBj5Ec13pHy', 'OBj5Ec13pHy', 'R6lZ5zPLSEr', 'qpvT61YaogL', 'wOa3jV64JMD', 'X33Se9JvIhL'],
            ['iOmlSantG2F', 'D9WjqDH40nS', 'D9WjqDH40nS', 'uYFxA3VOYmy', 'g75YoY6Zy0c', 'N2DDAtIwxow', 'UanvNUhRKkN'],
            ['zmo2LrEnDtq+lh7OOsQ2wEp', 'J4RDA1D1W6x', 'J4RDA1D1W6x', 'Hjb37ubV0QC', 'DxsMFxFhNxe', 'aAaZyMhmi5t', 'AvpqfIPEBFy'],
            ['', '', '', '', '', '', ''],
        ]
    }
    var deIds = dataElementIds.block1.toString() + ';' + dataElementIds.block2.toString() + ';' + dataElementIds.block3.toString() + ';' + dataElementIds.block4.toString();
    deIds = deIds.replaceAll(',', ';');

    document.getElementById("output").style.display = "none";
    document.getElementById("loader").style.display = "block";


    getOU();
    async function getOU() {
        let data = await getData(selectedOrgUnit.id, deIds, quater);

        let tableRow = ''
        dataElementIds.block1.forEach((ids, index) => {
            let total = 0;
            tableRow += `<tr><td style='text-align:left'>${deItems.block1[index]}</td>`
            ids.forEach(id => {
                let val = data[id] ? data[id] : '';
                tableRow += `<td>${val}</td>`
                total += Number(val);
            });
            tableRow += `<td>${total}</td>`
            tableRow += '</tr>'
        })
        document.getElementById('block-1').innerHTML = tableRow;

        tableRow = '<tr>'
        dataElementIds.block2.forEach((id, index) => {
                tableRow += `<td>${data[id] ? data[id] : ''}</td>`
        })
        tableRow += '</tr>'
        document.getElementById('block-2').innerHTML = tableRow;

        tableRow = ''
        dataElementIds.block3.forEach((ids, index) => {
            let total = 0;
            tableRow += `<tr><td style='text-align:left'>${deItems.block3[index]}</td>`
            ids.forEach(id => {
                let val = data[id] ? data[id] : '';
                tableRow += `<td>${val}</td>`
                total += Number(val);
            });
            tableRow += `<td>${total}</td>`
            tableRow += '</tr>'
        })
        document.getElementById('block-3').innerHTML = tableRow;

        tableRow = ''
        dataElementIds.block4.forEach((ids, index) => {
            tableRow += `<tr><td style='text-align:left'>${deItems.block4[index]}</td>`
            ids.forEach(id => {
                if(id.includes('+')) {
                    let val1 = data[id.split('+')[0]] ? data[id.split('+')[0]] : '';
                    let val2 =  data[id.split('+')[1]] ? data[id.split('+')[1]] : '';
                    tableRow += `<td>${Number(val1) + Number(val2)}</td>`;
                }
                else {
                    let val = data[id] ? data[id] : '';
                    tableRow += `<td>${val}</td>`;
                }
            });
            tableRow += '</tr>'
        })
        document.getElementById('block-4').innerHTML = tableRow;

        document.getElementById("output").style.display = "block";
        document.getElementById("loader").style.display = "none";
    };

    async function getData(orgUnitId, deIds, period) {
        var dataObj = {};
        var response = await (await fetch(`../api/analytics.json?dimension=dx:${deIds}&filter=pe:${period}&dimension=ou:${orgUnitId};OU_GROUP-Ej7jepIUI2j&displayProperty=NAME&outputIdScheme=UID&&skipRounding=true&paging=false`)).json();

        response.rows.forEach(row => {
            if (!dataObj[row[0]]) dataObj[row[0]] = Number(row[2]);
            else dataObj[row[0]] += Number(row[2]);
        })

        return dataObj;

    }


    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = `${filename}-${selectedOrgUnit.name}-${dateSelected}.xls`;
            document.getElementById("dlink").click();
        }
    })()


    function printContent(el) {
        var restorepage = document.body.innerHTML;
        var printcontent = document.getElementById(el).innerHTML;
        document.body.innerHTML = printcontent;
        window.print();
        document.body.innerHTML = restorepage;
    }


</script>