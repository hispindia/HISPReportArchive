<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Household Convergence Scorecard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    font-size: 14px;
    margin: 0;
    padding: 0;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 10px;
  }

  th,
  td {
    border: 1px solid #000;
    padding: 6px;
    text-align: left;
    vertical-align: top;
  }

  .header {
    font-weight: bold;

    font-size: large;
  }

  .header1 {
    background-color: #d9d9d9;
  }

  .section-title {
    font-size: 18px;
    font-weight: bold;
    padding: 8px 0;
  }

  .highlight {
    background-color: #c4e0bc;
    font-weight: bold;
  }

  .status-box {
    display: inline-block;
    padding: 2px 8px;
    margin-right: 4px;
    border-radius: 4px;
    color: #fff;
    font-weight: bold;
  }

  .green {
    background-color: #92d050;
  }

  .red {
    background-color: #ff0000;
  }

  .yellow {
    background-color: #ffff00;
    color: #000;
  }

  .gray {
    background-color: #fce5cd;
  }

  .score-symbol {
    font-size: 18px;
    text-align: center;
  }

  .score-green {
    color: #92d050;
    font-weight: bold;
  }

  .score-red {
    color: red;
    font-weight: bold;
  }

  .score-yellow {
    color: #e5b900;
    font-weight: bold;
  }

  .red {
    background-color: #f4c7c3 !important;
    text-align: center;
  }

  .yellow {
    background-color: #ffe699 !important;
    text-align: center;
  }

  .check {
    /* color: blueviolet; */
    /* Purple check */
    background-color: lightgreen;
    font-size: 18px;
    text-align: center;
  }

  .cross {
    /* color: red; */
    background-color: lightcoral;
    font-size: 18px;
    text-align: center;
  }

  .dash {
    color: black;
    font-size: 18px;
  }

  .category {
    background-color: #fce5cd;
  }

  #loader {
    position: absolute;
    left: 50%;
    top: 50%;
    z-index: 1;
    width: 150px;
    height: 150px;
    margin: -75px 0 0 -75px;
    border: 16px solid #f3f3f3;
    border-radius: 50%;
    border-top: 16px solid #34B4DB;
    width: 120px;
    height: 120px;
    -webkit-animation: spin 2s linear infinite;
    animation: spin 2s linear infinite;
  }
</style>

<a id="dlink" style="display:none;"></a>

<button type="button" class="btn btn-success btn-sm" style="vertical-align: middle; cursor:pointer" id="btnExport"
  onclick="tableToExcel('dataTable', 'BARANGAY CONSOLIDATION SCORECARD', 'BARANGAY CONSOLIDATION SCORECARD')"><span
    class="glyphicon glyphicon-download-alt" style="font-size: 15px;"></span>Download As Excel</button>
<div id="loader" style="display:none;">Loading...</div>
<div id="dataTable">
  <table>
    <!-- <tr>
      <td colspan="12" class="gray">Barangay Consolidation</td>
    </tr> -->
    <tr>
      <td colspan="12" class="header">HOUSEHOLD CONVERGENCE SCORECARD</td>
    </tr>
    <tr class="header1">
      <td colspan="8">BARANGAY INFORMATION</td>
      <td colspan="4">Date:<span id="report-date"></span></td>
    </tr>
    <tr>
      <td colspan="2">Barangay:<span id="barangay"></span></td>
      <td colspan="2">Municipality:<span id="municipality"></span></td>
      <td colspan="2">Province:<span id="province"></span></td>
      <td colspan="2">Region:<span id="region"></span></td>
      <td colspan="2">Quarter:<span id="quarter"></span></td>
      <td colspan="2">Year:<span id="year-id"></span></td>
    </tr>
    <tr>
      <td colspan="4">Number of IPs:<span id="ZkDVhSbzeRq"></span></td>
      <td colspan="4">
        Number of Eligible Houshold:<span id="fxmvSiKfEpn"></span>
      </td>
      <td colspan="4">
        Number of Eligible Children 0-59 mos old :<span id="M14FqSaQu5Q"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4">
        Number of 4Ps Members:<span id="UrdlhCguP6T"></span>
      </td>
      <td colspan="4">
        Number of Eligible Pregnant:<span id="egST5Av3tJh"></span>
      </td>
      <td colspan="4">
        Number of Eligible Children less than 6 mos old :<span id="r5cHtnYeyXd"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4">
        Number of Philhealth Members:<span id="Cl9XC0HVp1B"></span>
      </td>
      <td colspan="4">
        Number of Eligible Women of Reproductive Age:<span id="Lmh1EJ2UXBL"></span>
      </td>
      <td colspan="4">
        Number of Eligible Children 0-59 mos old :<span id="ePaxQu8511O"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4">Number of PWD:<span id="iWvv6vXisHf"></span></td>
      <td colspan="4">
        Number of Convergent Household:<span id="LOMZy9q1euI"></span>
      </td>
      <td colspan="4">
        Number of Eligible Children 24-59 mos old :<span id="wiZlLaZYus3"></span>
      </td>
    </tr>
  </table>
  <table>
    <thead>
      <tr id="year-header">
        <th rowspan="2">Indicators</th>
      </tr>
      <tr id="quarter-header"></tr>
    </thead>
    <tbody id="table-body">
      <tr class="category">
        <td id="household-services">Household Services</td>
      </tr>
      <tr>
        <td>
          Household has access to a safely managed drinking water source
        </td>
      </tr>
      <tr>
        <td>Household has access to a handwashing water source</td>
      </tr>
      <tr>
        <td>Household with access to improved toilet</td>
      </tr>
      <tr>
        <td>Attendance to FDS/SBCC Session on Health and Nutrition</td>
      </tr>
      <tr class="category">
        <td id="Maternal Services">Maternal Services</td>
      </tr>
      <tr>
        <td>Pre-natal</td>
      </tr>
      <tr>
        <td>Intake of Iron + Folic or MMS</td>
      </tr>
      <tr>
        <td>Facility Based Delivery</td>
      </tr>
      <tr>
        <td>Post Natal Care</td>
      </tr>
      <tr>
        <td>Tetanus Vaccine</td>
      </tr>
      <tr class="category">
        <td id="Child Services">Child Services</td>
      </tr>
      <tr>
        <td>Age Appropriate Immunization</td>
      </tr>
      <tr>
        <td>Exclusive Breastfeeding/ Diet Diversity Score</td>
      </tr>
      <tr>
        <td>Vitamin A Supplementation</td>
      </tr>
      <tr>
        <td>Growth Monitoring</td>
      </tr>
      <tr>
        <td>Monitoring and Treatment for SAM/MAM/OB/OW</td>
      </tr>
    </tbody>
  </table>
</div>

<script>
  const today = new Date();
  const year = today.getFullYear();
  const formattedDate = today.toLocaleDateString("en-GB"); // 'dd/mm/yyyy'
  const dateWithDashes = formattedDate.replace(/\//g, "-"); // Convert to 'dd-mm-yyyy'
  document.getElementById("report-date").innerText = `${dateWithDashes}`;
  document.getElementById("year-id").innerText = today.getFullYear();
  function getQuarter(month) {
    if (month >= 0 && month <= 2) return 'Q1';
    if (month >= 3 && month <= 5) return 'Q2';
    if (month >= 6 && month <= 8) return 'Q3';
    return 'Q4'; // months 9-11
  }

  // Get the month from the formatted date
  const month = parseInt(dateWithDashes.split("-")[1], 10) - 1; // Months are 0-indexed
  const quarter = getQuarter(month);

  // Display the quarter in an element with id "quarter"
  document.getElementById("quarter").innerText = `Quarter: ${quarter}`;
</script>

<script>

  var selectedOrgUnit = dhis2.report.organisationUnit;

  document.getElementById("loader").style.display = "block";
  document.addEventListener("DOMContentLoaded", async function () {

    console.log("dddddddddd", dhis2)
    const apiData = `https://ln3.hispindia.org/pmnp_is/api/analytics.json?dimension=pe%3AQUARTERS_THIS_YEAR&dimension=dx%3AGs1ujVrangk%3BjAtiWFz9C4S%3Bez8o9ujztdd%3BfPn20t5yvEB%3BvmPAnPQmK1y%3BTjKPYPbOZYu%3BrZLpYOyIZBt%3BCDnh391SN43%3BrEN34c1ojxx%3BiZDKeeBUgSC%3BGjW2dfR5Ihw%3BcbYeJFKTcHg%3BwDsgdSiF5eH%3BRtcDzSuysGK%3BzrkCYyhiCFJ%3BZkDVhSbzeRq%3BUrdlhCguP6T%3BCl9XC0HVp1B%3BfxmvSiKfEpn%3BegST5Av3tJh%3BLmh1EJ2UXBL%3BLOMZy9q1euI%3BM14FqSaQu5Q%3BwiZlLaZYus3%3BePaxQu8511O%3Br5cHtnYeyXd&showHierarchy=false&hierarchyMeta=false&includeMetadataDetails=true&includeNumDen=true&skipRounding=false&completedOnly=false&outputIdScheme=UID&filter=ou:${selectedOrgUnit.id}`
    console.log("Fetching data from API...");

    console.trace("hhhhhhhhhh");
    async function fetchData(url) {
      try {
        let response = await fetch(url);
        if (!response.ok) throw new Error("Failed to fetch data");
        return await response.json();
      } catch (error) {
        console.error("Error fetching data:", error);
        return null;
      }
    }
    const analyticsData = await fetchData(apiData);
    document.getElementById("loader").style.display = "none";
    const rows = analyticsData.rows;
    // data elements above the dynamic table
    const Attributes = {
      UrdlhCguP6T: {},
      ZkDVhSbzeRq: {},
      Cl9XC0HVp1B: {},
      fxmvSiKfEpn: {},
      egST5Av3tJh: {},
      Lmh1EJ2UXBL: {},
      Gs1ujVrangk: {},
      M14FqSaQu5Q: {},
      r5cHtnYeyXd: {},
      ePaxQu8511O: {},
      wiZlLaZYus3: {},
      LOMZy9q1euI: {},
    };

    // Helper to parse period for comparison of attributes and get the latest Quarter value 
    // function parsePeriod(pe) {
    //   const year = parseInt(pe.substring(0, 4));
    //   const quarter = parseInt(pe.substring(5));
    //   return { year, quarter, raw: pe };
    // }
    // 1. Get current year and quarter dynamically
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1; // January is 0
    let currentQuarter = "";

    if (currentMonth <= 3) currentQuarter = "Q1";
    else if (currentMonth <= 6) currentQuarter = "Q2";
    else if (currentMonth <= 9) currentQuarter = "Q3";
    else currentQuarter = "Q4";
    // Process each row
    rows.forEach((row) => {
      const dx = row[0];
      const pe = row[1];
      const value = row[2];

      if (!(dx in Attributes)) return;

      const year = parseInt(pe.slice(0, 4), 10);
      const quarter = pe.slice(-2); // Extracts "Q1", "Q2", etc.

      // 3. Match only the current quarter and year
      if (year === currentYear && quarter === currentQuarter) {
        const numericValue = value !== "" ? parseFloat(value) : "NA";
        Attributes[dx] = { year, quarter, value: numericValue };
        // const { year, quarter } = parsePeriod(pe);
        // // const numericValue = value !== "" ? parseFloat(value) : '';
        // const numericValue = value !== "" ? parseFloat(value) : '';
        // // Update latest quarter if needed
        // const currentLatestQ = Attributes[dx]?.latestQuarter;
        // if (
        //   !currentLatestQ ||
        //   year > currentLatestQ.year ||
        //   (year === currentLatestQ.year && quarter > currentLatestQ.quarter)
        // ) {
        //   Attributes[dx] = { year, quarter, value: numericValue };

        document.getElementById("ZkDVhSbzeRq").innerHTML =
          Attributes["ZkDVhSbzeRq"].value;
        document.getElementById("UrdlhCguP6T").innerHTML =
          Attributes["UrdlhCguP6T"].value;
        document.getElementById("Cl9XC0HVp1B").innerHTML =
          Attributes["Cl9XC0HVp1B"].value;
        document.getElementById("fxmvSiKfEpn").innerHTML =
          Attributes["fxmvSiKfEpn"].value;
        document.getElementById("egST5Av3tJh").innerHTML =
          Attributes["egST5Av3tJh"].value;
        document.getElementById("Lmh1EJ2UXBL").innerHTML =
          Attributes["Lmh1EJ2UXBL"].value;
        document.getElementById("LOMZy9q1euI").innerHTML =
          Attributes["LOMZy9q1euI"]?.value || ' ';
        document.getElementById("M14FqSaQu5Q").innerHTML =
          Attributes["M14FqSaQu5Q"].value;
        document.getElementById("r5cHtnYeyXd").innerHTML =
          Attributes["r5cHtnYeyXd"].value;
        document.getElementById("ePaxQu8511O").innerHTML =
          Attributes["ePaxQu8511O"].value;
        document.getElementById("wiZlLaZYus3").innerHTML =
          Attributes["wiZlLaZYus3"].value;

      }
    });
    console.log("Analytics Data:", analyticsData);
    var obj = {
      ez8o9ujztdd: {}, //1
      jAtiWFz9C4S: {}, //2
      GjW2dfR5Ihw: {}, //====
      zrkCYyhiCFJ: {},
      TjKPYPbOZYu: {},
      rEN34c1ojxx: {}, //5
      wDsgdSiF5eH: {},
      vmPAnPQmK1y: {},
      rZLpYOyIZBt: {},
      cbYeJFKTcHg: {},
      RtcDzSuysGK: {},
      CDnh391SN43: {}, //10
      fPn20t5yvEB: {}, //======
      iZDKeeBUgSC: {},
    };

    // updateDtavalue for DataTable
    let updateDatavalue = {};
    async function processTrackedEntityData() {
      // let response = await fetchData(apiUrl);
      // if (!response) return;
      console.log("updated value", updateDatavalue);
      analyticsData.rows.forEach((data) => {
        const dx = data[0];
        const pe = data[1];
        const value = data[2] || "NA";

        // const year = pe.slice(0, 4);
        // const quarter = pe.slice(-2); // "Q2"
        const year = parseInt(pe.slice(0, 4), 10);
        const quarter = pe.slice(-2); // Extracts "Q1", "Q2", etc.

        // 3. Match only the current quarter and year
        if (year === currentYear && quarter === currentQuarter) {

          if (!updateDatavalue[dx]) {
            updateDatavalue[dx] = {};
          }

          if (!updateDatavalue[dx][year]) {
            updateDatavalue[dx][year] = {};
          }
          updateDatavalue[dx][year][quarter] = value; // update the value with DataElement year and Quarter then value of that DataElement
        }
      });

      // check Orgunit id then fetch the OrgUnit api
      // let orgUnitId = response.orgUnit;
      // if (orgUnitId) {
      await fetchOrgUnitHierarchy();
      // }
      // calculate the Dynamic year and Set it to Array of Year like [2024,2025]
      const uniqueYears = new Set();
      analyticsData.rows.forEach((row) => {
        const pe = row[1]; // e.g., "2024Q2"
        const year = pe.slice(0, 4); // get "2024"
        uniqueYears.add(year);
      });
      // short the array 
      const years = Array.from(uniqueYears).sort();
      let baseColspan = 17;
      let extraPerAdditionalYear = 4;

      // Calculate dynamic colspan for Static filed in DataTable 
      let colspan =
        baseColspan +
        (years.length > 1
          ? (years.length - 1) * extraPerAdditionalYear
          : 0);

      // Apply to the td
      document
        .getElementById("household-services")
        .setAttribute("colspan", colspan);
      document
        .getElementById("Maternal Services")
        .setAttribute("colspan", colspan);
      document
        .getElementById("Child Services")
        .setAttribute("colspan", colspan);

      let yearHeader = document.getElementById("year-header");
      let quarterHeader = document.getElementById("quarter-header");
      let tableBody = document.getElementById("table-body");

      // Create Dynamic year headers
      years.forEach((year) => {
        yearHeader.innerHTML += `<th colspan="4" style="text-align: center;">Y${year}</th>`;
      });

      // Create Dynamic quarter headers
      years.forEach(() => {
        for (let quarter = 1; quarter <= 4; quarter++) {
          quarterHeader.innerHTML += `<th style="text-align: center;">Q${quarter}</th>`;
        }
      });
      let skipKeywords = [
        "Household Services",
        "Maternal Services",
        "Child Services",
      ];

      let rows = Array.from(tableBody.getElementsByTagName("tr")).filter(
        (row) => {
          let text = row.cells[0]?.innerText?.trim();
          return !skipKeywords.includes(text);
        }
      );
      //   let rows = Array.from(tableBody.getElementsByTagName("tr")); // Convert to array
      let keys = Object.keys(obj); // Get object keys

      // Ensure row-key mapping is correct
      if (rows.length !== keys.length) {
        console.warn("Mismatch: Number of rows and keys are different!");
      }

      rows.forEach((row, index) => {
        let key = keys[index]; // Correctly map row to key
        let data = updateDatavalue.hasOwnProperty(key)
          ? updateDatavalue[key]
          : null;

        years.forEach((year) => {
          for (let quarter = 1; quarter <= 4; quarter++) {
            let quarterKey = `Q${quarter}`;
            let cell = row.insertCell(-1); // Insert new cell

            let value = data?.[year]?.[quarterKey] || ""; // Safe lookup, default empty

            // Define symbol & background color
            let symbol = "";
            let bgColor = "white";

            if (value) {
              symbol = value;
              // bgColor = "lightgreen"; // ✅ Green for true
            }
            // Apply styles
            cell.innerHTML = `<span style="font-size: 16px; font-weight: bold;">${symbol}</span>`;
            // cell.style.backgroundColor = bgColor;
            // cell.style.textAlign = "center";
            // cell.style.fontWeight = "bold";
          }
        }); // draw blak cell when dataelement not present
      });


      // });
    }

    // Call function to fetch and update data
    processTrackedEntityData();

    async function fetchOrgUnitHierarchy() {
      // api for OrgUnit
      const orgUnitApi = `https://ln3.hispindia.org/pmnp_is/api/organisationUnits/${selectedOrgUnit.id}.json?fields=id,name,parent[id,name,parent[id,name,parent[id,name]]]`;
      const data = await fetchData(orgUnitApi);
      if (!data) return;

      const barangay = data?.name || "N/A";
      const municipality = data?.parent?.name || "N/A";
      const province = data?.parent?.parent?.name || "N/A";
      const region = data?.parent?.parent?.parent?.name || "N/A";

      document.getElementById("barangay").innerText = barangay;
      document.getElementById("municipality").innerText = municipality;
      document.getElementById("province").innerText = province;
      document.getElementById("region").innerText = region;
    }
  });
  var tableToExcel = (function () {
    var uri = 'data:application/vnd.ms-excel;base64,'
      , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
      , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
      , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
    return function (table, name, filename) {
      if (!table.nodeType) table = document.getElementById(table)
      var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
      document.getElementById("dlink").href = uri + base64(format(template, ctx));
      document.getElementById("dlink").download = filename + '.xls';
      document.getElementById("dlink").click();
    }
  })()
</script>