<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Household Convergence Scorecard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    font-size: 14px;
    margin: 0;
    padding: 0;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 10px;
  }

  th,
  td {
    border: 1px solid #000;
    padding: 6px;
    text-align: left;
    vertical-align: top;
  }

  .header {
    font-weight: bold;

    font-size: large;
  }

  .header1 {
    background-color: #D9D9D9;
  }

  .section-title {
    font-size: 18px;
    font-weight: bold;
    padding: 8px 0;
  }

  .highlight {
    background-color: #c4e0bc;
    font-weight: bold;
  }

  .status-box {
    display: inline-block;
    padding: 2px 8px;
    margin-right: 4px;
    border-radius: 4px;
    color: #fff;
    font-weight: bold;
  }

  .green {
    background-color: #92d050;
  }

  .red {
    background-color: #ff0000;
  }

  .yellow {
    background-color: #ffff00;
    color: #000;
  }

  .gray {
    background-color: #FCE5CD;
  }

  .score-symbol {
    font-size: 18px;
    text-align: center;
  }

  .score-green {
    color: #92d050;
    font-weight: bold;
  }

  .score-red {
    color: red;
    font-weight: bold;
  }

  .score-yellow {
    color: #e5b900;
    font-weight: bold;
  }

  .red {
    background-color: #f4c7c3 !important;
    text-align: center;
  }

  .yellow {
    background-color: #ffe699 !important;
    text-align: center;
  }

  .check {
    /* color: blueviolet; */
    /* Purple check */
    background-color: lightgreen;
    font-size: 18px;
    text-align: center;
  }

  .cross {
    /* color: red; */
    background-color: lightcoral;
    font-size: 18px;
    text-align: center;
  }

  .dash {
    color: black;
    font-size: 18px;
  }

  .category {
    background-color: #FCE5CD;
  }
</style>


<a id="dlink" style="display:none;"></a>

<button type="button" class="btn btn-success btn-sm" style="vertical-align: middle; cursor:pointer" id="btnExport"
  onclick="tableToExcel('dataTable', 'PNMP REPORT', 'PNMP REPORT')"><span class="glyphicon glyphicon-download-alt"
    style="font-size: 15px;"></span>Download As Excel</button>
<div id="dataTable">
  <table>
    <tr>
      <td colspan="12" class="gray">Individual</td>
    </tr>
    <tr>
      <td colspan="12" class="header">HOUSEHOLD CONVERGENCE SCORECARD</td>
    </tr>
    <tr class="header1">
      <td colspan="8">HOUSEHOLD INFORMATION</td>
      <td colspan="4">Date:<span id="report-date"></span></td>
    </tr>
    <tr>
      <td colspan="2">HH ID Number:<span id="IKOSsYJJZis"></span></td>
      <td colspan="2">Visitation Number:<span id="WGqRCnEYzux"></span></td>
      <td colspan="2">Quarter:<span id="I5nbD6rXhmn"></span></td>
      <td colspan="2">Year:<span id="year-id"></span></td>
      <td colspan="4">Last Visitation Date:<span id="event-date"></span></td>
    </tr>
    <tr>
      <td colspan="2">Street Address:<span id="HYNM3CJYLje"></span></td>
      <td colspan="6">IP STATUS(Y/N):<span id="lVOceUugk7C"></span></td>
      <td colspan="4" rowspan="3">Household Status:
        <span id="LNTl0FjkMaD"></span><br>
        <span id="yZXpvusfhSC"></span><br>
        <span id="usT2QWekRjm"></span><br>
        <span id="Ud7pdtnOz0p"></span><br>
      </td>
    </tr>
    <tr>
      <td colspan="2">Barangay:<span id="eMYBznRdn0t"> </span></td>
      <td colspan="6">4Ps membership (Y/N): <span id="TKSp7xKJEan"></span></td>
    </tr>
    <tr>
      <td colspan="2">Municipality:<span id="municipality"></span></td>
      <td colspan="6">Philhealth Membership (Y/N):<span id="nJ9peoKuLoX"></span></td>
    </tr>
    <tr>
      <td colspan="2">Province:<span id="province"></span></td>
      <td colspan="6">PWD(Y/N):</td>
      <td colspan="3">Eligible and Received:
      <td class="check"><span class="dash">✔</span></td>

      </td>
    </tr>
    <tr>
      <td colspan="2">Region:<span id="region"></span></td>
      <td colspan="6" rowspan="2" class="highlight" id="convergence-status"
        style="text-align: center;font-size: medium;align-content: center;"></td>
      <td colspan="3">Eligible but Not Received:
      <td class="cross"><span class="dash">✖</span></td>

      </td>
    </tr>
    <tr>
      <td colspan="2"></td>

      <td colspan="3">Ineligible and /or N/A:
      <td class="yellow"><span class="dash">−</span></td>
      </td>
    </tr>
  </table>
  <table>
    <thead>
      <tr id="year-header">
        <th rowspan="2">Indicators</th>
      </tr>
      <tr id="quarter-header"></tr>
    </thead>
    <tbody id="table-body">
      <tr class="category">
        <td id="household-services">Household Services</td>
      </tr>
      <tr>
        <td>Household has access to a safely managed drinking water source</td>
      </tr>
      <tr>
        <td>Household has access to a handwashing water source</td>
      </tr>
      <tr>
        <td>Household with access to improved toilet</td>
      </tr>
      <tr>
        <td>Attendance to FDS/SBCC Session on Health and Nutrition</td>
      </tr>
      <tr class="category">
        <td id="Maternal Services">Maternal Services</td>
      </tr>
      <tr>
        <td>Pre-natal</td>
      </tr>
      <tr>
        <td>Intake of Iron + Folic or MMS</td>
      </tr>
      <tr>
        <td>Facility Based Delivery</td>
      </tr>
      <tr>
        <td>Post Natal Care</td>
      </tr>
      <tr>
        <td>Tetanus Vaccine</td>
      </tr>
      <tr class="category">
        <td id="Child Services">Child Services</td>
      </tr>
      <tr>
        <td>Age Appropriate Immunization</td>
      </tr>
      <tr>
        <td>Exclusive Breastfeeding/ Diet Diversity Score</td>
      </tr>
      <tr>
        <td>Vitamin A Supplementation</td>
      </tr>
      <tr>
        <td>Growth Monitoring</td>
      </tr>
      <tr>
        <td>Monitoring and Treatment for SAM/MAM/OB/OW</td>
      </tr>
    </tbody>
  </table>
</div>

<script>
  const today = new Date();
  const year = today.getFullYear();
  const formattedDate = today.toLocaleDateString('en-GB'); // 'dd/mm/yyyy'
  const dateWithDashes = formattedDate.replace(/\//g, '-'); // Convert to 'dd-mm-yyyy'
  document.getElementById('report-date').innerText = `${dateWithDashes}`;
  document.getElementById('year-id').innerText = today.getFullYear();

</script>

<script>
  // get the Tei Id from the Browser Url 
  const currentUrl = window.parent.location.href;
  const hashUrl = currentUrl.split('&');
  const queryString = hashUrl[1].includes('tei') ? hashUrl[1].split('=')[1] : '';
  console.log("queryString==", queryString)
  // Compare the multiple Datavalues id from the Api data if all the present then show these names
  const HouseHoldStatus = {
    "LNTl0FjkMaD": "Pregnancy",
    "yZXpvusfhSC": "Gave birth within the last 28 days",
    "usT2QWekRjm": "WRA",
    "Ud7pdtnOz0p": "Child < 5 years"
  }

  // calculate the quarter function 
  function getQuarter(dateString) {
    const date = new Date(dateString);

    if (isNaN(date.getTime())) {
      throw new Error("Invalid date input");
    }

    const month = date.getUTCMonth() + 1; // months are 0-indexed
    const quarter = Math.ceil(month / 3);
    const year = date.getUTCFullYear();

    return { quarter: `Q${quarter}`, year: year };
  }

  //ok4PLjbZSBG    lWex2z5Blwy
  document.addEventListener("DOMContentLoaded", async function () {
    const apiUrl =
      `https://ln3.hispindia.org/pmnp_is/api/trackedEntityInstances/${queryString}.json?fields=*&order=eventDate:desc`;

    console.log("Fetching data from API...");
    console.trace("hhhhhhhhhh");
    async function fetchData(url) {
      try {
        let response = await fetch(url);
        if (!response.ok) throw new Error("Failed to fetch data");
        return await response.json();
      } catch (error) {
        console.error("Error fetching data:", error);
        return null;
      }
    }
    // Dynamic DataTable DataElements 
    var obj = {
      MNu4naFgvBC: {}, //1
      EeraoiUKKA6: {}, //2
      JOsQfzE5Lrl: {},
      dxag8YT8w46: {},
      EfmBmtzUDtA: {}, //5

      BRxB2mqlxtq: {},
      wf68PYq7Loa: {},
      // If l3vrPTVrY45 OR ULshoKF1PfR = Yes
      AhH8CegcpvR: {},
      // l3vrPTVrY45: {},
      sbKn8bylu58: {}, //10

      Kl5LLsA10rk: {},//======
      AhH8CegcpvQ: {},

      pOaMwFxZFmw: {},
      sXCoUlbEULM: {},
      nVzXtXKKiGI: {},//13
    };
    //conditional DataElements for combining the two DataElement value in single
    const exceptionalDataElement = "AhH8CegcpvQ";
    const dependencies = ["Xsi5z2a7JMY", "kL0aNVBx5MS"]// Show if any of these are YES
    const exceptionalDataElement2 = "AhH8CegcpvR";
    const dependencies2 = ["l3vrPTVrY45", "ULshoKF1PfR"]// Show if any of these are YES

    // let conditional DataElement id and use it in Object 
    let updateDatavalue = {
      "AhH8CegcpvQ": {},
      "AhH8CegcpvR": {},
    };
    async function processTrackedEntityData() {
      let response = await fetchData(apiUrl);
      if (!response) return;
      console.log("Tracked Entity Data:", response);

      console.log("updated value", updateDatavalue);

      response.enrollments.forEach((entity) => {
        // Extract attributes
        entity.attributes.forEach((attr) => {// fill the attribute value in this
          if (document.getElementById(attr.attribute)) {
            document.getElementById(attr.attribute).innerHTML = attr.value;
          }

        });


        entity.events.forEach((event) => {
          const dateString = event.eventDate.slice(0, 10); // date used for getting the Querter 
          const eventDateElement = document.getElementById("event-date");// used for showing the event date
          if (eventDateElement) {
            const eventDate = event.eventDate || event.created;
            const formattedDate = new Date(eventDate).toLocaleDateString("en-GB"); // Default format DD/MM/YYYY
            const dateWithDashes = formattedDate.replace(/\//g, '-'); // Convert to 'dd-mm-yyyy'
            eventDateElement.textContent = dateWithDashes;
          }
          // if (event.event !== targetEventId) return; // Skip if it's not the target event
          event.dataValues.forEach((dataValue) => {

            //it for exceptional datavalues check value



            // AllDatavalues[dataValue.dataElement] = dataValue.value;
            if (document.getElementById(dataValue.dataElement)) {// fill the value in HouseHold Status
              if (HouseHoldStatus[dataValue.dataElement]) {
                document.getElementById(dataValue.dataElement).innerHTML = HouseHoldStatus[dataValue.dataElement]
              }

            }
            if (!HouseHoldStatus[dataValue.dataElement]) {
              if (document.getElementById(dataValue.dataElement)) {// fill the value without houseHold element 
                // document.getElementById(dataValue.dataElement).innerHTML = dataValue.value;
                if (dataValue.dataElement === "WGqRCnEYzux") {
                  let displayUniqueValue = dataValue.value
                  document.getElementById(dataValue.dataElement).innerHTML = displayUniqueValue;

                }
                else {
                  let displayValue =
                    (dataValue.value === "1")
                      ? "Yes"
                      : (dataValue.value === "2")
                        ? "No"
                        : dataValue.value;

                  document.getElementById(dataValue.dataElement).innerHTML = displayValue;

                }

              }
            }



            // const quarter = getQuarter(dateString); // Determine quarter
            const { quarter, year } = getQuarter(dateString);
            if (!updateDatavalue[dataValue.dataElement]) {
              updateDatavalue[dataValue.dataElement] = {};
            }
            if (!updateDatavalue[dataValue.dataElement][year]) {
              updateDatavalue[dataValue.dataElement][year] = {};
            }

            // Apply special logic for specific DataElement this dataElement contaning 1 and 2 value that should be show tick if get 3 option value then cross
            const specialElements = ['JOsQfzE5Lrl']; // Add as many as needed

            if (specialElements.includes(dataValue.dataElement)) {
              // Check value and assign true, false, or 'NA'
              let val;
              if (dataValue.value === '1' || dataValue.value === '2') {
                val = 'true';
              } else if (dataValue.value === '3') {
                val = 'false';
              } else {
                val = dataValue.value;
              }
              updateDatavalue[dataValue.dataElement][year][quarter] = val;
            } else {
              // Default assignment for all other data elements
              updateDatavalue[dataValue.dataElement][year][quarter] = dataValue.value;
            }
            // updateDatavalue[dataValue.dataElement][year][quarter] = dataValue.value;
            // if (dependencies.includes(dataValue.dataElement)) {// this code for exceptional condition 2
            //   if ((dataValue.value == "true") || (dataValue.value == "0") || (dataValue.value == "false") || (dataValue.value == "1") || (dataValue.value == "NA")) {
            //     updateDatavalue[exceptionalDataElement] = {
            //       ...updateDatavalue[exceptionalDataElement],
            //       [year]: {
            //         ...updateDatavalue[exceptionalDataElement][year],
            //         [quarter]: dataValue.value
            //       }

            //     }
            //     // updateDatavalue[exceptionalDataElement][year][quarter] = 'true'
            //   }
            // }
            if (dependencies.includes(dataValue.dataElement)) {
              // Track values temporarily
              if (!window._depTempValues) window._depTempValues = {};
              window._depTempValues[dataValue.dataElement] = dataValue.value;

              const val1 = window._depTempValues[dependencies[0]];
              const val2 = window._depTempValues[dependencies[1]];

              // Proceed only when at least one is present
              if (val1 !== undefined || val2 !== undefined) {
                let finalValue = "NA";

                if (val1 === "1" || val2 === "1") {
                  finalValue = "1"; // Covers rules 1, 2, 3, 5
                } else if (val1 === "0" && val2 === "0") {
                  finalValue = "0"; // Rule 6
                } else if ((val1 === "NA" || val1 === undefined) && (val2 === "NA" || val2 === undefined)) {
                  finalValue = "NA"; // Rule 4
                }

                if (!updateDatavalue[exceptionalDataElement]) updateDatavalue[exceptionalDataElement] = {};
                if (!updateDatavalue[exceptionalDataElement][year]) updateDatavalue[exceptionalDataElement][year] = {};

                updateDatavalue[exceptionalDataElement][year][quarter] = finalValue;
              }
            }

            // if (dependencies2.includes(dataValue.dataElement)) {// this code for exceptional condition 1 
            //   if ((dataValue.value == "true") || (dataValue.value == "0") || (dataValue.value == "false") || (dataValue.value == "1") || (dataValue.value == "NA")) {
            //     updateDatavalue[exceptionalDataElement2] = {
            //       ...updateDatavalue[exceptionalDataElement2],
            //       [year]: {
            //         ...updateDatavalue[exceptionalDataElement2][year],
            //         [quarter]: dataValue.value
            //       }

            //     }
            //     // updateDatavalue[exceptionalDataElement][year][quarter] = 'true'
            //   }
            // }
            if (dependencies2.includes(dataValue.dataElement)) {// aply condition when both the DataElements NA then NA if one NA or one have value then value 
              // Track values temporarily
              if (!window._depTempValues) window._depTempValues = {};
              window._depTempValues[dataValue.dataElement] = dataValue.value;

              const val1 = window._depTempValues[dependencies2[0]];
              const val2 = window._depTempValues[dependencies2[1]];

              // Proceed only when at least one is present
              if (val1 !== undefined || val2 !== undefined) {
                let finalValue = "NA";

                if (val1 === "1" || val2 === "1") {
                  finalValue = "1"; // Covers rules 1, 2, 3, 5
                } else if (val1 === "0" && val2 === "0") {
                  finalValue = "0"; // Rule 6
                } else if ((val1 === "NA" || val1 === undefined) && (val2 === "NA" || val2 === undefined)) {
                  finalValue = "NA"; // Rule 4
                }

                if (!updateDatavalue[exceptionalDataElement2]) updateDatavalue[exceptionalDataElement2] = {};
                if (!updateDatavalue[exceptionalDataElement2][year]) updateDatavalue[exceptionalDataElement2][year] = {};

                updateDatavalue[exceptionalDataElement2][year][quarter] = finalValue;
              }
            }

          });
        });


        // Get the latest quarter that has any value
        function getLatestQuarterWithData(dataObj) {
          const years = Object.keys(dataObj)
            .map(Number)
            .sort((a, b) => b - a); // sort years descending

          for (let year of years) {
            for (let q = 4; q >= 1; q--) {
              const val = dataObj?.[year]?.[`Q${q}`];
              if (val !== undefined && val !== "") {
                return { year, quarter: `Q${q}` };
              }
            }
          }

          return null;
        }

        // Function to calculate if Convergent or Non-Convergent
        // function checkLatestQuarterConvergence(dataMap) {
        //   const keys = Object.keys(dataMap); // Use the incoming data map
        //   if (keys.length === 0) return "N/A";

        //   const baseData = dataMap[keys[0]]; // Use first key to find latest quarter
        //   const latest = getLatestQuarterWithData(baseData);
        //   if (!latest) return "N/A";

        //   const { year, quarter } = latest;

        //   for (let key of keys) {
        //     const data = dataMap[key];
        //     const value = data?.[year]?.[quarter];

        //     if (value !== "true" && value !== "1" && value !== "NA") {
        //       return "Non-Convergent"; // If any value is not "true" or "1", it's Non-Convergent
        //     }
        //   }

        //   return "Convergent"; // All values are "true" or "1"
        // }


        // Check convergence for the latest quarter with any value
        function getLatestQuarterWithData(dataObj) {
          const years = Object.keys(dataObj)
            .map(Number)
            .sort((a, b) => b - a); // sort years descending

          for (let year of years) {
            for (let q = 4; q >= 1; q--) {
              const val = dataObj?.[year]?.[`Q${q}`];
              if (val !== undefined && val !== "") {
                return { year, quarter: `Q${q}` };
              }
            }
          }

          return null;
        }
        // function to calculate the Convergent or Non Convergent
        function checkLatestQuarterConvergence(dataMap) {
          const keys = Object.keys(obj); // Same as your row-key map
          const dataToCheck = keys.map(key => updateDatavalue[key]);

          const { year, quarter } = getLatestQuarterWithData(updateDatavalue[keys[0]]); // Use first key as base
          if (!year || !quarter) return "N/A";

          for (let data of dataToCheck) {
            let value = data?.[year]?.[quarter];
            if (value == "false" || value == "0")
            // if (value !== "true" && value !== "1" && value !== undefined && value !== "" && value !== "NA")
            {
              return "Non-Convergent"; // Not ✅ or ➖
            }
          }

          return "Convergent"; // All are ✅ or ➖
        }

        // Add to the DOM the Convergent Status 
        const statusElement = document.getElementById("convergence-status");
        const convergenceResult = checkLatestQuarterConvergence(updateDatavalue);
        statusElement.innerText = `${convergenceResult}`;
        statusElement.style.background = convergenceResult === "Convergent" ? "lightgreen" : "lightcoral";
      });


      // check Orgunit id then fetch the OrgUnit api 
      let orgUnitId = response.orgUnit;
      if (orgUnitId) {
        await fetchOrgUnitHierarchy(orgUnitId);
      }
      // get Dynamic year from the Event date 
      const uniqueYears = new Set();
      const year = dateWithDashes.split("-")[2]; // get "2024"
      uniqueYears.add(year);

      // short the array 
      const years = Array.from(uniqueYears).sort();
      // let years = [2025];
      let baseColspan = 17;
      let extraPerAdditionalYear = 4;

      // Calculate total colspan
      let colspan = baseColspan + (years.length > 1 ? (years.length - 1) * extraPerAdditionalYear : 0);

      // Apply to the td
      document.getElementById("household-services").setAttribute("colspan", colspan);
      document.getElementById("Maternal Services").setAttribute("colspan", colspan);
      document.getElementById("Child Services").setAttribute("colspan", colspan);


      let yearHeader = document.getElementById("year-header");
      let quarterHeader = document.getElementById("quarter-header");
      let tableBody = document.getElementById("table-body");

      // Create year headers
      years.forEach((year) => {
        yearHeader.innerHTML += `<th colspan="4" style="text-align: center;">Y${year}</th>`;
      });

      // Create quarter headers
      years.forEach(() => {
        for (let quarter = 1; quarter <= 4; quarter++) {
          quarterHeader.innerHTML += `<th style="text-align: center;">Q${quarter}</th>`;
        }
      });
      let skipKeywords = ["Household Services", "Maternal Services", "Child Services"];

      let rows = Array.from(tableBody.getElementsByTagName("tr")).filter(row => {
        let text = row.cells[0]?.innerText?.trim();
        return !skipKeywords.includes(text);
      });
      //   let rows = Array.from(tableBody.getElementsByTagName("tr")); // Convert to array
      let keys = Object.keys(obj); // Get object keys

      // Ensure row-key mapping is correct
      if (rows.length !== keys.length) {
        console.warn("Mismatch: Number of rows and keys are different!");
      }

      rows.forEach((row, index) => {
        let key = keys[index]; // Correctly map row to key
        let data = updateDatavalue.hasOwnProperty(key)
          ? updateDatavalue[key]
          : null;

        years.forEach((year) => {
          for (let quarter = 1; quarter <= 4; quarter++) {
            let quarterKey = `Q${quarter}`;
            let cell = row.insertCell(-1); // Insert new cell

            let value = data?.[year]?.[quarterKey] || ""; // Safe lookup, default empty

            // Define symbol & background color
            let symbol = "";
            let bgColor = "white";

            if (value == "true" || value == "1" || value == "2" || value == "3" || value == "4" || value == "5") {
              symbol = "✔";
              bgColor = "lightgreen"; // ✅ Green for true
            } else if (value == "false" || value == "0" || value == "6" || value == "7" || value == "8") {
              symbol = "✖";
              bgColor = "lightcoral"; // ❌ Red for false
            } else if (value == "NA") {
              symbol = "➖";
              bgColor = "lightgoldenrodyellow"; // ➖ Yellow for "normal"
            }
            // else if (value == "NA") {
            //   symbol = "NA";
            //   bgColor = "lightgoldenrodyellow"; // ➖ Yellow for "normal"
            // }

            // else if (value) {
            //   symbol = value; // Show actual value
            // }

            // Apply styles
            cell.innerHTML = `<span style="font-size: 16px; font-weight: bold;">${symbol}</span>`;
            cell.style.backgroundColor = bgColor;
            cell.style.textAlign = "center";
            cell.style.fontWeight = "bold";
          }
        }); // draw blak cell when dataelement not present
      });

    }

    // Call function to fetch and update data
    processTrackedEntityData();
    async function fetchOrgUnitHierarchy(orgUnitId) {// api for OrgUnit 
      const orgUnitApi = `https://ln3.hispindia.org/pmnp_is/api/organisationUnits/${orgUnitId}.json?fields=id,name,parent[id,name,parent[id,name,parent[id,name]]]`;
      const data = await fetchData(orgUnitApi);
      if (!data) return;

      // const barangay = data?.name || "N/A";
      const municipality = data?.parent?.name || "N/A";
      const province = data?.parent?.parent?.name || "N/A";
      const region = data?.parent?.parent?.parent?.name || "N/A";

      // document.getElementById("barangay").innerText = barangay;
      document.getElementById("municipality").innerText = municipality;
      document.getElementById("province").innerText = province;
      document.getElementById("region").innerText = region;
    }

  });

  // var tableToExcel = (function () {
  //   var uri = 'data:application/vnd.ms-excel;base64,'
  //     , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
  //     , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
  //     , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
  //   return function (table, name, filename) {
  //     if (!table.nodeType) table = document.getElementById(table)
  //     var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
  //     document.getElementById("dlink").href = uri + base64(format(template, ctx));
  //     document.getElementById("dlink").download = filename + '.xls';
  //     document.getElementById("dlink").click();
  //   }
  // })()

  var tableToExcel = (function () {
  var uri = 'data:application/vnd.ms-excel;charset=utf-8;base64,',
    template = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office"
            xmlns:x="urn:schemas-microsoft-com:office:excel"
            xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="UTF-8">
          <!--[if gte mso 9]>
            <xml>
              <x:ExcelWorkbook>
                <x:ExcelWorksheets>
                  <x:ExcelWorksheet>
                    <x:Name>{worksheet}</x:Name>
                    <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>
                  </x:ExcelWorksheet>
                </x:ExcelWorksheets>
              </x:ExcelWorkbook>
            </xml>
          <![endif]-->
        </head>
        <body><table>{table}</table></body>
      </html>`,
    base64 = function (s) {
      return window.btoa(unescape(encodeURIComponent(s)))
    },
    format = function (s, c) {
      return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; })
    };

  return function (table, name, filename) {
    if (!table.nodeType) table = document.getElementById(table);
    var ctx = {
      worksheet: name || 'Worksheet',
      table: table.innerHTML
    };
    const link = document.getElementById("dlink");
    link.href = uri + base64(format(template, ctx));
    link.download = filename + '.xls';
    link.click();
  };
})();


</script>