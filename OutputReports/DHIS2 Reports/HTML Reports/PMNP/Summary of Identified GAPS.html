<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Household Convergence Scorecard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    font-size: 14px;
    margin: 0;
    padding: 0;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 10px;
  }

  th,
  td {
    border: 1px solid #000;
    padding: 6px;
    text-align: left;
    vertical-align: top;
  }


  /* table {
      table-layout: auto;
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      white-space: nowrap;
      padding: 8px;
      text-align: left;
    }

    .centerHeader {
      text-align: center;
    }

    /* Optional: to scroll horizontally on smaller screens */

  .header {
    font-weight: bold;
    font-size: large;
    background-color: #d0e0e3;
  }

  .header1 {
    background-color: #d9d9d9;
  }

  .section-title {
    font-size: 18px;
    font-weight: bold;
    padding: 8px 0;
  }

  .highlight {
    background-color: #c4e0bc;
    font-weight: bold;
  }

  .pink {
    background-color: #f4cccc;
  }

  .lightpink {
    background-color: #ead1dc;
  }

  .lightblue {
    background-color: #c9daf8;
  }

  .blue {
    background-color: #a4c2f4;
  }


  .yellow {
    background-color: #fff2cc;
    color: #000;
  }

  .lightyellow {
    background-color: #fce5cd;
  }

  .gray {
    background-color: #fce5cd;
  }

  .score-symbol {
    font-size: 18px;
    text-align: center;
  }

  .score-green {
    color: #92d050;
    font-weight: bold;
  }

  .purple {
    background-color: #d9d2e9;
  }

  .category {
    background-color: #d9d9d9;
  }


  .centerHeader {
    text-align: center;
  }

  .tableSidebar {
    align-content: center;
  }

  .report-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 20px 0;
    font-family: Arial, sans-serif;
  }

  .styled-select {
    padding: 8px 12px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background-color: #fff;
    transition: border-color 0.3s;
  }

  .styled-select:focus {
    border-color: #007bff;
    outline: none;
  }

  .styled-button {
    padding: 8px 16px;
    font-size: 14px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .styled-button:hover {
    background-color: #0056b3;

  }

  #loader {
    position: absolute;
    left: 50%;
    top: 50%;
    z-index: 1;
    width: 150px;
    height: 150px;
    margin: -75px 0 0 -75px;
    border: 16px solid #f3f3f3;
    border-radius: 50%;
    border-top: 16px solid #34b4db;
    width: 120px;
    height: 120px;
    -webkit-animation: spin 2s linear infinite;
    animation: spin 2s linear infinite;
  }

  @-webkit-keyframes spin {
    0% {
      -webkit-transform: rotate(0deg);
    }

    100% {
      -webkit-transform: rotate(360deg);
    }
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .animate-bottom {
    position: relative;
    -webkit-animation-name: animatebottom;
    -webkit-animation-duration: 1s;
    animation-name: animatebottom;
    animation-duration: 1s;
  }

  @-webkit-keyframes animatebottom {
    from {
      bottom: -100px;
      opacity: 0;
    }

    to {
      bottom: 0px;
      opacity: 1;
    }
  }

  @keyframes animatebottom {
    from {
      bottom: -100px;
      opacity: 0;
    }

    to {
      bottom: 0;
      opacity: 1;
    }
  }

  #printing {
    text-align: center;
  }
</style>



<a id="dlink" style="display:none;"></a>

<button type="button" class="btn btn-success btn-sm" style="vertical-align: middle; cursor:pointer" id="btnExport"
  onclick="tableToExcel('dataTable', 'HOUSEHOLD GAPS AND ACTION LIST', 'HOUSEHOLD GAPS AND ACTION LIST')"><span
    class="glyphicon glyphicon-download-alt" style="font-size: 15px;"></span>Download As Excel</button>

<div class="report-controls">
  <select id="reportTypeSelect" class="styled-select" onchange="showSelectedYear();">
    <option value="quarterly">Quarterly</option>
    <option value="yearly">Yearly</option>
  </select>

  <select id="quarterSelect" class="styled-select"></select>

  <button id="submitBtn" class="styled-button">Generate</button>
</div>
<div id="loader" style="display:none;"></div>
<div id="dataTable">


  <table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
    <tr>
      <td colspan="16" class="header" style="font-weight: bold; text-align: center;">Municipality Consolidation</td>
    </tr>
    <tr>
      <td colspan="16" style="font-weight: bold; text-align: center;">HOUSEHOLD CONVERGENCE SCORECARD (Summary of
        Identified Gaps)</td>
    </tr>
    <tr>
      <td colspan="10" class="category" style="font-weight: bold; text-align: left;">MUNICIPALITY INFORMATION</td>
      <td colspan="6" class="category" style="text-align: left;">Date: <span class="report-date"></span></td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Municipality: <span class="municipality"></span></td>
      <td colspan="4" style="text-align: left;">Province: <span class="province"></span></td>
      <td colspan="4" style="text-align: left;">Region: <span class="region"></span></td>
      <td colspan="2" style="text-align: left;">Quarter: <span class="selected-quarter-text"></span></td>
      <td colspan="2" style="text-align: left;">Year: <span class="selectedYearDisplay"></span></td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of Barangays: <span class="num-barangays"></span></td>
      <td colspan="4" style="text-align: left;">Total Number of Reported Households: <span class="QK9yXFa4SJu"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Pregnant Women: <span class="lO5Ia72xcAp"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 0-59 mos old: <span
          class="dg2DG6mAxtY"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of IPs: <span class="gyMM3IBHzYI"></span></td>
      <td colspan="4" style="text-align: left;">Total Number of Eligible Households: <span class="fuvC0llESgH"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Postpartum Women: <span class="FsCWDgHaKrF"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children &lt;6 mos: <span class="c7eOHqwwKXI"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of 4Ps Members: <span class="e40NOAg7hnu"></span></td>
      <td colspan="4" style="text-align: left;">Percent Approved: <span class="StDJxe7tIiS"></span></td>
      <td colspan="4" style="text-align: left;">Number of Eligible Women of Reproductive Age: <span
          class="WslwNhxbATv"></span></td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 6-11 mos: <span class="IAhTOf6Jlwp"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of Philhealth Members: <span class="AnJQW3euRTW"></span></td>
      <td colspan="4" style="text-align: left;">Total Number of Convergent Households: <span class="Gs1ujVrangk"></span>
      </td>
      <td colspan="4" style="border-bottom: none;"></td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 12-23 mos old: <span
          class="jY5SFQNSg2x"></span></td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of PWD: <span class="C4merzrHMn9"></span></td>
      <td colspan="4" style="text-align: left;">Percent Convergence: <span class="qzjKcfO9J2w"></span></td>
      <td colspan="4" style="border-top: none;"></td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 24-59 mos old: <span
          class="BllUSGdqi3r"></span></td>
    </tr>
  </table>

  <table table id="barangayTable" border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
    <thead>
      <tr>
        <th rowspan="3" class="lightyellow">Name of Barangay</th>
        <th rowspan="2" class="yellow">Number of Eligible HH in the Barangay</th>
        <th colspan="22" class="yellow">Household Services</th>
        <th colspan="3" class="purple">Women of Reproductive Age</th>
      </tr>
      <tr>
        <th colspan="2" class="yellow">Safe drinking water (Q701)</th>
        <th colspan="2" class="yellow">Water for handwashing (Q702)</th>
        <th colspan="2" class="yellow">Sanitary toilet (703)</th>
        <th colspan="2" class="yellow">Medical or Social Assistance from any Government Programs (Q801)</th>
        <th colspan="2" class="yellow">SBC Participation (Q900)</th>
        <th colspan="2" class="yellow">Child Mending / Early Learning Services (Q902)</th>
        <th colspan="2" class="yellow">Average Meal Intake(Q903)</th>
        <th colspan="2" class="yellow">Diversified food production activities (Q904)</th>
        <th colspan="2" class="yellow">Food Accessibility (Q905)</th>
        <th colspan="2" class="yellow">Nutrition Security (Q906)</th>
        <th colspan="2" class="yellow">Hunger (Q907)</th>

        <th class="purple">Number of Women of Reproductive Age</th>
        <th colspan="2" class="purple">Did not take Iron + Folic tablets (Q601)</th>
      </tr>
      <tr>
        <!-- Household Services Percentages -->
        <th class="yellow">Total</th>
        <th class="yellow">Actual No.</th>
        <th class="yellow">Percentage</th>
        <th class="yellow">Actual No.</th>
        <th class="yellow">Percentage</th>
        <th class="yellow">Actual No.</th>
        <th class="yellow">Percentage</th>
        <th class="yellow">Actual No.</th>
        <th class="yellow">Percentage</th>
        <th class="yellow">Actual No.</th>
        <th class="yellow">Percentage</th>
        <th class="yellow">Actual No.</th>
        <th class="yellow">Percentage</th>
        <th class="yellow">Actual No.</th>
        <th class="yellow">Percentage</th>
        <th class="yellow">Actual No.</th>
        <th class="yellow">Percentage</th>
        <th class="yellow">Actual No.</th>
        <th class="yellow">Percentage</th>
        <th class="yellow">Actual No.</th>
        <th class="yellow">Percentage</th>
        <th class="yellow">Actual No.</th>
        <th class="yellow">Percentage</th>
        <th class="purple">Total</th>
        <th class="purple">Actual No.</th>
        <th class="purple">Percentage</th>
      </tr>
    </thead>
    <tbody></tbody>

  </table>

  <table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
    <tr>
      <td colspan="16" class="header" style="font-weight: bold; text-align: center;">Municipality Consolidation</td>
    </tr>
    <tr>
      <td colspan="16" style="font-weight: bold; text-align: center;">HOUSEHOLD CONVERGENCE SCORECARD (Summary of
        Identified Gaps)</td>
    </tr>
    <tr>
      <td colspan="10" class="category" style="font-weight: bold; text-align: left;">MUNICIPALITY INFORMATION</td>
      <td colspan="6" class="category" style="text-align: left;">Date: <span id="report-date"></span></td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Municipality: <span class="municipality"></span></td>
      <td colspan="4" style="text-align: left;">Province: <span class="province"></span></td>
      <td colspan="4" style="text-align: left;">Region: <span class="region"></span></td>
      <td colspan="2" style="text-align: left;">Quarter: <span class="selected-quarter-text"></span></td>
      <td colspan="2" style="text-align: left;">Year: <span class="selectedYearDisplay"></span></td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of Barangays: <span class="num-barangays"></span></td>
      <td colspan="4" style="text-align: left;">Total Number of Reported Households: <span class="QK9yXFa4SJu"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Pregnant Women: <span class="lO5Ia72xcAp"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 0-59 mos old: <span
          class="dg2DG6mAxtY"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of IPs: <span class="gyMM3IBHzYI"></span></td>
      <td colspan="4" style="text-align: left;">Total Number of Eligible Households: <span class="fuvC0llESgH"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Postpartum Women: <span class="FsCWDgHaKrF"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children &lt;6 mos: <span class="c7eOHqwwKXI"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of 4Ps Members: <span class="e40NOAg7hnu"></span></td>
      <td colspan="4" style="text-align: left;">Percent Approved: <span class="StDJxe7tIiS"></span></td>
      <td colspan="4" style="text-align: left;">Number of Eligible Women of Reproductive Age: <span
          class="WslwNhxbATv"></span></td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 6-11 mos: <span class="IAhTOf6Jlwp"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of Philhealth Members: <span class="AnJQW3euRTW"></span></td>
      <td colspan="4" style="text-align: left;">Total Number of Convergent Households: <span class="Gs1ujVrangk"></span>
      </td>
      <td colspan="4" style="border-bottom: none;"></td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 12-23 mos old: <span
          class="jY5SFQNSg2x"></span></td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of PWD: <span class="C4merzrHMn9"></span></td>
      <td colspan="4" style="text-align: left;">Percent Convergence: <span class="qzjKcfO9J2w"></span></td>
      <td colspan="4" style="border-top: none;"></td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 24-59 mos old: <span
          class="BllUSGdqi3r"></span></td>
    </tr>
  </table>

  <table id="barangayTable1" border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
    <thead>
      <tr>
        <th rowspan="4" class="lightyellow">Name of Barangay</th>
      </tr>
      <tr>
        <th colspan="9" class="pink">Maternal Care</th>

        <th colspan="17" class="lightpink">Post-Partum Women Care</th>
      </tr>

      <tr>
        <th colspan="1" class="pink">Number of Pregnant Women</th>
        <th colspan="2" class="pink">Prenatal checkup for currently pregnant (Q103) </th>
        <th colspan="2" class="pink">Iron + Folic / MNS for currently pregnant (Q104)</th>
        <th colspan="2" class="pink">Deworming for currently pregnant (Q105)</th>
        <th colspan="2" class="pink">Tetanus Vaccine for pregnant (Q106)</th>

        <th class="lightpink">Number of Post-Partum Women</th>
        <th class="lightpink" colspan="2">Prenatal checkup for those who gave birth (Q203)</th>
        <th class="lightpink" colspan="2">Iron + Folic / MNP for those who gave birth (Q204)</th>
        <th class="lightpink" colspan="2">Deworming for those who gave birth (Q205)</th>
        <th class="lightpink" colspan="2">Tetanus Vaccine for those who gave birth (Q206)</th>
        <th class="lightpink" colspan="2">Facility Delivery (Q301)</th>
        <th class="lightpink" colspan="2">Post-Natal Visit (Q302)</th>
        <th class="lightpink" colspan="2">Vitamin A within 1 month after delivery (Q303)</th>
        <th class="lightpink" colspan="2">Iron+Folic/MNP within 1 month after delivery (Q304)</th>
      </tr>

      <tr>
        <!-- Maternal Care -->
        <th class="pink">Total</th>
        <th class="pink">Actual No.</th>
        <th class="pink">Percentage</th>
        <th class="pink">Actual No.</th>
        <th class="pink">Percentage</th>
        <th class="pink">Actual No.</th>
        <th class="pink">Percentage</th>
        <th class="pink">Actual No.</th>
        <th class="pink">Percentage</th>
        <th class="lightpink">Total</th>
        <th class="lightpink">Actual No.</th>
        <th class="lightpink">Percentage</th>
        <th class="lightpink">Actual No.</th>
        <th class="lightpink">Percentage</th>
        <th class="lightpink">Actual No.</th>
        <th class="lightpink">Percentage</th>
        <th class="lightpink">Actual No.</th>
        <th class="lightpink">Percentage</th>
        <th class="lightpink">Actual No.</th>
        <th class="lightpink">Percentage</th>
        <th class="lightpink">Actual No.</th>
        <th class="lightpink">Percentage</th>
        <th class="lightpink">Actual No.</th>
        <th class="lightpink">Percentage</th>
        <th class="lightpink">Actual No.</th>
        <th class="lightpink">Percentage</th>

      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
  <table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
    <tr>
      <td colspan="16" class="header" style="font-weight: bold; text-align: center;">Municipality Consolidation</td>
    </tr>
    <tr>
      <td colspan="16" style="font-weight: bold; text-align: center;">HOUSEHOLD CONVERGENCE SCORECARD (Summary of
        Identified Gaps)</td>
    </tr>
    <tr>
      <td colspan="10" class="category" style="font-weight: bold; text-align: left;">MUNICIPALITY INFORMATION</td>
      <td colspan="6" class="category" style="text-align: left;">Date: <span class="report-date"></span></td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Municipality: <span class="municipality"></span></td>
      <td colspan="4" style="text-align: left;">Province: <span class="province"></span></td>
      <td colspan="4" style="text-align: left;">Region: <span class="region"></span></td>
      <td colspan="2" style="text-align: left;">Quarter: <span class="selected-quarter-text"></span></td>
      <td colspan="2" style="text-align: left;">Year: <span class="selectedYearDisplay"></span></td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of Barangays: <span class="num-barangays"></span></td>
      <td colspan="4" style="text-align: left;">Total Number of Reported Households: <span class="QK9yXFa4SJu"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Pregnant Women: <span class="lO5Ia72xcAp"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 0-59 mos old: <span
          class="dg2DG6mAxtY"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of IPs: <span class="gyMM3IBHzYI"></span></td>
      <td colspan="4" style="text-align: left;">Total Number of Eligible Households: <span class="fuvC0llESgH"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Postpartum Women: <span class="FsCWDgHaKrF"></span>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children &lt;6 mos: <span class="c7eOHqwwKXI"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of 4Ps Members: <span class="e40NOAg7hnu"></span></td>
      <td colspan="4" style="text-align: left;">Percent Approved: <span class="StDJxe7tIiS"></span></td>
      <td colspan="4" style="text-align: left;">Number of Eligible Women of Reproductive Age: <span
          class="WslwNhxbATv"></span></td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 6-11 mos: <span class="IAhTOf6Jlwp"></span>
      </td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of Philhealth Members: <span class="AnJQW3euRTW"></span></td>
      <td colspan="4" style="text-align: left;">Total Number of Convergent Households: <span class="Gs1ujVrangk"></span>
      </td>
      <td colspan="4" style="border-bottom: none;"></td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 12-23 mos old: <span
          class="jY5SFQNSg2x"></span></td>
    </tr>
    <tr>
      <td colspan="4" style="text-align: left;">Number of PWD: <span class="C4merzrHMn9"></span></td>
      <td colspan="4" style="text-align: left;">Percent Convergence: <span class="qzjKcfO9J2w"></span></td>
      <td colspan="4" style="border-top:none;"></td>
      </td>
      <td colspan="4" style="text-align: left;">Number of Eligible Children 24-59 mos old: <span
          class="BllUSGdqi3r"></span></td>
    </tr>
  </table>
  <table id="barangayTable2" border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
    <thead>
      <tr>
        <th rowspan="3" class="lightyellow">Name of Barangay</th>
        <th colspan="25" class="lightblue">Childcare</th>
      </tr>
      <tr>

        <th rowspan="1" class="lightblue">Number of Children less than 6 mos</th>
        <th colspan="2" class="lightblue">Exclusive Breastfeeding (Q501)</th>
        <th rowspan="1" class="blue">Number of Children less than 6-23 mos</th>
        <th colspan="2" class="blue">Min. dietary diversity</th>
        <th colspan="2" class="blue">Micronutrient Powder (Q503)</th>
        <th colspan="2" class="blue">Vitamin A supplementation (Q504)</th>
        <th rowspan="1" class="lightblue">Number of Children less than 0-59 mos</th>
        <th colspan="2" class="lightblue">Vaccination on schedule (Q403)</th>
        <th colspan="2" class="lightblue">Growth Monitoring (Q505)</th>
        <th colspan="2" class="lightblue">Follow-up Growth Monitoring (Q506)</th>
        <th colspan="2" class="lightblue">Underweight/ Severely Underweight (Q508)</th>
        <th colspan="2" class="lightblue">Stunting/ Severely Stunting (Q510)</th>
        <th colspan="2" class="lightblue">Wasting/ Severely Wasting (Q511/513)</th>
        <th colspan="2" class="lightblue">Untracked and without referral SAM/MAM/OBN (Q512)</th>
      </tr>
      <tr>
        <th class="lightblue">Total</th>
        <th class="lightblue">Actual No.</th>
        <th class="lightblue">Percentage</th>
        <th class="blue">Total</th>
        <th class="blue">Actual No.</th>
        <th class="blue">Percentage</th>
        <th class="blue">Actual No.</th>
        <th class="blue">Percentage</th>
        <th class="blue">Actual No.</th>
        <th class="blue">Percentage</th>
        <th class="lightblue">Total</th>
        <th class="lightblue">Actual No.</th>
        <th class="lightblue">Percentage</th>
        <th class="lightblue">Actual No.</th>
        <th class="lightblue">Percentage</th>
        <th class="lightblue">Actual No.</th>
        <th class="lightblue">Percentage</th>
        <th class="lightblue">Actual No.</th>
        <th class="lightblue">Percentage</th>
        <th class="lightblue">Actual No.</th>
        <th class="lightblue">Percentage</th>
        <th class="lightblue">Actual No.</th>
        <th class="lightblue">Percentage</th>
        <th class="lightblue">Actual No.</th>
        <th class="lightblue">Percentage</th>
      </tr>
      <tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <script>
  // Selected Org Unit
  var selectedOrgUnit = dhis2.report.organisationUnit;

  // Set today's date in all spans
  document.querySelectorAll(".report-date").forEach(span => {
    span.textContent = new Date().toLocaleDateString();
  });

  // Reusable Fetch Function
  async function fetchData(url) {
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Request failed: ${response.status}`);
      return await response.json();
    } catch (err) {
      console.error("Fetch error:", err);
      return null;
    }
  }

  function setTextByClass(className, text) {
    const elements = document.querySelectorAll("." + className);
    elements.forEach(el => {
      el.innerText = text;
    });
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const orgUnitId = selectedOrgUnit.id;

    // Fetch parent + children (include hierarchy)
    const orgUnitsUrl = `../api/organisationUnits/${orgUnitId}.json?fields=id,name,level,
      parent[id,name,
        parent[id,name,
          parent[id,name]
        ]
      ],
      children[id,name]`;
    const orgUnitsData = await fetchData(orgUnitsUrl);
    if (!orgUnitsData) return;

    const numBarangays = orgUnitsData.children ? orgUnitsData.children.length : 0;

    // Update all elements with class "num-barangays"
    document.querySelectorAll(".num-barangays").forEach(el => {
      el.textContent = numBarangays;
    });

    // Show names in all tables
    setTextByClass("municipality", orgUnitsData.name);
    setTextByClass("province", orgUnitsData.parent?.name || "N/A");
    setTextByClass("region", orgUnitsData.parent?.parent?.name || "N/A");

    // Collect only children OU IDs
    const allOuIds = orgUnitsData.children.map(c => c.id);
    const ouParam = allOuIds.join(";");

    // Elements
    const quarterSelect = document.getElementById("quarterSelect");
    const reportTypeSelect = document.getElementById("reportTypeSelect");
    const submitBtn = document.getElementById("submitBtn");

    // ---------------- Period Selection ----------------
    const yearsToShow = [2025, 2026];
    const quarters = ["Q1", "Q2", "Q3", "Q4"];

    function showSelectedYear() {
      const selectedValue = quarterSelect.value;
      let selectedYear = "";

      if (reportTypeSelect.value === "quarterly") {
        selectedYear = selectedValue.substring(0, 4); // e.g. 2025 from "2025Q1"
      } else if (reportTypeSelect.value === "yearly") {
        selectedYear = selectedValue;
      }

      setTextByClass("selectedYearDisplay", selectedYear);
    }

    function populatePeriodOptions() {
      quarterSelect.innerHTML = "";
      const reportType = reportTypeSelect.value;

      if (reportType === "quarterly") {
        yearsToShow.forEach((year) => {
          quarters.forEach((q) => {
            const option = document.createElement("option");
            option.value = `${year}${q}`; // ✅ correct DHIS2 format, e.g. "2025Q1"
            option.text = `${year} ${q}`;
            quarterSelect.appendChild(option);
          });
        });
      } else if (reportType === "yearly") {
        yearsToShow.forEach((year) => {
          const option = document.createElement("option");
          option.value = year; // ✅ correct DHIS2 format, e.g. "2025"
          option.text = year;
          quarterSelect.appendChild(option);
        });
      }

      showSelectedYear();
    }

    reportTypeSelect.addEventListener("change", populatePeriodOptions);
    quarterSelect.addEventListener("change", showSelectedYear);
    populatePeriodOptions();

    // ---------------- Submit button ----------------
    submitBtn.addEventListener("click", async function () {
      document.getElementById("loader").style.display = "block";

      const selectedValue = quarterSelect.value;
      const reportType = reportTypeSelect.value;

      if (!selectedValue) {
        alert("Please select a period first.");
        document.getElementById("loader").style.display = "none";
        return;
      }

      // ✅ Use correct DHIS2 period codes
      let periodFilter = "";
      if (reportType === "quarterly") {
        periodFilter = "pe:" + selectedValue; // e.g. pe:2025Q1
      } else if (reportType === "yearly") {
        periodFilter = "pe:" + selectedValue; // e.g. pe:2025
      }

      // Show selected period text
      const selectedText =
        reportType === "yearly"
          ? selectedValue
          : selectedValue.substring(0, 4) + " " + selectedValue.substring(4); // e.g. "2025 Q1"
      setTextByClass("selected-quarter-text", selectedText);

      // 🚨 Municipality level check (from API-fetched data)
      if (!orgUnitsData.level || orgUnitsData.level !== 4) {
        document.getElementById("loader").style.display = "none";
        alert(
          "This is a Municipality level report. Kindly select a Municipality to generate the report."
        );
        return; // stop here
      }

      // ✅ Fetch data only if condition passes
      try {
        await fetchAnalytics(periodFilter, ouParam);
        await populateMunicipalityConsolidation(periodFilter, orgUnitId);
      } catch (err) {
        console.error("Error fetching report:", err);
        alert("Error fetching report data!");
      } finally {
        document.getElementById("loader").style.display = "none";
      }
    });
  });

  // ---------------- Barangay Section ----------------
  const indicatorIds = [
    "fuvC0llESgH", "vSXQugMIwCR", "KU0BLpyBZsq", "fg7RyFBvuq0", "ZKcDnyIGA4u",
    "MNKwZ0XBclz", "YA4HQTIHZOM", "q3HavajPD2q", "OjGV6Ma2Nz8", "diW56VUHy3k",
    "rf8MbsOXVnp", "iyvvRAy5Bze", "kwQam8wgcm9", "NOgMJv0lHpf", "PISVmmmSFAp",
    "W7f5JqP0uyx", "Y9dWLW4BSyS", "sRnZ0QQaesk", "N9IrhnwiVjD", "u6tYmQgzt02",
    "I0MoGyMab2F", "bxfwJutKzDe", "op1Wnv04eBI", "WslwNhxbATv", "PKcPqqVqQPW",
    "NYUB1E5bEud",
    "lO5Ia72xcAp", "CIvrNegxSuc", "wbTw5zvpkGB", "qu0AufvsoHa",
    "cng64doG2UZ", "UhxTlNipEGu", "Z0DoR1Vc6Ur", "rhlXAxeJFP2", "U8yPTUC8sKO",
    "FsCWDgHaKrF", "ykese1QymPc", "HGJM2qxtcaH", "uW5NzKN6qCG", "vseGW0LVA1J",
    "sAgGqqT6fjC", "FUjvxyUxnRz", "sOrsZxhtTQI", "w7h8kf7cbgt", "Xd0YWDxQ1tU",
    "erYGk2ewXPR", "XpP1rEK77LS", "ALbCF20fNJt", "mTGGFMl4GZJ", "jrF9uptzwgr",
    "uW5NzKN6qCG", "vseGW0LVA1J", "c7eOHqwwKXI", "mb9bZ3f36fg", "oLeSsVSY9OO",
    "K5Edcog43wR", "JYeg9mNguZn", "XjG9lhhzCKl", "G9xm4vC4Q3v", "cdU5IHUJBIi",
    "CCa4j0FCGey", "VxqBj6DMsSQ", "dg2DG6mAxtY", "tA4pyGBw8oS", "nujxsiBDLoD",
    "XaXpyl4yJTs", "l27aReQV3CK", "THGdGJIr3Fu", "psJJZnABqxD", "Q9UW9NfaiGV",
    "XBIXEYOLk7c", "Zq9jLyji9DC", "ITxxZ9qLhie", "YqDgqkQZZyb", "JiUt5TxsEP8",
    "ac1HsBHdtT8", "a43v7v5NjZa",
  ];

  const barangayTableIds = indicatorIds.slice(0, 26);
  const barangayTable1Ids = indicatorIds.slice(26, 52);
  const barangayTable2Ids = indicatorIds.slice(52);

  async function fetchAnalytics(periodFilter, ouParam) {
    const apiUrl =
      "https://links.hispindia.org/pmnpis_2/api/analytics.json?dimension=dx:" +
      indicatorIds.join(";") +
      "&dimension=ou:" + ouParam +
      "&filter=" + periodFilter;

    const res = await fetch(apiUrl);
    const data = await res.json();

    // Group by OU
    const grouped = {};
    data.rows.forEach(([dx, ou, val]) => {
      if (!grouped[ou]) grouped[ou] = {};
      grouped[ou][dx] = val;
    });

    // Populate each table
    populate("barangayTable", barangayTableIds, grouped, data.metaData.items);
    populate("barangayTable1", barangayTable1Ids, grouped, data.metaData.items);
    populate("barangayTable2", barangayTable2Ids, grouped, data.metaData.items);

    document.getElementById("loader").style.display = "none";
  }

  function populate(tableId, dxIds, grouped, metaItems) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML = "";

    Object.keys(grouped)
      .sort((a, b) => metaItems[a].name.localeCompare(metaItems[b].name))
      .forEach(ou => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = metaItems[ou].name;
        tr.appendChild(tdName);

        dxIds.forEach(dx => {
          const td = document.createElement("td");
          td.textContent = grouped[ou][dx] || "0";
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
  }

  // ---------------- Municipality Consolidation ----------------
  async function populateMunicipalityConsolidation(periodFilter, orgUnitId) {
    const apiUrl =
      "https://links.hispindia.org/pmnpis_2/api/analytics.json?" +
      "dimension=dx:gyMM3IBHzYI;e40NOAg7hnu;AnJQW3euRTW;jY5SFQNSg2x;C4merzrHMn9;QK9yXFa4SJu;fuvC0llESgH;StDJxe7tIiS;Gs1ujVrangk;qzjKcfO9J2w;lO5Ia72xcAp;FsCWDgHaKrF;WslwNhxbATv;dg2DG6mAxtY;c7eOHqwwKXI;IAhTOf6Jlwp;K5Edcog43wR;BllUSGdqi3r" +
      "&dimension=ou:" + orgUnitId +
      "&filter=" + periodFilter;

    const data = await fetchData(apiUrl);
    if (!data) return;

    const valuesByDx = {};
    data.rows.forEach(([dx, ou, val]) => {
      valuesByDx[dx] = parseFloat(val || 0);
    });

    Object.keys(valuesByDx).forEach((dx) => {
      const spans = document.querySelectorAll("." + dx);
      spans.forEach((span) => {
        span.textContent = valuesByDx[dx];
      });
    });

    document.querySelectorAll(".report-date").forEach(span => {
      span.textContent = new Date().toLocaleDateString();
    });
  }

  // ---------------- Export to Excel ----------------
  var tableToExcel = (function () {
    var uri = 'data:application/vnd.ms-excel;base64,'
      , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
      , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
      , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
    return function (table, name, filename) {
      if (!table.nodeType) table = document.getElementById(table)
      var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
      document.getElementById("dlink").href = uri + base64(format(template, ctx));
      document.getElementById("dlink").download = filename + '.xls';
      document.getElementById("dlink").click();
    }
  })()
</script>
