<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Health Report</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            background-color: #ffffff;
            margin-top: 8px;
        }

        th,
        td {
            border: 1px solid #000 !important;
            padding: 4px 6px !important;
            text-align: center !important;
            font-size: 12px;
        }

        th {
            font-weight: bold;
        }

        #loadingMsg {
            font-size: 16px;
            margin: 20px;
            color: #555;
        }

        #errorMsg {
            font-size: 16px;
            margin: 20px;
            color: red;
            display: none;
        }

        .report-header {
            margin: 8px 0;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <a id="dlink" style="display:none;"></a>

    <button type="button" class="btn btn-default btn-sm" style="vertical-align:middle;cursor:pointer"
        onclick="location.href='../dhis-web-reports-app/index.html#/generate-report'">
        <span class="glyphicon glyphicon-chevron-left" style="font-size:15px;"></span>&nbsp; Goto Report Selection Page
    </button>
    <button type="button" class="btn btn-primary btn-sm" style="vertical-align:middle;cursor:pointer"
        onclick="printContent('table-container')">
        <span class="glyphicon glyphicon-print" style="font-size:15px;"></span>&nbsp; Print
    </button>
    <button type="button" class="btn btn-success btn-sm" style="vertical-align:middle;cursor:pointer"
        onclick="tableToExcel('opd-table','Dental Health Report','Dental Health Report.xls')">
        <span class="glyphicon glyphicon-download-alt" style="font-size:15px;"></span> Download As Excel
    </button>

    <div class="report-header">
        <strong>Organisation Unit:</strong> <span id="selected-orgUnit"></span>
        &nbsp;&nbsp;
        <strong>Period:</strong> <span id="selected-date"></span>
    </div>

    <div id="loadingMsg">Loading report data, please wait...</div>
    <div id="errorMsg"></div>

    <div id="table-container">
        <table id="opd-table" border="1">
            <thead>
                <tr>
                    <th colspan="2"></th>
                    <th colspan="13">2.1 Patients Screened</th>
                    <th colspan="13">2.2 Dental Caries</th>
                    <th colspan="13">2.3 Gingivitis</th>
                    <th colspan="13">2.4 Periodontitis</th>
                    <th colspan="13">2.5 Malocclusion</th>
                    <th colspan="13">2.6.1 Dental Trauma - Avulsion</th>
                    <th colspan="13">2.6.2 Dental Trauma - Tooth Fracture (Ellis &amp; Davey)</th>
                    <th colspan="13">2.6.3 Dental Trauma - Dentoalveolar Fracture</th>
                    <th colspan="13">2.7 Precancerous Lesions</th>
                    <th colspan="13">2.8 Cancerous Lesions</th>
                    <th colspan="13">2.9 Oral Cancer</th>
                    <th colspan="13">2.10 Dental Fluorosis</th>
                </tr>
                <tr>
                    <th rowspan="2">Sno</th>
                    <th rowspan="2">Facility</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                    <th colspan="2">&lt;5 yrs</th>
                    <th colspan="2">5-14 yrs</th>
                    <th colspan="2">15-34 yrs</th>
                    <th colspan="2">35-59 yrs</th>
                    <th colspan="2">&gt;60 yrs</th>
                    <th colspan="3">Total</th>
                </tr>
                <tr>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>M</th>
                    <th>F</th>
                    <th>T</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        // ─── MONTHS ───────────────────────────────────────────────────────────────
        var months = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"];

        // ─── DHIS2 CONTEXT ────────────────────────────────────────────────────────
        var selectedOrgUnit = dhis2.report.organisationUnit;
        var ROOT_OU_ID = selectedOrgUnit.id;

        // ─── DATE EXTRACTION ─────────────────────────────────────────────────────
        var urlParams = new URLSearchParams(location.search);
        var startMonth = urlParams.get("sd") ? urlParams.get("sd").slice(0, 7) : null;
        var endMonth = urlParams.get("ed") ? urlParams.get("ed").slice(0, 7) : null;
        if (!startMonth && location.href.indexOf("&sd=") !== -1) {
            startMonth = location.href.split("&sd=")[1].slice(0, 7);
        }
        if (!endMonth && location.href.indexOf("&ed=") !== -1) {
            endMonth = location.href.split("&ed=")[1].slice(0, 7);
        }

        // ─── PERIOD BUILDER ───────────────────────────────────────────────────────
        function buildPeriodParam(start, end) {
            if (!start) { return null; }
            if (!end || start === end) { return start.replace("-", ""); }
            var periods = [];
            var sp = start.split("-"), ep = end.split("-");
            var y = parseInt(sp[0]), m = parseInt(sp[1]);
            var ey = parseInt(ep[0]), em = parseInt(ep[1]);
            while (y < ey || (y === ey && m <= em)) {
                periods.push(y + (m < 10 ? "0" : "") + m);
                m++;
                if (m > 12) { m = 1; y++; }
            }
            return periods.join(";");
        }

        var periodParam = buildPeriodParam(startMonth, endMonth);

        // ─── VALIDATION & UI ─────────────────────────────────────────────────────
        var loadingMsg = document.getElementById("loadingMsg");
        var errorMsg = document.getElementById("errorMsg");

        if (!startMonth || !endMonth) {
            alert("Please select start and end dates");
            if (loadingMsg) { loadingMsg.style.display = "none"; }
        } else if (startMonth.replace("-", "") > endMonth.replace("-", "")) {
            alert("Please select dates correctly");
            if (loadingMsg) { loadingMsg.style.display = "none"; }
        } else {
            var ouEl = document.getElementById("selected-orgUnit");
            if (ouEl) { ouEl.innerHTML = selectedOrgUnit.name; }

            var dateEl = document.getElementById("selected-date");
            if (dateEl) {
                var sp = startMonth.split("-"), ep = endMonth.split("-");
                var label = months[parseInt(sp[1]) - 1] + " " + sp[0];
                if (endMonth !== startMonth) {
                    label += " to " + months[parseInt(ep[1]) - 1] + " " + ep[0];
                }
                dateEl.innerHTML = label;
            }

            var tableBodyEl = document.getElementById("tableBody");
            if (tableBodyEl) { tableBodyEl.innerHTML = ""; }

            setTimeout(function () { loadReport(); }, 500);
        }

        // ─── ANALYTICS URL BUILDER ────────────────────────────────────────────────
        function buildAnalyticsUrl(period, ouId) {
            // 12 indicators × 10 disaggs = 120 dx combinations
            var indIds = [
                "g921nnOiRWV",  // 2.1 Patients Screened
                "DqUbffe5kkW",  // 2.2 Dental Caries
                "RDSZtISbKTU",  // 2.3 Gingivitis
                "yV9FPeLjkxr",  // 2.4 Periodontitis
                "Ygy5kZS9HFp",  // 2.5 Malocclusion
                "Y5hxzXVl22a",  // 2.6.1 Avulsion
                "q5bgQxfQXYM",  // 2.6.2 Tooth Fracture
                "WVRXtLM36MO",  // 2.6.3 Dentoalveolar Fracture
                "gEqRp0NAhta",  // 2.7 Precancerous Lesions
                "vLJEzWA3GEM",  // 2.8 Cancerous Lesions
                "v4d6eRB5gB2",  // 2.9 Oral Cancer
                "edxY4BAPlEM"   // 2.10 Dental Fluorosis
            ];
            var disaggIds = [
                "nhaX9jKStzS", "z0MDUxwdYN9", "NovUGYSxfz3", "vKZAkec62kj",
                "aTSonqVgsAs", "UEbsG4Vhbfb", "zmkByHXrBUc", "jvNdGBs9bA9",
                "wKl3KvsKd4a", "zpqOuduDlTC"
            ];
            var dxParts = [];
            for (var i = 0; i < indIds.length; i++) {
                for (var j = 0; j < disaggIds.length; j++) {
                    dxParts.push(indIds[i] + "." + disaggIds[j]);
                }
            }
            return "../api/26/analytics.json" +
                "?dimension=dx:" + dxParts.join(";") +
                "&dimension=ou:OU_GROUP-S57GNhlxPe7;" + ouId +
                "&filter=pe:" + period +
                "&displayProperty=NAME&outputIdScheme=UID";
        }

        // ─── SECTION DEFINITIONS ─────────────────────────────────────────────────
        // One indicator per section; M/F split via DISAGG_MAP below
        var SECTIONS = [
            { indicatorId: "g921nnOiRWV" },  // 2.1 Patients Screened
            { indicatorId: "DqUbffe5kkW" },  // 2.2 Dental Caries
            { indicatorId: "RDSZtISbKTU" },  // 2.3 Gingivitis
            { indicatorId: "yV9FPeLjkxr" },  // 2.4 Periodontitis
            { indicatorId: "Ygy5kZS9HFp" },  // 2.5 Malocclusion
            { indicatorId: "Y5hxzXVl22a" },  // 2.6.1 Avulsion
            { indicatorId: "q5bgQxfQXYM" },  // 2.6.2 Tooth Fracture
            { indicatorId: "WVRXtLM36MO" },  // 2.6.3 Dentoalveolar Fracture
            { indicatorId: "gEqRp0NAhta" },  // 2.7 Precancerous Lesions
            { indicatorId: "vLJEzWA3GEM" },  // 2.8 Cancerous Lesions
            { indicatorId: "v4d6eRB5gB2" },  // 2.9 Oral Cancer
            { indicatorId: "edxY4BAPlEM" }   // 2.10 Dental Fluorosis
        ];

        var TOTAL_COLS = 2 + (12 * 13); // 158

        // ─── DISAGG MAP ──────────────────────────────────────────────────────────
        // Exact mapping confirmed by user.
        // slot: 0=<5yrs  1=5-14yrs  2=15-34yrs  3=35-59yrs  4=>60yrs
        // gender: "M" or "F"
        var DISAGG_MAP = {
            "nhaX9jKStzS": { slot: 0, gender: "M" },  // <5 yrs, Male
            "z0MDUxwdYN9": { slot: 0, gender: "F" },  // <5 yrs, Female
            "NovUGYSxfz3": { slot: 1, gender: "M" },  // 5-14 yrs, Male
            "vKZAkec62kj": { slot: 1, gender: "F" },  // 5-14 yrs, Female
            "aTSonqVgsAs": { slot: 2, gender: "M" },  // 15-34 yrs, Male
            "UEbsG4Vhbfb": { slot: 2, gender: "F" },  // 15-34 yrs, Female
            "zmkByHXrBUc": { slot: 3, gender: "M" },  // 35-59 yrs, Male
            "jvNdGBs9bA9": { slot: 3, gender: "F" },  // 35-59 yrs, Female
            "wKl3KvsKd4a": { slot: 4, gender: "M" },  // >60 yrs, Male
            "zpqOuduDlTC": { slot: 4, gender: "F" }   // >60 yrs, Female
        };

        var ALL_DISAGG_UIDS = Object.keys(DISAGG_MAP);

        // ─── CELL BUILDERS ───────────────────────────────────────────────────────
        // Builds 13 cells for one section: 5 age groups (M+F each) + Total M + Total F + Grand Total
        function sectionCells(ouVals, indicatorId) {
            var mS = [0, 0, 0, 0, 0]; // Male slots 0-4
            var fS = [0, 0, 0, 0, 0]; // Female slots 0-4

            for (var d = 0; d < ALL_DISAGG_UIDS.length; d++) {
                var uid = ALL_DISAGG_UIDS[d];
                var info = DISAGG_MAP[uid];
                var key = indicatorId + "." + uid;
                var val = (ouVals && ouVals[key]) ? ouVals[key] : 0;
                if (info.gender === "M") { mS[info.slot] += val; }
                else { fS[info.slot] += val; }
            }

            var html = "";
            for (var ag = 0; ag < 5; ag++) {
                html += "<td>" + mS[ag] + "</td><td>" + fS[ag] + "</td>";
            }
            var totM = mS[0] + mS[1] + mS[2] + mS[3] + mS[4];
            var totF = fS[0] + fS[1] + fS[2] + fS[3] + fS[4];
            html += "<td>" + totM + "</td><td>" + totF + "</td><td>" + (totM + totF) + "</td>";
            return html;
        }

        function allSectionCells(ouVals) {
            var html = "";
            for (var s = 0; s < SECTIONS.length; s++) {
                html += sectionCells(ouVals, SECTIONS[s].indicatorId);
            }
            return html;
        }

        // ─── OU TREE HELPER ──────────────────────────────────────────────────────
        function findFacilitiesUnder(node, ouGroupSet) {
            var found = [];
            if (ouGroupSet[node.id]) { found.push({ id: node.id, name: node.name }); }
            var children = node.children || [];
            for (var i = 0; i < children.length; i++) {
                var sub = findFacilitiesUnder(children[i], ouGroupSet);
                for (var j = 0; j < sub.length; j++) { found.push(sub[j]); }
            }
            return found;
        }

        // ─── MAIN LOAD ───────────────────────────────────────────────────────────
        function loadReport() {
            if (loadingMsg) { loadingMsg.style.display = "block"; }
            if (errorMsg) { errorMsg.style.display = "none"; }

            var ANALYTICS_URL = buildAnalyticsUrl(periodParam, ROOT_OU_ID);

            fetch("../api/26/organisationUnitLevels.json")
                .then(function (r) {
                    if (!r.ok) { throw new Error("Levels API error: HTTP " + r.status); }
                    return r.json();
                })
                .then(function (levelsData) {
                    var depth = levelsData.organisationUnitLevels.length - 1;
                    var openPart = "", closePart = "";
                    for (var a = 0; a < depth; a++) { openPart += "children[id,name,level,"; closePart += "]"; }
                    var childrenFields = openPart + "id,name,level" + closePart;
                    var ouUrl = "../api/26/organisationUnits/" + ROOT_OU_ID +
                        ".json?paging=false&fields=id,name,level," + childrenFields;

                    return Promise.all([
                        fetch(ANALYTICS_URL).then(function (r) {
                            if (!r.ok) { throw new Error("Analytics API error: HTTP " + r.status); }
                            return r.json();
                        }),
                        fetch(ouUrl).then(function (r) {
                            if (!r.ok) { throw new Error("OU hierarchy API error: HTTP " + r.status); }
                            return r.json();
                        })
                    ]);
                })
                .then(function (results) {
                    var analyticsData = results[0];
                    var ouTree = results[1];

                    // Detect column indices dynamically from headers
                    var headers = analyticsData.headers || [];
                    var dxIdx = 0, ouIdx = 1, valueIdx = 2;
                    for (var h = 0; h < headers.length; h++) {
                        if (headers[h].name === "dx") { dxIdx = h; }
                        if (headers[h].name === "ou") { ouIdx = h; }
                        if (headers[h].name === "value") { valueIdx = h; }
                    }

                    // Build ouValues: { ouId: { "indicatorUID.disaggUID": value } }
                    var ouValues = {};
                    for (var c = 0; c < analyticsData.rows.length; c++) {
                        var row = analyticsData.rows[c];
                        var dx = row[dxIdx];
                        var ouKey = row[ouIdx];
                        var val = Number(row[valueIdx] || 0);
                        if (!ouValues[ouKey]) { ouValues[ouKey] = {}; }
                        ouValues[ouKey][dx] = (ouValues[ouKey][dx] || 0) + val;
                    }

                    // Totals accumulator
                    function addToTotals(totals, vals) {
                        if (!vals) { return; }
                        var keys = Object.keys(vals);
                        for (var k = 0; k < keys.length; k++) {
                            totals[keys[k]] = (totals[keys[k]] || 0) + vals[keys[k]];
                        }
                    }

                    // Build facility group set from analytics OU dimension
                    var ouGroupSet = {};
                    var ouList = analyticsData.metaData.dimensions.ou;
                    for (var g = 0; g < ouList.length; g++) { ouGroupSet[ouList[g]] = true; }

                    // ─── RENDER TABLE ─────────────────────────────────────────
                    var html = "";
                    var sno = 1;
                    var stateTotals = {};

                    var circles = ouTree.children || [];
                    circles.sort(function (a, b) { return a.name.localeCompare(b.name); });

                    for (var ci = 0; ci < circles.length; ci++) {
                        var circle = circles[ci];
                        var districts = (circle.children || []).slice();
                        districts.sort(function (a, b) { return a.name.localeCompare(b.name); });

                        var circleHasData = false;
                        var circleHtml = "";
                        var circleTotals = {};

                        for (var di = 0; di < districts.length; di++) {
                            var district = districts[di];
                            var facilities = findFacilitiesUnder(district, ouGroupSet);
                            facilities.sort(function (a, b) { return a.name.localeCompare(b.name); });
                            if (facilities.length === 0) { continue; }
                            circleHasData = true;

                            // District header (includes circle name)
                            circleHtml += "<tr style='background:#c0c0c0;font-weight:bold;'>";
                            circleHtml += "<td colspan='" + TOTAL_COLS + "' style='text-align:left !important;'>&nbsp;&nbsp;" + circle.name + " - " + district.name + "</td>";
                            circleHtml += "</tr>";

                            var distTotals = {};

                            for (var fi = 0; fi < facilities.length; fi++) {
                                var fac = facilities[fi];
                                var facVals = ouValues[fac.id] || null;
                                addToTotals(distTotals, facVals);
                                addToTotals(circleTotals, facVals);
                                addToTotals(stateTotals, facVals);

                                circleHtml += "<tr>";
                                circleHtml += "<td>" + sno + "</td>";
                                circleHtml += "<td style='text-align:left !important;'>" + fac.name + "</td>";
                                circleHtml += allSectionCells(facVals);
                                circleHtml += "</tr>";
                                sno++;
                            }

                            // District total row
                            circleHtml += "<tr style='background:#e0e0e0;font-weight:bold;'>";
                            circleHtml += "<td></td>";
                            circleHtml += "<td style='text-align:left !important;'>" + district.name + " Total</td>";
                            circleHtml += allSectionCells(distTotals);
                            circleHtml += "</tr>";
                        }

                        if (!circleHasData) { continue; }

                        html += circleHtml;

                        // Circle total row
                        html += "<tr style='background:#8c8c8c;font-weight:bold;color:#fff;'>";
                        html += "<td></td>";
                        html += "<td style='text-align:left !important;'>" + circle.name + " Total</td>";
                        html += allSectionCells(circleTotals);
                        html += "</tr>";
                    }

                    // State total row
                    html += "<tr style='background:#404040;font-weight:bold;color:#fff;'>";
                    html += "<td></td>";
                    html += "<td style='text-align:left !important;'>State Total</td>";
                    html += allSectionCells(stateTotals);
                    html += "</tr>";

                    document.getElementById("tableBody").innerHTML = html;
                    if (loadingMsg) { loadingMsg.style.display = "none"; }
                })
                .catch(function (err) {
                    if (loadingMsg) { loadingMsg.style.display = "none"; }
                    if (errorMsg) { errorMsg.style.display = "block"; errorMsg.textContent = "Error: " + err.message; }
                    console.error(err);
                });
        }

        function tableToExcel(tableId, filename = 'Report.xls') {
            var table = document.getElementById(tableId);
            if (!table) {
                alert("Table not found!");
                return;
            }

            var html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" 
              xmlns:x="urn:schemas-microsoft-com:office:excel" 
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="UTF-8">
        </head>
        <body>
            <table>${table.innerHTML}</table>
        </body>
        </html>
    `;

            var blob = new Blob([html], {
                type: "application/vnd.ms-excel;charset=utf-8;"
            });

            var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


    </script>
    <!-- printing script -->
    <script type="text/javascript">
        function printContent(el) {
            var restorepage = document.body.innerHTML;
            var printcontent = document.getElementById(el).innerHTML;
            document.body.innerHTML = printcontent;
            window.print();
            document.body.innerHTML = restorepage;
        }

    </script>
</body>

</html>