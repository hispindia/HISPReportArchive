<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Table</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
    integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            background-color: #fcd5b4;
            margin-top: 8px;
        }

        th,
        td {
            border: 1px solid #000 !important;
            padding: 8px !important;
            text-align: center !important;
        }

        th {
            font-weight: bold;
            text-align: center;


        }
    </style>
</head>

<body>

    <a id="dlink" style="display:none;"></a>

    <button type="button" id="btnBack" class="btn brn-default btn-sm" style="vertical-align: middle; cursor:pointer"
        onclick="location.href='../dhis-web-reports-app/index.html#/generate-report'">
        <span class="glyphicon glyphicon-chevron-left" style="font-size: 15px;"></span>&nbsp; Goto Report Selection Page
    </button>

    <button type="button" class="btn btn-primary btn-sm" style="vertical-align: middle; cursor:pointer"
        onclick="printContent('table-container')"><span class="glyphicon glyphicon-print" style="font-size: 15px;"></span>
        &nbsp;
        Print
    </button>

    <button type="button" class="btn btn-success btn-sm" style="vertical-align: middle; cursor:pointer" id="btnExport"
        onclick="tableToExcel('opd-table', 'Hospital OPD Report', 'Hospital OPD Report.xls')"><span
            class="glyphicon glyphicon-download-alt" style="font-size: 15px;"></span>Download As Excel</button>


    <div id="table-container">
        <table id="opd-table" border="1">
            <tr>
                <th rowspan="4">Circle</th>
                <th colspan="56">From <span id="from-date"></span></th>
                <th colspan="70">To <span id="to-date"></span></th>
            </tr>
            <tr>
                <th colspan="56">New Opd</th>
                <th colspan="70">Old-Opd</th>
            </tr>

            <tr>
                <th rowspan="2">Name of Hospital</th>
                <th colspan="3">General</th>
                <th colspan="3">Medicine</th>
                <th colspan="3">Surgery</th>
                <th colspan="3">Paediatrics</th>
                <th colspan="2">Obstetrics</th>
                <th colspan="2">Gynae</th>
                <th colspan="3">Dialysis</th>
                <th colspan="3">Orthopaedic</th>
                <th colspan="3">TB</th>
                <th colspan="3">Ophthalmic</th>
                <!-- <th colspan="3">Emergency</th> -->
                <th colspan="3">Psychiatric</th>
                <!-- <th colspan="3">Dog Bite</th> -->
                <th colspan="3">ENT</th>
                <th colspan="3">Dermatology</th>
                <th colspan="3">ICTC</th>
                <th colspan="3">Dental</th>
                <th colspan="3">AYUSH</th>
                <th colspan="3">Insecticide Poisoning (due to inhalation)</th>
                <th colspan="3">Insecticide Poisoning (due to consumption)</th>
                <th colspan="3">Total OPD as per OPD Register</th>
                <th colspan="3">General</th>
                <th colspan="3">Medicine</th>
                <th colspan="3">Surgery</th>
                <th colspan="3">Paediatrics</th>
                <th colspan="2">Obstetrics</th>
                <th colspan="2">Gynae</th>
                <th colspan="3">Dialysis</th>
                <th colspan="3">Orthopaedic</th>
                <th colspan="3">TB</th>
                <th colspan="3">Ophthalmic</th>
                <th colspan="3">Emergency</th>
                <th colspan="3">Psychiatric</th>
                <!-- <th colspan="3">Dog Bite</th> -->
                <th colspan="3">ENT</th>
                <th colspan="3">Dermatology</th>
                <th colspan="3">ICTC</th>
                <th colspan="3">Dental</th>
                <th colspan="3">AYUSH</th>
                <th colspan="3">Insecticide Poisoning (due to inhalation)</th>
                <th colspan="3">Insecticide Poisoning (due to consumption)</th>
                <th colspan="3">Total OPD as per OPD Register</th>
            </tr>

            <tr>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <!-- <th>Male</th>
                <th>Female</th>
                <th>Transgender</th> -->
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <!-- <th>Male</th>
                <th>Female</th>
                <th>Transgender</th> -->
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <!-- <th>Male</th>
                <th>Female</th>
                <th>Transgender</th> -->

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>

                <th>Male</th>
                <th>Female</th>
                <th>Transgender</th>
            </tr>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        document.getElementsByClassName("hideInPrint")["0"] && (document.getElementsByClassName("hideInPrint")["0"].style.display = "none");

        var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        var selectedOrgUnit = dhis2.report.organisationUnit;
        var orgUnit = dhis2.report.organisationUnitChildren;
        var organisationUnitChildren = orgUnit.sort((a, b) => a.name.localeCompare(b.name));
        var level = dhis2.report.organisationUnitHierarchy.length;

        var orgUnitData = [];
        var printTotalValue = [];
        var orgUnitHierarchy = {};

        // Extract dates from URL parameters
        var urlParams = new URLSearchParams(location.search);
        var startMonth = urlParams.get('sd') ? urlParams.get('sd').slice(0, 10) : null;
        var endMonth = urlParams.get('ed') ? urlParams.get('ed').slice(0, 10) : null;

        if (!startMonth && location.href.includes("&sd=")) {
            var sdPart = location.href.split("&sd=")[1];
            startMonth = sdPart ? sdPart.slice(0, 10) : null;
        }
        if (!endMonth && location.href.includes("&ed=")) {
            var edPart = location.href.split("&ed=")[1];
            endMonth = edPart ? edPart.slice(0, 10) : null;
        }

        if (!startMonth || !endMonth) {
            alert("Please select start and end dates");
            if ($('#loader').length) $('#loader').hide();
        } else {
            var monthArr = [startMonth, endMonth];

            if (startMonth.split("-").join("") > endMonth.split("-").join("")) {
                alert("Please select dates correctly");
                if ($('#loader').length) $('#loader').hide();
            } else {
                var selectedOrgUnitEl = document.getElementById("selected-orgUnit");
                if (selectedOrgUnitEl) selectedOrgUnitEl.innerHTML = selectedOrgUnit.name;

                var selectedDateEl = document.getElementById("selected-date");
                if (selectedDateEl) selectedDateEl.innerHTML = months[startMonth.split("-")["1"] - 1] + " " + startMonth.split("-")["0"] + " to " + months[endMonth.split("-")["1"] - 1] + " " + endMonth.split("-")["0"];

                var dataTableEl = document.getElementById("dataTable");
                if (dataTableEl) dataTableEl.style.visibility = "hidden";

                var tableBodyEl = document.getElementById("tableBody");
                if (tableBodyEl) tableBodyEl.innerHTML = "";

                if ($('#loader').length) $('#loader').show();

                setTimeout(function () { getData(monthArr); }, 1000);
            }
        }

        function getData(smToem) {
            var includedOrgUnitGroups = [];
            var numberOfDays = 0;
            var financialYear = [];

            // API 1 Data Elements
            var dataElementIds1 = [
                "GodxmEViKX1", "xUtGYnNSvBh", "XgtnJmd7ZGw",
                "JwlS8xFJtAI", "F4u0lqj1qL5", "Y6luhijHWbx", "mWTFgeLSjXW",
                "OXFPwsXjPC0", "IGNwamYWlD7", "lWy5Mx9ai77", "gfhh2httW5d", "D5qcOWbeIv5",
                "Dxra5Ht4PiF", "eBZCO59pNkT", "Avy2idAefBO", "KGRSYk9CJIS", "FhzzL9sX8zt",
                "tUn4HiR3Yya", "rjOb1XXuJE2", "b5gefd4B37n", "eTWRL241Hqz", "TgNcKFAIzv2",
                "FwkrBIMcVxE", "sFIjiWKCgT9", "oR2ZtjLYUyY", "tq9aEgjb3t7", "aCFKOAvQwqx",
                "oAbYTJ66QBT", "pBnPCqAu6V0", "KMVHYVAZrwf", "Cw0IKh7MhhN", "jJUnOoZQW6p",
                "TOY7o5KeGOS", "QxGCgMLgwU7", "Rv6hiMnSJJB", "F9ippJQfsPN", "pGRpeKnFiFY",
                "iLkFfhwRZIo", "mUexvg36QpF", "TCdtHzMDO5Q", "kon0ZfQ5Mzp", "OHoOL1eG38Y",
                "XzzHYWhzPpw", "NEvPV3RhUry", "Rx8D1vhOz2e", "g8yHBsScUmh", "w8DYNUL8gSN",
                "g5EKrrdnalF", "luWRpO7wbCq", "MuGjMniEyDN", "YOaP3goIwM3", "bxldqNHkFb3",
                "opB9mvs6iIy", "hJeodMxRHp0", "M07ii3amcEt"
            ];

            // API 2 Data Elements
            var dataElementIds2 = [
                "Xkm5aXUztAC", "hRJlOSPa0e7", "Zvh15VyYmRZ", "i0ne4y6tz8h", "mkMzv1jVF82",
                "w9W02hPYD7o", "KXCBsZhweJd", "L4l2PfFCAWw", "Wei2F7dWixL", "AR5DfDSgyjO",
                "CHQY72lerj6", "Y8Ji7xk1z6U", "Co6YYBxZHnf", "hdV28BGbBqH", "HPsv5TXySVa",
                "qhVnzOcekjS", "o8ZLiWV0tKY", "qTRbNA9YIb3", "qdRdznONd5z", "J8XhZzuxJ8n",
                "gpA0erLDjl6", "SOXoGmHHOGB", "pM1hLmZdv6h", "CtTr6KDHaVo", "AZEAvs1nu9N",
                "fn7rDaqucsd", "HgKXKjWF3Y4", "yImkYZxNLqj", "yQN7jfGDwtc", "ocXgElldWQf",
                "McnKBGTaVU4", "mapgC5BkNCv", "HCuHK05mcF8", "QkafA433SC1", "uPvbJTt0Dao",
                "PkNs0gz48Tn", "XHR8wq4fbwS", "ZBVvkPtXItB", "VReAppo1QHe", "WvYMbMyKNat",
                "DAKkjNL1CQP", "Ez4XsHkRFVw", "Gw4fSCVL3wd", "pY2AcKQfTvR", "A72YHOiMGyZ",
                "QwGfsKYsgwX", "rQSuE20w9HE", "ZQh03Yj8spF", "mjLCBem37v3", "Q7cGZFQciqz",
                "Gh6x45T6Su4", "freysSTBTyJ", "oW6orxFtOMq", "A61LfhT1lpQ", "KPsVt8Pwhmh",
                "Oy4z7pNKZNu", "alTe3WLMa9U", "b5jDaN8jhFi"
            ];

            var getBetweenDates = function (startDate, endDate) {
                var arr = [];
                var startYear = startDate.split("-");
                var endYear = endDate.split("-");
                var numberOfDays = 0;
                var financialYear = [];

                for (var i = parseInt(startYear[0]); i <= parseInt(endYear[0]); i++) {
                    var startMonth = (i > parseInt(startYear[0])) ? 1 : parseInt(startYear[1]);
                    var endMonth = (i == endYear[0]) ? parseInt(endYear[1]) : 12;

                    for (var j = startMonth; j <= endMonth; j++) {
                        let value = j < 10 ? i + "0" + j : i + "" + j;
                        numberOfDays += new Date(i, j, 0).getDate();
                        arr.push(value);

                        if (j < 4) {
                            if (!financialYear.includes((i - 1) + "April")) financialYear.push((i - 1) + "April");
                        } else {
                            if (!financialYear.includes(i + "April")) financialYear.push(i + "April");
                        }
                    }
                }

                return arr;
            };

            // Example usage
            var smToEm = getBetweenDates(smToem[0], smToem[1]);

            // Display in table headers
            document.getElementById("from-date").textContent = smToem[0];
            document.getElementById("to-date").textContent = smToem[1];

            var isHospital = {};

            $.when(
                $.get("../api/27/organisationUnitGroups/S0CHG7msf7i.json?fields=id,name,organisationUnits&paging=false"),
                $.get("../api/27/organisationUnitGroups/k5pG961XOGC.json?fields=id,name,organisationUnits&paging=false"),
                $.get("../api/27/organisationUnitGroups/CXswpFTMKVB.json?fields=id,name,organisationUnits&paging=false"),
                $.get("../api/27/organisationUnitGroups/S57GNhlxPe7.json?fields=id,name,organisationUnits&paging=false")
            ).done(function (state, circle, group, hospitalOu) {
                var rows = [];
                rows = [].concat(state[0].organisationUnits).concat(circle[0].organisationUnits).concat(group[0].organisationUnits).concat(hospitalOu[0].organisationUnits);
                hospitalOu[0].organisationUnits.forEach(ou => isHospital[ou.id] = true);

                var fetchDEs1 = dataElementIds1.slice();
                var fetchDEs2 = dataElementIds2.slice();

                var dim1 = fetchDEs1.join(";");
                var dim2 = fetchDEs2.join(";");

                console.log("=== STARTING DATA FETCH ===");
                console.log("API 1 Data Elements:", dataElementIds1.length);
                console.log("API 2 Data Elements:", dataElementIds2.length);
                console.log("Months to fetch:", smToEm);

                var api1Total = 0;
                var api2Total = 0;

                // Fetch data for each month from API 1
                smToEm.forEach(month => {
                    if (dim1) {
                        $.ajax({
                            type: "GET",
                            async: false,
                            url: `../api/26/analytics.json?dimension=dx:${dim1}&dimension=pe:${month}&dimension=ou:${selectedOrgUnit.id};OU_GROUP-S57GNhlxPe7&displayProperty=NAME&paging=false`,
                            data: JSON,
                            success: function (data, status) {
                                var rowCount = data.rows ? data.rows.length : 0;
                                api1Total += rowCount;
                                console.log(`API 1 - Month ${month}: ${rowCount} rows`);

                                if (data.rows) {
                                    data.rows.forEach(row => {
                                        var ouId = row[2];
                                        var deId = row[0];
                                        var value = row[3];

                                        if (!orgUnitData[ouId]) orgUnitData[ouId] = {};
                                        if (!orgUnitData[ouId][deId]) orgUnitData[ouId][deId] = 0;
                                        orgUnitData[ouId][deId] = Number(value) + Number(orgUnitData[ouId][deId]);
                                    });
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error("API 1 Error:", error, "Status:", xhr.status);
                            }
                        });
                    }
                });

                console.log(`API 1 TOTAL ROWS: ${api1Total}`);

                // Fetch data from API 2
                smToEm.forEach(month => {
                    if (dim2) {
                        $.ajax({
                            type: "GET",
                            async: false,
                            url: `../api/26/analytics.json?dimension=dx:${dim2}&dimension=pe:${month}&dimension=ou:${selectedOrgUnit.id};OU_GROUP-S57GNhlxPe7&displayProperty=NAME&paging=false`,
                            data: JSON,
                            success: function (data, status) {
                                var rowCount = data.rows ? data.rows.length : 0;
                                api2Total += rowCount;
                                console.log(`API 2 - Month ${month}: ${rowCount} rows`);

                                if (data.rows) {
                                    data.rows.forEach(row => {
                                        var ouId = row[2];
                                        var deId = row[0];
                                        var value = row[3];

                                        if (!orgUnitData[ouId]) orgUnitData[ouId] = {};
                                        if (!orgUnitData[ouId][deId]) orgUnitData[ouId][deId] = 0;
                                        orgUnitData[ouId][deId] = Number(value) + Number(orgUnitData[ouId][deId]);
                                    });
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error("API 2 Error:", error, "Status:", xhr.status);
                                console.error("Response:", xhr.responseText);
                            }
                        });
                    }
                });

                console.log(`API 2 TOTAL ROWS: ${api2Total}`);

                if (api2Total === 0) {
                    console.warn("⚠⚠⚠ API 2 RETURNED ZERO ROWS - NO DATA FOR THESE DATA ELEMENTS! ⚠⚠⚠");
                }

                // Financial year fetch
                if (financialYear.length > 0) {
                    $.ajax({
                        type: "GET",
                        async: false,
                        url: `../api/analytics.json?dimension=dx:fePK3YQItlG&dimension=pe:${financialYear.join(";")}&dimension=ou:${selectedOrgUnit.id};OU_GROUP-S57GNhlxPe7&displayProperty=NAME&paging=false`,
                        data: JSON,
                        success: function (data, status) {
                            if (data.rows) {
                                data.rows.forEach(row => {
                                    var ouId = row[2];
                                    var deId = row[0];
                                    var value = row[3];

                                    if (!orgUnitData[ouId]) orgUnitData[ouId] = {};
                                    if (!orgUnitData[ouId][deId]) orgUnitData[ouId][deId] = 0;
                                    orgUnitData[ouId][deId] = Number(value) + Number(orgUnitData[ouId][deId]);
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("Financial Year API Error:", error);
                        }
                    });
                }

                // Debug: Show what data was collected
                var ouIds = Object.keys(orgUnitData);
                console.log(`Total org units with data: ${ouIds.length}`);
                if (ouIds.length > 0) {
                    var firstOu = ouIds[0];
                    var deIds = Object.keys(orgUnitData[firstOu]);
                    console.log(`First org unit has ${deIds.length} data elements`);

                    var api1Count = deIds.filter(id => dataElementIds1.includes(id)).length;
                    var api2Count = deIds.filter(id => dataElementIds2.includes(id)).length;
                    console.log(`API 1 DEs present: ${api1Count}/${dataElementIds1.length}`);
                    console.log(`API 2 DEs present: ${api2Count}/${dataElementIds2.length}`);
                }

                rows.forEach(data => includedOrgUnitGroups[data.id] = true);
                renderData();
            });

            function renderData() {
                var url = '../api/organisationUnits/' + selectedOrgUnit.id + '.json?paging=false&fields=id,name,level,dataSets[id]';

                $.ajax({
                    type: "GET",
                    async: false,
                    url: '../api/organisationUnitLevels.json',
                    data: JSON,
                    success: function (data, status) {
                        for (let i = 0; i < data.organisationUnitLevels.length; i++) {
                            url += ',children[id,name,level,dataSets[id]';
                        }
                        url += ']';
                    }
                });

                $.ajax({
                    type: "GET",
                    async: false,
                    url: url,
                    data: JSON,
                    success: function (data, status) {
                        var levelColor = [];
                        levelColor["2"] = "#89CFF0";
                        levelColor["3"] = "#A0D6B4";
                        levelColor["4"] = "#B2BEB5";
                        levelColor["6"] = "#FFCC99";

                        treeDown(data, levelColor, null, null);

                        var dataTableEl = document.getElementById("dataTable");
                        if (dataTableEl) dataTableEl.style.visibility = "visible";
                        if ($('#loader').length) $('#loader').hide();
                        var printingEl = document.getElementById("printing");
                        if (printingEl) printingEl.style.display = "block";
                    }
                });

                function treeDown(arr, color, parentName, parentLevel) {
                    var key = arr;

                    if (parentName && parentLevel) {
                        if (!orgUnitHierarchy[key.id]) {
                            orgUnitHierarchy[key.id] = {};
                        }
                        orgUnitHierarchy[key.id][parentLevel] = parentName;

                        if (orgUnitHierarchy[arr.id]) {
                            Object.keys(orgUnitHierarchy[arr.id]).forEach(lvl => {
                                if (!orgUnitHierarchy[key.id][lvl]) {
                                    orgUnitHierarchy[key.id][lvl] = orgUnitHierarchy[arr.id][lvl];
                                }
                            });
                        }
                    }

                    if (key.children && key.children.length && key.level != 7) {
                        key.children.sort((a, b) => a.name.localeCompare(b.name));
                        for (let i = 0; i < key.children.length; i++) {
                            if (!orgUnitHierarchy[key.children[i].id]) {
                                orgUnitHierarchy[key.children[i].id] = {};
                            }
                            if (orgUnitHierarchy[key.id]) {
                                Object.keys(orgUnitHierarchy[key.id]).forEach(lvl => {
                                    orgUnitHierarchy[key.children[i].id][lvl] = orgUnitHierarchy[key.id][lvl];
                                });
                            }
                            orgUnitHierarchy[key.children[i].id][key.level] = key.name;

                            treeDown(key.children[i], color, key.name, key.level);
                        }

                        if (includedOrgUnitGroups[key.id] && !isHospital[key.id]) {
                            var obj = { id: key.id, name: key.name, level: key.level };
                            obj["color"] = color[key.level];
                            runAPI(obj.id, obj.name, obj.color, obj.level);
                        }
                    } else {
                        if (includedOrgUnitGroups[key.id]) {
                            var obj = { id: key.id, name: key.name, level: key.level };
                            runAPI(obj.id, obj.name, null, obj.level);
                        }
                    }
                }

                function runAPI(orgUnitId, orgUnit, levelColor, orgUnitLevel) {
                    var printValue = [];
                    var addRow = "";

                    var allDataElements = dataElementIds1.concat(dataElementIds2);

                    allDataElements.forEach((de, i) => {
                        let value = 0;
                        if (de && de !== "" && orgUnitData[orgUnitId] && orgUnitData[orgUnitId][de] !== undefined) {
                            value = orgUnitData[orgUnitId][de];
                        }
                        printValue["value" + i] = value;
                    });

                    if (isHospital[orgUnitId]) {
                        var circleName = "";
                        if (orgUnitHierarchy[orgUnitId]) {
                            circleName = orgUnitHierarchy[orgUnitId][3] || "";
                        }

                        addRow = '<tr>';
                        addRow += '<td>' + (circleName || "") + '</td>';
                        addRow += '<td>' + orgUnit + '</td>';

                        allDataElements.forEach((de, j) => {
                            let value = printValue["value" + j];
                            if (value === "" || value === null || isNaN(value)) value = 0;
                            if (typeof value === "number" && !Number.isInteger(value)) value = Number(value).toFixed(2);
                            addRow += `<td>${value}</td>`;

                            if (de && de !== "" && !de.includes('divide') && !de.includes('percentage')) {
                                for (let parentLevel = orgUnitLevel - 1; parentLevel >= 2; parentLevel--) {
                                    if (!printTotalValue[parentLevel + "totalValue" + j]) {
                                        printTotalValue[parentLevel + "totalValue" + j] = 0;
                                    }
                                    printTotalValue[parentLevel + "totalValue" + j] =
                                        Number(printTotalValue[parentLevel + "totalValue" + j]) + Number(value);
                                }
                            }
                        });

                        addRow += `</tr>`;
                        const tableBodyEl = document.getElementById("tableBody");
                        if (tableBodyEl && addRow) tableBodyEl.innerHTML += addRow;
                    }

                    if (orgUnitLevel <= 6 && orgUnitLevel >= 2 && !isHospital[orgUnitId]) {
                        if (orgUnitLevel != 5 && orgUnitLevel != 6) {
                            addRow = `<tr><td colspan="2" style="font-weight:bold;background:${levelColor};">${orgUnit} Total</td>`;

                            allDataElements.forEach((de, i) => {
                                let value = printTotalValue[orgUnitLevel + "totalValue" + i];
                                if (value === "" || value === null || value === undefined || isNaN(value)) value = 0;
                                value = Number(value).toFixed(0);
                                addRow += `<td style="font-weight:bold;background:${levelColor};">${value}</td>`;
                            });

                            addRow += `</tr>`;
                            const tableBodyEl = document.getElementById("tableBody");
                            if (tableBodyEl && addRow) tableBodyEl.innerHTML += addRow;
                        }

                        allDataElements.forEach((de, i) => {
                            if (!de || de === "" || de.includes('divide') || de.includes('percentage')) return;
                            printTotalValue[orgUnitLevel + "totalValue" + i] = 0;
                        });
                    }
                }
            }
        }

        var tableToExcel = (function () {
            var uri = 'data:application/vnd.ms-excel;base64,'
                , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
                , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
                , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
            return function (table, name, filename) {
                if (!table.nodeType) table = document.getElementById(table)
                var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
                document.getElementById("dlink").href = uri + base64(format(template, ctx));
                document.getElementById("dlink").download = filename;
                document.getElementById("dlink").click();
            }
        })()

    </script>


    <!-- printing script -->
    <script type="text/javascript">
        function printContent(el) {
            var restorepage = document.body.innerHTML;
            var printcontent = document.getElementById(el).innerHTML;
            document.body.innerHTML = printcontent;
            window.print();
            document.body.innerHTML = restorepage;
        }

    </script>

</body>

</html>